/*!
 * DicomProvider v1.0.8.09200
 * ©2017-2022 上海辉明软件有限公司.All Rights Reserved
 */
var DISPLAY_MODE,DPUIMsg=function(){function e(){}return Object.defineProperty(e,"mouseClick",{get:function(){return"MouseClick"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseDoubleClick",{get:function(){return"MouseDoubleClick"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseLBDown",{get:function(){return"MouseLBDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseLBUp",{get:function(){return"MouseLBUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseRBDown",{get:function(){return"MouseRBDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseRBUp",{get:function(){return"MouseRBUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseMove",{get:function(){return"MouseMove"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseWheel",{get:function(){return"MouseWheel"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchDown",{get:function(){return"TouchDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchUp",{get:function(){return"TouchUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchDoubleTap",{get:function(){return"TouchDoubleTap"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchLongPress",{get:function(){return"TouchLongPress"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchFlingUp",{get:function(){return"TouchFlingUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchFlingDown",{get:function(){return"TouchFlingDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchMove",{get:function(){return"TouchMove"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoom",{get:function(){return"TouchZoom"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoomStart",{get:function(){return"TouchZoomStart"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoomEnd",{get:function(){return"TouchZoomEnd"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"keyPress",{get:function(){return"KeyPress"},enumerable:!0,configurable:!0}),e}(),ImageFile=function(){return function(){}}(),ColorItem=function(){return function(e,t,i){this.R=e,this.G=t,this.B=i}}(),DefaultColorTable=function(){return function(){this.default1=new Map,this.default2=new Map,this.default3=new Map,this.default4=new Map;var e=new ColorItem(255,50,20);this.default1.set(76,e),e=new ColorItem(255,255,0),this.default1.set(206,e),e=new ColorItem(16,140,130),this.default2.set(64,e),e=new ColorItem(43,25,200),this.default2.set(102,e),e=new ColorItem(160,50,130),this.default2.set(140,e),e=new ColorItem(240,130,68),this.default2.set(166,e),e=new ColorItem(100,42,96),this.default3.set(20,e),e=new ColorItem(10,20,79),this.default3.set(40,e),e=new ColorItem(0,0,150),this.default3.set(81,e),e=new ColorItem(20,40,70),this.default3.set(102,e),e=new ColorItem(110,90,10),this.default3.set(128,e),e=new ColorItem(220,170,60),this.default3.set(153,e),e=new ColorItem(80,30,10),this.default3.set(166,e),e=new ColorItem(200,60,10),this.default3.set(179,e),e=new ColorItem(0,0,0),this.default4.set(0,e),e=new ColorItem(125,0,255),this.default4.set(1,e),e=new ColorItem(121,0,255),this.default4.set(2,e),e=new ColorItem(116,0,255),this.default4.set(3,e),e=new ColorItem(112,0,255),this.default4.set(4,e),e=new ColorItem(108,0,255),this.default4.set(5,e),e=new ColorItem(103,0,255),this.default4.set(6,e),e=new ColorItem(99,0,255),this.default4.set(7,e),e=new ColorItem(95,0,255),this.default4.set(285,e),e=new ColorItem(91,0,255),this.default4.set(9,e),e=new ColorItem(86,0,255),this.default4.set(10,e),e=new ColorItem(82,0,255),this.default4.set(11,e),e=new ColorItem(78,0,255),this.default4.set(12,e),e=new ColorItem(73,0,255),this.default4.set(13,e),e=new ColorItem(69,0,255),this.default4.set(14,e),e=new ColorItem(65,0,255),this.default4.set(15,e),e=new ColorItem(60,0,255),this.default4.set(16,e),e=new ColorItem(56,0,255),this.default4.set(17,e),e=new ColorItem(52,0,255),this.default4.set(18,e),e=new ColorItem(47,0,255),this.default4.set(19,e),e=new ColorItem(43,0,255),this.default4.set(20,e),e=new ColorItem(39,0,255),this.default4.set(21,e),e=new ColorItem(34,0,255),this.default4.set(22,e),e=new ColorItem(30,0,255),this.default4.set(23,e),e=new ColorItem(26,0,255),this.default4.set(24,e),e=new ColorItem(22,0,255),this.default4.set(25,e),e=new ColorItem(17,0,255),this.default4.set(26,e),e=new ColorItem(13,0,255),this.default4.set(27,e),e=new ColorItem(9,0,255),this.default4.set(28,e),e=new ColorItem(4,0,255),this.default4.set(29,e),e=new ColorItem(0,2,255),this.default4.set(30,e),e=new ColorItem(0,7,255),this.default4.set(31,e),e=new ColorItem(0,11,255),this.default4.set(32,e),e=new ColorItem(0,16,255),this.default4.set(33,e),e=new ColorItem(0,20,255),this.default4.set(34,e),e=new ColorItem(0,25,255),this.default4.set(35,e),e=new ColorItem(0,29,255),this.default4.set(36,e),e=new ColorItem(0,34,255),this.default4.set(37,e),e=new ColorItem(0,38,255),this.default4.set(38,e),e=new ColorItem(0,43,255),this.default4.set(39,e),e=new ColorItem(0,47,255),this.default4.set(40,e),e=new ColorItem(0,52,255),this.default4.set(41,e),e=new ColorItem(0,56,255),this.default4.set(42,e),e=new ColorItem(0,61,255),this.default4.set(43,e),e=new ColorItem(0,65,255),this.default4.set(44,e),e=new ColorItem(0,70,255),this.default4.set(45,e),e=new ColorItem(0,74,255),this.default4.set(46,e),e=new ColorItem(0,79,255),this.default4.set(47,e),e=new ColorItem(0,83,255),this.default4.set(48,e),e=new ColorItem(0,88,255),this.default4.set(49,e),e=new ColorItem(0,92,255),this.default4.set(50,e),e=new ColorItem(0,97,255),this.default4.set(51,e),e=new ColorItem(0,101,255),this.default4.set(52,e),e=new ColorItem(0,106,255),this.default4.set(53,e),e=new ColorItem(0,110,255),this.default4.set(54,e),e=new ColorItem(0,115,255),this.default4.set(55,e),e=new ColorItem(0,119,255),this.default4.set(56,e),e=new ColorItem(0,124,255),this.default4.set(57,e),e=new ColorItem(0,128,255),this.default4.set(58,e),e=new ColorItem(0,133,255),this.default4.set(59,e),e=new ColorItem(0,137,255),this.default4.set(60,e),e=new ColorItem(0,142,255),this.default4.set(61,e),e=new ColorItem(0,146,255),this.default4.set(62,e),e=new ColorItem(0,151,255),this.default4.set(63,e),e=new ColorItem(0,155,255),this.default4.set(64,e),e=new ColorItem(0,160,255),this.default4.set(65,e),e=new ColorItem(0,164,255),this.default4.set(66,e),e=new ColorItem(0,169,255),this.default4.set(67,e),e=new ColorItem(0,173,255),this.default4.set(68,e),e=new ColorItem(0,178,255),this.default4.set(69,e),e=new ColorItem(0,182,255),this.default4.set(70,e),e=new ColorItem(0,187,255),this.default4.set(71,e),e=new ColorItem(0,191,255),this.default4.set(72,e),e=new ColorItem(0,196,255),this.default4.set(73,e),e=new ColorItem(0,200,255),this.default4.set(74,e),e=new ColorItem(0,205,255),this.default4.set(75,e),e=new ColorItem(0,209,255),this.default4.set(76,e),e=new ColorItem(0,214,255),this.default4.set(77,e),e=new ColorItem(0,218,255),this.default4.set(78,e),e=new ColorItem(0,223,255),this.default4.set(79,e),e=new ColorItem(0,227,255),this.default4.set(80,e),e=new ColorItem(0,232,255),this.default4.set(81,e),e=new ColorItem(0,236,255),this.default4.set(82,e),e=new ColorItem(0,241,255),this.default4.set(83,e),e=new ColorItem(0,245,255),this.default4.set(84,e),e=new ColorItem(0,250,255),this.default4.set(85,e),e=new ColorItem(0,255,255),this.default4.set(86,e),e=new ColorItem(0,255,255),this.default4.set(87,e),e=new ColorItem(0,255,250),this.default4.set(88,e),e=new ColorItem(0,255,245),this.default4.set(89,e),e=new ColorItem(0,255,241),this.default4.set(90,e),e=new ColorItem(0,255,236),this.default4.set(91,e),e=new ColorItem(0,255,231),this.default4.set(92,e),e=new ColorItem(0,255,226),this.default4.set(93,e),e=new ColorItem(0,255,222),this.default4.set(94,e),e=new ColorItem(0,255,217),this.default4.set(95,e),e=new ColorItem(0,255,212),this.default4.set(96,e),e=new ColorItem(0,255,208),this.default4.set(97,e),e=new ColorItem(0,255,203),this.default4.set(98,e),e=new ColorItem(0,255,198),this.default4.set(99,e),e=new ColorItem(0,255,193),this.default4.set(100,e),e=new ColorItem(0,255,189),this.default4.set(101,e),e=new ColorItem(0,255,184),this.default4.set(102,e),e=new ColorItem(0,255,179),this.default4.set(103,e),e=new ColorItem(0,255,175),this.default4.set(104,e),e=new ColorItem(0,255,170),this.default4.set(105,e),e=new ColorItem(0,255,165),this.default4.set(106,e),e=new ColorItem(0,255,160),this.default4.set(107,e),e=new ColorItem(0,255,156),this.default4.set(108,e),e=new ColorItem(0,255,151),this.default4.set(109,e),e=new ColorItem(0,255,146),this.default4.set(110,e),e=new ColorItem(0,255,142),this.default4.set(111,e),e=new ColorItem(0,255,137),this.default4.set(112,e),e=new ColorItem(0,255,132),this.default4.set(113,e),e=new ColorItem(0,255,128),this.default4.set(114,e),e=new ColorItem(0,255,123),this.default4.set(115,e),e=new ColorItem(0,255,118),this.default4.set(116,e),e=new ColorItem(0,255,113),this.default4.set(117,e),e=new ColorItem(0,255,109),this.default4.set(118,e),e=new ColorItem(0,255,104),this.default4.set(119,e),e=new ColorItem(0,255,99),this.default4.set(120,e),e=new ColorItem(0,255,95),this.default4.set(121,e),e=new ColorItem(0,255,90),this.default4.set(122,e),e=new ColorItem(0,255,85),this.default4.set(123,e),e=new ColorItem(0,255,80),this.default4.set(124,e),e=new ColorItem(0,255,76),this.default4.set(125,e),e=new ColorItem(0,255,71),this.default4.set(126,e),e=new ColorItem(0,255,66),this.default4.set(127,e),e=new ColorItem(0,255,62),this.default4.set(128,e),e=new ColorItem(0,255,57),this.default4.set(129,e),e=new ColorItem(0,255,52),this.default4.set(130,e),e=new ColorItem(0,255,47),this.default4.set(131,e),e=new ColorItem(0,255,43),this.default4.set(132,e),e=new ColorItem(0,255,38),this.default4.set(133,e),e=new ColorItem(0,255,33),this.default4.set(134,e),e=new ColorItem(0,255,29),this.default4.set(135,e),e=new ColorItem(0,255,24),this.default4.set(136,e),e=new ColorItem(0,255,19),this.default4.set(137,e),e=new ColorItem(0,255,14),this.default4.set(138,e),e=new ColorItem(0,255,10),this.default4.set(139,e),e=new ColorItem(0,255,5),this.default4.set(140,e),e=new ColorItem(0,255,0),this.default4.set(141,e),e=new ColorItem(0,255,0),this.default4.set(142,e),e=new ColorItem(3,255,0),this.default4.set(143,e),e=new ColorItem(7,255,0),this.default4.set(144,e),e=new ColorItem(12,255,0),this.default4.set(145,e),e=new ColorItem(16,255,0),this.default4.set(146,e),e=new ColorItem(21,255,0),this.default4.set(147,e),e=new ColorItem(25,255,0),this.default4.set(148,e),e=new ColorItem(30,255,0),this.default4.set(149,e),e=new ColorItem(34,255,0),this.default4.set(150,e),e=new ColorItem(39,255,0),this.default4.set(151,e),e=new ColorItem(43,255,0),this.default4.set(152,e),e=new ColorItem(48,255,0),this.default4.set(153,e),e=new ColorItem(52,255,0),this.default4.set(154,e),e=new ColorItem(57,255,0),this.default4.set(155,e),e=new ColorItem(61,255,0),this.default4.set(156,e),e=new ColorItem(66,255,0),this.default4.set(157,e),e=new ColorItem(70,255,0),this.default4.set(158,e),e=new ColorItem(75,255,0),this.default4.set(159,e),e=new ColorItem(79,255,0),this.default4.set(160,e),e=new ColorItem(84,255,0),this.default4.set(161,e),e=new ColorItem(88,255,0),this.default4.set(162,e),e=new ColorItem(93,255,0),this.default4.set(163,e),e=new ColorItem(97,255,0),this.default4.set(164,e),e=new ColorItem(102,255,0),this.default4.set(165,e),e=new ColorItem(106,255,0),this.default4.set(166,e),e=new ColorItem(111,255,0),this.default4.set(167,e),e=new ColorItem(115,255,0),this.default4.set(168,e),e=new ColorItem(120,255,0),this.default4.set(169,e),e=new ColorItem(124,255,0),this.default4.set(170,e),e=new ColorItem(129,255,0),this.default4.set(171,e),e=new ColorItem(133,255,0),this.default4.set(172,e),e=new ColorItem(137,255,0),this.default4.set(173,e),e=new ColorItem(142,255,0),this.default4.set(174,e),e=new ColorItem(146,255,0),this.default4.set(175,e),e=new ColorItem(151,255,0),this.default4.set(176,e),e=new ColorItem(155,255,0),this.default4.set(177,e),e=new ColorItem(160,255,0),this.default4.set(178,e),e=new ColorItem(164,255,0),this.default4.set(179,e),e=new ColorItem(169,255,0),this.default4.set(180,e),e=new ColorItem(173,255,0),this.default4.set(181,e),e=new ColorItem(178,255,0),this.default4.set(182,e),e=new ColorItem(182,255,0),this.default4.set(183,e),e=new ColorItem(187,255,0),this.default4.set(184,e),e=new ColorItem(191,255,0),this.default4.set(185,e),e=new ColorItem(196,255,0),this.default4.set(186,e),e=new ColorItem(200,255,0),this.default4.set(187,e),e=new ColorItem(205,255,0),this.default4.set(188,e),e=new ColorItem(209,255,0),this.default4.set(189,e),e=new ColorItem(214,255,0),this.default4.set(190,e),e=new ColorItem(218,255,0),this.default4.set(191,e),e=new ColorItem(223,255,0),this.default4.set(192,e),e=new ColorItem(227,255,0),this.default4.set(193,e),e=new ColorItem(232,255,0),this.default4.set(194,e),e=new ColorItem(236,255,0),this.default4.set(195,e),e=new ColorItem(241,255,0),this.default4.set(196,e),e=new ColorItem(245,255,0),this.default4.set(197,e),e=new ColorItem(250,255,0),this.default4.set(198,e),e=new ColorItem(254,255,0),this.default4.set(199,e),e=new ColorItem(255,252,0),this.default4.set(200,e),e=new ColorItem(255,247,0),this.default4.set(201,e),e=new ColorItem(255,243,0),this.default4.set(202,e),e=new ColorItem(255,238,0),this.default4.set(203,e),e=new ColorItem(255,234,0),this.default4.set(204,e),e=new ColorItem(255,229,0),this.default4.set(205,e),e=new ColorItem(255,225,0),this.default4.set(206,e),e=new ColorItem(255,220,0),this.default4.set(207,e),e=new ColorItem(255,216,0),this.default4.set(208,e),e=new ColorItem(255,211,0),this.default4.set(209,e),e=new ColorItem(255,206,0),this.default4.set(210,e),e=new ColorItem(255,202,0),this.default4.set(211,e),e=new ColorItem(255,197,0),this.default4.set(212,e),e=new ColorItem(255,193,0),this.default4.set(213,e),e=new ColorItem(255,188,0),this.default4.set(214,e),e=new ColorItem(255,184,0),this.default4.set(215,e),e=new ColorItem(255,179,0),this.default4.set(216,e),e=new ColorItem(255,175,0),this.default4.set(217,e),e=new ColorItem(255,170,0),this.default4.set(218,e),e=new ColorItem(255,165,0),this.default4.set(219,e),e=new ColorItem(255,161,0),this.default4.set(220,e),e=new ColorItem(255,156,0),this.default4.set(221,e),e=new ColorItem(255,152,0),this.default4.set(222,e),e=new ColorItem(255,147,0),this.default4.set(223,e),e=new ColorItem(255,143,0),this.default4.set(224,e),e=new ColorItem(255,138,0),this.default4.set(225,e),e=new ColorItem(255,134,0),this.default4.set(226,e),e=new ColorItem(255,129,0),this.default4.set(227,e),e=new ColorItem(255,124,0),this.default4.set(228,e),e=new ColorItem(255,120,0),this.default4.set(229,e),e=new ColorItem(255,115,0),this.default4.set(230,e),e=new ColorItem(255,111,0),this.default4.set(231,e),e=new ColorItem(255,106,0),this.default4.set(232,e),e=new ColorItem(255,102,0),this.default4.set(233,e),e=new ColorItem(255,97,0),this.default4.set(234,e),e=new ColorItem(255,93,0),this.default4.set(235,e),e=new ColorItem(255,88,0),this.default4.set(236,e),e=new ColorItem(255,83,0),this.default4.set(237,e),e=new ColorItem(255,79,0),this.default4.set(238,e),e=new ColorItem(255,74,0),this.default4.set(239,e),e=new ColorItem(255,70,0),this.default4.set(240,e),e=new ColorItem(255,65,0),this.default4.set(241,e),e=new ColorItem(255,61,0),this.default4.set(242,e),e=new ColorItem(255,56,0),this.default4.set(243,e),e=new ColorItem(255,52,0),this.default4.set(244,e),e=new ColorItem(255,47,0),this.default4.set(245,e),e=new ColorItem(255,42,0),this.default4.set(246,e),e=new ColorItem(255,38,0),this.default4.set(247,e),e=new ColorItem(255,33,0),this.default4.set(248,e),e=new ColorItem(255,29,0),this.default4.set(249,e),e=new ColorItem(255,24,0),this.default4.set(250,e),e=new ColorItem(255,20,0),this.default4.set(251,e),e=new ColorItem(255,15,0),this.default4.set(252,e),e=new ColorItem(255,11,0),this.default4.set(253,e),e=new ColorItem(255,6,0),this.default4.set(254,e),e=new ColorItem(255,255,255),this.default4.set(255,e)}}();!function(e){e[e.DISP_2D=0]="DISP_2D",e[e.DISP_MPR_T=1]="DISP_MPR_T",e[e.DISP_MPR_S=2]="DISP_MPR_S",e[e.DISP_MPR_C=3]="DISP_MPR_C",e[e.DISP_VR=4]="DISP_VR",e[e.DISP_MPR=5]="DISP_MPR",e[e.DISP_MPR_O=6]="DISP_MPR_O"}(DISPLAY_MODE||(DISPLAY_MODE={}));var TextOrientation,AnnoColor,CDicomProvider=function(){function e(e,t,i,n,a){void 0===n&&(n="2d"),this._connKey="2d",console.debug("CDicomProvider.constructor(wsHost:%s, userName:%s, token:%s, syncJS:%o)",e,t,i,a),this._connKey=n,this.uiBinder=new CUIBinder(this._connKey),CDicomDataManager.GetInstance(this._connKey).Connect(e,t,i)}return e.prototype.Release=function(){CLocalForageWrapperInstance.GetInstance().ClearDB()},e.prototype.getStudyInfoByCB=function(e,t){this.getStudyInfoAsync(e).then(function(e){t(e,0,"")},function(e){t(null,-1,e)})},e.prototype.getStudyThumbByCB=function(e,t){this.getStudyThumbAsync(e).then(function(e){t(e,0,"")},function(e){t(null,-1,e)})},e.prototype.getSeriesListByCB=function(e,t){this.getSeriesListAsync(e).then(function(e){t(e,0,"")},function(e){t(null,-1,e)})},e.prototype.getSerialThumbByCB=function(e,t,i){this.getSerialThumbAsync(e,t).then(function(e){i(e,0,"")},function(e){i(null,-1,e)})},e.prototype.getStudyInfoAsync=function(e){var t=this;return console.debug("CDicomProvider.getStudyInfoAsync(xeGuid:%s)",e),new Promise(function(i,n){CDicomDataManager.GetInstance(t._connKey).getStudyDataAsync(e).then(function(e){i(e)},function(t){console.warn("CDicomProvider.getStudyInfoAsync(xeGuid:%s) fail:%s",e,t),n(t)})})},e.prototype.getStudyThumbAsync=function(e){var t=this;return console.debug("CDicomProvider.getStudyThumbAsync(xeGuid:%s)",e),new Promise(function(i,n){CDicomDataManager.GetInstance(t._connKey).getStudyThumbAsync(e).then(function(e){i(e)},function(t){console.warn("CDicomProvider.getStudyThumbAsync(xeGuid:%s) fail:%s",e,t),n(t)})})},e.prototype.getSeriesListAsync=function(e){var t=this;return console.debug("CDicomProvider.getSeriesListAsync(xeGuid:%s)",e),new Promise(function(i,n){CDicomDataManager.GetInstance(t._connKey).getSeriesDataListAsync(e).then(function(e){i(e)},function(t){console.warn("CDicomProvider.getSeriesListAsync(xeGuid:%s) fail:%s",e,t),n(t)})})},e.prototype.getSerialThumbAsync=function(e,t){var i=this;return console.debug("CDicomProvider.getSerialThumbAsync(xeGuid:%s, serialIndex:%d)",e,t),new Promise(function(n,a){CDicomDataManager.GetInstance(i._connKey).getSerialThumbAsync(e,t).then(function(e){n(e)},function(i){console.warn("CDicomProvider.getSerialThumbAsync(xeGuid:%s, serialIndex:%d) fail:%s",e,t,i),a(i)})})},e.prototype.attachPane=function(e,t,i,n){void 0===n&&(n=DISPLAY_MODE.DISP_2D),console.debug("CDicomProvider.attachPane(xeGuid:%s, serialIndex:%d, paneID:%s)",e,t,i),this.uiBinder.attachPane(e,t,i,n)},e.prototype.attachCanvas=function(e,t,i){void 0===i&&(i=DISPLAY_MODE.DISP_2D),console.debug("CDicomProvider.attachCanvas(paneID:%s, canvasIDs:%o, displayMode:%d)",e,t,i);var n=this.uiBinder.getPane(e);null!=n?n.attach(t,i):console.warn("CDicomProvider.attachCanvas(paneID:%s, canvasIDs:%o, displayMode:%d) fail:pane is not existed",e,t,i)},e.prototype.setCanvasSliderBar=function(e,t,i,n){console.debug("CDicomProvider.setCanvasSliderBar(paneID:%s, canvasID:%s)",e,t);var a=this.uiBinder.getPane(e);null!=a?a.setCanvasSliderBar(t,i,n):console.warn("CDicomProvider.setCanvasSliderBar(paneID:%s, canvasID:%s) fail:paneID is not existed",e,t)},e.prototype.detachPane=function(e){console.debug("CDicomProvider.detachPane(paneID:%s)",e),this.uiBinder.detachPane(e)},e.prototype.detachCanvas=function(e,t){console.debug("CDicomProvider.detachCanvas(paneID:%s, canvasIDs:%o)",e,t);var i=this.uiBinder.getPane(e);null!=i?i.detach(t):console.warn("CDicomProvider.detachCanvas(paneID:%s, canvasIDs:%o) fail:pane is not existed",e,t)},e.prototype.setWWWLCB=function(e){console.debug("CDicomProvider.setWWWLCB()"),CImageDrawerManager.GetInstance().cb_WWWLChange=e},e.prototype.setCanvasDrawStateCB=function(e){console.debug("CDicomProvider.setCanvasDrawStateCB()"),CImageDrawerManager.GetInstance().cb_CanvasDrawState=e},e.prototype.setFocusPane=function(e,t){void 0===t&&(t=!1),console.debug("CDicomProvider.setFocusPane(paneID:%s, isAppend:%s)",e,t),this.uiBinder.setFocusPane(e,t)},e.prototype.drawImageAsync_Pane=function(e,t,i,n){var a=this;return void 0===i&&(i=!1),void 0===n&&(n=null),console.debug("CDicomProvider.drawImageAsync_Pane(paneID:%s, imageIndex:%d, forceJPG:%s, attachmentData:%o)",e,t,i,n),new Promise(function(s,r){var o=a.uiBinder.getPane(e);null!=o?o.drawAsync(t,i,n).then(function(){s()},function(a){console.warn("CDicomProvider.drawImageAsync_Pane(paneID:%s, imageIndex:%d, forceJPG:%s, attachmentData:%o) fail:%s",e,t,i,n,a),r(a)}):(console.warn("CDicomProvider.drawImageAsync_Pane(paneID:%s, imageIndex:%d, forceJPG:%s, attachmentData:%o) fail:pane is not existed",e,t,i,n),r("paneID is invalid or didn't atteched"))})},e.prototype.recover_PaneAsync=function(e){var t=this;return console.debug("CDicomProvider.recover_PaneAsync(paneID:%s)",e),new Promise(function(){var i=t.uiBinder.getPane(e);null!=i?i.recover():console.warn("CDicomProvider.recover_PaneAsync(paneID:%s) fail:pane is not existed",e)})},e.prototype.rotateR_PaneAsync=function(e){var t=this;return console.debug("CDicomProvider.rotateR_PaneAsync(paneID:%s)",e),new Promise(function(){var i=t.uiBinder.getPane(e);null!=i?i.rotate(90):console.warn("CDicomProvider.rotateR_PaneAsync(paneID:%s) fail:pane is not existed",e)})},e.prototype.rotateL_PaneAsync=function(e){var t=this;return console.debug("CDicomProvider.rotateL_PaneAsync(paneID:%s)",e),new Promise(function(){var i=t.uiBinder.getPane(e);null!=i?i.rotate(-90):console.warn("CDicomProvider.rotateL_PaneAsync(paneID:%s) fail:pane is not existed",e)})},e.prototype.mirrorH_PaneAsync=function(e){var t=this;return console.debug("CDicomProvider.mirrorH_PaneAsync(paneID:%s)",e),new Promise(function(){var i=t.uiBinder.getPane(e);null!=i?i.mirrorH():console.warn("CDicomProvider.mirrorH_PaneAsync(paneID:%s) fail:pane is not existed",e)})},e.prototype.mirrorV_PaneAsync=function(e){var t=this;return console.debug("CDicomProvider.mirrorV_PaneAsync(paneID:%s)",e),new Promise(function(){var i=t.uiBinder.getPane(e);null!=i?i.mirrorV():console.warn("CDicomProvider.mirrorV_PaneAsync(paneID:%s) fail:pane is not existed",e)})},e.prototype.setWWWL_PaneAsync=function(e,t,i){var n=this;return console.debug("CDicomProvider.setWWWL_PaneAsync(paneID:%s, ww:%d, wl:%d)",e,t,i),new Promise(function(){var a=n.uiBinder.getPane(e);null!=a?a.setWWWL(t,i):console.warn("CDicomProvider.setWWWL_PaneAsync(paneID:%s, ww:%d, wl:%d) fail:pane is not existed",e,t,i)})},e.prototype.getWWWL=function(e){console.debug("CDicomProvider.getWWWL(paneID:%s)",e);var t=this.uiBinder.getPane(e);return null!=t?t.getWWWL():(console.warn("CDicomProvider.getWWWL(paneID:%s) fail:pane is not existed",e),null)},e.prototype.getPaneDispState=function(e){console.debug("CDicomProvider.getPaneDispState(paneID:%s)",e);var t=this.uiBinder.getPane(e);return null!=t?t.getPaneDispState():(console.warn("CDicomProvider.getPaneDispState(paneID:%s) fail:pane is not existed",e),null)},e.prototype.setPanePseudocolor=function(e,t,i){console.debug("CDicomProvider.setPanePseudocolor(paneID:%s, colorItems:%o, enable:%s)",e,t,i);var n=this.uiBinder.getPane(e);n&&n.setPseudocolor(t,i)},e.prototype.setPaneSharpen=function(e,t){console.debug("CDicomProvider.setPaneSharpen(paneID:%s, enable:%s)",e,t);var i=this.uiBinder.getPane(e);i?i.setSharpen(t):console.warn("CDicomProvider.setPaneSharpen(paneID:%s, enable:%s) fail:pane is not existed",e,t)},e.prototype.setPaneInverse=function(e,t){console.debug("CDicomProvider.setPaneInverse(paneID:%s, enable:%s)",e,t);var i=this.uiBinder.getPane(e);i?i.setInverse(t):console.warn("CDicomProvider.setPaneInverse(paneID:%s, enable:%s) fail:pane is not existed",e,t)},e.prototype.setMPRParam=function(e,t,i){console.debug("CDicomProvider.setMPRParam(paneID:%s, canvasID:%s, param:%o)",e,t,i);var n=this.uiBinder.getPane(e);n?n.setMPRParam(t,i):console.warn("CDicomProvider.setMPRParam(paneID:%s, canvasID:%s, param:%o) fail:pane is not existed",e,t,i)},e.prototype.deleteSelectedAnno=function(){console.debug("CDicomProvider.deleteSelectedAnno()"),CImageDrawerManager.GetInstance().deleteSelected("all")},e.prototype.deleteCanvasSelectedAnno=function(e,t){console.debug("CDicomProvider.deleteCanvasSelectedAnno(paneID:%s, canvasID:%s)",e,t);var i=this.uiBinder.getPane(e);null!=i?i.deleteCanvasSelectedAnno(t,"all"):console.warn("CDicomProvider.deleteCanvasSelectedAnno(paneID:%s, canvasID:%s) fail:pane is not existed",e,t)},e.prototype.deletePaneAnno=function(e){console.debug("CDicomProvider.deletePaneAnno(paneID:%s), paneID");var t=this.uiBinder.getPane(e);null!=t?t.deleteAllAnno("all"):console.warn("CDicomProvider.deletePaneAnno(paneID:%s) fail:pane is not existed",e)},e.prototype.setShowAnno=function(e,t){console.debug("CDicomProvider.setShowAnno(bShow:%s, paneID:%s)",e,t);var i=this.uiBinder.getPane(t);null!=i?i.setShowAnno(e):console.warn("CDicomProvider.setShowAnno(bShow:%s, paneID:%s) fail:pane is not existed",e,t)},e.prototype.setOperateMode=function(e){console.debug("CDicomProvider.setOperateMode(mode:%s)",e),CImageDrawerManager.GetInstance().setCurrentToolName(e)},e.prototype.setOperateMode_LeftWithCtrl=function(e){console.debug("CDicomProvider.setOperateMode_LeftWithCtrl(mode:%s)",e),CImageDrawerManager.GetInstance().leftCtrlAnnoName=e},e.prototype.setOperateMode_Wheel=function(e){console.debug("CDicomProvider.setOperateMode_Wheel(mode:%s)",e),CImageDrawerManager.GetInstance().WheelAnnoName=e},e.prototype.setOperateMode_WheelWithCtrl=function(e){console.debug("CDicomProvider.setOperateMode_WheelWithCtrl(mode:%s)",e),CImageDrawerManager.GetInstance().WheelCtrlAnnoName=e},e.prototype.setZoomInCallback=function(e,t){console.debug("CDicomProvider.setZoomInCallback()"),CImageDrawerManager.GetInstance().setZoomInCallback(e,t)},e.prototype.setShowOverlay=function(e,t){console.debug("CDicomProvider.setShowOverlay(bShow:%s, paneID:%s)",e,t);var i=this.uiBinder.getPane(t);null!=i?i.setShowOverlay(e):console.warn("CDicomProvider.setShowOverlay(bShow:%s, paneID:%s) fail:pane is not existed",e,t)},e.prototype.setShowPositionLine=function(e,t){console.debug("CDicomProvider.setShowOverlay(bShow:%s, xeguid:%s)",e,t),CImageDrawerManager.GetInstance().showPositionLine=e},e.prototype.setPageLinkage=function(e){console.debug("CDicomProvider.setPageLinkage(bLink:%s)",e),CImageDrawerManager.GetInstance().isSeriesLinkageSameStudy=e},e.prototype.setPageLinkageDiffStudy=function(e,t){void 0===t&&(t=0),console.debug("CDicomProvider.setPageLinkageDiffStudy(bLink:%s)",e),CImageDrawerManager.GetInstance().isSeriesLinkageDiffStudy=e,CImageDrawerManager.GetInstance().seriesLinkageModeDiffStudy=t},e.prototype.resetDisplayState=function(e){console.debug("CDicomProvider.resetDisplayState(paneID:%s)",e);var t=this.uiBinder.getPane(e);null!=t?t.resetDisplayState():console.warn("CDicomProvider.resetDisplayState(paneID:%s) fail:pane is not existed",e)},e.prototype.getShowOverlay=function(e){var t=this.uiBinder.getPane(e);return null!=t&&t.getShowOverlay()},e.prototype.setFullCacheMode=function(e){CDicomDataManager.GetInstance(this._connKey).isFullMode=e},e.prototype.getFullCacheMode=function(){return CDicomDataManager.GetInstance(this._connKey).isFullMode},e.prototype.setJPGMode=function(e){CDicomDataManager.GetInstance(this._connKey).isJPGMode=e},e.prototype.getJPGMode=function(){return CDicomDataManager.GetInstance(this._connKey).isJPGMode},e.prototype.getSerialCacheFinished=function(e,t){return CDicomDataManager.GetInstance(this._connKey).getSerialCacheFinished(e,t)},e.prototype.setDownloadProgressCallback=function(e){CDicomDataManager.GetInstance(this._connKey).setDownloadProgressCallback(e)},e.prototype.changeImageZoom=function(e,t){console.debug("CDicomProvider.changeImageZoom(paneID:%s, increase:%f)",e,t);var i=this.uiBinder.getPane(e);i?i.changeImageZoom(t):console.warn("CDicomProvider.changeImageZoom(paneID:%s, increase:%f) fail:pane is not existed",e,t)},e.prototype.panePlayStart=function(){},e.prototype.panePlayStop=function(){},e.prototype.setThinSeriesMode=function(e,t){void 0===t&&(t=""),CDicomDataManager.GetInstance(this._connKey).setThinSeriesMode(e,t)},e.prototype.updateDicomStateBySync=function(e,t){var i=CircularJSON.parse(t);i.viewName==this._connKey&&this.uiBinder&&this.uiBinder.setBinderSate(i)},e.prototype.getFullDicomStateForSync=function(){return CircularJSON.stringify(this.uiBinder.getBinderState())},e.prototype.getImageFileAsync=function(e,t,i){var n=this;return console.debug("CDicomProvider.getImageFileAsync(xeGuid:%s, serialIndex:%d, imageIndex:%d)",e,t,i),new Promise(function(a,s){var r,o=CDicomDataManager.GetInstance(n._connKey).getSeriesData(e,t);null!=o?r=o.getImageIndexByPos(i):s("序列不存在"),CDicomDataManager.GetInstance(n._connKey).getImageFileAsync(e,t,r,!0).then(function(e){e.imageIndex=i,a(e)},function(i){console.error("CDicomProvider.getImageFileAsync(xeGuid:%s, serialIndex:%d, imageIndex:%d) fail:%s",e,t,r,i),s(i)})})},e}(),Point2d=function(){return function(e,t){this.x=e,this.y=t}}(),Point3d=function(){function e(e,t,i){this.isHide=!1,this.x=e,this.y=t,this.z=i}return e.prototype.clone=function(){return new e(this.x,this.y,this.z)},e}(),Size=function(){return function(e,t){this.width=e,this.height=t}}(),Rect=function(){function e(e,t,i,n,a){void 0===a&&(a=null),this.tips=null,e<i?(this.left=e,this.right=i):(this.left=i,this.right=e),t<n?(this.top=t,this.bottom=n):(this.top=n,this.bottom=t),this.tips=a}return Object.defineProperty(e.prototype,"Width",{get:function(){return Math.abs(this.right-this.left)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Height",{get:function(){return Math.abs(this.bottom-this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"Perimeter",{get:function(){return 2*(this.Width+this.Height)},enumerable:!0,configurable:!0}),e.prototype.ptInRect=function(e){return e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom},Object.defineProperty(e.prototype,"leftTop",{get:function(){return new Point2d(this.left,this.top)},set:function(e){this.left=e.x,this.top=e.y},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightBottom",{get:function(){return new Point2d(this.right,this.bottom)},set:function(e){this.right=e.x,this.bottom=e.y},enumerable:!0,configurable:!0}),e.prototype.contains=function(e){return e.x>this.left&&e.x<this.right&&e.y>this.top&&e.y<this.bottom},e.prototype.clone=function(){return new e(this.left,this.top,this.right,this.bottom,null==this.tips?null:this.tips.clone())},e.prototype.copy=function(e){this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom,this.tips=null==e.tips?null:e.tips.clone()},e.prototype.normalizeRect=function(){var e;this.left>this.right&&(e=this.left,this.left=this.right,this.right=e),this.top>this.bottom&&(e=this.top,this.top=this.bottom,this.bottom=e)},e.prototype.offsetRect=function(e,t){this.left+=e,this.right+=e,this.top+=t,this.bottom+=t},e.prototype.inflatRect=function(e,t){this.left-=e,this.right+=e,this.top-=t,this.bottom+=t,this.left>this.right&&(this.left=Math.round((this.left-this.right)/2),this.right=this.left),this.top>this.bottom&&(this.top=Math.round((this.top-this.bottom)/2),this.bottom=this.top)},e.prototype.calcNearestPoint=function(e){var t=new Point2d(0,0),i=16e6,n=(this.left-e.x)*(this.left-e.x)+(this.top-e.y)*(this.top-e.y);return n<i&&(i=n,t.x=this.left,t.y=this.top),(n=(this.right-e.x)*(this.right-e.x)+(this.top-e.y)*(this.top-e.y))<i&&(i=n,t.x=this.right,t.y=this.top),(n=(this.left-e.x)*(this.left-e.x)+(this.bottom-e.y)*(this.bottom-e.y))<i&&(i=n,t.x=this.left,t.y=this.bottom),(n=(this.right-e.x)*(this.right-e.x)+(this.bottom-e.y)*(this.bottom-e.y))<i&&(i=n,t.x=this.right,t.y=this.bottom),t},e.prototype.calcTipValue=function(e){var t=e.getData(),i="",n=-32768,a=32767,s=0,r=0,o=this.top,l=this.bottom,h=this.left,u=this.right;o=Utility.BOUND_VALUE(o,0,e.heightFull),l=Utility.BOUND_VALUE(l,0,e.heightFull),h=Utility.BOUND_VALUE(h,0,e.widthFull),u=Utility.BOUND_VALUE(u,0,e.widthFull);for(var d=o;d<l;d++)for(var c=h;c<u;c++){var p=e.widthFull*d+c;if(null!=t){var g=t[p];n<g&&(n=g),a>g&&(a=g),r+=g}s++}if(null!=t){var _=void 0;0!=s?(_=r/s,i+="最大值："+n.toString()+"\r\n",i+="最小值："+a.toString()+"\r\n",i+="平均值："+_.toFixed(3)+"\r\n"):(_=0,n=0,a=0,i+="最大值：-\r\n",i+="最小值：-\r\n",i+="平均值：-\r\n")}else i+="最大值：加载中，请稍后\r\n",i+="最小值：加载中，请稍后\r\n",i+="平均值：加载中，请稍后\r\n";return i+="周长："+(2*(e.pixelSpacingX*this.Width+e.pixelSpacingY*this.Height)).toFixed(3)+"\r\n",i+="面积："+(e.pixelSpacingX*e.pixelSpacingY*s).toFixed(3)+"mm*mm\r\n"},e.prototype.equal=function(e){return this.left==e.left&&(this.right==e.right&&(this.top==e.top&&this.bottom==e.bottom))},e}(),Utility=function(){function e(){}return e.queryString=function(e){var t=location.search.match(new RegExp("[?&]"+e+"=([^&]*)(&?)","i"));return t?t[1]:""},e.BOUND_VALUE=function(e,t,i){return e<t?t:e>i?i:e},e.convertToInt=function(e){return e.length<4?null:(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0]},e.decodeZipAsText=function(e){return new JSZip(e).file("1").asText()},e.decodeZipAsUint8Array=function(e){return new JSZip(e).file("1").asText()},e.Utf8ToUnicode=function(e){for(var t,i,n,a="",s=e.length,r=0,o=s;r<s;)if(0==(128&(t=e.charCodeAt(r)))){if(o<1)break;a+=String.fromCharCode(127&t),r++,o-=1}else if(192==(224&t)){if(i=e.charCodeAt(r+1),o<2||128!=(192&i))break;a+=String.fromCharCode((63&t)<<6|63&i),r+=2,o-=2}else{if(224!=(240&t))break;if(i=e.charCodeAt(r+1),n=e.charCodeAt(r+2),o<3||128!=(192&i)||128!=(192&n))break;a+=String.fromCharCode((15&t)<<12|(63&i)<<6|63&n),r+=3,o-=3}return 0!=o?"":a},e.calcFitWindow=function(e,t,i){if(t.Height*e.Width/(t.Width*e.Height)<1){i.top=t.top,i.bottom=t.bottom;var n=Math.floor(t.Height*e.Width/e.Height);i.left=Math.floor(t.left+(t.Width-n)/2),i.right=i.left+n}else{i.left=t.left,i.right=t.right;var a=Math.floor(t.Width*e.Height/e.Width);i.top=Math.floor(t.top+(t.Height-a)/2),i.bottom=i.top+a}},e.CalcSliceDistance=function(t,i,n){var a=new Point3d(0,0,0),s=new Point3d(0,0,0);a.x=t[0],a.y=t[1],a.z=t[2],s.x=i[0],s.y=i[1],s.z=i[2];var r=new Point3d(0,0,0),o=new Point3d(0,0,0);r.x=n[0],r.y=n[1],r.z=n[2],o.x=n[3],o.y=n[4],o.z=n[5];var l=new Point3d(0,0,0);e.ComputeVerticalVecter(r,o,l);var h=new Array,u=new Array;h[0]=r.x,h[1]=r.y,h[2]=r.z,h[3]=o.x,h[4]=o.y,h[5]=o.z,h[6]=l.x,h[7]=l.y,h[8]=l.z,u[0]=s.x-a.x,u[1]=s.y-a.y,u[2]=s.z-a.z;var d=new Array,c=new Array;return e.MyMatrix3x3Invert(h,d),e.MyMatrixMul(u,3,1,d,3,3,c),c[2]},e.MyMatrix3x3Invert=function(e,t){if(null==e||null==t)return!1;var i=e[0]*e[4]*e[8]+e[1]*e[5]*e[6]+e[2]*e[3]*e[7]-e[2]*e[4]*e[6]-e[0]*e[5]*e[7]-e[1]*e[3]*e[8];return!(Math.abs(i)<1e-6)&&(t[0]=(e[4]*e[8]-e[5]*e[7])/i,t[1]=(e[2]*e[7]-e[1]*e[8])/i,t[2]=(e[1]*e[5]-e[2]*e[4])/i,t[3]=(e[5]*e[6]-e[3]*e[8])/i,t[4]=(e[0]*e[8]-e[2]*e[6])/i,t[5]=(e[2]*e[3]-e[0]*e[5])/i,t[6]=(e[3]*e[7]-e[4]*e[6])/i,t[7]=(e[1]*e[6]-e[0]*e[7])/i,t[8]=(e[0]*e[4]-e[1]*e[3])/i,!0)},e.MyMatrixMul=function(e,t,i,n,a,s,r){if(null==e||null==n||null==r||s!=t)return!1;for(var o=0,l=0;l<i;l++)for(var h=0;h<a;h++){o=0;for(var u=0;u<t;u++)o+=e[l*t+u]*n[u*a+h];r[l*a+h]=o}return!0},e.calcImageDistanceToZero=function(e,t,i){if(null!=e&&null!=t){var n=e.imagePosition.split("\\"),a=[parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2])];e.imageDistanceToZero=Math.sqrt((a[0]-t[0])*(a[0]-t[0])+(a[1]-t[1])*(a[1]-t[1])+(a[2]-t[2])*(a[2]-t[2])),null!=i&&(e.imageDistanceToZero=e.imageDistanceToZero*i),e.zeroImagePosition=t}},e.ComputeVerticalVecter=function(t,i,n){return n.x=i.y*t.z-i.z*t.y,n.y=i.z*t.x-i.x*t.z,n.z=i.x*t.y-i.y*t.x,e.NormalizVecter(n)},e.VecterVertical=function(e,t){var i=e.x*t.x+e.y*t.y+e.z*t.z;return Math.abs(i)<.01},e.Matrix33MultiVector3_32f=function(e,t,i){i.x=t.x*e[0]+t.y*e[1]+t.z*e[2],i.y=t.x*e[3]+t.y*e[4]+t.z*e[5],i.z=t.x*e[6]+t.y*e[7]+t.z*e[8]},e.TBRotate=function(t,i,n,a,s,r,o){var l=new Array(2);l[0]=new Array(2),l[1]=new Array(2),l[0][0]=t,l[0][1]=i,l[1][0]=n,l[1][1]=a;var h=new Array(2);h[0]=Math.sqrt(l[0][0]*l[0][0]+l[0][1]*l[0][1]),h[1]=Math.sqrt(l[1][0]*l[1][0]+l[1][1]*l[1][1]);var u=new Array(2);u[0]=new Point3d(0,0,0),u[1]=new Point3d(0,0,0);for(var d=0;d<2;d++)h[d]<.866?(u[d].x=l[d][0],u[d].y=l[d][1],u[d].z=Math.sqrt(.749956-h[d]*h[d])):(u[d].x=l[d][0]/h[d]*.866,u[d].y=l[d][1]/h[d]*.866,u[d].z=0);var c=new Point3d(0,0,0);if(!e.ComputeVerticalVecter(u[0],u[1],c))return!1;var p=new Point3d(0,0,0);if(!e.ComputeVerticalVecter(s,r,p))return!1;var g=new Point3d(0,0,0);if(g.x=c.x*p.x+c.y*r.x-c.z*s.x,g.y=c.x*p.y+c.y*r.y-c.z*s.y,g.z=c.x*p.z+c.y*r.z-c.z*s.z,!e.NormalizVecter(g))return!1;var _=new Array(2);_[0]=Math.sqrt(u[0].x*u[0].x+u[0].y*u[0].y+u[0].z*u[0].z),_[1]=Math.sqrt(u[1].x*u[1].x+u[1].y*u[1].y+u[1].z*u[1].z);var m=Math.acos((u[0].x*u[1].x+u[0].y*u[1].y+u[0].z*u[1].z)/_[0]/_[1]);return!(Math.abs(m)<1e-4)&&(e.Rotate(m,g,o),!0)},e.Rotate=function(e,t,i){var n=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2)),a=new Array(3);a[0]=t.x/n,a[1]=t.y/n,a[2]=t.z/n,Math.abs(Math.abs(a[0])-1)<1e-6&&(a[1]+=1e-5);var s=Math.sqrt(a[1]*a[1]+a[2]*a[2]),r=new Array(3);r[0]=new Array(3),r[1]=new Array(3),r[2]=new Array(3),r[0][0]=(a[1]*a[1]+a[2]*a[2])/s,r[0][1]=-a[0]*a[1]/s,r[0][2]=-a[0]*a[2]/s,r[1][0]=0,r[1][1]=a[2]/s,r[1][2]=-a[1]/s,r[2][0]=a[0],r[2][1]=a[1],r[2][2]=a[2];var o=new Array(3);o[0]=new Array(3),o[1]=new Array(3),o[2]=new Array(3);var l=new Array(3);l[0]=new Array(3),l[1]=new Array(3),l[2]=new Array(3);var h=Math.cos(e),u=Math.sin(e);l[0][0]=r[0][0]*h-r[1][0]*u,l[0][1]=r[0][0]*u+r[1][0]*h,l[0][2]=r[2][0],l[1][0]=r[0][1]*h-r[1][1]*u,l[1][1]=r[0][1]*u+r[1][1]*h,l[1][2]=r[2][1],l[2][0]=r[0][2]*h-r[1][2]*u,l[2][1]=r[0][2]*u+r[1][2]*h,l[2][2]=r[2][2],o[0][0]=l[0][0]*r[0][0]+l[0][1]*r[1][0]+l[0][2]*r[2][0],o[0][1]=l[0][0]*r[0][1]+l[0][1]*r[1][1]+l[0][2]*r[2][1],o[0][2]=l[0][0]*r[0][2]+l[0][1]*r[1][2]+l[0][2]*r[2][2],o[1][0]=l[1][0]*r[0][0]+l[1][1]*r[1][0]+l[1][2]*r[2][0],o[1][1]=l[1][0]*r[0][1]+l[1][1]*r[1][1]+l[1][2]*r[2][1],o[1][2]=l[1][0]*r[0][2]+l[1][1]*r[1][2]+l[1][2]*r[2][2],o[2][0]=l[2][0]*r[0][0]+l[2][1]*r[1][0]+l[2][2]*r[2][0],o[2][1]=l[2][0]*r[0][1]+l[2][1]*r[1][1]+l[2][2]*r[2][1],o[2][2]=l[2][0]*r[0][2]+l[2][1]*r[1][2]+l[2][2]*r[2][2],i[0]=o[0][0],i[1]=o[0][1],i[2]=o[0][2],i[3]=o[1][0],i[4]=o[1][1],i[5]=o[1][2],i[6]=o[2][0],i[7]=o[2][1],i[8]=o[2][2]},e.NormalizVecter=function(e){var t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2)+Math.pow(e.z,2));return!(Math.abs(t)<.001)&&(e.x/=t,e.y/=t,e.z/=t,!0)},e.point_Line_Distance=function(e,t,i,n,a){if(t==n&&i==a)return Math.sqrt((e.x-t)*(e.x-t)+(e.y-i)*(e.y-i));var s=a-i,r=t-n,o=n*i-t*a;return(s*e.x+r*e.y+o)/Math.sqrt(s*s+r*r)},e.testHitOnLineSegment=function(t,i,n,a){if(i==n)return Math.abs(t.x-i.x)<a&&Math.abs(t.y-i.y)<a;if(i.x==n.x)return Math.abs(t.x-i.x)<a&&(t.y-i.y)*(t.y-n.y)<0;var s=Math.sqrt((n.x-i.x)*(n.x-i.x)+(n.y-i.y)*(n.y-i.y)),r=(n.y-i.y)/s*a,o=(n.x-i.x)/s*a,l=[new Point2d(i.x-r,i.y+o),new Point2d(i.x+r,i.y-o),new Point2d(n.x+r,n.y-o),new Point2d(n.x-r,n.y+o)],h=e.point_Line_Distance(t,l[0].x,l[0].y,l[1].x,l[1].y),u=e.point_Line_Distance(t,l[3].x,l[3].y,l[2].x,l[2].y),d=e.point_Line_Distance(t,l[1].x,l[1].y,l[2].x,l[2].y),c=e.point_Line_Distance(t,l[0].x,l[0].y,l[3].x,l[3].y);return!(h*u>0||d*c>0)},e.getAngleToXAxis=function(e,t){var i=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y));if(i<1e-7)return 0;var n=(t.x-e.x)/i,a=(t.y-e.y)/i;return a>=0?Math.acos(n):a<0?2*Math.PI-Math.acos(n):0},e.generateID=function(){return this._id++},e.showDebugInfo=function(e,t,i,n,a){},e.calDispMatrix=function(e,t,i,n,a){var s=[1,0,0,1,0,0],r=a.rotateAngle;if(0!=e){var o,l,h=a.offRateX,u=a.offRateY,d=.5*i,c=.5*n,p=a.zoom;return 90==r||270==r?(o=i/t,l=n/e):(o=i/e,l=n/t),p*=o>l?l:o,s[4]=d+h*i,s[5]=c+u*n,0==r?(s[4]-=.5*e*p,s[5]-=.5*t*p):90==r?(s[0]=0,s[1]=1,s[2]=-1,s[3]=0,s[4]+=.5*t*p,s[5]-=.5*e*p):180==r?(s[0]=-1,s[1]=0,s[2]=0,s[3]=-1,s[4]+=.5*e*p,s[5]+=.5*t*p):270==r&&(s[0]=0,s[1]=-1,s[2]=1,s[3]=0,s[4]-=.5*t*p,s[5]+=.5*e*p),a.isHorzMirror&&(s[0]=-s[0],s[2]=-s[2],90==r?s[4]-=p*t:0==r?s[4]+=p*e:180==r?s[4]-=p*e:270==r&&(s[4]+=p*t)),a.isVertMirror&&(s[1]=-s[1],s[3]=-s[3],90==r?s[5]+=p*e:270==r?s[5]-=p*e:0==r?s[5]+=p*t:180==r&&(s[5]-=p*t)),s[0]*=p,s[1]*=p,s[2]*=p,s[3]*=p,s}},e.updateProp=function(e,t,i){e&&(i?i.call(t,e):t=e)},e._id=0,e}();!function(e){e[e.TYPE_TOPLEFT=0]="TYPE_TOPLEFT",e[e.TYPE_BOTTOMRIGHT=1]="TYPE_BOTTOMRIGHT",e[e.TYPE_BOTTOMLEFT=2]="TYPE_BOTTOMLEFT",e[e.TYPE_TOPRIGHT=3]="TYPE_TOPRIGHT"}(TextOrientation||(TextOrientation={})),function(e){e[e.COLOR_TIPTEXT=0]="COLOR_TIPTEXT",e[e.COLOR_TIPBACKGROUND=1]="COLOR_TIPBACKGROUND",e[e.COLOR_ANNO=2]="COLOR_ANNO",e[e.COLOR_TIPLINE=3]="COLOR_TIPLINE",e[e.COLOR_TIPBORDER=4]="COLOR_TIPBORDER",e[e.COLOR_HANDLER=5]="COLOR_HANDLER",e[e.COLOR_ANNOFUCUSED=6]="COLOR_ANNOFUCUSED"}(AnnoColor||(AnnoColor={}));var CORNER_TYPE,UIUtilities=function(){function e(){}return e.drawMultiLineText=function(e,t,i,n,a,s){for(var r=n.split("\r\n"),o=t.top+a,l=0;l<r.length;l++)e.fillText(r[l],t.left,o),o+=a,o+=s},e.getAnnoColor=function(e){switch(e){case AnnoColor.COLOR_TIPBACKGROUND:return"black";case AnnoColor.COLOR_TIPTEXT:case AnnoColor.COLOR_TIPBORDER:return"#57f900";case AnnoColor.COLOR_TIPLINE:return"yellow";case AnnoColor.COLOR_HANDLER:return"red";case AnnoColor.COLOR_ANNOFUCUSED:case AnnoColor.COLOR_ANNO:return"#57f900"}},e.calcTextRectSize=function(e,t,i,n){for(var a=new Size(0,0),s=t.split("\r\n"),r=0;r<s.length;r++){var o=e.measureText(s[r]);a.width<o.width&&(a.width=Math.ceil(o.width)),a.height+=i,a.height+=n}return a.height>0&&(a.height-=n),a},e}(),myTrace=function(){function e(){this._wsTrace=null,this._logs=new Array,this._wsUrl="ws://192.168.1.182:3000",this._wsIsConnect=!1}return e.prototype.myTrace=function(e,t){if(this._wsIsConnect)this._wsTrace.send(JSON.stringify({moduleName:e,logContent:t}));else{this._logs.push({moduleName:e,logContent:t}),this.createWsConnect()}},e.prototype.createWsConnect=function(){var e=this;if(null==this._wsTrace){console.debug("createWsConnect=====>创建连接:"+this._wsUrl);try{this._wsTrace=new WebSocket(this._wsUrl),this._wsTrace.onclose=function(){e._wsIsConnect=!1,e._wsTrace=null},this._wsTrace.onerror=function(){e._wsIsConnect=!1,e._wsTrace=null},this._wsTrace.onopen=function(){for(e._wsIsConnect=!0;e._logs.length>0;)e._wsTrace.send(JSON.stringify(e._logs.shift()))},this._wsTrace.onmessage=function(e){}}catch(e){}window.onerror=function(t,i,n){var a=i+": "+n+"\t"+t;return console.error(a),e.myTrace("server",a),!0}}},e}(),OffCanvas=function(){function e(e,t){this.offcanvas=document.createElement("canvas"),this.context=null,this.width=0,this.height=0,this.offcanvas.width=this.width=e,this.offcanvas.height=this.height=t,this.context=this.offcanvas.getContext("2d",{alpha:!1}),this.context.clearRect(0,0,e,t)}return e.prototype.createImageData=function(e,t){return this.context.createImageData(e,t)},e.prototype.getImageData=function(e,t,i,n){return this.context.getImageData(e,t,i,n)},e.prototype.putImageData=function(e,t,i){this.context.putImageData(e,t,i)},e}(),MyOffCanvasUtil=function(){function e(){this.offCanvasArray=new Array,this.width=0,this.height=0,this.isInit=!1}return e.prototype.Init=function(e,t,i){this.offCanvasArray.length>0&&this.offCanvasArray.splice(0);var n=i/512,a=Math.floor(i/512);n>a&&++a;for(var s=i,r=0;r<a;r++){var o=void 0,l=void 0,h=void 0,u=void 0;r==a-1?(o=0,l=512*r,h=t-1,u=i-1):(o=0,l=512*r,h=s-1,u=512*(r+1)-1);var d=new OffCanvas(h-o+1,u-l+1),c=new ImageData(h-o+1,u-l+1),p=4*(o+l*s),g=4*(h+u*s),_=e.subarray(p,g);c.data.set(_),d.putImageData(c,o,l),this.offCanvasArray.push(d)}this.width=t,this.height=i,this.isInit=!0},e.prototype.getAllBuffer=function(){for(var e=new Uint8ClampedArray(this.width*this.height*4),t=0;t<this.offCanvasArray.length;t++){var i=this.offCanvasArray[t],n=i.getImageData(0,0,i.width,i.height);e.set(n.data,t*i.width*i.height*4)}return e},e.prototype.getCavansByWH=function(e,t){},e.prototype.drawImageToCanvasContext=function(e,t,i,n,a,s,r,o,l){new ImageData(n,a)},e}(),TipLocation=function(){function e(){this.orientationType=TextOrientation.TYPE_BOTTOMRIGHT,this._startPoint=new Point2d(0,0),this._fontHeight=12,this._lineSpacing=1,this._strTips="",this._szTips=new Size(0,0)}return e.prototype.getClientRect=function(e){var t=new Rect(0,0,0,0),i=e.imageToClient_point(this._startPoint);if(t.leftTop=i,t.rightBottom=new Point2d(i.x+this._szTips.width,i.y+this._szTips.height),t.right>e.canvas.width){var n=t.right-e.canvas.width;t.left-=n,t.right-=n}if(t.left<0){n=t.left-0;t.left-=n,t.right-=n}if(t.bottom>e.canvas.height){n=t.bottom-e.canvas.height;t.top-=n,t.bottom-=n}if(t.top<0){n=t.top-0;t.top-=n,t.bottom-=n}return t},e.prototype.update=function(e){this.orientationType=e.orientationType,this._startPoint=new Point2d(e._startPoint.x,e._startPoint.y),this._fontHeight=e._fontHeight,this._lineSpacing=e._lineSpacing,this._strTips=e._strTips,this._szTips=new Size(e._szTips.width,e._szTips.height)},e.prototype.clone=function(){var t=new e;return t.orientationType=this.orientationType,t._startPoint=new Point2d(this._startPoint.x,this._startPoint.y),t._fontHeight=this._fontHeight,t._lineSpacing=this._lineSpacing,t._strTips=this._strTips,t._szTips=new Size(this._szTips.width,this._szTips.height),t},e.calcTipLoc=function(t,i,n,a,s,r,o){void 0===o&&(o=0);var l=new e;return l._szTips=UIUtilities.calcTextRectSize(t,n,s,r),l._fontHeight=s,l._lineSpacing=r,l._strTips=n,l._startPoint.x=(a.left+a.right)/2+o,l._startPoint.y=(a.top+a.bottom)/2-o,l},e.prototype.updateTip=function(e,t,i,n,a){this._fontHeight=n,this._lineSpacing=a,this._strTips=i,this._szTips=UIUtilities.calcTextRectSize(e,i,n,a)},e.prototype.moveTips=function(e,t,i){var n=e.imageToClient_point(this._startPoint);n.x+=t,n.y+=i,n.x=n.x>e.canvas.width?e.canvas.width:n.x,n.x=n.x<0?0:n.x,n.y=n.y>e.canvas.height?e.canvas.height:n.y,n.y=n.y<0?0:n.y,this._startPoint=e.clientToImage_point(n)},e.drawTip=function(e,t,i){if(i._strTips.length>0){var n=i.getClientRect(t);e.save(),e.globalAlpha=.5,e.fillStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPBACKGROUND),e.fillRect(n.left,n.top,n.Width,n.Height),e.strokeStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPBORDER),e.strokeRect(n.left,n.top,n.Width,n.Height),e.fillStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPTEXT),e.globalAlpha=1,UIUtilities.drawMultiLineText(e,n,i.orientationType,i._strTips,i._fontHeight,i._lineSpacing),e.restore()}},e.drawConnectLine=function(e,t,i,n){if(i._strTips.length>0){var a=i.getClientRect(t);e.save(),e.setLineDash([3,3]),e.strokeStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPLINE),e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(a.left,a.top),e.stroke(),e.restore()}},e}(),UIMsg=function(){function e(){}return Object.defineProperty(e,"mouseClick",{get:function(){return"MouseClick"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseDoubleClick",{get:function(){return"MouseDoubleClick"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseLBDown",{get:function(){return"MouseLBDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseLBUp",{get:function(){return"MouseLBUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseRBDown",{get:function(){return"MouseRBDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseRBUp",{get:function(){return"MouseRBUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseMove",{get:function(){return"MouseMove"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"mouseWheel",{get:function(){return"MouseWheel"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchDown",{get:function(){return"TouchDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchUp",{get:function(){return"TouchUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchDoubleTap",{get:function(){return"TouchDoubleTap"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchLongPress",{get:function(){return"TouchLongPress"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchFlingUp",{get:function(){return"TouchFlingUp"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchFlingDown",{get:function(){return"TouchFlingDown"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchMove",{get:function(){return"TouchMove"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoom",{get:function(){return"TouchZoom"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoomStart",{get:function(){return"TouchZoomStart"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"touchZoomEnd",{get:function(){return"TouchZoomEnd"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"keyPress",{get:function(){return"KeyPress"},enumerable:!0,configurable:!0}),e}(),CXeEventHandler=function(){function e(){this._msgHandlers={}}return e.prototype.addHandler=function(e,t,i,n){var a={};if(a.obj=t,a.id=i,a.handler=n,null==this._msgHandlers[e]){var s=new Array;s.push(a),this._msgHandlers[e]=s}else this._msgHandlers[e].push(a)},e.prototype.removeHandler=function(e,t){var i=this._msgHandlers[e];if(null!=i)for(var n=0;n<i.length;){i[n].obj==t?i.splice(n,1):n++}},e.prototype.doHandler=function(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];var a=this._msgHandlers[e];if(null!=a)for(var s=0;s<a.length;s++){var r=a[s];r.id!=t&&"all"!=t||r.handler.apply(r.obj,i.slice())}},e}();!function(e){e[e.CORNER_TYPE_TOPLEFT=0]="CORNER_TYPE_TOPLEFT",e[e.CORNER_TYPE_TOPRIGHT=1]="CORNER_TYPE_TOPRIGHT",e[e.CORNER_TYPE_BOTTOMLEFT=2]="CORNER_TYPE_BOTTOMLEFT",e[e.CORNER_TYPE_BOTTOMRIGHT=3]="CORNER_TYPE_BOTTOMRIGHT"}(CORNER_TYPE||(CORNER_TYPE={}));var HANDLEINDEX,FilterBase=function(){function e(e,t,i,n){this._name="",this._eventHandler=null,this._parentID="",this._imageHelper=null,this.c_fontHeight=12,this.c_lineSpacing=1,this._name=e,this._imageHelper=t,this._eventHandler=i,this._parentID=n}return Object.defineProperty(e.prototype,"imageData",{get:function(){return this._imageHelper.imageData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageState",{get:function(){return this._imageHelper.imageState},enumerable:!0,configurable:!0}),e.prototype.getName=function(){return this._name},e.prototype.procImage=function(e){},e.prototype.procMessage=function(e){return!1},e.prototype.clear=function(){},e.prototype.clearSelected=function(){},e}(),FilterManager=function(){function e(){this._filters=new Array,this._offCanvas=document.createElement("canvas")}return e.prototype.AddFilter=function(e,t,i,n){this._filters.push(FilterCreator.createFilter(e,t,i,n))},e.prototype.getFilter=function(e){for(var t=0;t<this._filters.length;t++)if(this._filters[t].getName()==e)return this._filters[t];return null},e.prototype.procImage=function(e){var t=this;this._offCanvas.width=e.width,this._offCanvas.height=e.height,this._filters.forEach(function(e){e.procImage(t._offCanvas)});var i=e.getContext("2d",{alpha:!1});i.save(),i.fillStyle="black",i.fillRect(0,0,e.width,e.height),i.drawImage(this._offCanvas,0,0),i.restore()},e.prototype.procMessage=function(e){for(var t=!1,i=this._filters.length-1;i>=0;i--)t?this._filters[i].clearSelected():this._filters[i].procMessage(e)&&(t=!0)},e.prototype.clear=function(){for(var e=this._filters.length-1;e>=0&&!this._filters[e].clear();e--);},e}(),overlayCheckSize=150,FilterCreator=function(){function e(){}return e.createFilter=function(e,t,i,n){switch(e){case"annoPoint":return new CXeAnnoPoint(t,i,n);case"annoLine":return new CXeAnnoLine(t,i,n);case"annoRect":return new CXeAnnoRect(t,i,n);case"annoEllipse":return new CXeAnnoEllipse(t,i,n,"annoEllipse");case"signalNoiseRatio":return new XeSignalNoiseRatio(t,i,n);case"annoAngle":return new CXeAnnoAngle(t,i,n);case"lineAnnoAngle":return new CXeAnnoLineAngle(t,i,n);case"annoArrow":return new CXeAnnoArrow(t,i,n);case"annoText":return new CXeAnnoText(t,i,n);case"overlay":return new COverlayFilter(t,i,n);case"ww-wl":return new CWWWLFilter(t,i,n);case"imageMove":return new CMoveFilter(t,i,n);case"imageZoom":return new CZoomFilter(t,i,n);case"positionLine":return new CPositionLineFilter(t,i,n);case"orientationFilter":return new COrientationFilter(t,i,n);case"cube":return new CCubeFilter(t,i,n);case"rulerFilter":return new CRulerFilter(t,i,n);case"AIMarker":return new XeAIMarker(t,i,n);case"mpr":return new CMPRFilter(t,i,n);case"vr":return new CIVRFilter(t,i,n);case"magnifyMirror":return new CIMagnifyMirror(t,i,n)}return null},e}(),CImageDataFilterTool=function(){function e(){}return e.prototype.clampPixel=function(e,t,i){return e<t?t:e>i?i:e},e.prototype.getPixel=function(e,t,i,n,a){var s=4*(i*n+t);return t<0||t>=n||i<0||i>=a?[e[4*(this.clampPixel(i,0,a-1)*n+this.clampPixel(t,0,n-1))],e[4*(this.clampPixel(i,0,a-1)*n+this.clampPixel(t,0,n-1))+1],e[4*(this.clampPixel(i,0,a-1)*n+this.clampPixel(t,0,n-1))+2],e[4*(this.clampPixel(i,0,a-1)*n+this.clampPixel(t,0,n-1))+3]]:[e[s],e[s+1],e[s+2],e[s+3]]},e.prototype.bilinearInterpolate=function(e,t,i,n,a,s){var r=i[0],o=i[1],l=i[2],h=i[3],u=n[0],d=n[1],c=n[2],p=n[3],g=a[0],_=a[1],m=a[2],f=a[3],y=s[0],I=s[1],x=s[2],w=s[3],D=1-e,P=1-t,v=P*(D*h+e*p)+t*(D*f+e*w);return[P*(D*r+e*u)+t*(D*g+e*y),P*(D*o+e*d)+t*(D*_+e*I),P*(D*l+e*c)+t*(D*m+e*x),v]},e.prototype.convolveFilter=function(e,t,i,n){var a,s,r=[];a=s=Math.sqrt(t.length);for(var o=Math.floor(a/2),l=Math.floor(s/2),h=0;h<n;h++)for(var u=0;u<i;u++){for(var d=4*(h*i+u),c=0,p=0,g=0,_=-o;_<=o;_++){var m,f=h+_;m=0<=f&&f<n?f*i:h*i;for(var y=s*(_+o)+l,I=-l;I<=l;I++){var x=t[y+I];if(0!=x){var w=u+I;0<=w&&w<i||(w=u);var D=4*(m+w);c+=x*e[D],p+=x*e[D+1],g+=x*e[D+2]}}}r[d]=Math.floor(c+.5),r[d+1]=Math.floor(p+.5),r[d+2]=Math.floor(g+.5),r[d+3]=e[d+3]}for(var P=0;P<r.length;P++)e[P]=r[P]},e.prototype.transformFilter=function(e,t,i,n){for(var a=[],s=[],r=0;r<e.length;r++)s[r]=e[r];for(var o=0;o<n;o++)for(var l=0;l<i;l++){var h=4*(o*i+l);t.apply(this,[l,o,a]);var u,d,c,p,g=Math.floor(a[0]),_=Math.floor(a[1]),m=a[0]-g,f=a[1]-_;if(g>=0&&g<i-1&&_>=0&&_<n-1){var y=4*(i*_+g);u=[e[y],e[y+1],e[y+2],e[y+3]],d=[e[y+4],e[y+5],e[y+6],e[y+7]],c=[e[y+4*i],e[y+4*i+1],e[y+4*i+2],e[y+4*i+3]],p=[e[y+4*(i+1)],e[y+4*(i+1)+1],e[y+4*(i+1)+2],e[y+4*(i+1)+3]]}else u=this.getPixel(e,g,_,i,n),d=this.getPixel(e,g+1,_,i,n),c=this.getPixel(e,g,_+1,i,n),p=this.getPixel(e,g+1,_+1,i,n);var I=this.bilinearInterpolate(m,f,u,d,c,p);s[h]=I[0],s[h+1]=I[1],s[h+2]=I[2],s[h+3]=I[3]}for(var x=0;x<s.length;x++)e[x]=s[x]},e}(),__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(e){e[e.TYPE_TOPLEFT=0]="TYPE_TOPLEFT",e[e.TYPE_TOPRIGHT=1]="TYPE_TOPRIGHT",e[e.TYPE_BOTTOMLEFT=2]="TYPE_BOTTOMLEFT",e[e.TYPE_BOTTOMRIGHT=3]="TYPE_BOTTOMRIGHT"}(HANDLEINDEX||(HANDLEINDEX={}));var HitHandle_Cube,CXeAnnoEllipse=function(e){function t(t,i,n,a){var s=e.call(this,a,t,i,n)||this;s._ellipses=null,s._currEllipse=null,s._originalEllipseRect=null,s._isLBDown=!1,s._selectedDownPoint=null,s._selectedEllipseIndex=null,s._selectedHandleIndex=null,s._selectedEllipseTipsIndex=null,s._currentPoint=null,s._isKeepCircle=!1,s._minRadius=1,s._ellipses=t.imageState.ellipseStates.ellipses;var r=s;return s._eventHandler.addHandler("deleteSelected",s,"annoEllipse",function(){r.deleteSelected()}),s._eventHandler.addHandler("deleteAll",s,"annoEllipse",function(){r.deleteAll()}),s}return __extends(t,e),t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this)},Object.defineProperty(t.prototype,"isKeepCircle",{set:function(e){this._isKeepCircle=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ellipseCount",{get:function(){return null==this._ellipses?0:this._ellipses.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ellipses",{get:function(){return this._ellipses},set:function(e){this._ellipses=e},enumerable:!0,configurable:!0}),t.prototype.clearSelected=function(){this._isLBDown=!1,this._currEllipse=null,this._selectedEllipseIndex=null,this._selectedHandleIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();this._isLBDown=!0,this._originalEllipseRect=new Rect(0,0,0,0);var t={x:e.x,y:e.y};if(this._selectedHandleIndex=null,this._selectedEllipseIndex=null,this._selectedEllipseTipsIndex=null,this.hitOnHandle(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(this.hitOnTips(t))return this._currentPoint=t,!0;if(this.hitOnBody(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(e.annoName==this.getName())return this._currentPoint=t,this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._currentPoint=null,this._originalEllipseRect=null,this._selectedEllipseTipsIndex=null,e.x&&e.y){if(null!=this._selectedEllipseIndex)return this._ellipses[this._selectedEllipseIndex].outerRect.normalizeRect(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName())return null!=this._currEllipse&&(this._currEllipse.outerRect.normalizeRect(),this._ellipses.push(this._currEllipse),this._currEllipse=null,this._selectedEllipseIndex=this.ellipses.length-1,this._imageHelper.needDrawSameImage=!0),this._eventHandler.doHandler("update",this._parentID,null,null),!0}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(1==this._isLBDown){if(null!=this._selectedEllipseIndex){var i=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),n=i.x-this._selectedDownPoint.x,a=i.y-this._selectedDownPoint.y;if(null!=this._selectedHandleIndex)this._ellipses[this._selectedEllipseIndex].setEllipseRect(this.getOffsetRect(this._originalEllipseRect,this._selectedHandleIndex,n,a));else{var s=this._originalEllipseRect.clone();s.offsetRect(n,a),this._ellipses[this._selectedEllipseIndex].setEllipseRect(s);var r=e.x-this._currentPoint.x,o=e.y-this._currentPoint.y;this._currentPoint={x:e.x,y:e.y},this._ellipses[this._selectedEllipseIndex].tips.moveTips(this._imageHelper,r,o)}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(null!=this._selectedEllipseTipsIndex){n=e.x-this._currentPoint.x,a=e.y-this._currentPoint.y;this.ellipses[this._selectedEllipseTipsIndex].moveTips(this._imageHelper,n,a),this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY))}else if(null!=this._currentPoint&&Math.abs(e.x-this._currentPoint.x)>3&&Math.abs(e.y-this._currentPoint.y)>3){var l=this._imageHelper.clientToImage_point(this._currentPoint),h=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),u=new Rect(l.x,l.y,h.x,h.y);this._currEllipse=new Ellipse(u),this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY))}}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){var t=e.getContext("2d",{alpha:!1});t.save();for(var i=0;i<this._ellipses.length;++i)this._ellipses[i].draw(t,this._imageHelper,this.c_fontHeight,this.c_lineSpacing,!1),i==this._selectedEllipseIndex&&this._ellipses[i].drawHandles(t,this._imageHelper);null!=this._currEllipse&&this._currEllipse.draw(t,this._imageHelper,this.c_fontHeight,this.c_lineSpacing,!0),t.restore()}else this.clearSelected()},t.prototype.hitOnBody=function(e){var t=this._imageHelper.clientToImage_point(e);if(null!=this._selectedEllipseIndex){var i=this._ellipses[this._selectedEllipseIndex].getHandleDistance(this._imageHelper);if(i>0&&this._ellipses[this._selectedEllipseIndex].ptInHandlesRegion(t,i))return this._originalEllipseRect=this._ellipses[this._selectedEllipseIndex].outerRect.clone(),!0}this._selectedEllipseIndex=null;for(var n=0;n<this._ellipses.length;++n)if(this._ellipses[n].ptInEllipse(t))return this._selectedEllipseIndex=n,this._originalEllipseRect=this._ellipses[n].outerRect.clone(),!0;return!1},t.prototype.hitOnTips=function(e){this._selectedEllipseTipsIndex=null;for(var t=0;t<this._ellipses.length;++t){if(null!=this._ellipses[t].tips)if(this._ellipses[t].tips.getClientRect(this._imageHelper).ptInRect(e))return this._selectedEllipseTipsIndex=t,!0}return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null;for(var t=null,i=0;i<this._ellipses.length;++i)if(null!=(t=this._ellipses[i].hitOnHandle(e,this._imageHelper)))return this._selectedHandleIndex=t,this._selectedEllipseIndex=i,this._originalEllipseRect=this._ellipses[i].outerRect.clone(),!0;return!1},t.prototype.drawCross=function(e,t){var i=e.getContext("2d",{alpha:!1});i.save(),i.strokeStyle=t,i.beginPath(),i.moveTo(this._currentPoint.x-4,this._currentPoint.y),i.lineTo(this._currentPoint.x+4,this._currentPoint.y),i.moveTo(this._currentPoint.x,this._currentPoint.y-4),i.lineTo(this._currentPoint.x,this._currentPoint.y+4),i.stroke(),i.restore()},t.prototype.deleteSelected=function(){null!=this._selectedEllipseIndex&&(this._ellipses.splice(this._selectedEllipseIndex,1),this._selectedEllipseIndex=null,this._selectedHandleIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._ellipses.splice(0),this._currEllipse=null,this._selectedEllipseIndex=null,this._selectedHandleIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null)},t.prototype.offsetRect=function(e,t,i){var n=e.left+t,a=e.top+i,s=e.right+t,r=e.bottom+i;return new Rect(n,a,s,r)},t.prototype.normalizeOffsetRect=function(e,t){e.bottom-e.top<2*this._minRadius&&(0==t||1==t?e.top=e.bottom-2*this._minRadius:e.bottom=e.top+2*this._minRadius),e.bottom-e.top>this._imageHelper.imageData.imageHeight&&(0==t||1==t?e.top=e.bottom-this._imageHelper.imageData.imageHeight:e.bottom=e.top+this._imageHelper.imageData.imageHeight),e.right-e.left<2*this._minRadius&&(0==t||2==t?e.left=e.right-2*this._minRadius:e.right=e.left+2*this._minRadius),e.right-e.left>this._imageHelper.imageData.imageWidth&&(0==t||2==t?e.left=e.right-this._imageHelper.imageData.imageWidth:e.right=e.left+this._imageHelper.imageData.imageWidth),e.normalizeRect()},t.prototype.getOffsetRect=function(e,t,i,n){var a=e.clone();return 0==t?(this._isKeepCircle&&(Math.abs(i)>Math.abs(n)?n=i:i=n),a.left=e.left+i,a.top=e.top+n):1==t?(this._isKeepCircle&&(Math.abs(i)>Math.abs(n)?n=-1*i:i=-1*n),a.top=e.top+n,a.right=e.right+i):2==t?(this._isKeepCircle&&(Math.abs(i)>Math.abs(n)?n=-1*i:i=-1*n),a.left=e.left+i,a.bottom=e.bottom+n):3==t&&(this._isKeepCircle&&(Math.abs(i)>Math.abs(n)?n=i:i=n),a.bottom=e.bottom+n,a.right=e.right+i),a},t}(FilterBase),Ellipse=function(){function e(e,t){void 0===t&&(t=null),this._handleSize=5,this._minHandleDist=30,this._strTips=null,this._mapValues=new Map,this._tips=null,this._tipsCalcing=!1,this._outerRect=e,this._tips=t}return Object.defineProperty(e.prototype,"tips",{get:function(){return this._tips},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"outerRect",{get:function(){return this._outerRect},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){var e=Math.round(this._outerRect.left+(this._outerRect.right-this._outerRect.left)/2),t=Math.round(this._outerRect.top+(this._outerRect.bottom-this._outerRect.top)/2);return new Point2d(e,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hRadius",{get:function(){return Math.round((this._outerRect.right-this._outerRect.left)/2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vRadius",{get:function(){return Math.round((this._outerRect.bottom-this._outerRect.top)/2)},enumerable:!0,configurable:!0}),e.prototype.generateHandleRectByPoint=function(e,t){var i=new Rect(t.x-this._handleSize,t.y-this._handleSize,t.x+this._handleSize,t.y+this._handleSize);return e||(i.inflatRect(2*this._handleSize,2*this._handleSize),i.offsetRect(2*-this._handleSize,2*-this._handleSize)),i},e.prototype.getHandles=function(e){var t=this.hRadius,i=this.vRadius;e>0&&(t<e&&(t=e),i<e&&(i=e));var n=new Array;return n.push(new Point2d(this.center.x-t,this.center.y-i)),n.push(new Point2d(this.center.x+t,this.center.y-i)),n.push(new Point2d(this.center.x-t,this.center.y+i)),n.push(new Point2d(this.center.x+t,this.center.y+i)),n},e.prototype.drawBody=function(e,t,i){var n=t.imageToClient_point(this._outerRect.leftTop),a=t.imageToClient_point(this._outerRect.rightBottom),s=n.x+(a.x-n.x)/2,r=n.y+(a.y-n.y)/2,o=Math.abs((a.x-n.x)/2),l=Math.abs((a.y-n.y)/2),h=o>=l?o:l,u=o/h,d=l/h;e.save(),e.strokeStyle=i?UIUtilities.getAnnoColor(AnnoColor.COLOR_ANNOFUCUSED):UIUtilities.getAnnoColor(AnnoColor.COLOR_ANNO),e.scale(u,d),e.beginPath(),e.moveTo((s+o)/u,r/d),e.arc(s/u,r/d,h,0,2*Math.PI),e.closePath(),e.stroke(),e.restore()},e.prototype.draw=function(e,t,i,n,a){this.drawBody(e,t,a),this.drawTips(e,t,i,n)},e.prototype.calcStandardDiffValue=function(e,t,i,n,a){if(0==a)return 0;var s=0,r=this.center,o=this._outerRect.top;o<0&&(o=0);var l=this._outerRect.bottom;l>e.imageData.imageHeight&&(l=e.imageData.imageHeight);for(var h=0;o<l;o++,h++){var u=r.x-i[h];u<0&&(u=0);var d=r.x+i[h];d>=e.imageData.imageWidth&&(d=e.imageData.imageWidth-1);for(var c=u;c<d;c++){var p=t[e.imageData.imageWidth*o+c];s+=(p-n)*(p-n)}}return Math.sqrt(s/a)},e.prototype.calcTipValue=function(e){var t=e.imageData.getData();null!=t&&(this._tipsCalcing=!1);var i="",n=this.hRadius,a=this.vRadius,s=2*a+1;if(!(s<=1||s>1e3)){for(var r=new Array(s),o=0;o<s;o++){var l=a*a-(o-a)*(o-a),h=Math.sqrt(l);r[o]=Math.round(h*n/a)}var u=-32768,d=32767,c=0,p=0,g=this.center,_=this._outerRect.top;_<0&&(_=0);var m=this._outerRect.bottom;m>e.imageData.heightFull&&(m=e.imageData.heightFull);for(o=0;_<m;_++,o++){var f=g.x-r[o];f<0&&(f=0);var y=g.x+r[o];y>=e.imageData.widthFull&&(y=e.imageData.widthFull-1);for(var I=f;I<y;I++){var x=e.imageData.widthFull*_+I;if(null!=t){var w=t[x];u<w&&(u=w),d>w&&(d=w),p+=w}c++}}if(null!=t){var D=void 0;0!=c?(D=p/c,i+="最大值："+u.toString()+"\r\n",i+="最小值："+d.toString()+"\r\n",i+="平均值："+D.toFixed(3)+"\r\n"):(D=0,u=0,d=0,i+="最大值：-\r\n",i+="最小值：-\r\n",i+="平均值：-\r\n")}else 16==e.imageData.bitsAllocated&&(i+="最大值：加载中，请稍后\r\n",i+="最小值：加载中，请稍后\r\n",i+="平均值：加载中，请稍后\r\n",this._tipsCalcing=!0);return i+="面积："+(e.imageData.pixelSpacingX*e.imageData.pixelSpacingY*c).toFixed(3)+"mm*mm\r\n"}console.debug("invalid CountV:%d, vRadiu:%d",s,a)},e.prototype.drawTips=function(e,t,i,n){if(e.save(),(null==this._strTips||0==this._strTips.length||this._tipsCalcing)&&(this._strTips=this.calcTipValue(t)),null!=this._strTips&&0!=this._strTips.length){null==this._tips?this._tips=TipLocation.calcTipLoc(e,t,this._strTips,this._outerRect,i,n):this._tips.updateTip(e,t,this._strTips,i,n),TipLocation.drawTip(e,t,this._tips);var a=t.imageToClient_point(this.center);TipLocation.drawConnectLine(e,t,this._tips,a),e.restore()}},e.prototype.setEllipseRect=function(e){this._outerRect=e,this._strTips=null},e.prototype.clearTips=function(){this._strTips=null},e.prototype.getHandleDistance=function(e){var t=this._outerRect.clone();e.imageToClient_rect(t);var i=0;if(t.Width<this._minHandleDist||t.Height<this._minHandleDist){var n=new Rect(0,0,this._minHandleDist,this._minHandleDist);e.clientToImage_rect(n),i=n.Width}return i},e.prototype.drawHandles=function(e,t){var i=this,n=this.getHandleDistance(t),a=this.getHandles(n);e.save(),e.fillStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_HANDLER),a.forEach(function(n){var a=t.imageToClient_point(n),s=i.generateHandleRectByPoint(!0,a);e.beginPath(),e.fillRect(s.left,s.top,s.Width,s.Height),e.stroke(),e.closePath()}),e.restore()},e.prototype.ptInEllipse=function(e){var t=this.center;return(e.x-t.x)*(e.x-t.x)/(this.hRadius*this.hRadius)+(e.y-t.y)*(e.y-t.y)/(this.vRadius*this.vRadius)<=1},e.prototype.ptInHandlesRegion=function(e,t){var i=this.getHandles(t);if(4!=i.length)return!1;for(var n=new Array,a=0,s=i;a<s.length;a++){var r=s[a],o=this.generateHandleRectByPoint(!1,r);n.push(o)}return e.x>n[0].left&&e.x<n[1].right&&e.y>n[0].top&&e.y<n[2].bottom},e.prototype.hitOnHandle=function(e,t){for(var i=this.getHandleDistance(t),n=null,a=this.getHandles(i),s=0;s<a.length;++s){var r=t.imageToClient_point(a[s]);if(this.generateHandleRectByPoint(!1,r).ptInRect(e))return n=s}return n},e.prototype.hitOnTips=function(e,t){return this._tips.getClientRect(e).ptInRect(t)},e.prototype.moveTips=function(e,t,i){this._tips.moveTips(e,t,i)},e.prototype.clone=function(){return new e(this._outerRect.clone(),null==this._tips?null:this._tips.clone())},e.prototype.getValue=function(e){return this._mapValues.has(e)?this._mapValues.get(e):null},e}(),Line=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(){function e(e,t,i){void 0===i&&(i=null),this._handleSize=12,this.tips=null,this.startPoint=e,this.endPoint=t,this.tips=i}return e.prototype.clone=function(){return new e({x:this.startPoint.x,y:this.startPoint.y},{x:this.endPoint.x,y:this.endPoint.y},this.tips)},e.prototype.hitOnLine=function(e){return!!Utility.testHitOnLineSegment(e,this.startPoint,this.endPoint,10)},e.prototype.hitOnHandle=function(e){return e.x>=this.startPoint.x-this._handleSize&&e.x<=this.startPoint.x+this._handleSize&&e.y>=this.startPoint.y-this._handleSize&&e.y<=this.startPoint.y+this._handleSize?0:e.x>=this.endPoint.x-this._handleSize&&e.x<=this.endPoint.x+this._handleSize&&e.y>=this.endPoint.y-this._handleSize&&e.y<=this.endPoint.y+this._handleSize?1:null},e.prototype.draw=function(e,t,i){var n=t.imageToClient_point(this.startPoint),a=t.imageToClient_point(this.endPoint);e.save(),e.strokeStyle=i,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(a.x,a.y),e.stroke(),e.closePath(),e.restore()},e.prototype.drawHandles=function(e,t,i){var n=this,a=t.imageToClient_point(this.startPoint),s=t.imageToClient_point(this.endPoint),r=new Array;r.push(a),r.push(s),e.save(),e.strokeStyle=i,r.forEach(function(t){e.beginPath(),e.arc(t.x,t.y,n._handleSize,0,2*Math.PI),e.stroke(),e.closePath()}),e.restore()},e.prototype.drawTip=function(e,t,i,n){if(this.startPoint.x!=this.endPoint.x||this.startPoint.y!=this.endPoint.y){var a=this.calTipsStr(t),s={x:Math.round(this.startPoint.x+this.endPoint.x)/2,y:Math.round(this.startPoint.y+this.endPoint.y)/2},r=t.imageToClient_point(s),o=new Rect(s.x-1,s.y-1,s.x+1,s.y+1);null==this.tips?this.tips=TipLocation.calcTipLoc(e,t,a,o,i,1,10):this.tips.updateTip(e,t,a,i,1),TipLocation.drawTip(e,t,this.tips),TipLocation.drawConnectLine(e,t,this.tips,r)}},e.prototype.calTipsStr=function(e){var t="px",i=this.startPoint.x-this.endPoint.x,n=this.startPoint.y-this.endPoint.y;return e.imageData.pixelSpacingX>.01&&(i*=e.imageData.pixelSpacingX,n*=e.imageData.pixelSpacingY,t="mm"),Math.sqrt(i*i+n*n).toFixed(2).toString()+t},e}()),CXeAnnoLine=function(e){function t(t,i,n){var a=e.call(this,"annoLine",t,i,n)||this;a._originalLine=null,a._selectedLineIndex=null,a._selectedHandleIndex=null,a._selectedDownPoint=null,a._selectedLineTipsIndex=null,a._isLBDown=!1,a._currentPoint=null,a._curLine=null;var s=a;return a._eventHandler.addHandler("deleteSelected",a,"annoLine",function(){s.deleteSelected()}),a._eventHandler.addHandler("deleteAll",a,"annoLine",function(){s.deleteAll()}),a}return __extends(t,e),Object.defineProperty(t.prototype,"_lines",{get:function(){return this._imageHelper&&this._imageHelper.imageState&&this._imageHelper.imageState.lineStates?this._imageHelper.imageState.lineStates.lines:null},set:function(e){this._imageHelper.imageState.lineStates.lines=e},enumerable:!0,configurable:!0}),t.prototype.getStatus=function(){return{lines:this._lines,originalLine:this._originalLine,selectedLineIndex:this._selectedLineIndex,selectedHandleIndex:this._selectedHandleIndex,selectedDownPoint:this._selectedDownPoint}},t.prototype.setStatus=function(e){this._lines=e.lines,this._originalLine=e.originalLine,this._selectedLineIndex=e.selectedLineIndex,this._selectedHandleIndex=e.selectedHandleIndex,this._selectedDownPoint=e.selectedDownPoint},t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this)},Object.defineProperty(t.prototype,"lineCount",{get:function(){return null==this._lines?0:this._lines.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lines",{get:function(){return this._lines},set:function(e){this._lines=e},enumerable:!0,configurable:!0}),t.prototype.clearSelected=function(){this._isLBDown=!1,this._currentPoint=null,this._curLine=null,this._selectedLineIndex=null,this._selectedHandleIndex=null,this._selectedLineTipsIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();this._isLBDown=!0;var t={x:e.x,y:e.y};if(this._originalLine={startPoint:{x:null,y:null},endPoint:{x:null,y:null}},this._selectedHandleIndex=null,this._selectedLineIndex=null,this._selectedLineTipsIndex=null,this.hitOnHandle(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(this.hitOnTips(t))return this._currentPoint=t,!0;if(this.hitOnBody(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(e.annoName==this.getName())return this._currentPoint=t,this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._currentPoint=null,this._selectedLineTipsIndex=null,e.x&&e.y){if(null!=this._selectedLineIndex)return this._imageHelper.needDrawSameImage=!0,this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName())return this._curLine&&((Math.abs(this._curLine.startPoint.x-this._curLine.endPoint.x)>3||Math.abs(this._curLine.startPoint.y-this._curLine.endPoint.y)>3)&&(this.lines.push(this._curLine),this._selectedLineIndex=this.lines.length-1,this._imageHelper.needDrawSameImage=!0),this._curLine=null),this._eventHandler.doHandler("update",this._parentID,null,null),!0}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._isLBDown)return!1;if(null!=this._selectedLineIndex){var i=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(null!=this._selectedHandleIndex)0==this._selectedHandleIndex?this._lines[this._selectedLineIndex].startPoint=i:1==this._selectedHandleIndex&&(this._lines[this._selectedLineIndex].endPoint=i);else{var n=i.x-this._selectedDownPoint.x,a=i.y-this._selectedDownPoint.y;this._lines[this._selectedLineIndex].startPoint.x=this._originalLine.startPoint.x+n,this._lines[this._selectedLineIndex].startPoint.y=this._originalLine.startPoint.y+a,this._lines[this._selectedLineIndex].endPoint.x=this._originalLine.endPoint.x+n,this._lines[this._selectedLineIndex].endPoint.y=this._originalLine.endPoint.y+a;var s=e.x-this._currentPoint.x,r=e.y-this._currentPoint.y;this._currentPoint={x:e.x,y:e.y},this._lines[this._selectedLineIndex].tips.moveTips(this._imageHelper,s,r)}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(null!=this._selectedLineTipsIndex){n=e.x-this._currentPoint.x,a=e.y-this._currentPoint.y;return this._lines[this._selectedLineTipsIndex].tips.moveTips(this._imageHelper,n,a),this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}if(e.annoName==this.getName()){var o=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),l=this._imageHelper.clientToImage_point(this._currentPoint);return this._curLine=new Line(l,o),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.drawCross=function(e,t){var i=e.getContext("2d",{alpha:!1});i.save(),i.strokeStyle=t,i.beginPath(),i.moveTo(this._currentPoint.x-6,this._currentPoint.y),i.lineTo(this._currentPoint.x+6,this._currentPoint.y),i.moveTo(this._currentPoint.x,this._currentPoint.y-6),i.lineTo(this._currentPoint.x,this._currentPoint.y+6),i.stroke(),i.restore()},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){var t="#57f900",i=e.getContext("2d",{alpha:!1});i.save(),this._curLine&&(this._curLine.draw(i,this._imageHelper,t),n==this._selectedLineIndex&&this._curLine.drawHandles(i,this._imageHelper,t),this._curLine.drawTip(i,this._imageHelper,this.c_fontHeight,t));for(var n=0;n<this._lines.length;++n)this._lines[n].draw(i,this._imageHelper,t),n==this._selectedLineIndex&&this._lines[n].drawHandles(i,this._imageHelper,t),this._lines[n].drawTip(i,this._imageHelper,this.c_fontHeight,t);i.restore()}else this.clearSelected()},t.prototype.hitOnBody=function(e){for(var t=0;t<this._lines.length;++t){var i=this._imageHelper.imageToClient_point(this._lines[t].startPoint),n=this._imageHelper.imageToClient_point(this._lines[t].endPoint);if(Utility.testHitOnLineSegment(e,i,n,10))return this._selectedLineIndex=t,this._originalLine.startPoint.x=this._lines[t].startPoint.x,this._originalLine.startPoint.y=this._lines[t].startPoint.y,this._originalLine.endPoint.x=this._lines[t].endPoint.x,this._originalLine.endPoint.y=this._lines[t].endPoint.y,!0}return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null,this._selectedLineIndex=null;for(var t=0;t<this._lines.length;++t){var i=this._imageHelper.imageToClient_point(this._lines[t].startPoint),n=this._imageHelper.imageToClient_point(this._lines[t].endPoint);if(e.x>=i.x-12&&e.x<=i.x+12&&e.y>=i.y-12&&e.y<=i.y+12?(this._selectedHandleIndex=0,this._selectedLineIndex=t):e.x>=n.x-12&&e.x<=n.x+12&&e.y>=n.y-12&&e.y<=n.y+12&&(this._selectedHandleIndex=1,this._selectedLineIndex=t),null!=this._selectedLineIndex)return this._originalLine.startPoint.x=this._lines[t].startPoint.x,this._originalLine.startPoint.y=this._lines[t].startPoint.y,this._originalLine.endPoint.x=this._lines[t].endPoint.x,this._originalLine.endPoint.y=this._lines[t].endPoint.y,!0}return!1},t.prototype.hitOnTips=function(e){this._selectedLineTipsIndex=null;for(var t=0;t<this._lines.length;++t){if(null!=this._lines[t].tips)if(this._lines[t].tips.getClientRect(this._imageHelper).ptInRect(e))return this._selectedLineTipsIndex=t,!0}return!1},t.prototype.drawLine=function(e,t,i){if(!(t<0||t>=this._lines.length)){var n=this._imageHelper.imageToClient_point(this._lines[t].startPoint),a=this._imageHelper.imageToClient_point(this._lines[t].endPoint),s=e.getContext("2d",{alpha:!1});s.save(),s.strokeStyle=i,s.globalAlpha=1,s.lineWidth=1,s.beginPath(),s.moveTo(n.x,n.y),s.lineTo(a.x,a.y),s.stroke(),t==this._selectedLineIndex&&(s.beginPath(),s.arc(n.x,n.y,12,0,2*Math.PI),s.stroke(),s.beginPath(),s.arc(a.x,a.y,12,0,2*Math.PI),s.stroke()),s.restore()}},t.prototype.deleteSelected=function(){null!=this._selectedLineIndex&&(this._lines.splice(this._selectedLineIndex,1),this._selectedLineIndex=null,this._selectedHandleIndex=null,this._selectedLineTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._lines.length>0&&(this._lines.splice(0),this._curLine=null,this._selectedLineIndex=null,this._selectedHandleIndex=null,this._selectedLineTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t}(FilterBase),CXeAnnoArrow=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"annoArrow",t,i,n)||this;a._arrows=null,a._curArrow=null,a._originalArrow=null,a._selectedArrowIndex=null,a._selectedHandleIndex=null,a._selectedDownPoint=null,a._isDrawingArrow=!1,a._isLBDown=!1,a._arrows=t.imageState.arrowState.arrows;var s=a;return a._eventHandler.addHandler("deleteSelected",a,"annoArrow",function(){s.deleteSelected()}),a._eventHandler.addHandler("deleteAll",a,"annoArrow",function(){s.deleteAll()}),a}return __extends(t,e),Object.defineProperty(t.prototype,"arrows",{get:function(){return this._arrows},set:function(e){this._arrows=e,this._imageHelper.imageState.arrowState.arrows=e},enumerable:!0,configurable:!0}),t.prototype.getStatus=function(){return{}},t.prototype.setStatus=function(e){},t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this)},Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),t.prototype.hitTest=function(e){return this.hitOnHandle({x:e.x,y:e.y})?(this._selectedDownPoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),!0):!!this.hitOnBody({x:e.x,y:e.y})&&(this._selectedDownPoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),!0)},t.prototype.clearSelected=function(){this._isLBDown=!1,this._curArrow=null,this._selectedArrowIndex=null,this._selectedHandleIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();if(this._isLBDown=!0,this._selectedArrowIndex=null,this._selectedHandleIndex=null,this.hitOnHandle({x:e.x,y:e.y}))return this._selectedDownPoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),!0;if(this.hitOnBody({x:e.x,y:e.y}))return this._selectedDownPoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),!0;if(e.annoName==this.getName()){var t=this._imageHelper.clientToImage_point({x:e.x,y:e.y});return this._curArrow=new Arrow(t,t),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,e.x&&e.y){if(null!=this._selectedArrowIndex)return this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName()){if(this._curArrow){t=this._imageHelper.clientToImage_point({x:e.x,y:e.y});this._curArrow.endpoint=t,Math.abs(t.x-this._curArrow.vertex.x)>=3&&Math.abs(t.y-this._curArrow.vertex.y)>=3&&(this._arrows.push(this._curArrow),this._selectedArrowIndex=this._arrows.length-1,this._imageHelper.needDrawSameImage=!0),this._curArrow=null}return this._eventHandler.doHandler("update",this._parentID,null,null),!0}}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._isLBDown)return!1;if(null!=this._selectedArrowIndex){var i=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(null!=this._selectedHandleIndex)0==this._selectedHandleIndex?this._arrows[this._selectedArrowIndex].vertex=i:1==this._selectedHandleIndex&&(this._arrows[this._selectedArrowIndex].endpoint=i);else{var n=i.x-this._selectedDownPoint.x,a=i.y-this._selectedDownPoint.y;this._arrows[this._selectedArrowIndex].vertex.x=this._originalArrow.vertex.x+n,this._arrows[this._selectedArrowIndex].vertex.y=this._originalArrow.vertex.y+a,this._arrows[this._selectedArrowIndex].endpoint.x=this._originalArrow.endpoint.x+n,this._arrows[this._selectedArrowIndex].endpoint.y=this._originalArrow.endpoint.y+a}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(e.annoName==this.getName()&&null!=this._curArrow){var s=this._imageHelper.clientToImage_point({x:e.x,y:e.y});return this._curArrow.endpoint=s,this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){var t=e.getContext("2d",{alpha:!1});t.save(),t.strokeStyle="#57f900",t.lineWidth=1,null!=this._curArrow&&(this._curArrow.draw(t,this._imageHelper),this._curArrow.drawHandles(t,this._imageHelper));for(var i=0;i<this._arrows.length;++i)this._arrows[i].draw(t,this._imageHelper),i==this._selectedArrowIndex&&this._arrows[i].drawHandles(t,this._imageHelper);t.restore()}else this.clearSelected()},t.prototype.hitOnBody=function(e){this._selectedArrowIndex=null;for(var t=0;t<this._arrows.length;++t)if(this._arrows[t].hitOnLine(e,this._imageHelper))return this._selectedArrowIndex=t,this._originalArrow=this._arrows[t].clone(),!0;return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null,this._selectedArrowIndex=null;for(var t=null,i=0;i<this._arrows.length;++i)if(null!=(t=this._arrows[i].hitOnHandle(e,this._imageHelper)))return this._selectedHandleIndex=t,this._selectedArrowIndex=i,this._originalArrow=this._arrows[i].clone(),!0;return!1},t.prototype.deleteSelected=function(){null!=this._selectedArrowIndex&&(this._arrows.splice(this._selectedArrowIndex,1),this._selectedArrowIndex=null,this._selectedHandleIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._arrows.splice(0),this._curArrow=null,this._selectedArrowIndex=null,this._selectedHandleIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null)},t}(FilterBase)),Arrow=function(){function e(e,t){this._handleSize=12,this.vertex=e,this.endpoint=t}return e.prototype.clone=function(){return new e({x:this.vertex.x,y:this.vertex.y},{x:this.endpoint.x,y:this.endpoint.y})},e.prototype.hitOnLine=function(e,t){var i=t.imageToClient_point(this.vertex),n=t.imageToClient_point(this.endpoint);return!!Utility.testHitOnLineSegment(e,i,n,10)},e.prototype.hitOnHandle=function(e,t){var i=t.imageToClient_point(this.vertex);if(e.x>=i.x-this._handleSize&&e.x<=i.x+this._handleSize&&e.y>=i.y-this._handleSize&&e.y<=i.y+this._handleSize)return 0;var n=t.imageToClient_point(this.endpoint);return e.x>=n.x-this._handleSize&&e.x<=n.x+this._handleSize&&e.y>=n.y-this._handleSize&&e.y<=n.y+this._handleSize?1:null},e.prototype.draw=function(e,t){var i=t.imageToClient_point(this.vertex),n=t.imageToClient_point(this.endpoint),a=180*Math.atan2(n.y-i.y,n.x-i.x)/Math.PI,s=(a+30)*Math.PI/180,r=(a-30)*Math.PI/180,o=10*Math.cos(s),l=10*Math.sin(s),h=10*Math.cos(r),u=10*Math.sin(r);e.save(),e.beginPath();var d=n.x-o,c=n.y-l;e.moveTo(n.x,n.y),e.lineTo(i.x,i.y),d=i.x+o,c=i.y+l,e.moveTo(d,c),e.lineTo(i.x,i.y),d=i.x+h,c=i.y+u,e.lineTo(d,c),e.stroke(),e.restore()},e.prototype.drawHandles=function(e,t){var i=t.imageToClient_point(this.vertex),n=t.imageToClient_point(this.endpoint);e.save(),e.beginPath(),e.arc(i.x,i.y,this._handleSize,0,2*Math.PI),e.stroke(),e.beginPath(),e.arc(n.x,n.y,this._handleSize,0,2*Math.PI),e.stroke(),e.closePath(),e.restore()},e}(),CXeAnnoPoint=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"annoPoint",t,i,n)||this;return a._isPressed=!1,a._imageHelper.imageState.pointStates.imagePoint=null,a}return __extends(t,e),Object.defineProperty(t.prototype,"imagePoint",{get:function(){return this._imageHelper.imageState.pointStates.imagePoint},set:function(e){this._imageHelper.imageState.pointStates.imagePoint=e},enumerable:!0,configurable:!0}),t.prototype.getStatus=function(){return{imagePoint:this.imagePoint}},t.prototype.setStatus=function(e){this.imagePoint=e.imagePoint},t.prototype.procImage=function(e){if(null!=this.imagePoint&&this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID){var t,i,n={x:0,y:0},a=this._imageHelper.imageToClient_point(this.imagePoint);a.x<=50?(n.x=a.x+5,t="left"):(n.x=a.x-5,t="right"),a.y<=30?(n.y=a.y+5,i="top"):(n.y=a.y-5,i="bottom");var s,r=e.getContext("2d",{alpha:!1});r.save(),r.strokeStyle="#57f900",r.beginPath(),r.moveTo(a.x-6,a.y),r.lineTo(a.x+6,a.y),r.moveTo(a.x,a.y-6),r.lineTo(a.x,a.y+6),r.stroke(),r.fillStyle="#57f900",r.textAlign=t,r.textBaseline=i;var o=20;this.imageData.getImageLevel()<=IMAGE_LEVEL.IMAGE_LEVEL_JPG?(s=16==this.imageData.bitsAllocated?"图像未加载完毕":"图像格式不支持",(o=Math.round(e.width/40))<12&&(o=12),o>16&&(o=16),r.font=o.toString()+"px sans-serif",r.textAlign="center",n.x=a.x,n.y=2*n.y-a.y):(s=this.imageData.getPixelValue(this.imagePoint).toString(),r.font="20px sans-serif");var l,h,u=UIUtilities.calcTextRectSize(r,s,o,1);"left"==r.textAlign?l=n.x-1:"right"==r.textAlign?l=n.x-u.width-1:"center"==r.textAlign&&(l=n.x-Math.round(u.width/2)-1),"top"==r.textBaseline?h=n.y-1:"bottom"==r.textBaseline&&(h=n.y-u.height-1),r.globalAlpha=.5,r.fillStyle="black",r.fillRect(l,h,u.width+1,u.height+1),r.strokeStyle="#57f900",r.strokeRect(l,h,u.width+1,u.height+1),r.fillStyle="#57f900",r.fillText(s,n.x,n.y),r.restore()}},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return!1;if(e.annoName!=this.getName())return 1==this._isPressed&&(this._isPressed=!1,this.imagePoint=null,this._eventHandler.doHandler("update",this._parentID,null,null),!0);if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(e.x&&e.y){this._isPressed=!0;var t={x:e.x,y:e.y};return this.imagePoint=this._imageHelper.clientToImage_point(t),this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY)),!0}}else{if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp)return 1==this._isPressed&&(this._isPressed=!1,this.imagePoint=null),this._eventHandler.doHandler("update",this._parentID,null,null),!0;if((e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove)&&e.x&&e.y&&this._isPressed){t={x:e.x,y:e.y};return this.imagePoint=this._imageHelper.clientToImage_point(t),this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY)),!0}}return!1},t}(FilterBase)),CXeAnnoRect=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"annoRect",t,i,n)||this;a._rects=null,a._currRect=null,a._originalRect=null,a._isLBDown=!1,a._isClicked=!1,a._clickedPoint=null,a._touchDownTime=null,a._selectedDownPoint=null,a._selectedRectIndex=null,a._selectedRectTipsIndex=null,a._selectedHandleIndex=null,a._currentPoint=null,a._rectHandles=null,a._rects=t.imageState.rectStates.rects;var s=a;return a._eventHandler.addHandler("deleteSelected",a,"annoRect",function(){s.deleteSelected()}),a._eventHandler.addHandler("deleteAll",a,"annoRect",function(){s.deleteAll()}),a}return __extends(t,e),Object.defineProperty(t.prototype,"rectCount",{get:function(){return null==this._rects?0:this._rects.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rects",{get:function(){return this._rects},set:function(e){this._rects=e,this._imageHelper.imageState.rectStates.rects=e},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this)},t.prototype.clearSelected=function(){this._isLBDown=!1,this._currRect=null,this._selectedRectIndex=null,this._selectedHandleIndex=null,this._selectedRectTipsIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();this._isLBDown=!0,this._originalRect=new Rect(0,0,0,0);var t={x:e.x,y:e.y};if(this._selectedRectIndex=null,this._selectedRectTipsIndex=null,this._selectedHandleIndex=null,this.hitOnHandle(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(this.hitOnTips(t))return this._currentPoint=t,!0;if(this.hitOnBody(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(e.annoName==this.getName())return this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._currentPoint=null,this._selectedRectTipsIndex=null,e.x&&e.y){if(null!=this._selectedRectIndex)return this._rects[this._selectedRectIndex].normalizeRect(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName())return this._currRect&&(Math.abs(this._currRect.right-this._currRect.left)>=3&&Math.abs(this._currRect.bottom-this._currRect.top)>=3&&(this.rects.push(this._currRect),this._selectedRectIndex=this.rects.length-1,this._imageHelper.needDrawSameImage=!0),this._currRect=null),this._eventHandler.doHandler("update",this._parentID,null,null),!0}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(null!=this._selectedRectIndex){var i=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(this._touchDownTime=(new Date).getTime(),null!=this._selectedHandleIndex)this.moveHandle(this._selectedRectIndex,this._selectedHandleIndex,i);else{var n=i.x-this._selectedDownPoint.x,a=i.y-this._selectedDownPoint.y;this._rects[this._selectedRectIndex].left=this._originalRect.left+n,this._rects[this._selectedRectIndex].top=this._originalRect.top+a,this._rects[this._selectedRectIndex].right=this._originalRect.right+n,this._rects[this._selectedRectIndex].bottom=this._originalRect.bottom+a;var s=e.x-this._currentPoint.x,r=e.y-this._currentPoint.y;this._currentPoint={x:e.x,y:e.y},this._rects[this._selectedRectIndex].tips.moveTips(this._imageHelper,s,r)}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(null!=this._selectedRectTipsIndex){n=e.x-this._currentPoint.x,a=e.y-this._currentPoint.y;return this.rects[this._selectedRectTipsIndex].tips.moveTips(this._imageHelper,n,a),this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}if(null!=this._currentPoint){var o=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),l=this._imageHelper.clientToImage_point(this._currentPoint);return this._currRect=new Rect(l.x,l.y,o.x,o.y),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){this._currRect&&this.drawRect(e,this._currRect,"#57f900",!0);for(var t=0;t<this._rects.length;++t)this.drawRect(e,this.rects[t],"#57f900",t==this._selectedRectIndex)}else this.clearSelected()},t.prototype.hitOnBody=function(e){for(var t=0;t<this._rects.length;++t){var i=this._imageHelper.imageToClient_point(this._rects[t].leftTop),n=this._imageHelper.imageToClient_point(this._rects[t].rightBottom);if(e.x>i.x&&e.x<n.x&&e.y>i.y&&e.y<n.y)return this._selectedRectIndex=t,this._originalRect.left=this._rects[t].left,this._originalRect.top=this._rects[t].top,this._originalRect.right=this._rects[t].right,this._originalRect.bottom=this._rects[t].bottom,!0}return!1},t.prototype.hitOnTips=function(e){this._selectedRectTipsIndex=null;for(var t=0;t<this._rects.length;++t){if(null!=this._rects[t].tips)if(this._rects[t].tips.getClientRect(this._imageHelper).ptInRect(e))return this._selectedRectTipsIndex=t,!0}return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null,this._selectedRectIndex=null;for(var t=0;t<this._rects.length;++t)for(var i=this.getHandles(this.rects[t]),n=0;n<i.length;++n){var a=this._imageHelper.imageToClient_point(i[n]);if(e.x>=a.x-12&&e.x<=a.x+12&&e.y>=a.y-12&&e.y<=a.y+12&&(this._selectedRectIndex=t,this._selectedHandleIndex=n,null!=this._selectedRectIndex))return this._originalRect.left=this._rects[t].left,this._originalRect.top=this._rects[t].top,this._originalRect.right=this._rects[t].right,this._originalRect.bottom=this._rects[t].bottom,!0}return!1},t.prototype.drawRect=function(e,t,i,n){var a=this;if(t){var s=this._imageHelper.imageToClient_point(t.leftTop),r=this._imageHelper.imageToClient_point(t.rightBottom),o=e.getContext("2d",{alpha:!1});if(o.save(),o.strokeStyle=i,o.strokeRect(s.x,s.y,r.x-s.x,r.y-s.y),n)this.getHandles(t).forEach(function(e){var t=a._imageHelper.imageToClient_point(e);o.beginPath(),o.arc(t.x,t.y,12,0,2*Math.PI),o.stroke(),o.closePath()}),o.stroke();o.restore();var l=t.calcTipValue(this._imageHelper.imageData);null==t.tips?t.tips=TipLocation.calcTipLoc(o,this._imageHelper,l,t,this.c_fontHeight,this.c_lineSpacing,10):t.tips.updateTip(o,this._imageHelper,l,this.c_fontHeight,this.c_lineSpacing),TipLocation.drawTip(o,this._imageHelper,t.tips);var h=new Point2d(Math.round(t.left+(t.right-t.left)/2),Math.round(t.top+(t.bottom-t.top)/2));h=this._imageHelper.imageToClient_point(h),TipLocation.drawConnectLine(o,this._imageHelper,t.tips,h)}},t.prototype.deleteSelected=function(){null!=this._selectedRectIndex&&(this._rects.splice(this._selectedRectIndex,1),this._selectedRectIndex=null,this._selectedHandleIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._currRect=null,this._rects.splice(0),this._selectedRectIndex=null,this._selectedHandleIndex=null,this._selectedRectTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null)},t.prototype.getHandles=function(e){var t=new Array;return e&&(t.push({x:e.left,y:e.top}),t.push({x:e.right,y:e.top}),t.push({x:e.right,y:e.bottom}),t.push({x:e.left,y:e.bottom})),t},t.prototype.moveHandle=function(e,t,i){e<0||e>=this._rects.length||(0==t?(this._rects[e].left=i.x,this._rects[e].top=i.y):1==t?(this._rects[e].right=i.x,this._rects[e].top=i.y):2==t?(this._rects[e].right=i.x,this._rects[e].bottom=i.y):3==t&&(this._rects[e].left=i.x,this._rects[e].bottom=i.y))},t}(FilterBase));__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(e){e[e.NONE=0]="NONE",e[e.N=1]="N",e[e.E=2]="E",e[e.S=3]="S",e[e.W=4]="W",e[e.I=5]="I",e[e.O=6]="O"}(HitHandle_Cube||(HitHandle_Cube={}));var COARSE_IMAGE,CCubeFilter=function(e){function t(t,i,n){var a=e.call(this,"cube",t,i,n)||this;return a._cursorStyle="auto",a._hitHandle=0,a._cube=null,a._prevX=0,a._prevY=0,a._eX=0,a._eY=0,a._eZ=0,a._oX=50,a._oY=50,a._mouseDown=!1,a._cube=new Cube(a._oX,a._oY,30),a}return __extends(t,e),t.prototype.procMessage=function(e){return e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown?(this.onMouseDown(e),!0):e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp?(this.onMouseUp(e),!0):(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove)&&(this.onMouseMove(e),!0)},t.prototype.procImage=function(e){e.style.cursor=this._cursorStyle,this._cube.draw(e,this._eX,this._eY,this._eZ)},t.prototype.ptInHandle=function(e,t){return this._cube.ptInHandle(e,t)},t.prototype.ptInRect=function(e,t){return this._cube.ptInRect(e,t)},t.prototype.onMouseDown=function(e){var t=this.ptInHandle(e.x,e.y);2==t?(this._cursorStyle="s-resize",this._hitHandle=HitHandle_Cube.S):1==t?(this._cursorStyle="n-resize",this._hitHandle=HitHandle_Cube.N):3==t?(this._cursorStyle="w-resize",this._hitHandle=HitHandle_Cube.W):4==t?(this._cursorStyle="e-resize",this._hitHandle=HitHandle_Cube.E):1==(t=this.ptInRect(e.x,e.y))?(this._cursorStyle="pointer",this._hitHandle=HitHandle_Cube.I):-1==t?(this._cursorStyle="all-scroll",this._hitHandle=HitHandle_Cube.O):this._cursorStyle="auto",this._prevX=e.x,this._prevY=e.y,this._mouseDown=!0},t.prototype.NormalizVecter=function(e){var t=Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2));Math.abs(t)<.001||(e[0]/=t,e[1]/=t,e[2]/=t)},t.prototype.TrackingBallRotate=function(e,t,i,n,a,s,r,o,l,h){var u=1;l||(u=-1);var d,c=[0,0,0];1==o?d=.866:2==o&&(d=.707);var p=[0,0,0,0];p[0]=e,p[1]=t,p[2]=i,p[3]=n;var g=[0,0];g[0]=Math.sqrt(p[0]*p[0]+p[1]*p[1]),g[1]=Math.sqrt(p[2]*p[2]+p[3]*p[3]);var _=[0,0,0,0,0,0];if(1==o)for(var m=0;m<2;m++)g[m]<d?(_[3*m+0]=p[2*m+0],_[3*m+1]=p[2*m+1],_[3*m+2]=u*Math.sqrt(d*d-g[m]*g[m])):(_[3*m+0]=p[2*m+0]/g[m]*d,_[3*m+1]=p[2*m+1]/g[m]*d,_[3*m+2]=0);else if(2==o){for(m=0;m<2;m++)g[m]<d?(_[3*m+0]=p[3*m+0],_[3*m+1]=p[3*m+1],_[3*m+2]=u*Math.sqrt(d*d-g[m]*g[m])):(_[3*m+0]=p[3*m+0],_[3*m+1]=p[3*m+1],_[3*m+2]=0);if(t==n){var f=[0,t,0];_[0]=_[0]-f[0],_[1]=_[1]-f[1],_[2]=_[2]-f[2],_[3]=_[3]-f[0],_[4]=_[4]-f[1],_[5]=_[5]-f[2]}else{if(e!=i)return;f=[e,0,0];_[0]=_[0]-f[0],_[1]=_[1]-f[1],_[2]=_[2]-f[2],_[3]=_[3]-f[0],_[4]=_[4]-f[1],_[5]=_[5]-f[2]}}c[0]=_[4]*_[2]-_[5]*_[1],c[1]=_[5]*_[0]-_[3]*_[2],c[2]=_[3]*_[1]-_[4]*_[0],this.NormalizVecter(c),(void 0)[0]=c[0]*s[0]+c[1]*r[0]-c[2]*a[0],(void 0)[1]=c[0]*s[1]+c[1]*r[1]-c[2]*a[1],(void 0)[2]=c[0]*s[2]+c[1]*r[2]-c[2]*a[2],this.NormalizVecter(void 0);var y=[0,0];y[0]=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),y[1]=Math.sqrt(_[3]*_[3]+_[4]*_[4]+_[5]*_[5]);var I=Math.acos((_[0]*_[3]+_[1]*_[4]+_[2]*_[5])/y[0]/y[1]);Math.abs(I)<1e-4||this.Rotate(I,void 0,h)},t.prototype.ComputeVerticalVecter=function(e,t,i){i.x=t.y*e.z-t.z*e.y,i.y=t.z*e.x-t.x*e.z,i.z=t.x*e.y-t.y*e.x,this.NormalizVecter(i)},t.prototype.Rotate=function(e,t,i){var n=[0,0,0],a=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2));n[0]=t.x/a,n[1]=t.y/a,n[2]=t.z/a,Math.abs(Math.abs(n[0])-1)<1e-6&&(n[1]+=1e-5);var s,r,o=Math.sqrt(n[1]*n[1]+n[2]*n[2]),l=[1,0,0,0,1,0,0,0,1];l[0][0]=(n[1]*n[1]+n[2]*n[2])/o,l[0][1]=-n[0]*n[1]/o,l[0][2]=-n[0]*n[2]/o,l[1][0]=0,l[1][1]=n[2]/o,l[1][2]=-n[1]/o,l[2][0]=n[0],l[2][1]=n[1],l[2][2]=n[2];var h=Math.cos(e),u=Math.sin(e);r[0][0]=l[0][0]*h-l[1][0]*u,r[0][1]=l[0][0]*u+l[1][0]*h,r[0][2]=l[2][0],r[1][0]=l[0][1]*h-l[1][1]*u,r[1][1]=l[0][1]*u+l[1][1]*h,r[1][2]=l[2][1],r[2][0]=l[0][2]*h-l[1][2]*u,r[2][1]=l[0][2]*u+l[1][2]*h,r[2][2]=l[2][2],s[0][0]=r[0][0]*l[0][0]+r[0][1]*l[1][0]+r[0][2]*l[2][0],s[0][1]=r[0][0]*l[0][1]+r[0][1]*l[1][1]+r[0][2]*l[2][1],s[0][2]=r[0][0]*l[0][2]+r[0][1]*l[1][2]+r[0][2]*l[2][2],s[1][0]=r[1][0]*l[0][0]+r[1][1]*l[1][0]+r[1][2]*l[2][0],s[1][1]=r[1][0]*l[0][1]+r[1][1]*l[1][1]+r[1][2]*l[2][1],s[1][2]=r[1][0]*l[0][2]+r[1][1]*l[1][2]+r[1][2]*l[2][2],s[2][0]=r[2][0]*l[0][0]+r[2][1]*l[1][0]+r[2][2]*l[2][0],s[2][1]=r[2][0]*l[0][1]+r[2][1]*l[1][1]+r[2][2]*l[2][1],s[2][2]=r[2][0]*l[0][2]+r[2][1]*l[1][2]+r[2][2]*l[2][2],i[0][0]=s[0][0]},t.prototype.onMouseMove=function(e){var t=this._cube.ptInHandle(e.x,e.y);2==t?this._cursorStyle="s-resize":1==t?this._cursorStyle="n-resize":3==t?this._cursorStyle="w-resize":4==t?this._cursorStyle="e-resize":(t=this._cube.ptInRect(e.x,e.y),this._cursorStyle=1==t?"pointer":-1==t?"all-scroll":"auto"),this._hitHandle==HitHandle_Cube.S?(this._cursorStyle="s-resize",this._eX=this._prevY<e.y?this._eX-1:this._eX+1):this._hitHandle==HitHandle_Cube.N?(this._cursorStyle="n-resize",this._eX=this._prevY<e.y?this._eX-1:this._eX+1):this._hitHandle==HitHandle_Cube.W?(this._cursorStyle="w-resize",this._eY=this._prevX<e.x?this._eY-1:this._eY+1):this._hitHandle==HitHandle_Cube.E?(this._cursorStyle="e-resize",this._eY=this._prevX<e.x?this._eY+1:this._eY-1):this._hitHandle==HitHandle_Cube.I?(this._cursorStyle="pointer",this._prevX<e.x?this._eY++:this._prevX>e.x&&this._eY--,this._prevY<e.y?this._eX--:this._prevY>e.y&&this._eX++):this._hitHandle==HitHandle_Cube.O&&(this._cursorStyle="all-scroll",this._prevY-e.y>this._prevX-e.x?this._eZ++:this._prevY-e.y<this._prevX-e.x&&this._eZ--),this._prevX=e.x,this._prevY=e.y;var i=Math.PI*this._eX/180,n=Math.PI*this._eY/180,a=Math.PI*this._eZ/180;this._eventHandler.doHandler("getImage3D","imageViewer",i,n,a),this._eventHandler.doHandler("update",this._parentID,null,null)},t.prototype.onMouseUp=function(e){this._mouseDown=!1,this._cursorStyle="auto",this._hitHandle=HitHandle_Cube.NONE},t}(FilterBase),Cube=function(){function e(e,t,i){this._curPosition=0,this._box=[],this._handles=new Array,this._hitHandle=-1,this._oX=0,this._oY=0,this._length=i,this._oX=e,this._oY=t;var n=this._length;this._box=[new Point3d(0,0,0),new Point3d(0,-n,0),new Point3d(n,-n,0),new Point3d(n,0,0),new Point3d(0,0,-n),new Point3d(0,-n,-n),new Point3d(n,-n,-n),new Point3d(n,0,-n)],this.initHandle()}return e.prototype.ptInRect=function(e,t){var i=Math.pow(Math.sqrt(3)*this._length/2,2),n=Math.pow(e-this._oX-this._length/2,2)+Math.pow(t-this._oY-this._length/2,2);return n>=i?-1:n<i?1:0},e.prototype.ptInHandle=function(e,t){for(var i=0;i<this._handles.length;i++){var n=this._handles[i].x,a=this._handles[i].y,s=Math.pow(this._handles[i].r,2);if(Math.pow(e-n,2)+Math.pow(t-a,2)<s)return i+1}return 0},e.prototype.initHandle=function(){var e=this._oX+this._length/2,t=Math.sqrt(3)*this._length/2+this._oY+this._length/2,i=-Math.sqrt(3)*this._length/2+this._oY+this._length/2;this._handles.push({x:e,y:t,r:10}),this._handles.push({x:e,y:i,r:10});var n=this._oY+this._length/2,a=Math.sqrt(3)*this._length/2+this._oX+this._length/2,s=-Math.sqrt(3)*this._length/2+this._oX+this._length/2;this._handles.push({x:a,y:n,r:10}),this._handles.push({x:s,y:n,r:10})},e.prototype.calc=function(e,t,i){for(var n=new Array,a=0;a<8;a++)n.push(new Point3d(0,0,0));for(a=0;a<this._box.length;a++)n[a].x=this._box[a].x,n[a].y=this._box[a].y,n[a].z=this._box[a].z;var s=Math.sin(Math.PI*t/180),r=Math.cos(Math.PI*t/180);for(a=0;a<n.length;a++)n[a].x-=this._length/2,n[a].z+=this._length/2,n[a].y+=this._length/2;for(a=0;a<n.length;a++){var o=n[a].x;n[a].x=o*r+n[a].z*s,n[a].z=-o*s+n[a].z*r}s=Math.sin(Math.PI*e/180),r=Math.cos(Math.PI*e/180);for(a=0;a<n.length;a++){var l=n[a].y;n[a].y=l*r-n[a].z*s,n[a].z=n[a].z*r+l*s}s=Math.sin(Math.PI*i/180),r=Math.cos(Math.PI*i/180);for(a=0;a<n.length;a++){o=n[a].x;n[a].x=o*r-n[a].y*s,n[a].y=o*s+n[a].y*r}for(a=0;a<n.length;a++)n[a].x=n[a].x+this._oX+this._length/2,n[a].y+=this._oY+this._length/2,n[a].z-=this._length/2;return n},e.prototype.drawLine=function(e,t,i){1!=t.isHide&&1!=i.isHide&&(e.moveTo(t.x,t.y),e.lineTo(i.x,i.y))},e.prototype.drawText=function(e,t,i,n,a,s){var r=t.x<a.x?t.x:a.x,o=t.y<i.y?t.y:i.y;r+=Math.abs(t.x-a.x)/2,o+=Math.abs(t.y-i.y)/2;var l=t.y,h=n.y,u=t.x,d=n.x,c=h-l,p=u-d,g=u*(h-l)-l*(d-u);l=i.y;var _=(h=a.y)-l,m=(u=i.x)-(d=a.x),f=u*(h-l)-l*(d-u);if(r=(g*m-p*f)/(c*m-p*_),o=(c*f-g*_)/(c*m-p*_),0==t.isHide&&0==i.isHide&&0==n.isHide&&0==a.isHide){e.save(),e.translate(r,o);var y=Math.atan((t.y-a.y)/(t.x-a.x));y>Math.PI/2&&(y=Math.PI-y),e.rotate(y),e.textAlign="left",e.textBaseline="top",e.fillText(s,0,0),e.restore()}},e.prototype.draw=function(e,t,i,n){var a=e.getContext("2d",{alpha:!1});a.save(),a.strokeStyle="white",a.beginPath();for(var s=this.calc(t,i,n),r=0,o=0;o<s.length;o++)r=r<s[o].z?r:s[o].z;for(o=0;o<s.length;o++)s[o].z.toFixed(0)==r.toFixed(0)&&(s[o].isHide=!0);this.drawLine(a,s[0],s[1]),this.drawLine(a,s[1],s[2]),this.drawLine(a,s[2],s[3]),this.drawLine(a,s[3],s[0]),this.drawLine(a,s[0],s[4]),this.drawLine(a,s[4],s[5]),this.drawLine(a,s[5],s[1]),this.drawLine(a,s[5],s[6]),this.drawLine(a,s[6],s[7]),this.drawLine(a,s[7],s[4]),this.drawLine(a,s[6],s[2]),this.drawLine(a,s[7],s[3]),this.drawText(a,s[0],s[1],s[2],s[3],"front"),this.drawText(a,s[0],s[1],s[5],s[4],"left"),this.drawText(a,s[2],s[3],s[7],s[6],"right"),this.drawText(a,s[0],s[3],s[7],s[4],"bottom"),this.drawText(a,s[1],s[2],s[6],s[5],"top"),this.drawText(a,s[4],s[5],s[6],s[7],"back"),a.stroke(),a.beginPath();var l=Math.sqrt(3)*this._length/2;a.arc(this._oX+this._length/2,this._oY+this._length/2,l,0,2*Math.PI),a.stroke();for(o=0;o<this._handles.length;o++){var h=this._handles[o].x,u=this._handles[o].y;l=this._handles[o].r;a.beginPath(),a.arc(h,u,l,0,2*Math.PI),a.stroke()}a.restore()},e}(),CMoveFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"imageMove",t,i,n)||this;return a._pressPoint=null,a._offRateXSave=0,a._offRateYSave=0,a._needSync=!1,a}return __extends(t,e),t.prototype.procMessage=function(e){if(e.annoName!=this.getName())return this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0),!1;if(this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_INVALID)return this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown)this._pressPoint={x:e.x,y:e.y},this._offRateXSave=this._imageHelper.offRateX,this._offRateYSave=this._imageHelper.offRateY;else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(null==this._pressPoint)return!0;this._imageHelper.offRateX=this._offRateXSave+(e.x-this._pressPoint.x)/this._imageHelper.cellWidth,this._imageHelper.offRateY=this._offRateYSave+(e.y-this._pressPoint.y)/this._imageHelper.cellHeight,this._needSync=!0,this._eventHandler.doHandler("update",this._parentID,null,null)}else e.name!=UIMsg.mouseLBUp&&e.name!=UIMsg.touchUp||(this._pressPoint=null,this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0));return!0},t}(FilterBase)),COverlayFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"overlay",t,i,n)||this;return a._cornerInfo=null,a._lineSpacing=2,a.gapToEdge=2,a.point={x:0,y:0},a}return __extends(t,e),t.prototype.procImage=function(e){if(!(e.width<overlayCheckSize||e.height<overlayCheckSize)&&this._imageHelper.imageState.dispInfo.isShowOverlay){null==this._cornerInfo&&(this._cornerInfo=this.imageData.overlayInfo);var t=this.calcFontHeight(e);null!=this._cornerInfo&&(this.drawText(e,this._cornerInfo.leftTop,CORNER_TYPE.CORNER_TYPE_TOPLEFT,t),this.drawText(e,this._cornerInfo.leftBottom,CORNER_TYPE.CORNER_TYPE_BOTTOMLEFT,t),this.drawText(e,this._cornerInfo.rightTop,CORNER_TYPE.CORNER_TYPE_TOPRIGHT,t),this.drawText(e,this._cornerInfo.rightBottom,CORNER_TYPE.CORNER_TYPE_BOTTOMRIGHT,t))}},t.prototype.drawText=function(e,t,i,n){var a=e.getContext("2d",{alpha:!1});a.save();var s=(t=this.replaceCurrentValues(t)).split("\r\n");a.font=this.calcFontHeight(e).toString()+"px sans-serif",a.strokeStyle="black",a.fillStyle="white",a.textBaseline="top";var r=this.gapToEdge,o=0;if(i==CORNER_TYPE.CORNER_TYPE_BOTTOMLEFT||i==CORNER_TYPE.CORNER_TYPE_BOTTOMRIGHT){i==CORNER_TYPE.CORNER_TYPE_BOTTOMLEFT?a.textAlign="left":(a.textAlign="right",r=e.width-this.gapToEdge),o=e.height-n;for(var l=s.length-1;l>=0;l--)a.strokeText(s[l],r,o),a.fillText(s[l],r,o),o-=n,o-=this._lineSpacing}else{i==CORNER_TYPE.CORNER_TYPE_TOPLEFT?a.textAlign="left":(a.textAlign="right",r=e.width-this.gapToEdge);for(l=0;l<s.length;l++)a.strokeText(s[l],r,o),a.fillText(s[l],r,o),o+=n,o+=this._lineSpacing}a.restore()},t.prototype.replaceCurrentValues=function(e){return e=(e=(e=(e=e.replace("[WW]",this.imageState.windowWidth.toString())).replace("[WL]",this.imageState.windowCenter.toString())).replace("[LEVEL]",this.imageData.getImageLevel().toString())).replace("[ZOOM]",this.imageState.zoom.toString()),void 0===this.imageData.pixelSpacingX||void 0===this.imageData.pixelSpacingY||(e=(e=e.replace("[PIXELSPACING]",this.imageData.pixelSpacingX.toFixed(2).toString()+"x"+this.imageData.pixelSpacingY.toFixed(2).toString())).replace("[FOV]",(this.imageData.pixelSpacingX*this.imageData.widthFull).toFixed(2).toString()+"x"+(this.imageData.pixelSpacingY*this.imageData.heightFull).toFixed(2).toString())),e},t.prototype.calcFontHeight=function(e){var t=20;return(t=e.height>e.width?e.width/40:e.height/40)<=13&&(t=13),t},t}(FilterBase));__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(e){e[e.MAX_WIDTH=128]="MAX_WIDTH",e[e.MAX_HEIGHT=128]="MAX_HEIGHT"}(COARSE_IMAGE||(COARSE_IMAGE={}));var optType,CWWWLFilter=function(e){function t(t,i,n){var a=e.call(this,"ww-wl",t,i,n)||this;return a._isCoarseMode=!1,a._CoarseImageHeight=0,a._CoarseImageWeight=0,a._CoarseImageBuffer=null,a._CoarseRotateMatrix=[1,0,0,1,0,0],a._bigImageCoarseData=null,a._bigImageCoarseSize=new Size(0,0),a._bigImageCoarseHeight=0,a._bigImageCoarseWeight=0,a._bigImageCoarseBuffer=null,a._bigImageCoarseRotateMatrix=[1,0,0,1,0,0],a._lastROI=new Rect(-1,-1,-1,-1),a._pressPoint=null,a._prevPoint=null,a._needShowJPGTip=!1,a._lastMPRJpg=null,a._needSync=!1,a._mapTable=new Uint16Array(65536),a._tableWW=0,a._tableWL=0,a.imageDataFilterTool=new CImageDataFilterTool,a._filterUsingStatus=-1,a}return __extends(t,e),t.prototype.procImage=function(e){var i=this._imageHelper.imageData.getImageLevel();if(i==IMAGE_LEVEL.IMAGE_LEVEL_INVALID?this._imageHelper.isMPRMode()&&null!=this._lastMPRJpg&&(this._imageHelper.calDispMatrix(this._lastMPRJpg.width,this._lastMPRJpg.height),this.drawJPG(e,this._lastMPRJpg,this._imageHelper.rotateMatrix)):i==IMAGE_LEVEL.IMAGE_LEVEL_JPG&&(this._imageHelper.calDispMatrix(this._imageHelper.imageData.getJPG().width,this._imageHelper.imageData.getJPG().height),this.drawJPG(e,this._imageHelper.imageData.getJPG(),this._imageHelper.rotateMatrix),this._imageHelper.isMPRMode()&&(this._lastMPRJpg=this._imageHelper.imageData.getJPG())),i==IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL)if(this._isCoarseMode){if(t.imageCoarseSize.width==this._CoarseImageWeight&&t.imageCoarseSize.height==this._CoarseImageHeight&&null!=this._CoarseImageBuffer||(this._CoarseImageWeight=t.imageCoarseSize.width,this._CoarseImageHeight=t.imageCoarseSize.height,this._CoarseImageBuffer=new Uint8ClampedArray(this._CoarseImageWeight*this._CoarseImageHeight*4)),null!=this._CoarseImageBuffer){if(this._imageHelper.needCalcWW){if(!this.calcWW_linear(this.imageState.windowWidth,this.imageState.windowCenter,t.imageCoarseData,t.imageCoarseSize.width,t.imageCoarseSize.height,this._CoarseImageBuffer))return;this.drawOffCanvas(e,this._CoarseImageBuffer,t.imageCoarseSize.width,t.imageCoarseSize.height)}this.drawImage(e,this._CoarseRotateMatrix,this._imageHelper.needCalcWW),this._imageHelper.needCalcWW=!1}}else if(this.imageData.imageWidth>2560&&this.imageData.imageWidth/2>e.width){var n=this._imageHelper.needCalcWW;if(this._imageHelper.calDispMatrix(this._imageHelper.imageData.imageWidth,this._imageHelper.imageData.imageHeight),!this._lastROI.equal(this._imageHelper.roi)||null==this._bigImageCoarseData){this._lastROI.copy(this._imageHelper.roi);var a=Math.ceil(2*e.width),s=Math.ceil(2*e.height);this._bigImageCoarseData=new Int16Array(a*s),this._imageHelper.offScale=this.genCoarseImageData(a,s,this._bigImageCoarseData,this._bigImageCoarseSize),n=!0}if(null!=this._bigImageCoarseBuffer&&this._bigImageCoarseSize.width==this._bigImageCoarseWeight&&this._bigImageCoarseSize.height==this._bigImageCoarseHeight||(this._bigImageCoarseWeight=this._bigImageCoarseSize.width,this._bigImageCoarseHeight=this._bigImageCoarseSize.height,this._bigImageCoarseBuffer=new Uint8ClampedArray(this._bigImageCoarseWeight*this._bigImageCoarseHeight*4),n=!0),n){if(!this.calcWW_linear(this.imageState.windowWidth,this.imageState.windowCenter,this._bigImageCoarseData,this._bigImageCoarseSize.width,this._bigImageCoarseSize.height,this._bigImageCoarseBuffer))return;this.drawOffCanvas(e,this._bigImageCoarseBuffer,this._bigImageCoarseWeight,this._bigImageCoarseHeight)}this.genCoarseImageRotateMatrix(this._bigImageCoarseSize,this._bigImageCoarseRotateMatrix),this._imageHelper.offCoarseRotateMatrix=this._bigImageCoarseRotateMatrix,this.drawImage(e,this._bigImageCoarseRotateMatrix,n),this._imageHelper.needCalcWW=!1}else{if(this._imageHelper.needCalcWW){var r=new Uint8ClampedArray(this.imageData.imageWidth*this.imageData.imageHeight*4);if(null!=r){if(!this.calcWW_linear(this.imageState.windowWidth,this.imageState.windowCenter,this.imageData.getData(),this.imageData.imageWidth,this.imageData.imageHeight,r))return;this.drawOffCanvas(e,r,this.imageData.imageWidth,this.imageData.imageHeight)}}this._imageHelper.calDispMatrix(this._imageHelper.imageData.imageWidth,this._imageHelper.imageData.imageHeight),this._imageHelper.offScale=1,this._imageHelper.offCoarseRotateMatrix=null,this.drawImage(e,this._imageHelper.rotateMatrix,this._imageHelper.needCalcWW),this._imageHelper.needCalcWW=!1}else if(!this._imageHelper.isMPRMode()&&this._needShowJPGTip){var o=e.getContext("2d",{alpha:!1});o.save();var l=Math.round(e.width/40);l<12&&(l=12),l>16&&(l=16),o.font=l.toString()+"px sans-serif",o.fillStyle="#FF8000",o.textAlign="center",o.textBaseline="top",o.fillText("加载中，请稍后",e.width/2,2),o.restore()}},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&e.name!=UIMsg.mouseRBDown)return this._needSync&&(this._imageHelper.needDrawSerial=!0,this._needSync=!1),!1;if(e.annoName==this.getName()){if(this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_INVALID)return!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown||e.name==UIMsg.mouseRBDown)return this.onXXDown(e),!0;if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove)return this.onXXMove(e),!0;if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp||e.name==UIMsg.mouseRBUp)return this.onXXUp(e),!0}else{if(e.name==UIMsg.mouseRBDown)return this.onXXDown(e),!0;if(e.name==UIMsg.mouseRBUp)return this.onXXUp(e),!0}return!1},t.prototype.onXXDown=function(e){this._imageHelper.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_JPG||this._imageHelper.isMPRMode()?(this._pressPoint={x:e.x,y:e.y},this._prevPoint=this._pressPoint,(this._imageHelper.imageData.imageHeight>1e3||this._imageHelper.imageData.imageWidth>1e3)&&(this.genCoarseImage(COARSE_IMAGE.MAX_WIDTH,COARSE_IMAGE.MAX_HEIGHT,t.imageCoarseData,t.imageCoarseSize,this._CoarseRotateMatrix),this._isCoarseMode=!0,this._imageHelper.needCalcWW=!0)):this._imageHelper.imageData.imageDataTypeId&&"300"==this._imageHelper.imageData.imageDataTypeId&&16==this._imageHelper.imageData.bitsAllocated&&!this._imageHelper.isJPGMode()&&(this._needShowJPGTip=!0,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.onXXMove=function(e){if(null!=this._prevPoint){var t=this.imageState.windowWidth,i=t/1e3;e.ctrlKey?i=t/500:e.shiftKey&&(i=t/3e3),i<1&&(i=1);var n,a;a=(this._prevPoint.y-e.y)*i,n=(e.x-this._prevPoint.x)*i,this._imageHelper.setWW(this._imageHelper.getWW()+n,this._imageHelper.getWL()+a,!1)&&(this._needSync=!0,this._eventHandler.doHandler("update",this._parentID,null,null)),this._prevPoint={x:e.x,y:e.y}}},t.prototype.onXXUp=function(e){this._prevPoint=null,this._isCoarseMode=!1,this._imageHelper.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID&&(this._needShowJPGTip?(this._needShowJPGTip=!1,this._eventHandler.doHandler("update",this._parentID,null,null)):(this._imageHelper.needCalcWW=!0,this._needSync&&(this._imageHelper.needDrawSerial=!0,this._needSync=!1),this._eventHandler.doHandler("update",this._parentID,null,null)))},t.prototype.resetTable=function(e,t){if(e!=this._tableWW||t!=this._tableWL){for(var i=0;i<65536;i++)this._mapTable[i]=0;this._tableWL=t,this._tableWW=e}},t.prototype.calcWW_linear=function(e,t,i,n,a,s){return this.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_JPG||16==this.imageData.bitsAllocated&&(this.imageState.windowWidth=null==e?400:e,this.imageState.windowCenter=null==t?35:t,this.resetTable(this.imageState.windowWidth,this.imageState.windowCenter),"MONOCHROME1"===this.imageData.photoMetricInterpretation?this.calc_imagepixelMONO1(i,n,a,s):this.calc_imagepixelMONO2(i,n,a,s),!0)},t.prototype.calc_imagepixelMONO1=function(e,t,i,n){if(null==e)return!1;var a=this.imageState.windowCenter-this.imageState.windowWidth/2,s=this.imageState.windowCenter+this.imageState.windowWidth/2;if(0==this.imageData.pixelRepresentation)for(var r=0,o=0,l=0;l<i;l++)for(var h=l*t,u=0;u<t;u++)o=4*(h+u),(r=e[h+u]>>>0&65535)<=a?(n[o]=255,n[o+1]=255,n[o+2]=255,n[o+3]=255):r>s?(n[o]=0,n[o+1]=0,n[o+2]=0,n[o+3]=255):65280&this._mapTable[r]?(n[o]=255&this._mapTable[r],n[o+1]=255&this._mapTable[r],n[o+2]=255&this._mapTable[r],n[o+3]=255):(n[o]=255-255*(r-a)/this.imageState.windowWidth,n[o+1]=255-255*(r-a)/this.imageState.windowWidth,n[o+2]=255-255*(r-a)/this.imageState.windowWidth,n[o+3]=255,this._mapTable[r]=65280|n[o]);else for(l=0;l<i;l++)for(h=l*t,u=0;u<t;u++)if(o=4*(h+u),e[h+u]<=a)n[o]=0,n[o+1]=0,n[o+2]=0,n[o+3]=255;else if(e[h+u]>s)n[o]=255,n[o+1]=255,n[o+2]=255,n[o+3]=255;else{var d=e[h+u]>>>0&65535;65280&this._mapTable[d]?(n[o]=255&this._mapTable[d],n[o+1]=255&this._mapTable[d],n[o+2]=255&this._mapTable[d],n[o+3]=255):(n[o]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+1]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+2]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+3]=255,this._mapTable[d]=65280|n[o])}return!0},t.prototype.calc_imagepixelMONO2=function(e,t,i,n){if(null==e)return!1;var a=this.imageState.windowCenter-this.imageState.windowWidth/2,s=this.imageState.windowCenter+this.imageState.windowWidth/2;if(0==this.imageData.pixelRepresentation)for(var r=0,o=0,l=0;l<i;l++)for(var h=l*t,u=0;u<t;u++)o=4*(h+u),(r=e[h+u]>>>0&65535)<=a?(n[o]=0,n[o+1]=0,n[o+2]=0,n[o+3]=255):r>s?(n[o]=255,n[o+1]=255,n[o+2]=255,n[o+3]=255):65280&this._mapTable[r]?(n[o]=255&this._mapTable[r],n[o+1]=255&this._mapTable[r],n[o+2]=255&this._mapTable[r],n[o+3]=255):(n[o]=255*(r-a)/this.imageState.windowWidth,n[o+1]=255*(r-a)/this.imageState.windowWidth,n[o+2]=255*(r-a)/this.imageState.windowWidth,n[o+3]=255,this._mapTable[r]=65280|n[o]);else for(l=0;l<i;l++)for(h=l*t,u=0;u<t;u++)if(o=4*(h+u),e[h+u]<=a)n[o]=0,n[o+1]=0,n[o+2]=0,n[o+3]=255;else if(e[h+u]>s)n[o]=255,n[o+1]=255,n[o+2]=255,n[o+3]=255;else{var d=e[h+u]>>>0&65535;65280&this._mapTable[d]?(n[o]=255&this._mapTable[d],n[o+1]=255&this._mapTable[d],n[o+2]=255&this._mapTable[d],n[o+3]=255):(n[o]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+1]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+2]=255*(e[h+u]-a)/this.imageState.windowWidth,n[o+3]=255,this._mapTable[d]=65280|n[o])}return!0},Object.defineProperty(t.prototype,"hotAreaWidth",{get:function(){if(0==this._imageHelper.cellWidth)return 0;var e=this._imageHelper.cellWidth*t._HotAreaScale;return e>t._MaxHotAreaSize?t._MaxHotAreaSize:e<t._MinHotAreaSize?t._MinHotAreaSize:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hotAreaHeight",{get:function(){if(0==this._imageHelper.cellHeight)return 0;var e=this._imageHelper.cellHeight*t._HotAreaScale;return e>t._MaxHotAreaSize?t._MaxHotAreaSize:e<t._MinHotAreaSize?t._MinHotAreaSize:e},enumerable:!0,configurable:!0}),t.prototype.genCoarseImage=function(e,t,i,n,a){n.height=0,n.width=0,null!=this.imageData.getData()&&(this.genCoarseImageData(e,t,i,n),this.genCoarseImageRotateMatrix(n,a))},t.prototype.genCoarseImageData=function(e,t,i,n){var a=new Rect(0,0,0,0);this._imageHelper.roi.Height<=0||this._imageHelper.roi.Width<=0?(a.right=this.imageData.imageWidth,a.bottom=this.imageData.imageHeight):(a.left=this._imageHelper.roi.left,a.top=this._imageHelper.roi.top,a.right=this._imageHelper.roi.right,a.bottom=this._imageHelper.roi.bottom);var s=new Rect(0,0,e,t),r=new Rect(0,0,0,0);Utility.calcFitWindow(a,s,r);var o=Math.ceil(a.Width/r.Width),l=Math.ceil(a.Height/r.Height),h=Math.max(o,l);o<=1&&l<=1?(h=1,h=1,n.height=a.Height,n.width=a.Width):(n.height=Math.ceil(a.Height/h),n.width=Math.ceil(a.Width/h));for(var u=0,d=a.top;d<a.bottom;d+=h)for(var c=d*this.imageData.imageWidth,p=this.imageData.getData(),g=a.left;g<a.right;g+=h)i[u]=p[c+g],u++;return 1/h},t.prototype.genCoarseImageRotateMatrix=function(e,t){var i,n,a,s=[1,0,0,1,0,0],r=this._imageHelper.roi.Width/e.width,o=(this._imageHelper.roi.Height,e.height,e.width),l=e.height,h=this.imageState.rotateAngle,u=this.imageState.offRateX,d=this.imageState.offRateY,c=this._imageHelper.cellWidth,p=this._imageHelper.cellHeight,g=.5*c,_=.5*p,m=this.imageState.zoom;!this.imageState.isHorzMirror||90!=h&&270!=h||(h=(h+180+360)%360),!this.imageState.isVertMirror||90!=h&&270!=h||(h=(h+180+360)%360),90==h||270==h?(i=c/this.imageData.imageHeight,n=p/this.imageData.imageWidth):(i=c/this.imageData.imageWidth,n=p/this.imageData.imageHeight),m*=i>n?n:i,m*=r,s[4]=g+u*c,s[5]=_+d*p,0==h?(s[4]-=.5*o*m,s[5]-=.5*l*m):90==h?(s[0]=0,s[1]=1,s[2]=-1,s[3]=0,s[4]+=.5*l*m,s[5]-=.5*o*m):180==h?(s[0]=-1,s[1]=0,s[2]=0,s[3]=-1,s[4]+=.5*o*m,s[5]+=.5*l*m):270==h&&(s[0]=0,s[1]=-1,s[2]=1,s[3]=0,s[4]-=.5*l*m,s[5]+=.5*o*m),this.imageState.isHorzMirror&&(s[0]=-s[0],s[2]=-s[2],90==h?s[4]-=m*l:0==h?s[4]+=m*o:180==h?s[4]-=m*o:270==h&&(s[4]+=m*l)),this.imageState.isVertMirror&&(s[1]=-s[1],s[3]=-s[3],90==h?s[5]+=m*o:270==h?s[5]-=m*o:0==h?s[5]+=m*l:180==h&&(s[5]-=m*l)),t[0]=m*s[0],t[1]=m*s[1],t[2]=m*s[2],t[3]=m*s[3],t[4]=0,t[5]=0,a=this._imageHelper.roi.clone(),this._imageHelper.imageToClient_rect(a),t[4]=a.left,t[5]=a.top},t.prototype.PseudoColor=function(e){if(null==this._imageHelper.imageState.dispInfo.pseudoColorMap)return!1;if(e)for(var t=this._imageHelper.imageState.dispInfo.pseudoColorMap,i=e.length/4-1;i>=0;i--){var n=4*i,a=e[n];if(t.has(a)){var s=t.get(a);e[n]=s.R,e[n+1]=s.G,e[n+2]=s.B,e[n+3]=255}}},t.prototype.Inverse=function(e){if(e)for(var t=e.length/4,i=0;i<t;i++){var n=4*i,a=e[n],s=e[n+1],r=e[n+2];e[n]=255-a,e[n+1]=255-s,e[n+2]=255-r}},t.prototype.Sharpen=function(e,t,i){this._imageHelper.imageData.getImageLevel();if(e){this.imageDataFilterTool.convolveFilter(e,[0,-.2,0,-.2,1.8,-.2,0,-.2,0],t,i)}},t.prototype.drawOffCanvas=function(e,t,i,n){this._imageHelper.offCanvas.width=i,this._imageHelper.offCanvas.height=n;var a=this._imageHelper.offCanvas.getContext("2d",{alpha:!1});if(a.clearRect(0,0,i,n),n>1e3){var s=4;n>2e3&&(s=8),n>4e3&&(s=16);for(var r=Math.round(n/s),o=i,l=0;l<s;l++){var h=void 0,u=void 0,d=void 0,c=void 0;l==s-1?(h=0,u=l*r,d=i-1,c=n-1):(h=0,u=l*r,d=o-1,c=(l+1)*r-1);var p=a.createImageData(d-h+1,c-u+1),g=4*(h+u*o),_=4*(d+c*o),m=t.subarray(g,_);p.data.set(m),a.putImageData(p,h,u)}}else{(p=a.createImageData(i,n)).data.set(t),a.putImageData(p,0,0)}},t.prototype.drawImage=function(e,t,i){this.drawPixelFilters(i);var n=e.getContext("2d",{alpha:!1});n.save(),n.fillStyle="black",n.fillRect(0,0,e.width,e.height),n.transform.apply(n,t),n.drawImage(this._imageHelper.offFilterCanvas,0,0),n.restore()},t.prototype.drawImageNoRotate=function(e,t){this.drawPixelFilters(t);var i=e.getContext("2d",{alpha:!1});i.save(),i.fillStyle="black",i.fillRect(0,0,e.width,e.height),i.drawImage(this._imageHelper.offFilterCanvas,0,0),i.restore()},t.prototype.drawPixelFilters=function(e){var t=0;if(this._imageHelper.imageState.dispInfo.enbalePseudoColor&&(t+=1),this._imageHelper.imageState.dispInfo.enbaleInverse&&(t+=2),this._imageHelper.imageState.dispInfo.enbaleSharpen&&(t+=4),t!=this._filterUsingStatus||e){this._filterUsingStatus=t,this._imageHelper.offFilterCanvas.width=this._imageHelper.offCanvas.width,this._imageHelper.offFilterCanvas.height=this._imageHelper.offCanvas.height;var i=this._imageHelper.offCanvas.getContext("2d",{alpha:!1}),n=this._imageHelper.offFilterCanvas.getContext("2d",{alpha:!1}),a=i.getImageData(0,0,this._imageHelper.offCanvas.width,this._imageHelper.offCanvas.height);this._imageHelper.imageState.dispInfo.enbalePseudoColor&&this.PseudoColor(a.data),this._imageHelper.imageState.dispInfo.enbaleInverse&&this.Inverse(a.data),this._imageHelper.imageState.dispInfo.enbaleSharpen&&this.Sharpen(a.data,a.width,a.height),n.putImageData(a,0,0)}},t.prototype.drawJPG=function(e,t,i){this._imageHelper.offCanvas.width=e.width,this._imageHelper.offCanvas.height=e.height;var n=this._imageHelper.offCanvas.getContext("2d",{alpha:!1});n.fillStyle="black",n.fillRect(0,0,this._imageHelper.offCanvas.width,this._imageHelper.offCanvas.height),n.transform.apply(n,i),n.drawImage(t,0,0),this.drawImageNoRotate(e,!0)},t.imageCoarseData=new Int16Array(COARSE_IMAGE.MAX_WIDTH*COARSE_IMAGE.MAX_HEIGHT),t.imageCoarseSize=new Size(0,0),t._MinHotAreaSize=30,t._MaxHotAreaSize=80,t._HotAreaScale=.1,t}(FilterBase),CPageTurn=function(){function e(e,t,i){this._name="pageTurn",this._isLBDown=!1,this._lastPointY=null,this._eventHandler=null,this._parentID="",this._imageHelper=null,this._imageHelper=e,this._eventHandler=t,this._parentID=i}return e.prototype.getName=function(){return this._name},e.prototype.procMessage=function(e){if(e.annoName!=this.getName())return!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown)return this._isLBDown?e.annoName==this.getName():(this._isLBDown=!0,this._lastPointY=e.y,!0);if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(this._isLBDown&&this._lastPointY)return e.y-this._lastPointY>3?(this.pageTurn(1),this._lastPointY=e.y):this._lastPointY-e.y>3&&(this.pageTurn(-1),this._lastPointY=e.y),!0}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp)return this._isLBDown=!1,this._lastPointY=null,!0;return!1},e.prototype.pageTurn=function(e){this._eventHandler.doHandler("pageTurn",this._parentID,e)},e}(),CZoomFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"imageZoom",t,i,n)||this;return a._baseZoom=0,a._touchTwoFingerDistance=-1,a._baseMoveLoc=new Point2d(0,0),a._touchTwoFingerDistanceMoveLimit=350,a._touchMoveDistanceLimit=50,a._lastMoveLoc=null,a._offRateXSave=0,a._offRateYSave=0,a._baseScale=1,a._needSync=!1,a._zoomStart=!1,a}return __extends(t,e),t.prototype.procMessage=function(e){if(e.annoName!=this.getName())return this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0),!1;if(this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_INVALID)return this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0),!1;var t=!1;if(e.name==UIMsg.mouseWheel)e.wheelDelta&&(e.wheelDelta>0?this._imageHelper.zoom+=.1:this._imageHelper.zoom-=.1,this._imageHelper.zoom<.1?this._imageHelper.zoom=.1:this._imageHelper.zoom>10&&(this._imageHelper.zoom=10),t=!0,this._imageHelper.needDrawSerial=!0);else if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown)this._zoomStart=!0,this._lastMoveLoc={x:e.x,y:e.y};else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._zoomStart)return!1;var i=-(e.y-this._lastMoveLoc.y)/500;this._imageHelper.zoom>1&&(i*=this._imageHelper.zoom),this._imageHelper.zoom+=i,this._imageHelper.zoom<.1?this._imageHelper.zoom=.1:this._imageHelper.zoom>10&&(this._imageHelper.zoom=10),t=!0,this._lastMoveLoc={x:e.x,y:e.y}}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp)this._zoomStart=!1,this._lastMoveLoc=null,this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0);else if(e.name==UIMsg.touchZoom){if(!this._zoomStart)return!1;if((this._touchTwoFingerDistance<0||Math.abs(e.scale-this._baseScale)>.12)&&this._baseZoom>0)this._imageHelper.zoom=this._baseZoom*e.scale,this._touchTwoFingerDistance=-1;else{if(this._baseZoom>0)Math.sqrt((this._baseMoveLoc.x-e.x)*(this._baseMoveLoc.x-e.x)+(this._baseMoveLoc.y-e.y)*(this._baseMoveLoc.y-e.y))>this._touchMoveDistanceLimit&&(this._baseZoom=0);this._imageHelper.offRateX=this._offRateXSave+(e.x-this._lastMoveLoc.x)/this._imageHelper.cellWidth,this._imageHelper.offRateY=this._offRateYSave+(e.y-this._lastMoveLoc.y)/this._imageHelper.cellHeight}t=!0}else e.name==UIMsg.touchZoomStart?(this._zoomStart=!0,this._baseZoom=this._imageHelper.zoom,this._baseMoveLoc.x=e.x,this._baseMoveLoc.y=e.y,e.twoFingerDistance>this._touchTwoFingerDistanceMoveLimit?this._touchTwoFingerDistance=-1:(this._touchTwoFingerDistance=e.twoFingerDistance,this._baseScale=e.scale,this._lastMoveLoc={x:e.x,y:e.y},this._offRateXSave=this._imageHelper.offRateX,this._offRateYSave=this._imageHelper.offRateY)):e.name==UIMsg.touchZoomEnd&&(this._zoomStart=!1,this._baseZoom=0,this._touchTwoFingerDistance=-1,this._lastMoveLoc=null,this._needSync&&(this._needSync=!1,this._imageHelper.needDrawSerial=!0));return t&&(this._needSync=!0,this._eventHandler.doHandler("update",this._parentID,null,null)),!0},t}(FilterBase)),COrientationFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"orientationFilter",t,i,n)||this;return a._direction=new Array,a._inited=!1,a}return __extends(t,e),t.prototype.procImage=function(e){if(!(e.width<overlayCheckSize||e.height<overlayCheckSize||void 0==this._imageHelper.imageData.imageOrientation||this._imageHelper.imageData.imageOrientation.indexOf("\\")<0)){this.initOri(this._imageHelper.imageData.imageOrientation);var t=new Array;t.push(new Point2d(-1,0)),t.push(new Point2d(0,1));for(var i="left",n="",a=0;a<2;a++)this.dirClient2Image(t[a]),n=this.getOriText(t[a]),0==a?i="left":1==a&&(i="bottom"),this.drawText(e,n,i)}},t.prototype.drawText=function(e,t,i){var n=e.getContext("2d",{alpha:!1});n.save(),n.strokeStyle="black",n.fillStyle="white",n.textBaseline="top",n.font="20px sans-serif";var a=null,s=null;"left"==i&&(a=5,s=e.height/2,n.textAlign="left"),"bottom"==i&&(a=e.width/2,s=e.height-25,n.textAlign="center"),null!=a&&null!=s&&(n.strokeText(t,a,s),n.fillText(t,a,s)),n.restore()},t.prototype.initOri=function(e){if(!(this._inited||void 0==this._imageHelper.imageData.imageOrientation||e.indexOf("\\")<0)){var t=e.split("\\");if(6==t.length){for(var i=0;i<2;i++){this._direction.push(new Array);for(var n=0;n<3;n++)this._direction[i].push(parseFloat(t[3*i+n]))}this._inited=!0}}},t.prototype.dirClient2Image=function(e){var t=this._imageHelper.imageState.rotateAngle;t>=360?t%=360:t<0&&(t=t/360+360),!this._imageHelper.imageState.isHorzMirror||90!=t&&270!=t||(t=(t+180+360)%360),!this._imageHelper.imageState.isVertMirror||90!=t&&270!=t||(t=(t+180+360)%360),this._imageHelper.imageState.isHorzMirror&&(e.x=-e.x),this._imageHelper.imageState.isVertMirror&&(e.y=-e.y);var i=new Point2d(e.x,e.y);switch(t){case 0:i.x=e.x,i.y=e.y;break;case 90:i.x=e.y,i.y=-e.x;break;case 180:i.x=-e.x,i.y=-e.y;break;case 270:i.x=-e.y,i.y=e.x}e.x=i.x,e.y=i.y},t.prototype.getOriText=function(e){var t=[["L","R"],["P","A"],["H","F"]],i=-1,n=-1;if(0==e.x)i=1,n=e.y;else{if(0!=e.y)return null;i=0,n=e.x}var a=new Array;a.push({ori:null,oriText:""}),a.push({ori:null,oriText:""}),a.push({ori:null,oriText:""});for(var s=0;s<3;s++)a[s].ori=this._direction[i][s],this._direction[i][s]<-.1&&(a[s].oriText=n>0?t[s][1]:t[s][0]),this._direction[i][s]>.1&&(a[s].oriText=n>0?t[s][0]:t[s][1]);a.sort(function(e,t){return Math.abs(e.ori)>Math.abs(t.ori)?-1:Math.abs(e.ori)<Math.abs(t.ori)?1:0});var r=a[0].oriText+a[1].oriText+a[2].oriText;return""!=r?"["+r+"]":""},t}(FilterBase)),CPositionLineFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"positionLine",t,i,n)||this;return a._lines=new Array,a._isLocalizer=!1,a._isInited=!1,void 0!=t.imageData.imageType&&(a.Init(t),a._isInited=!0),a}return __extends(t,e),t.prototype.Init=function(e){var t=this;this._isLocalizer=this._imageHelper.isLocalizerImage(),this._eventHandler.addHandler("showPositionLine",this,"LOCALIZER",function(e){t._lines.splice(0),e.length>0&&e.forEach(function(e){if(null!=e){var i=t.calcPosLine(t._imageHelper.imageData,e);null!=i&&2==i.length&&t._lines.push({startPoint:i[0],endPoint:i[1]})}}),t._eventHandler.doHandler("update",t._parentID)}),this._eventHandler.addHandler("clearPositionLine",this,"LOCALIZER",function(){t._lines.length>0&&(t._lines.splice(0),t._eventHandler.doHandler("update",t._parentID))})},t.prototype.clear=function(){this._eventHandler.removeHandler("showPositionLine",this),this._eventHandler.removeHandler("clearPositionLine",this)},t.prototype.procImage=function(e){var t=this;if(CImageDrawerManager.GetInstance().showPositionLine&&!(e.width<overlayCheckSize||e.height<overlayCheckSize)){this._isInited||void 0==this._imageHelper.imageData.imageType||(this.Init(this._imageHelper),this._isInited=!0);var i=e.getContext("2d",{alpha:!1});i.save(),i.translate(.5,.5),this._isLocalizer&&(i.font="14px sans-serif",i.fillStyle="#fff",i.textAlign="center",i.textBaseline="middle",i.fillText("定位图",100,100)),i.strokeStyle="yellow",i.lineWidth=1,this._lines.forEach(function(e){var n=t._imageHelper.imageToClient_point(e.startPoint),a=t._imageHelper.imageToClient_point(e.endPoint);i.beginPath(),i.moveTo(Math.floor(n.x),Math.floor(n.y)),i.lineTo(Math.floor(a.x),Math.floor(a.y)),i.stroke()}),i.restore()}},t.prototype.procMessage=function(e){return!1},t.prototype.calcPosLine=function(e,t){if(void 0==e.imagePosition||""==e.imagePosition||void 0==e.imageOrientation||""==e.imageOrientation||void 0==t.imagePosition||""==t.imagePosition||void 0==t.imageOrientation||""==t.imageOrientation)return null;var i=e.imageType,n=t.imageType;if(null==i||null==n)return null;if(i.indexOf("DERIVED")>=0||n.indexOf("DERIVED")>=0)return null;var a=e.imagePosition.split("\\"),s=e.imageOrientation.split("\\"),r=t.imagePosition.split("\\"),o=t.imageOrientation.split("\\"),l=parseFloat(s[1])*parseFloat(s[5])-parseFloat(s[2])*parseFloat(s[4]),h=parseFloat(s[2])*parseFloat(s[3])-parseFloat(s[0])*parseFloat(s[5]),u=parseFloat(s[0])*parseFloat(s[4])-parseFloat(s[1])*parseFloat(s[3]),d=l*parseFloat(a[0])+h*parseFloat(a[1])+u*parseFloat(a[2]),c=parseFloat(o[1])*parseFloat(o[5])-parseFloat(o[2])*parseFloat(o[4]),p=parseFloat(o[2])*parseFloat(o[3])-parseFloat(o[0])*parseFloat(o[5]),g=parseFloat(o[0])*parseFloat(o[4])-parseFloat(o[1])*parseFloat(o[3]);if(Math.abs(l-c)<.1&&Math.abs(h-p)<.1&&Math.abs(u-g)<.1||Math.abs(l+c)<.1&&Math.abs(h+p)<.1&&Math.abs(u+g)<.1)return null;var _=t.widthFull*t.pixelSpacingX,m=t.heightFull*t.pixelSpacingY,f=[];f.push({x:parseFloat(r[0]),y:parseFloat(r[1]),z:parseFloat(r[2]),m:parseFloat(o[0]),n:parseFloat(o[1]),p:parseFloat(o[2])}),f.push({x:parseFloat(r[0]),y:parseFloat(r[1]),z:parseFloat(r[2]),m:parseFloat(o[3]),n:parseFloat(o[4]),p:parseFloat(o[5])}),f.push({x:parseFloat(r[0])+_*parseFloat(o[0])+m*parseFloat(o[3]),y:parseFloat(r[1])+_*parseFloat(o[1])+m*parseFloat(o[4]),z:parseFloat(r[2])+_*parseFloat(o[2])+m*parseFloat(o[5]),m:parseFloat(o[0]),n:parseFloat(o[1]),p:parseFloat(o[2])}),f.push({x:parseFloat(r[0])+_*parseFloat(o[0])+m*parseFloat(o[3]),y:parseFloat(r[1])+_*parseFloat(o[1])+m*parseFloat(o[4]),z:parseFloat(r[2])+_*parseFloat(o[2])+m*parseFloat(o[5]),m:parseFloat(o[3]),n:parseFloat(o[4]),p:parseFloat(o[5])});for(var y=[],I=0;I<f.length;I++){var x=[[l,h,u,d],[0,0,0,0],[0,0,0,0]];if(this.getLineMatrix(f[I],x)){if(!this.gaussElimination(x))continue;if(Math.abs(x[2][2])<1e-6)continue;var w=x[2][3]/x[2][2],D=(x[1][3]-w*x[1][2])/x[1][1],P=(x[0][3]-D*x[0][1]-w*x[0][2])/x[0][0],v=new Point3d(P,D,w);if(this.pointInImage(t,v)){for(var S=!1,C=0;C<y.length;C++)if(y[C].x==v.x&&y[C].y==v.y&&y[C].z==v.z){S=!0;break}S||y.push(v)}}}if(2!=y.length)return null;var M=[];for(I=0;I<2;I++){var b=y[I].x-parseFloat(a[0]),A=y[I].y-parseFloat(a[1]),L=y[I].z-parseFloat(a[2]),R=(P=b*parseFloat(s[0])+A*parseFloat(s[1])+L*parseFloat(s[2]),b*parseFloat(s[3])+A*parseFloat(s[4])+L*parseFloat(s[5])),H=new Point2d(P/e.pixelSpacingY+.5,R/e.pixelSpacingX+.5);M.push(H)}return M},t.prototype.getLineMatrix=function(e,t){var i=parseInt(Math.abs(e.m).toFixed(0)),n=parseInt(Math.abs(e.n).toFixed(0)),a=parseInt(Math.abs(e.p).toFixed(0));return(0!=i||0!=n||0!=a)&&(t[1][0]=e.n,t[1][1]=-e.m,t[1][2]=0,t[1][3]=e.n*e.x-e.m*e.y,t[2][0]=0,t[2][1]=e.p,t[2][2]=-e.n,t[2][3]=e.p*e.y-e.n*e.z,0==i&&0==n?(t[1][0]=1,t[1][1]=0,t[1][2]=0,t[1][3]=e.x,t[2][0]=0,t[2][1]=1,t[2][2]=0,t[2][3]=e.y):0==i&&0==a?(t[1][0]=1,t[1][1]=0,t[1][2]=0,t[1][3]=e.x,t[2][0]=0,t[2][1]=0,t[2][2]=1,t[2][3]=e.z):0==n&&0==a?(t[1][0]=0,t[1][1]=1,t[1][2]=0,t[1][3]=e.y,t[2][0]=0,t[2][1]=0,t[2][2]=1,t[2][3]=e.z):0==i?(t[1][0]=0,t[1][1]=e.p,t[1][2]=-e.n,t[1][3]=e.p*e.y-e.n*e.z,t[2][0]=1,t[2][1]=0,t[2][2]=0,t[2][3]=e.x):0==n?(t[1][0]=e.p,t[1][1]=0,t[1][2]=-e.m,t[1][3]=e.p*e.x-e.m*e.z,t[2][0]=0,t[2][1]=1,t[2][2]=0,t[2][3]=e.y):0==a&&(t[1][0]=e.n,t[1][1]=-e.m,t[1][2]=0,t[1][3]=e.n*e.x-e.m*e.y,t[2][0]=0,t[2][1]=0,t[2][2]=1,t[2][3]=e.z),!0)},t.prototype.gaussElimination=function(e){for(var t=e.length,i=e[0].length,n=0;n<t-1;n++){for(var a=Math.abs(e[n][n]),s=-1,r=n;r<t;r++)Math.abs(e[r][n])>a&&(s=r,a=Math.abs(e[r][n]));if(s>0)for(r=n;r<i;r++){var o=e[s][r];e[s][r]=e[n][r],e[n][r]=o}var l=e[n][n];if(Math.abs(l)<1e-6)return!1;var h=e[n];for(r=n+1;r<t;r++){var u=e[r],d=u[n];if(!(Math.abs(d)<1e-6))for(var c=n;c<i;c++)u[c]=(u[c]*l-h[c]*d)/d}}return!0},t.prototype.pointInImage=function(e,t){var i=e.imagePosition.split("\\"),n=e.imageOrientation.split("\\"),a=(parseFloat(n[1]),parseFloat(n[5]),parseFloat(n[2]),parseFloat(n[4]),parseFloat(n[2]),parseFloat(n[3]),parseFloat(n[0]),parseFloat(n[5]),parseFloat(n[0]),parseFloat(n[4]),parseFloat(n[1]),parseFloat(n[3]),t.x-parseFloat(i[0])),s=t.y-parseFloat(i[1]),r=t.z-parseFloat(i[2]),o=a*parseFloat(n[0])+s*parseFloat(n[1])+r*parseFloat(n[2]),l=a*parseFloat(n[3])+s*parseFloat(n[4])+r*parseFloat(n[5]),h=new Point2d(o/e.pixelSpacingY+.5,l/e.pixelSpacingX+.5);return!!new Rect(-1,-1,e.widthFull+1,e.heightFull+1).ptInRect(h)},t}(FilterBase)),CRulerFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"rulerFilter",t,i,n)||this;return a._supportRuler=!1,a._leftMode=!0,Math.abs(a._imageHelper.imageData.pixelSpacingX)>1e-10&&Math.abs(a._imageHelper.imageData.pixelSpacingY)>1e-10&&(a._supportRuler=!0),a}return __extends(t,e),t.prototype.procImage=function(e){e.width<overlayCheckSize||e.height<overlayCheckSize||(0==this._supportRuler&&Math.abs(this._imageHelper.imageData.pixelSpacingX)>1e-10&&Math.abs(this._imageHelper.imageData.pixelSpacingY)>1e-10&&(this._supportRuler=!0),0!=this._supportRuler&&this._imageHelper.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID&&this.drawRulerVert(e))},t.prototype.drawRulerVert=function(e){var t=new Array;t.push(this._imageHelper.clientToImage_point({x:0,y:0})),t.push(this._imageHelper.clientToImage_point({x:0,y:e.height}));var i=Math.abs(t[1].x-t[0].x),n=Math.abs(t[1].y-t[0].y),a=(0!=i?i*this._imageHelper.imageData.pixelSpacingX:n*this._imageHelper.imageData.pixelSpacingY)/e.height;if(!(a>10)){var s=Math.round(e.height*a/2),r=Math.round(s/10),o=10*r/a,l=(o=Math.round(o+.5))/r,h=new Rect(0,0,e.width,e.height),u=e.getContext("2d",{alpha:!1});u.save(),u.translate(.5,.5),u.strokeStyle="black",u.lineWidth=3,this.drawRulerVert_(u,h,o,r,l),u.strokeStyle="white",u.lineWidth=1,this.drawRulerVert_(u,h,o,r,l),u.font=this.calcFontHeight(h).toString()+"px sans-serif",u.strokeStyle="black",u.fillStyle="white",u.textBaseline="top",this._leftMode?u.textAlign="left":u.textAlign="right";var d=r.toString()+"cm",c=h.right-5;this._leftMode&&(c=5);var p=h.bottom-(h.Height-o)/2+2;u.strokeText(d,c,p),u.fillText(d,c,p),u.restore()}},t.prototype.drawRulerVert_=function(e,t,i,n,a){var s=t.right-5;this._leftMode&&(s=5);for(var r=t.top+(t.Height-i)/2,o=Math.round(Math.sqrt(t.Width*t.Height)/50),l=2*o,h=0;h<=n;h++){var u=o;h%5==0&&(u=l);var d=r+h*a;e.beginPath(),e.moveTo(s,d),this._leftMode?e.lineTo(s+u,d):e.lineTo(s-u,d),e.stroke()}e.beginPath(),e.moveTo(s,r),e.lineTo(s,r+i),e.stroke()},t.prototype.calcFontHeight=function(e){var t=20;return(t=e.Height>e.Width?e.Width/40:e.Height/40)<=13&&(t=13),t},t}(FilterBase)),CIVRFilter=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"vr",t,i,n)||this;return a._isLBDown=!1,a._isRBDown=!1,a._basePt=new Point2d(0,0),a}return __extends(t,e),t.prototype.procImage=function(e){},t.prototype.procMessage=function(e){if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return!0;if(e.annoName.length>0&&"ww-wl"==e.annoName){if(this._isRBDown)return!0;this._isRBDown=!0}else{if(this._isLBDown)return!0;this._isLBDown=!0}return this._basePt={x:e.x,y:e.y},!0}if(e.name==UIMsg.mouseRBDown)return!!this._isRBDown||(this._basePt={x:e.x,y:e.y},this._isRBDown=!0,!0);if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.mouseRBUp||e.name==UIMsg.touchUp)return this._isLBDown=!1,this._isRBDown=!1,!0;if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._isLBDown&&!this._isRBDown)return!1;var t={x:e.x,y:e.y};if(!this.needRefreshJpg(t))return!1;if(this._isLBDown){if(this.doRefreshEye(t))return!0}else if(this._isRBDown&&this.doRefreshOpacity(t))return!0;return!1}return!1},t.prototype.doRefreshEye=function(e){return!!this.calcNewVRPos(e)&&(this._basePt=e,this._eventHandler.doHandler("updateVRJpg",this._parentID),!0)},t.prototype.doRefreshOpacity=function(e){return!!this.calcNewVROpacity(e)&&(this._basePt=e,this._eventHandler.doHandler("updateVRJpg",this._parentID),!0)},t.prototype.calcNewVRPos=function(e){var t=new Array(9),i=this._imageHelper.cellHeight,n=this._imageHelper.cellWidth,a=Math.min(i,n)/2,s=(this._basePt.x-n/2)/a,r=-(i/2-this._basePt.y)/a,o=(e.x-n/2)/a,l=-(i/2-e.y)/a;if(!Utility.TBRotate(s,r,o,l,this._imageHelper.imageState.vrState.eyeRay,this._imageHelper.imageState.vrState.yAxis,t))return!1;var h=new Point3d(0,0,0);Utility.Matrix33MultiVector3_32f(t,this._imageHelper.imageState.vrState.eyeRay,h);var u=new Point3d(0,0,0);return Utility.Matrix33MultiVector3_32f(t,this._imageHelper.imageState.vrState.yAxis,u),this.imageState.vrState.eyeRay=h,this.imageState.vrState.yAxis=u,!0},t.prototype.calcNewVROpacity=function(e){var t=3e-6*(e.x-this._basePt.x),i=.001*(e.y-this._basePt.y),n=this.imageState.vrState.getVRParam(),a=n.opa_x2-n.opa_x1,s=n.opa_x3-n.opa_x1,r=n.opa_x4-n.opa_x1,o=Utility.BOUND_VALUE(n.opa_x1+t,0,1-a);return n.opa_x1=o,n.opa_x2=o+a,n.opa_x3=o+s,n.opa_x4=o+r,n.opa_height=Utility.BOUND_VALUE(n.opa_height-i,.05,1),this.imageState.vrState.setVRParam(n,!1),!0},t.prototype.needRefreshJpg=function(e){var t=Math.abs(e.x-this._basePt.x),i=Math.abs(e.y-this._basePt.y);return t>5||i>5},t}(FilterBase)),MPRLine=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(){return function(){}}());!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.KEY_MOVE=1]="KEY_MOVE",e[e.LINE_ROTATE=2]="LINE_ROTATE",e[e.LINE_MOVE=3]="LINE_MOVE",e[e.PAGE_TURN=4]="PAGE_TURN",e[e.OPR_ROTATE=5]="OPR_ROTATE"}(optType||(optType={}));var IMAGE_LEVEL,MinStep=3,CMPRFilter=function(e){function t(t,i,n){var a=e.call(this,"mpr",t,i,n)||this;return a._isLBDown=!1,a._hitRadiusLimit=10,a._hitBodyLimit=10,a._hitRotateLimit=5,a._prePt=null,a._PlanumLineColor_T="#66cd00",a._PlanumLineColor_S="#ff8c00",a._PlanumLineColor_C="#ff0000",a._PlanumLineColor_O="#ffff00",a._isShowPosLine=!0,a._mprData=null,a._ptStart=null,a._ptLast=null,a._curOptType=optType.UNKNOWN,a._curOptPlanum="",a._BaseState=null,a._Lines=new Map,a._eventHandler.addHandler("showPositionLine",a,"LOCALIZER",function(e){a._isShowPosLine||(a._isShowPosLine=!0,a._eventHandler.doHandler("update",a._parentID))}),a._eventHandler.addHandler("clearPositionLine",a,"LOCALIZER",function(){a._isShowPosLine&&(a._isShowPosLine=!1,a._eventHandler.doHandler("update",a._parentID))}),a._mprData=CDicomDataManager.GetInstance(a._imageHelper.connKey).getMPRInfo(a.imageData.xeGuid,a.imageData.seriesIndex),a}return __extends(t,e),t.prototype.setImagePoint=function(e){"t"==this._imageHelper.mprPlanum?(this._imageHelper.imageState.mprX=e.x,this._imageHelper.imageState.mprY=e.y):"s"==this._imageHelper.mprPlanum?(this._imageHelper.imageState.mprY=e.x,this._imageHelper.imageState.mprZ=e.y):"c"==this._imageHelper.mprPlanum&&(this._imageHelper.imageState.mprX=e.x,this._imageHelper.imageState.mprZ=e.y)},t.prototype.getImagePoint=function(){var e;return"t"==this._imageHelper.mprPlanum?e=new Point2d(this._imageHelper.imageState.mprX,this._imageHelper.imageState.mprY):"s"==this._imageHelper.mprPlanum?e=new Point2d(this._imageHelper.imageState.mprY,this._imageHelper.imageState.mprZ):"c"==this._imageHelper.mprPlanum&&(e=new Point2d(this._imageHelper.imageState.mprX,this._imageHelper.imageState.mprZ)),e},t.prototype.procImage=function(e){this.procImg(e)},t.prototype.procMessage=function(e){return this.procMsg(e)},t.prototype.drawBorder=function(e){var t;"t"==this._imageHelper.mprPlanum?t=this._PlanumLineColor_T:"s"==this._imageHelper.mprPlanum?t=this._PlanumLineColor_S:"c"==this._imageHelper.mprPlanum?t=this._PlanumLineColor_C:"o"==this._imageHelper.mprPlanum&&(t=this._PlanumLineColor_O);var i=e.getContext("2d",{alpha:!1});i.save(),i.strokeStyle=t,i.lineWidth=2,i.strokeRect(0,0,e.width,e.height),i.restore()},t.prototype.drawCross=function(e){var t,i,n=this._imageHelper.imageToClient_point(this.getImagePoint());"t"==this._imageHelper.mprPlanum?(t=this._PlanumLineColor_C,i=this._PlanumLineColor_S):"s"==this._imageHelper.mprPlanum?(t=this._PlanumLineColor_T,i=this._PlanumLineColor_C):"c"==this._imageHelper.mprPlanum&&(t=this._PlanumLineColor_T,i=this._PlanumLineColor_S);var a=e.getContext("2d",{alpha:!1});a.save(),a.strokeStyle=t,a.beginPath(),a.moveTo(0,n.y),a.lineTo(n.x-this._hitRadiusLimit,n.y),a.moveTo(n.x+this._hitRadiusLimit,n.y),a.lineTo(e.width,n.y),a.stroke(),a.restore(),a.save(),a.strokeStyle=i,a.beginPath(),a.moveTo(n.x,0),a.lineTo(n.x,n.y-this._hitRadiusLimit),a.moveTo(n.x,n.y+this._hitRadiusLimit),a.lineTo(n.x,e.height),a.stroke(),a.restore()},t.prototype.hitOnBody=function(e){var t=this._imageHelper.imageToClient_point(this.getImagePoint());return new Rect(t.x-this._hitRadiusLimit,t.y-this._hitRadiusLimit,t.x+this._hitRadiusLimit,t.y+this._hitRadiusLimit).ptInRect(e)},t.prototype.procImg=function(e){null!=this._mprData&&(CImageDrawerManager.GetInstance().showPositionLine?(this._isShowPosLine=!0,this.drawBorder(e),"o"!=this._imageHelper.mprPlanum&&this.DrawAllLines(e)):this._isShowPosLine=!1)},t.prototype.procMsg=function(e){if(e.annoName.length>0&&"ww-wl"!=e.annoName&&"pageTurn"!=e.annoName)return!1;if("o"!=this._imageHelper.mprPlanum&&!CImageDrawerManager.GetInstance().showPositionLine)return this._isShowPosLine=!1,!1;if(this._isShowPosLine=!0,(!(this._imageHelper.imageData.getImageLevel()<=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)||this._imageHelper.isMPRMode())&&!(this._imageHelper.imageData.getImageLevel()<=IMAGE_LEVEL.IMAGE_LEVEL_INVALID&&this._imageHelper.isMPRMode()&&e.name!=UIMsg.mouseLBUp&&e.name!=UIMsg.touchUp)){if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return!0;var t={x:e.x,y:e.y};if("o"==this._imageHelper.mprPlanum)this._curOptType=optType.OPR_ROTATE,this._ptStart=t;else if(this.IsOnKeyPoint(t)){this._curOptType=optType.KEY_MOVE,this._ptStart=t,this._curOptPlanum="";var i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);var a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s),this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone(),basekey2d:s}}else if(this.IsOnLineRotate(this._Lines.get("t"),t)){this._curOptType=optType.LINE_ROTATE,this._ptStart=t,this._curOptPlanum="t";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);var r=this.CalculateAngle(t,s);this._BaseState={baseBaseEyeRay:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaEyeRay.clone(),baseBaseYAxis:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaYAxis.clone(),baseTEyeRay:this._mprData.getImageData("t").dynaEyeRay.clone(),baseTYAxis:this._mprData.getImageData("t").dynaYAxis.clone(),baseSEyeRay:this._mprData.getImageData("s").dynaEyeRay.clone(),baseSYAxis:this._mprData.getImageData("s").dynaYAxis.clone(),baseCEyeRay:this._mprData.getImageData("c").dynaEyeRay.clone(),baseCYAxis:this._mprData.getImageData("c").dynaYAxis.clone(),baseOEyeRay:this._mprData.getImageData("o").dynaEyeRay.clone(),baseOYAxis:this._mprData.getImageData("o").dynaYAxis.clone(),basekey2d:s,baseStartAngle:r}}else if(this.IsOnLineRotate(this._Lines.get("s"),t)){this._curOptType=optType.LINE_ROTATE,this._ptStart=t,this._curOptPlanum="s";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);r=this.CalculateAngle(t,s);this._BaseState={baseBaseEyeRay:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaEyeRay.clone(),baseBaseYAxis:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaYAxis.clone(),baseTEyeRay:this._mprData.getImageData("t").dynaEyeRay.clone(),baseTYAxis:this._mprData.getImageData("t").dynaYAxis.clone(),baseSEyeRay:this._mprData.getImageData("s").dynaEyeRay.clone(),baseSYAxis:this._mprData.getImageData("s").dynaYAxis.clone(),baseCEyeRay:this._mprData.getImageData("c").dynaEyeRay.clone(),baseCYAxis:this._mprData.getImageData("c").dynaYAxis.clone(),baseOEyeRay:this._mprData.getImageData("o").dynaEyeRay.clone(),baseOYAxis:this._mprData.getImageData("o").dynaYAxis.clone(),basekey2d:s,baseStartAngle:r}}else if(this.IsOnLineRotate(this._Lines.get("c"),t)){this._curOptType=optType.LINE_ROTATE,this._ptStart=t,this._curOptPlanum="c";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);r=this.CalculateAngle(t,s);this._BaseState={baseBaseEyeRay:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaEyeRay.clone(),baseBaseYAxis:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaYAxis.clone(),baseTEyeRay:this._mprData.getImageData("t").dynaEyeRay.clone(),baseTYAxis:this._mprData.getImageData("t").dynaYAxis.clone(),baseSEyeRay:this._mprData.getImageData("s").dynaEyeRay.clone(),baseSYAxis:this._mprData.getImageData("s").dynaYAxis.clone(),baseCEyeRay:this._mprData.getImageData("c").dynaEyeRay.clone(),baseCYAxis:this._mprData.getImageData("c").dynaYAxis.clone(),baseOEyeRay:this._mprData.getImageData("o").dynaEyeRay.clone(),baseOYAxis:this._mprData.getImageData("o").dynaYAxis.clone(),basekey2d:s,baseStartAngle:r}}else if(this.IsOnLineRotate(this._Lines.get("o"),t)){this._curOptType=optType.LINE_ROTATE,this._ptStart=t,this._curOptPlanum="o";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);r=this.CalculateAngle(t,s);this._BaseState={baseBaseEyeRay:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaEyeRay.clone(),baseBaseYAxis:this._mprData.getImageData(this._imageHelper.mprPlanum).dynaYAxis.clone(),baseTEyeRay:this._mprData.getImageData("t").dynaEyeRay.clone(),baseTYAxis:this._mprData.getImageData("t").dynaYAxis.clone(),baseSEyeRay:this._mprData.getImageData("s").dynaEyeRay.clone(),baseSYAxis:this._mprData.getImageData("s").dynaYAxis.clone(),baseCEyeRay:this._mprData.getImageData("c").dynaEyeRay.clone(),baseCYAxis:this._mprData.getImageData("c").dynaYAxis.clone(),baseOEyeRay:this._mprData.getImageData("o").dynaEyeRay.clone(),baseOYAxis:this._mprData.getImageData("o").dynaYAxis.clone(),basekey2d:s,baseStartAngle:r}}else if(this.IsOnLineBody(this._Lines.get("t"),t)){this._curOptType=optType.LINE_MOVE,this._ptStart=t,this._curOptPlanum="t";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);var o=new Point2d(0,0),l=new Point2d(0,0);this.Calculate_MPRIndecateLine(this._curOptPlanum,this._imageHelper.mprPlanum,o,l),this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone(),baseLineStart:o,baseLineEnd:l,basekey2d:s}}else if(this.IsOnLineBody(this._Lines.get("s"),t)){this._curOptType=optType.LINE_MOVE,this._ptStart=t,this._curOptPlanum="s";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);o=new Point2d(0,0),l=new Point2d(0,0);this.Calculate_MPRIndecateLine(this._curOptPlanum,this._imageHelper.mprPlanum,o,l),this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone(),baseLineStart:o,baseLineEnd:l,basekey2d:s}}else if(this.IsOnLineBody(this._Lines.get("c"),t)){this._curOptType=optType.LINE_MOVE,this._ptStart=t,this._curOptPlanum="c";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);o=new Point2d(0,0),l=new Point2d(0,0);this.Calculate_MPRIndecateLine(this._curOptPlanum,this._imageHelper.mprPlanum,o,l),this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone(),baseLineStart:o,baseLineEnd:l,basekey2d:s}}else if(this.IsOnLineBody(this._Lines.get("o"),t)){this._curOptType=optType.LINE_MOVE,this._ptStart=t,this._curOptPlanum="o";i=this._mprData.getImageData(this._imageHelper.mprPlanum),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(i.dynaYAxis,i.dynaEyeRay,n);a=0,s=new Point2d(0,0);this.Point3dTo2d(this._mprData.keyPoint,s,i.dynaPtOrigin,n,i.dynaYAxis,i.dynaEyeRay,i.dynaPixelRate,a),s=this._imageHelper.imageToClient_point(s);o=new Point2d(0,0),l=new Point2d(0,0);this.Calculate_MPRIndecateLine(this._curOptPlanum,this._imageHelper.mprPlanum,o,l),this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone(),baseLineStart:o,baseLineEnd:l,basekey2d:s}}else{if("pageTurn"!=e.annoName)return!1;this._curOptType=optType.PAGE_TURN,this._ptStart=t,this._curOptPlanum="",this._BaseState={baseKeyPoint:this._mprData.keyPoint.clone()}}return this._isLBDown=!0,this._ptLast=t,this._eventHandler.doHandler("update",this._parentID,null,null),!0}if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp)return!!this._isLBDown&&(this._isLBDown=!1,this._curOptType=optType.UNKNOWN,this._ptStart=null,this._ptLast=null,this._curOptPlanum="",this._BaseState=null,this._eventHandler.doHandler("update",this._parentID,null,null),!0);if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._isLBDown)return!1;var h=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(h={x:e.x,y:e.y},null!=this._ptStart&&(Math.abs(h.x-this._ptLast.x)>=MinStep||Math.abs(h.y-this._ptLast.y)>=MinStep)){switch(this._curOptType){case optType.OPR_ROTATE:this.calcOprEye(h),this._ptStart=h;break;case optType.KEY_MOVE:this.KeyPointMove(this._imageHelper.mprPlanum,this._ptStart,h);break;case optType.LINE_ROTATE:this.LineRotate(this._curOptPlanum,this._imageHelper.mprPlanum,this._ptStart,h);break;case optType.LINE_MOVE:this.LineMove(this._curOptPlanum,this._imageHelper.mprPlanum,this._ptStart,h);break;case optType.PAGE_TURN:default:this.PageTurn(this._imageHelper.mprPlanum,this._ptStart,h)}return this._ptLast=h,this._imageHelper.needDrawSerial=!0,this._eventHandler.doHandler("update",this._parentID,null,null),!0}return!0}return!1}},t.prototype.DrawAllLines=function(e){var t=this;this._Lines.clear();var i=e.getContext("2d",{alpha:!1});MPRDrawersContent.forEach(function(e){if(t._imageHelper.mprPlanum!=e){var n=t.getLineByPlanum(e,t._imageHelper.mprPlanum);null!=n&&(t._Lines.set(e,n),i.save(),i.strokeStyle=n.color,i.lineWidth=1,i.beginPath(),i.moveTo(n.ptStart1.x,n.ptStart1.y),i.lineTo(n.ptEnd1.x,n.ptEnd1.y),i.moveTo(n.ptStart2.x,n.ptStart2.y),i.lineTo(n.ptEnd2.x,n.ptEnd2.y),i.stroke(),i.closePath(),i.beginPath(),i.arc(n.ptRotate.x,n.ptRotate.y,n.rotateRadius,0,360,!1),i.fillStyle=n.color,i.fill(),i.stroke(),i.closePath(),i.restore())}})},t.prototype.calcOprEye=function(e){var t=this._imageHelper.imageData,i=new Array(9),n=this._imageHelper.cellHeight,a=this._imageHelper.cellWidth,s=Math.min(n,a)/2,r=(this._ptStart.x-a/2)/s,o=-(n/2-this._ptStart.y)/s,l=(e.x-a/2)/s,h=-(n/2-e.y)/s;if(!Utility.TBRotate(r,o,l,h,t.dynaEyeRay,t.dynaYAxis,i))return!1;var u=new Point3d(0,0,0);Utility.Matrix33MultiVector3_32f(i,t.dynaEyeRay,u);var d=new Point3d(0,0,0);return Utility.Matrix33MultiVector3_32f(i,t.dynaYAxis,d),t.dynaEyeRay=u,t.dynaYAxis=d,!0},t.prototype.getLineByPlanum=function(e,t){this._mprData.getImageData(t);var i=new MPRLine,n=new Point2d(0,0),a=new Point2d(0,0);if("t"==e)i.color=this._PlanumLineColor_T;else if("c"==e)i.color=this._PlanumLineColor_C;else if("s"==e)i.color=this._PlanumLineColor_S;else{if("o"!=e)return null;i.color=this._PlanumLineColor_O}this.Calculate_MPRIndecateLine(e,t,n,a);var s=Math.abs(n.x-a.x),r=Math.abs(n.y-a.y),o=Math.sqrt(s*s+r*r),l=(a.x-n.x)/o,h=(a.y-n.y)/o;0<=l&&l<1e-6?l=1e-6:-1e-6<l&&l<=0&&(l=-1e-6);var u=new Point2d(0,0),d=new Point2d(0,0),c="t";if("t"==e&&"c"==t||"c"==e&&"t"==t)c="s";else if("t"==e&&"s"==t||"s"==e&&"t"==t)c="c";else{if(!("s"==e&&"c"==t||"c"==e&&"s"==t))return null;c="t"}this.Calculate_MPRIndecateLine(c,t,u,d);var p=this.CalInterSectionPoint(n,a,u,d),g=p.y-h/l*p.x,_=h/l,m=new Point2d(0,0);m.x=p.x-10*l,m.y=p.y-10*h;var f=new Point2d(0,0);f.x=p.x+10*l,f.y=p.y+10*h;var y=new Point2d(0,0),I=new Point2d(0,0);if(this.CalculateIntersectionPointsWithRect(_,g,this._imageHelper.canvas.width,this._imageHelper.canvas.height,y,I),0==y.x&&0==y.y||0==I.x&&0==I.y)return null;i.planum=e;var x=this.GetInterPointByEndPoint(m,f,y,I);i.ptStart1=this.GetInterPointByStartPoint(m,f,y,I),i.ptEnd1=m,i.ptStart2=f,i.ptEnd2=x;var w=y.x-I.x,D=y.y-I.y,P=.2*Math.sqrt(w*w+D*D);return i.ptRotate=new Point2d(0,0),i.ptRotate.x=Math.floor(x.x-P*l+.5),i.ptRotate.y=Math.floor(x.y-P*h+.5),i.rotateRadius=this._hitRotateLimit,i},t.prototype.LineRotate=function(e,t,i,n){if(this._BaseState){new Point2d(0,0),this._mprData.getImageData(t);var a=new Point3d(0,0,0),s=new Point3d(0,0,0),r=new Point3d(0,0,0);if("t"==t)a=this._BaseState.baseTEyeRay,s=this._BaseState.baseCYAxis,r=this._BaseState.baseSYAxis;else if("c"==t)a=this._BaseState.baseCEyeRay,s=this._BaseState.baseTYAxis,r=this._BaseState.baseSYAxis;else{if("s"!=t)return;a=this._BaseState.baseSEyeRay,s=this._BaseState.baseTYAxis,r=this._BaseState.baseCYAxis}var o=this.CalculateAngle(n,this._BaseState.basekey2d)-this._BaseState.baseStartAngle,l=new Array(9);Utility.Rotate(o,a,l);var h=new Point3d(0,0,0),u=new Point3d(0,0,0);if(Utility.Matrix33MultiVector3_32f(l,s,h),Utility.Matrix33MultiVector3_32f(l,r,u),"t"==t)this._mprData.imageDataC.dynaYAxis=h,this._mprData.imageDataS.dynaYAxis=u;else if("c"==t)this._mprData.imageDataT.dynaYAxis=h,this._mprData.imageDataS.dynaYAxis=u;else{if("s"!=t)return;this._mprData.imageDataT.dynaYAxis=h,this._mprData.imageDataC.dynaYAxis=u}var d=new Point3d(0,0,0),c=new Point3d(0,0,0),p=new Point3d(0,0,0);if(Utility.Matrix33MultiVector3_32f(l,this._BaseState.baseTEyeRay,d),Utility.Matrix33MultiVector3_32f(l,this._BaseState.baseCEyeRay,c),this._mprData.imageDataT.dynaEyeRay=d,this._mprData.imageDataC.dynaEyeRay=c,Utility.ComputeVerticalVecter(d,c,p),this._mprData.imageDataS.dynaEyeRay=p,Utility.VecterVertical(this._mprData.imageDataT.dynaEyeRay,this._mprData.imageDataT.dynaYAxis));}},t.prototype.LineMove=function(e,t,i,n){if(this._BaseState&&this._BaseState.baseKeyPoint){var a=new Point3d(0,0,0),s=this._mprData.getImageData(t);Utility.ComputeVerticalVecter(s.dynaYAxis,s.dynaEyeRay,a);var r=Math.abs(this._BaseState.baseLineStart.x-this._BaseState.baseLineEnd.x),o=Math.abs(this._BaseState.baseLineStart.y-this._BaseState.baseLineEnd.y),l=Math.sqrt(r*r+o*o),h=(this._BaseState.baseLineEnd.x-this._BaseState.baseLineStart.x)/l,u=-((this._BaseState.baseLineEnd.y-this._BaseState.baseLineStart.y)/l),d=h,c=-1*this.Point_Line_Distance(n,this._BaseState.baseLineStart.x,this._BaseState.baseLineStart.y,this._BaseState.baseLineEnd.x,this._BaseState.baseLineEnd.y),p=new Point2d(0,0);p.x=c*u+this._BaseState.basekey2d.x,p.y=c*d+this._BaseState.basekey2d.y,p.x=Utility.BOUND_VALUE(p.x,3,this._imageHelper.cellWidth-3),p.y=Utility.BOUND_VALUE(p.y,3,this._imageHelper.cellHeight-3);var g=this._imageHelper.clientToImage_point(p),_=new Point3d(0,0,0);this.Point2dTo3d(g,_,s.dynaPtOrigin,a,s.dynaYAxis,s.dynaPixelRate),_.x=Utility.BOUND_VALUE(_.x,0,this._mprData.volWeight-1),_.y=Utility.BOUND_VALUE(_.y,0,this._mprData.volHeight-1),_.z=Utility.BOUND_VALUE(_.z,0,this._mprData.volTall-1),this._mprData.keyPoint=_}},t.prototype.Point_Line_Distance=function(e,t,i,n,a){if(t==n&&i==a)return Math.sqrt((e.x-t)*(e.x-t)+(e.y-i)*(e.y-i));var s=a-i,r=t-n,o=n*i-t*a;return(s*e.x+r*e.y+o)/Math.sqrt(s*s+r*r)},t.prototype.KeyPointMove=function(e,t,i){if(this._BaseState&&this._BaseState.baseKeyPoint){new Point2d(0,0);var n=new Point3d(0,0,0),a=this._mprData.getImageData(e);Utility.ComputeVerticalVecter(a.dynaYAxis,a.dynaEyeRay,n);var s=new Point2d(0,0);s.x=i.x-t.x+this._BaseState.basekey2d.x,s.y=i.y-t.y+this._BaseState.basekey2d.y,s.x=Utility.BOUND_VALUE(s.x,3,this._imageHelper.cellWidth-3),s.y=Utility.BOUND_VALUE(s.y,3,this._imageHelper.cellHeight-3);var r=this._imageHelper.clientToImage_point(s),o=new Point3d(0,0,0);this.Point2dTo3d(r,o,a.dynaPtOrigin,n,a.dynaYAxis,a.dynaPixelRate),o.x=Utility.BOUND_VALUE(o.x,0,this._mprData.volWeight-1),o.y=Utility.BOUND_VALUE(o.y,0,this._mprData.volHeight-1),o.z=Utility.BOUND_VALUE(o.z,0,this._mprData.volTall-1),this._mprData.keyPoint=o}},t.prototype.PageTurn=function(e,t,i){if(this._BaseState&&this._BaseState.baseKeyPoint){var n=i.y-t.y,a=new Point3d(0,0,0);if("t"==e)a=this._mprData.imageDataT.dynaEyeRay;else if("c"==e)a=this._mprData.imageDataC.dynaEyeRay;else{if("s"!=e)return null;a=this._mprData.imageDataS.dynaEyeRay}var s=new Point3d(this._BaseState.baseKeyPoint.x+n*a.x,this._BaseState.baseKeyPoint.y+n*a.y,this._BaseState.baseKeyPoint.z+n*a.z);s.x=Utility.BOUND_VALUE(s.x,0,this._mprData.volWeight-1),s.y=Utility.BOUND_VALUE(s.y,0,this._mprData.volHeight-1),s.z=Utility.BOUND_VALUE(s.z,0,this._mprData.volTall-1),this._mprData.keyPoint=s}},t.prototype.Calculate_MPRIndecateLine=function(e,t,i,n){var a,s,r,o,l=new Point3d(0,0,0),h=new Point3d(0,0,0),u=new Point3d(0,0,0),d=new Point3d(0,0,0),c=new Point3d(0,0,0),p=new Point3d(0,0,0),g=new Point3d(0,0,0),_=new Point3d(0,0,0),m=this._mprData.getImageData(e);l=m.dynaEyeRay,u=m.dynaYAxis,r=m.dynaWidth,o=m.dynaHeight,m.dynaFov,c=m.dynaPtCenter;var f=this._mprData.getImageData(t);p=f.dynaEyeRay,_=f.dynaYAxis,a=f.dynaWidth,s=f.dynaHeight,f.dynaFov,d=f.dynaPtCenter,Utility.ComputeVerticalVecter(u,l,h),Utility.ComputeVerticalVecter(_,p,g);var y=f.dynaPixelRate,I=m.dynaPixelRate,x=this._mprData.keyPoint,w=new Point3d(0,0,0),D=new Point3d(0,0,0);this.CalculateOriginPoint3d(p,g,_,y,0,a,s,x,d,w),this.CalculateOriginPoint3d(l,h,u,I,0,r,o,x,c,D);var P=new Point2d(0,0),v=new Point2d(0,0),S=new Point3d(0,0,0),C=new Point3d(0,0,0);if(!this.ComputeTwoPlaneCrossLine3d(w,g,_,a,s,y,D,h,u,r,o,I,S,C))return null;this.Point3dTo2d(S,P,w,g,f.dynaYAxis,f.dynaEyeRay,f.dynaPixelRate,0),P=this._imageHelper.imageToClient_point(P),i.x=P.x,i.y=P.y,this.Point3dTo2d(C,v,w,g,f.dynaYAxis,f.dynaEyeRay,f.dynaPixelRate,0),v=this._imageHelper.imageToClient_point(v),n.x=v.x,n.y=v.y},t.prototype.CalculateAngle=function(e,t){var i=e.x-t.x,n=e.y-t.y,a=0;return 0==i&&0==n?a=0:i>=0?a=Math.asin(n/Math.sqrt(i*i+n*n)):i<0&&(a=Math.PI-Math.asin(n/Math.sqrt(i*i+n*n))),a},t.prototype.CalculateOriginPoint3d=function(e,t,i,n,a,s,r,o,l,h){var u=new Point3d(0,0,0),d=e.x*o.x+e.y*o.y+e.z*o.z-(l.x*e.x+l.y*e.y+l.z*e.z);u.x=e.x*d+l.x,u.y=e.y*d+l.y,u.z=e.z*d+l.z,h.x=u.x-t.x*((s-1)/2)*n-i.x*((r-1)/2)*n,h.y=u.y-t.y*((s-1)/2)*n-i.y*((r-1)/2)*n,h.z=u.z-t.z*((s-1)/2)*n-i.z*((r-1)/2)*n;var c=new Point2d(0,0),p=new Point3d(0,0,0);p.x=o.x-h.x,p.y=o.y-h.y,p.z=o.z-h.z,c.x=(t.x*p.x+t.y*p.y+t.z*p.z)/n,c.y=(i.x*p.x+i.y*p.y+i.z*p.z)/n;var g=e.x*p.x+e.y*p.y+e.z*p.z;return a>0&&(c.x<s*a||c.y<r*a||c.x>s*(1-a)||c.y>r*(1-a))?(l=o,h.x=l.x-t.x*((s-1)/2)*n-i.x*((r-1)/2)*n,h.y=l.y-t.y*((s-1)/2)*n-i.y*((r-1)/2)*n,h.z=l.z-t.z*((s-1)/2)*n-i.z*((r-1)/2)*n):(l.x+=e.x*g,l.y+=e.y*g,l.z+=e.z*g),!0},t.prototype.ComputeTwoPlaneCrossLine=function(e,t,i,n,a,s,r,o,l,h,u,d,c,p){var g=new Array(5);g[0]=g[4]=r,g[1]=new Point3d(r.x+l.x*d*u,r.y+l.y*d*u,r.z+l.z*d*u),g[2]=new Point3d(r.x+l.x*d*u+o.x*d*h,r.y+l.y*d*u+o.y*d*h,r.z+l.z*d*u+o.z*d*h),g[3]=new Point3d(r.x+o.x*d*h,r.y+o.y*d*h,r.z+o.z*d*h);var _=new Array(2);_[0]=0,_[1]=0;for(var m=0;m<5;m++){var f=new Point3d(0,0,0);f.x=g[m+1].x-g[m].x,f.y=g[m+1].y-g[m].y,f.z=g[m+1].z-g[m].z,Utility.NormalizVecter(f);var y=(g[m+1].x+g[m+1].y+g[m+1].z-g[m].x-g[m].y-g[m].z)/(f.x+f.y+f.z),I=new Array(9),x=new Array(9),w=new Point3d(0,0,0),D=new Point3d(0,0,0);if(I[0]=t.x,I[3]=t.y,I[6]=t.z,I[1]=i.x,I[4]=i.y,I[7]=i.z,I[2]=-f.x,I[5]=-f.y,I[8]=-f.z,w.x=g[m].x-e.x,w.y=g[m].y-e.y,w.z=g[m].z-e.z,this.MatrixReverse(I,x)&&(this.Matrix33MultiVector3_64f(x,w,D),D.z>=0&&D.z<=y)){if(_[0]){p.x=D.x/s,p.y=D.y/s,_[1]=1;break}c.x=D.x/s,c.y=D.y/s,_[0]=1}}return!(!_[0]||!_[1])},t.prototype.GetInterPointByStartPoint=function(e,t,i,n){var a=e.x-i.x,s=e.y-i.y;return a*a+s*s<(a=t.x-i.x)*a+(s=t.y-i.y)*s?i:n},t.prototype.GetInterPointByEndPoint=function(e,t,i,n){var a=e.x-i.x,s=e.y-i.y;return a*a+s*s<(a=t.x-i.x)*a+(s=t.y-i.y)*s?n:i},t.prototype.CalculateIntersectionPointsWithRect=function(e,t,i,n,a,s){var r=0,o=0;r=0;var l=0,h=0;0<=(o=t)&&o<=n&&(a.x=r,a.y=o,l=1),o=e*(r=i)+t,l+h<2&&0<=o&&o<=n&&(0==l?(a.x=r,a.y=o,l=1):(s.x=r,s.y=o,h=1)),o=0,r=-t/e,l+h<2&&0<=r&&r<=i&&(0==l?(a.x=r,a.y=o,l=1):(s.x=r,s.y=o,h=1)),r=((o=n)-t)/e,l+h<2&&0<=r&&r<=i&&(0==l?(a.x=r,a.y=o,l=1):(s.x=r,s.y=o,h=1))},t.prototype.ComputeTwoPlaneCrossLine3d=function(e,t,i,n,a,s,r,o,l,h,u,d,c,p){var g=new Array(5);g[0]=g[4]=r,g[1]=new Point3d(r.x+l.x*d*u,r.y+l.y*d*u,r.z+l.z*d*u),g[2]=new Point3d(r.x+l.x*d*u+o.x*d*h,r.y+l.y*d*u+o.y*d*h,r.z+l.z*d*u+o.z*d*h),g[3]=new Point3d(r.x+o.x*d*h,r.y+o.y*d*h,r.z+o.z*d*h);var _=new Array(2);_[0]=0,_[1]=0;for(var m=0;m<4;m++){var f=new Point3d(0,0,0);f.x=g[m+1].x-g[m].x,f.y=g[m+1].y-g[m].y,f.z=g[m+1].z-g[m].z,Utility.NormalizVecter(f);var y=(g[m+1].x+g[m+1].y+g[m+1].z-g[m].x-g[m].y-g[m].z)/(f.x+f.y+f.z),I=new Array(9),x=new Array(9),w=new Point3d(0,0,0),D=new Point3d(0,0,0);if(I[0]=t.x,I[3]=t.y,I[6]=t.z,I[1]=i.x,I[4]=i.y,I[7]=i.z,I[2]=-f.x,I[5]=-f.y,I[8]=-f.z,w.x=g[m].x-e.x,w.y=g[m].y-e.y,w.z=g[m].z-e.z,this.MatrixReverse(I,x)&&(this.Matrix33MultiVector3_64f(x,w,D),D.z>=0&&D.z<=y)){if(_[0]){p.x=g[m].x+f.x*D.z,p.y=g[m].y+f.y*D.z,p.z=g[m].z+f.z*D.z,_[1]=1;break}c.x=g[m].x+f.x*D.z,c.y=g[m].y+f.y*D.z,c.z=g[m].z+f.z*D.z,_[0]=1}}return!(!_[0]||!_[1])},t.prototype.MatrixReverse=function(e,t){var i=e[0]*e[4]*e[8]+e[1]*e[5]*e[6]+e[2]*e[3]*e[7]-e[2]*e[4]*e[6]-e[0]*e[5]*e[7]-e[1]*e[3]*e[8];return!(Math.abs(i)<1e-6)&&(t[0]=(e[4]*e[8]-e[5]*e[7])/i,t[1]=(e[2]*e[7]-e[1]*e[8])/i,t[2]=(e[1]*e[5]-e[2]*e[4])/i,t[3]=(e[5]*e[6]-e[3]*e[8])/i,t[4]=(e[0]*e[8]-e[2]*e[6])/i,t[5]=(e[2]*e[3]-e[0]*e[5])/i,t[6]=(e[3]*e[7]-e[4]*e[6])/i,t[7]=(e[1]*e[6]-e[0]*e[7])/i,t[8]=(e[0]*e[4]-e[1]*e[3])/i,!0)},t.prototype.Matrix33MultiVector3_64f=function(e,t,i){return i.x=t.x*e[0]+t.y*e[1]+t.z*e[2],i.y=t.x*e[3]+t.y*e[4]+t.z*e[5],i.z=t.x*e[6]+t.y*e[7]+t.z*e[8],!0},t.prototype.Point2dTo3d=function(e,t,i,n,a,s){return t.x=i.x+n.x*e.x*s+a.x*e.y*s,t.y=i.y+n.y*e.x*s+a.y*e.y*s,t.z=i.z+n.z*e.x*s+a.z*e.y*s,!0},t.prototype.Point3dTo2d=function(e,t,i,n,a,s,r,o){var l=new Point3d(0,0,0);l.x=e.x-i.x,l.y=e.y-i.y,l.z=e.z-i.z,Utility.NormalizVecter(n),Utility.NormalizVecter(a),Utility.NormalizVecter(s),t.x=(n.x*l.x+n.y*l.y+n.z*l.z)/r,t.y=(a.x*l.x+a.y*l.y+a.z*l.z)/r,s.x,l.x,s.y,l.y,s.z,l.z},t.prototype.IsOnLineRotate=function(e,t){if(!e)return!1;var i=Math.abs(e.ptRotate.x-t.x),n=Math.abs(e.ptRotate.y-t.y),a=Math.sqrt(Math.pow(i,2)+Math.pow(n,2));return Math.abs(a)<=e.rotateRadius+5},t.prototype.IsOnLineBody=function(e,t){if(!e)return!1;var i=Utility.point_Line_Distance(t,e.ptStart1.x,e.ptStart1.y,e.ptEnd2.x,e.ptEnd2.y);return Math.abs(i)<=this._hitBodyLimit},t.prototype.IsOnKeyPoint=function(e){var t=this._mprData.getImageData(this._imageHelper.mprPlanum),i=new Point2d(0,0),n=new Point3d(0,0,0);Utility.ComputeVerticalVecter(t.dynaYAxis,t.dynaEyeRay,n);this.Point3dTo2d(this._mprData.keyPoint,i,t.dynaPtOrigin,n,t.dynaYAxis,t.dynaEyeRay,t.dynaPixelRate,0),i=this._imageHelper.imageToClient_point(i);var a=Math.abs(i.x-e.x),s=Math.abs(i.y-e.y),r=Math.sqrt(Math.pow(a,2)+Math.pow(s,2));return Math.abs(r)<=this._hitRadiusLimit},t.prototype.CalInterSectionPoint=function(e,t,i,n){var a=new Point2d(0,0),s=t.x-e.x,r=t.y-e.y,o=n.x-i.x,l=n.y-i.y;if(Math.abs(r)<=1e-6){Math.abs(l)<=1e-6&&(l=1e-6);var h=(e.y-i.y)/l;a.x=i.x+h*o,a.y=e.y}else{var u=s*l-r*o;0<=u&&u<1e-6?u=1e-6:-1e-6<u&&u<=0&&(u=-1e-6);h=(r*(i.x-e.x)-s*(i.y-e.y))/u;var d=(i.y-e.y+h*l)/r;a.x=e.x+d*s,a.y=e.y+d*r}return a},t}(FilterBase),CXeAnnoAngle=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"annoAngle",t,i,n)||this;a._angles=null,a._currAngle=null,a._originalAngle=null,a._isLBDown=!1,a._mouseDownCount=0,a._selectedDownPoint=null,a._selectedAngleIndex=null,a._selectedAngleTipsIndex=null,a._selectedHandleIndex=null,a._currentPoint=null,a._angles=t.imageState.angleState.angles;var s=a;return a._eventHandler.addHandler("deleteSelected",a,"annoAngle",function(){s.deleteSelected()}),a._eventHandler.addHandler("deleteAll",a,"annoAngle",function(){s.deleteAll()}),a._eventHandler.addHandler("changeOperateMode",a,"annoAngle",function(e){e!=s.getName()&&null!=s._currAngle&&(s.clearSelected(),s._eventHandler.doHandler("update",this._parentID,null,null))}),a}return __extends(t,e),t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this),this._eventHandler.removeHandler("changeOperateMode",this)},Object.defineProperty(t.prototype,"anglesCount",{get:function(){return null==this._angles?0:this._angles.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"angles",{get:function(){return this._angles},set:function(e){this._angles=e,this._imageHelper.imageState.angleState.angles=e},enumerable:!0,configurable:!0}),t.prototype.clearSelected=function(){this._isLBDown=!1,this._currAngle=null,this._mouseDownCount=0,this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedAngleTipsIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();this._isLBDown=!0;var t={x:e.x,y:e.y};if(this._selectedHandleIndex=null,this._selectedAngleIndex=null,this._selectedAngleTipsIndex=null,0==this._mouseDownCount&&this.hitOnHandle(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(0==this._mouseDownCount&&this.hitOnTips(t))return this._currentPoint=t,!0;if(0==this._mouseDownCount&&this.hitOnBody(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(e.annoName==this.getName()){if(0==this._mouseDownCount){var i=this._imageHelper.clientToImage_point(t);this._currAngle=new Angle(i,i,i),this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY))}else if(1==this._mouseDownCount&&this._currAngle){i=this._imageHelper.clientToImage_point(t);this._currAngle.endpoint2=i,this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY))}return!0}}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._currentPoint=null,this._selectedAngleTipsIndex=null,e.x&&e.y){if(null!=this._selectedAngleIndex)return this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName()){if(this._currAngle)if(0==this._mouseDownCount)if(Math.abs(this._currAngle.vertex.x-this._currAngle.endpoint1.x)>3||Math.abs(this._currAngle.vertex.y-this._currAngle.endpoint1.y)>3){this._mouseDownCount=1;i=this._imageHelper.clientToImage_point({x:e.x,y:e.y});this._currAngle.endpoint1=i}else this._currAngle=null;else if(1==this._mouseDownCount&&(Math.abs(this._currAngle.vertex.x-this._currAngle.endpoint2.x)>3||Math.abs(this._currAngle.vertex.y-this._currAngle.endpoint2.y)>3)){this._mouseDownCount=0;var n=this._imageHelper.clientToImage_point({x:e.x,y:e.y});this._currAngle.endpoint2=n,this._angles.push(this._currAngle),this._currAngle=null,this._selectedAngleIndex=this._angles.length-1,this._imageHelper.needDrawSameImage=!0}return this._eventHandler.doHandler("update",this._parentID,null,null),!0}}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(null!=this._selectedAngleIndex){var a=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(null!=this._selectedHandleIndex)0==this._selectedHandleIndex?this._angles[this._selectedAngleIndex].vertex=a:1==this._selectedHandleIndex?this._angles[this._selectedAngleIndex].endpoint1=a:2==this._selectedHandleIndex&&(this._angles[this._selectedAngleIndex].endpoint2=a);else{var s=a.x-this._selectedDownPoint.x,r=a.y-this._selectedDownPoint.y;this._angles[this._selectedAngleIndex].vertex.x=this._originalAngle.vertex.x+s,this._angles[this._selectedAngleIndex].vertex.y=this._originalAngle.vertex.y+r,this._angles[this._selectedAngleIndex].endpoint1.x=this._originalAngle.endpoint1.x+s,this._angles[this._selectedAngleIndex].endpoint1.y=this._originalAngle.endpoint1.y+r,this._angles[this._selectedAngleIndex].endpoint2.x=this._originalAngle.endpoint2.x+s,this._angles[this._selectedAngleIndex].endpoint2.y=this._originalAngle.endpoint2.y+r;var o=e.x-this._currentPoint.x,l=e.y-this._currentPoint.y;this._currentPoint={x:e.x,y:e.y},this._angles[this._selectedAngleIndex].tips.moveTips(this._imageHelper,o,l)}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(null!=this._selectedAngleTipsIndex){s=e.x-this._currentPoint.x,r=e.y-this._currentPoint.y;return this.angles[this._selectedAngleTipsIndex].tips.moveTips(this._imageHelper,s,r),this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}if(e.annoName==this.getName()&&null!=this._currAngle){a=this._imageHelper.clientToImage_point({x:e.x,y:e.y});return 0==this._mouseDownCount?this._currAngle.endpoint1=a:1==this._mouseDownCount&&(this._currAngle.endpoint2=a),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){var t=e.getContext("2d",{alpha:!1});t.save(),t.strokeStyle="#57f900",this._currAngle&&(this._currAngle.draw(t,this._imageHelper),this._currAngle.drawHandles(t,this._imageHelper),this._currAngle.drawTip(t,this._imageHelper,this.c_fontHeight,"#57f900"));for(var i=0;i<this._angles.length;++i)this._angles[i].draw(t,this._imageHelper),i==this._selectedAngleIndex&&this._angles[i].drawHandles(t,this._imageHelper),this._angles[i].drawTip(t,this._imageHelper,this.c_fontHeight,"#57f900");t.restore()}else this.clearSelected()},t.prototype.hitOnBody=function(e){this._selectedAngleIndex=null;for(var t=0;t<this._angles.length;++t)if(this._angles[t].hitOnLine(e,this._imageHelper))return this._selectedAngleIndex=t,this._originalAngle=this._angles[t].clone(),!0;return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null,this._selectedAngleIndex=null;for(var t=null,i=0;i<this._angles.length;++i)if(null!=(t=this._angles[i].hitOnHandle(e,this._imageHelper)))return this._selectedHandleIndex=t,this._selectedAngleIndex=i,this._originalAngle=this._angles[i].clone(),!0;return!1},t.prototype.hitOnTips=function(e){this._selectedAngleTipsIndex=null;for(var t=0;t<this.angles.length;++t){if(null!=this.angles[t].tips)if(this.angles[t].tips.getClientRect(this._imageHelper).ptInRect(e))return this._selectedAngleTipsIndex=t,!0}return!1},t.prototype.drawCross=function(e,t){var i=e.getContext("2d",{alpha:!1});i.save(),i.strokeStyle=t,i.beginPath(),i.moveTo(this._currentPoint.x-4,this._currentPoint.y),i.lineTo(this._currentPoint.x+4,this._currentPoint.y),i.moveTo(this._currentPoint.x,this._currentPoint.y-4),i.lineTo(this._currentPoint.x,this._currentPoint.y+4),i.stroke(),i.restore()},t.prototype.deleteSelected=function(){null==this._selectedAngleIndex&&null==this._currAngle||(this._angles.splice(this._selectedAngleIndex,1),this._mouseDownCount=0,this._currAngle=null,this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedAngleTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._mouseDownCount=0,this._currAngle=null,this._angles.splice(0),this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedAngleTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null)},t}(FilterBase)),Angle=function(){function e(e,t,i,n){void 0===n&&(n=null),this._handleSize=12,this.tips=null,this.vertex=e,this.endpoint1=t,this.endpoint2=i,this.tips=n}return Object.defineProperty(e.prototype,"handles",{get:function(){var e=new Array;return e.push(this.vertex),e.push(this.endpoint1),e.push(this.endpoint2),e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e({x:this.vertex.x,y:this.vertex.y},{x:this.endpoint1.x,y:this.endpoint1.y},{x:this.endpoint2.x,y:this.endpoint2.y},this.tips)},e.prototype.hitOnLine=function(e,t){var i=t.imageToClient_point(this.vertex),n=t.imageToClient_point(this.endpoint1),a=t.imageToClient_point(this.endpoint2);return!!Utility.testHitOnLineSegment(e,i,n,10)||!!Utility.testHitOnLineSegment(e,i,a,10)},e.prototype.hitOnHandle=function(e,t){for(var i=0;i<this.handles.length;++i){var n=t.imageToClient_point(this.handles[i]);if(e.x>=n.x-this._handleSize&&e.x<=n.x+this._handleSize&&e.y>=n.y-this._handleSize&&e.y<=n.y+this._handleSize)return i}return null},e.prototype.draw=function(e,t){var i=t.imageToClient_point(this.vertex),n=t.imageToClient_point(this.endpoint1),a=t.imageToClient_point(this.endpoint2);e.save(),e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(n.x,n.y),e.moveTo(i.x,i.y),e.lineTo(a.x,a.y),e.closePath(),e.stroke(),e.restore()},e.prototype.drawHandles=function(e,t){var i=this,n=t.imageToClient_point(this.vertex),a=t.imageToClient_point(this.endpoint1),s=t.imageToClient_point(this.endpoint2),r=new Array;r.push(n),r.push(a),r.push(s),e.save(),r.forEach(function(t){e.beginPath(),e.arc(t.x,t.y,i._handleSize,0,2*Math.PI),e.stroke(),e.closePath()}),e.restore()},e.prototype.drawTip=function(e,t,i,n){if(this.endpoint2.x!=this.vertex.x||this.endpoint2.y!=this.vertex.y){var a=t.imageToClient_point(this.vertex),s="角度："+this.calAngle().toString()+"度",r=new Rect(this.vertex.x-1,this.vertex.y-1,this.vertex.x+1,this.vertex.y+1);null==this.tips?this.tips=TipLocation.calcTipLoc(e,t,s,r,i,1,10):this.tips.updateTip(e,t,s,i,1),TipLocation.drawTip(e,t,this.tips),TipLocation.drawConnectLine(e,t,this.tips,a)}},e.prototype.calAngle=function(){var e=Utility.getAngleToXAxis(this.endpoint1,this.vertex),t=Utility.getAngleToXAxis(this.endpoint2,this.vertex),i=Math.abs(t-e);return i>Math.PI&&(i=2*Math.PI-i),Math.round(i/Math.PI*180)},e}(),CXeAnnoLineAngle=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"lineAnnoAngle",t,i,n)||this;a._lineAngles=null,a._currLineAngle=null,a._originalLineAngle=null,a._isLBDown=!1,a._mouseDownCount=0,a._selectedDownPoint=null,a._selectedAngleIndex=null,a._selectedAngleTipsIndex=null,a._selectedHandleIndex=null,a._selectedLineIndex=null,a._currentPoint=null,a._lineAngles=t.imageState.lineAngleState.lineAngles;var s=a;return a._eventHandler.addHandler("deleteSelected",a,"annoLineAngle",function(){s.deleteSelected()}),a._eventHandler.addHandler("deleteAll",a,"annoLineAngle",function(){s.deleteAll()}),a._eventHandler.addHandler("changeOperateMode",a,"annoLineAngle",function(e){e!=s.getName()&&null!=s._currLineAngle&&(s.clearSelected(),s._eventHandler.doHandler("update",this._parentID,null,null))}),a}return __extends(t,e),t.prototype.clear=function(){this._eventHandler.removeHandler("deleteSelected",this),this._eventHandler.removeHandler("deleteAll",this),this._eventHandler.removeHandler("changeOperateMode",this)},Object.defineProperty(t.prototype,"anglesCount",{get:function(){return null==this._lineAngles?0:this._lineAngles.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusColor",{get:function(){return"orange"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lineAngles",{get:function(){return this._lineAngles},set:function(e){this._lineAngles=e,this._imageHelper.imageState.lineAngleState.lineAngles=e},enumerable:!0,configurable:!0}),t.prototype.clearSelected=function(){this._isLBDown=!1,this._currLineAngle=null,this._mouseDownCount=0,this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedLineIndex=null,this._selectedAngleTipsIndex=null},t.prototype.procMessage=function(e){if(e.annoName!=this.getName()&&"selectAnno"!=e.annoName)return this.clearSelected(),!1;if(!this._imageHelper.imageState.isShowAnno)return this.clearSelected(),!1;if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown)return e.annoName==this.getName();this._isLBDown=!0;var t={x:e.x,y:e.y};if(this._selectedHandleIndex=null,this._selectedLineIndex=null,this._selectedAngleIndex=null,this._selectedAngleTipsIndex=null,0==this._mouseDownCount&&this.hitOnHandle(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(0==this._mouseDownCount&&this.hitOnTips(t))return this._currentPoint=t,!0;if(0==this._mouseDownCount&&this.hitOnBody(t))return this._selectedDownPoint=this._imageHelper.clientToImage_point(t),this._currentPoint=t,!0;if(e.annoName==this.getName()){if(0==this._mouseDownCount){var i=this._imageHelper.clientToImage_point(t);this._currLineAngle=new LineAngle(i,i,null,null),this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY))}else if(1==this._mouseDownCount&&this._currLineAngle){i=this._imageHelper.clientToImage_point(t);this._currLineAngle.startpoint2=i,this._currLineAngle.endpoint2=i,this._eventHandler.doHandler("update",this._parentID,t,new Point2d(e.pageX,e.pageY))}return!0}}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._currentPoint=null,this._selectedAngleTipsIndex=null,e.x&&e.y){if(null!=this._selectedAngleIndex)return this._eventHandler.doHandler("update",this._parentID,null,null),!0;if(e.annoName==this.getName()){if(this._currLineAngle)if(0==this._mouseDownCount)if(Math.abs(this._currLineAngle.startpoint1.x-this._currLineAngle.endpoint1.x)>3||Math.abs(this._currLineAngle.startpoint1.y-this._currLineAngle.endpoint1.y)>3){this._mouseDownCount=1;i=this._imageHelper.clientToImage_point({x:e.x,y:e.y});this._currLineAngle.endpoint1=i}else this._currLineAngle=null;else if(1==this._mouseDownCount&&(Math.abs(this._currLineAngle.startpoint2.x-this._currLineAngle.endpoint2.x)>3||Math.abs(this._currLineAngle.startpoint2.y-this._currLineAngle.endpoint2.y)>3)){this._mouseDownCount=0;var n=this._imageHelper.clientToImage_point({x:e.x,y:e.y});this._currLineAngle.endpoint2=n,this._lineAngles.push(this._currLineAngle),this._currLineAngle=null,this._selectedAngleIndex=this._lineAngles.length-1,this._imageHelper.needDrawSameImage=!0}return this._eventHandler.doHandler("update",this._parentID,null,null),!0}}}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(null!=this._selectedAngleIndex){var a=this._imageHelper.clientToImage_point({x:e.x,y:e.y});if(null!=this._selectedHandleIndex)0==this._selectedHandleIndex?this.lineAngles[this._selectedAngleIndex].startpoint1=a:1==this._selectedHandleIndex?this.lineAngles[this._selectedAngleIndex].endpoint1=a:2==this._selectedHandleIndex?this.lineAngles[this._selectedAngleIndex].startpoint2=a:3==this._selectedHandleIndex&&(this.lineAngles[this._selectedAngleIndex].endpoint2=a);else if(null!=this._selectedLineIndex){var s=a.x-this._selectedDownPoint.x,r=a.y-this._selectedDownPoint.y;0==this._selectedLineIndex?(this.lineAngles[this._selectedAngleIndex].startpoint1.x=this._originalLineAngle.startpoint1.x+s,this.lineAngles[this._selectedAngleIndex].startpoint1.y=this._originalLineAngle.startpoint1.y+r,this.lineAngles[this._selectedAngleIndex].endpoint1.x=this._originalLineAngle.endpoint1.x+s,this.lineAngles[this._selectedAngleIndex].endpoint1.y=this._originalLineAngle.endpoint1.y+r):1==this._selectedLineIndex&&(this.lineAngles[this._selectedAngleIndex].startpoint2.x=this._originalLineAngle.startpoint2.x+s,this.lineAngles[this._selectedAngleIndex].startpoint2.y=this._originalLineAngle.startpoint2.y+r,this.lineAngles[this._selectedAngleIndex].endpoint2.x=this._originalLineAngle.endpoint2.x+s,this.lineAngles[this._selectedAngleIndex].endpoint2.y=this._originalLineAngle.endpoint2.y+r);var o=e.x-this._currentPoint.x,l=e.y-this._currentPoint.y;this._currentPoint={x:e.x,y:e.y},this.lineAngles[this._selectedAngleIndex].tips.moveTips(this._imageHelper,o,l)}return this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}if(null!=this._selectedAngleTipsIndex){var h=e.x-this._currentPoint.x,u=e.y-this._currentPoint.y;return this.lineAngles[this._selectedAngleTipsIndex].tips.moveTips(this._imageHelper,h,u),this._currentPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,this._currentPoint,new Point2d(e.pageX,e.pageY)),!0}if(e.annoName==this.getName()&&null!=this._currLineAngle){a=this._imageHelper.clientToImage_point({x:e.x,y:e.y});return 0==this._mouseDownCount?this._currLineAngle.endpoint1=a:1==this._mouseDownCount&&(this._currLineAngle.endpoint2=a),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}}else if(e.name==UIMsg.keyPress&&(8==e.keyCode||46==e.keyCode))return this.deleteSelected(),this._eventHandler.doHandler("update",this._parentID,null,null),!0;return!1},t.prototype.procImage=function(e){if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID)if(this._imageHelper.imageState.isShowAnno){var t=e.getContext("2d",{alpha:!1});t.save(),t.strokeStyle="#57f900",this._currLineAngle&&(this._currLineAngle.draw(t,this._imageHelper),this._currLineAngle.drawHandles(t,this._imageHelper),this._currLineAngle.drawTip(t,this._imageHelper,this.c_fontHeight,"#57f900"));for(var i=0;i<this.lineAngles.length;++i)this.lineAngles[i].draw(t,this._imageHelper),i==this._selectedAngleIndex&&this.lineAngles[i].drawHandles(t,this._imageHelper),this.lineAngles[i].drawTip(t,this._imageHelper,this.c_fontHeight,"#57f900");t.restore()}else this.clearSelected()},t.prototype.hitOnBody=function(e){this._selectedAngleIndex=null,this._selectedLineIndex=null;for(var t=null,i=0;i<this.lineAngles.length;++i)if(null!=(t=this.lineAngles[i].hitOnLine(e,this._imageHelper)))return this._selectedLineIndex=t,this._selectedAngleIndex=i,this._originalLineAngle=this.lineAngles[i].clone(),!0;return!1},t.prototype.hitOnHandle=function(e){this._selectedHandleIndex=null,this._selectedAngleIndex=null;for(var t=null,i=0;i<this._lineAngles.length;++i)if(null!=(t=this._lineAngles[i].hitOnHandle(e,this._imageHelper)))return this._selectedHandleIndex=t,this._selectedAngleIndex=i,this._originalLineAngle=this._lineAngles[i].clone(),!0;return!1},t.prototype.hitOnTips=function(e){this._selectedAngleTipsIndex=null;for(var t=0;t<this.lineAngles.length;++t){var i=this.lineAngles[t].tips;if(null!=i)if(i.getClientRect(this._imageHelper).ptInRect(e))return this._selectedAngleTipsIndex=t,!0}return!1},t.prototype.drawCross=function(e,t){var i=e.getContext("2d",{alpha:!1});i.save(),i.strokeStyle=t,i.beginPath(),i.moveTo(this._currentPoint.x-4,this._currentPoint.y),i.lineTo(this._currentPoint.x+4,this._currentPoint.y),i.moveTo(this._currentPoint.x,this._currentPoint.y-4),i.lineTo(this._currentPoint.x,this._currentPoint.y+4),i.stroke(),i.restore()},t.prototype.deleteSelected=function(){null==this._selectedAngleIndex&&null==this._currLineAngle||(this._lineAngles.splice(this._selectedAngleIndex,1),this._mouseDownCount=0,this._currLineAngle=null,this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedAngleTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null))},t.prototype.deleteAll=function(){this._mouseDownCount=0,this._currLineAngle=null,this._lineAngles.splice(0),this._selectedAngleIndex=null,this._selectedHandleIndex=null,this._selectedAngleTipsIndex=null,this._eventHandler.doHandler("update",this._parentID,null,null)},t}(FilterBase)),LineAngle=function(){function e(e,t,i,n,a){void 0===a&&(a=null),this.startpoint1=null,this.endpoint1=null,this.startpoint2=null,this.endpoint2=null,this._handleSize=12,this.tips=null,this.startpoint1=e,this.endpoint1=t,this.startpoint2=i,this.endpoint2=n,this.tips=a}return Object.defineProperty(e.prototype,"handles",{get:function(){var e=new Array;return e.push(this.startpoint1),e.push(this.endpoint1),e.push(this.startpoint2),e.push(this.endpoint2),e},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(null==this.startpoint1?null:{x:this.startpoint1.x,y:this.startpoint1.y},null==this.endpoint1?null:{x:this.endpoint1.x,y:this.endpoint1.y},null==this.startpoint2?null:{x:this.startpoint2.x,y:this.startpoint2.y},null==this.endpoint2?null:{x:this.endpoint2.x,y:this.endpoint2.y},this.tips)},e.prototype.hitOnLine=function(e,t){var i=null==this.startpoint1?null:t.imageToClient_point(this.startpoint1),n=null==this.startpoint2?null:t.imageToClient_point(this.endpoint1);if(null!=i&&null!=n&&Utility.testHitOnLineSegment(e,i,n,10))return 0;var a=null==this.endpoint1?null:t.imageToClient_point(this.startpoint2),s=null==this.endpoint2?null:t.imageToClient_point(this.endpoint2);return null!=a&&null!=s&&Utility.testHitOnLineSegment(e,a,s,10)?1:null},e.prototype.hitOnHandle=function(e,t){for(var i=0;i<this.handles.length;++i)if(null!=this.handles[i]){var n=t.imageToClient_point(this.handles[i]);if(e.x>=n.x-this._handleSize&&e.x<=n.x+this._handleSize&&e.y>=n.y-this._handleSize&&e.y<=n.y+this._handleSize)return i}return null},e.prototype.draw=function(e,t){var i=null==this.startpoint1?null:t.imageToClient_point(this.startpoint1),n=null==this.startpoint2?null:t.imageToClient_point(this.startpoint2),a=null==this.endpoint1?null:t.imageToClient_point(this.endpoint1),s=null==this.endpoint2?null:t.imageToClient_point(this.endpoint2);e.save(),e.beginPath(),null!=i&&null!=a&&(e.moveTo(i.x,i.y),e.lineTo(a.x,a.y)),null!=n&&null!=s&&(e.moveTo(n.x,n.y),e.lineTo(s.x,s.y)),e.closePath(),e.stroke(),e.restore()},e.prototype.drawHandles=function(e,t){var i=this;e.save(),this.handles.forEach(function(n){if(null!=n){var a=t.imageToClient_point(n);e.beginPath(),e.arc(a.x,a.y,i._handleSize,0,2*Math.PI),e.stroke(),e.closePath()}}),e.restore()},e.prototype.drawTip=function(e,t,i,n){if(null!=this.startpoint1&&null!=this.endpoint1&&null!=this.startpoint2&&null!=this.endpoint2){var a=new Point2d((this.startpoint1.x+this.endpoint1.x)/2,(this.startpoint1.y+this.endpoint1.y)/2),s=new Point2d((this.startpoint2.x+this.endpoint2.x)/2,(this.startpoint2.y+this.endpoint2.y)/2),r=new Point2d((a.x+s.x)/2,(a.y+s.y)/2),o="角度："+this.calAngle().toString()+"度",l=new Rect(r.x-1,r.y-1,r.x+1,r.y+1);null==this.tips?this.tips=TipLocation.calcTipLoc(e,t,o,l,i,1,10):this.tips.updateTip(e,t,o,i,1),a=t.imageToClient_point(a),s=t.imageToClient_point(s),r=t.imageToClient_point(r),TipLocation.drawTip(e,t,this.tips),TipLocation.drawConnectLine(e,t,this.tips,a),TipLocation.drawConnectLine(e,t,this.tips,s)}},e.prototype.calAngle=function(){var e=Utility.getAngleToXAxis(this.endpoint1,this.startpoint1),t=Utility.getAngleToXAxis(this.endpoint2,this.startpoint2),i=Math.abs(t-e);return i>Math.PI&&(i=2*Math.PI-i),Math.round(i/Math.PI*180)},e}(),CIMagnifyMirror=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"magnifyMirror",t,i,n)||this;return a._pressPoint=null,a._mirrorCanvas=document.createElement("canvas"),a._isTouchEvent=!1,a}return __extends(t,e),t.prototype.procImage=function(e){if(null!=this._pressPoint){var t=.3*e.width;t=Math.round(t);var i=this._pressPoint.x-t/2,n=this._pressPoint.y-t/2,a=.15*e.width;a=Math.round(a);var s=this._pressPoint.x-a/2,r=this._pressPoint.y-a/2,o=this._pressPoint.x+a/2,l=this._pressPoint.y+a/2,h=void 0,u=void 0,d=void 0;null==this._imageHelper.offCoarseRotateMatrix||this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_JPG?(h=this._imageHelper.clientToImage_point(this._pressPoint),u=this._imageHelper.clientToImage_point({x:s,y:r}),d=this._imageHelper.clientToImage_point({x:o,y:l})):(h=this._imageHelper.clientToCoarse_point(this._pressPoint),u=this._imageHelper.clientToCoarse_point({x:s,y:r}),d=this._imageHelper.clientToCoarse_point({x:o,y:l}));var c=Math.abs(u.x-d.x)/2,p=Math.abs(u.y-d.y)/2,g=h.x-c/2,_=h.y-p/2;this._mirrorCanvas.width=t,this._mirrorCanvas.height=t;var m=this._mirrorCanvas.getContext("2d",{alpha:!1});m.save(),m.fillStyle="black",m.fillRect(0,0,t,t);var f=[1,0,0,1,0,0],y=this._imageHelper.imageState.isHorzMirror,I=this._imageHelper.imageState.isVertMirror,x=this._imageHelper.imageState.rotateAngle;!y||90!=x&&270!=x||(x=(x+180+360)%360),!I||90!=x&&270!=x||(x=(x+180+360)%360),90==x?(f[0]=0,f[1]=1,f[2]=-1,f[3]=0,f[4]=t,f[5]=0):180==x?(f[0]=-1,f[1]=0,f[2]=0,f[3]=-1,f[4]=t,f[5]=t):270==x&&(f[0]=0,f[1]=-1,f[2]=1,f[3]=0,f[4]=0,f[5]=t),y&&(f[0]=-f[0],f[2]=-f[2],90==x?f[4]-=t:0==x?f[4]+=t:180==x?f[4]-=t:270==x&&(f[4]+=t)),I&&(f[1]=-f[1],f[3]=-f[3],90==x?f[5]+=t:270==x?f[5]-=t:0==x?f[5]+=t:180==x&&(f[5]-=t));m.transform.apply(m,f),this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL?m.drawImage(this._imageHelper.offFilterCanvas,g,_,c,p,0,0,t,t):this._imageHelper.imageData.getImageLevel()==IMAGE_LEVEL.IMAGE_LEVEL_JPG&&m.drawImage(this._imageHelper.imageData.getJPG(),g,_,c,p,0,0,t,t),m.restore();var w=i,D=n;if(this._isTouchEvent){w=0,D=0;var P={left:null,top:null,right:null,bottom:null};P.left=w-50,P.top=D-50,P.right=w+t+50,P.bottom=D+t+50,this._pressPoint.y<P.bottom&&this._pressPoint.x<=P.right&&(w=e.width-t)}var v=e.getContext("2d",{alpha:!1});v.save(),v.drawImage(this._mirrorCanvas,0,0,t,t,w,D,t,t);v.strokeStyle="#57f900",v.strokeRect(w,D,t,t),v.restore()}},t.prototype.procMessage=function(e){return e.annoName!=this.getName()?(this._pressPoint=null,!1):this._imageHelper.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID&&(e.name==UIMsg.touchDown||e.name==UIMsg.touchMove||e.name==UIMsg.touchUp?this._isTouchEvent=!0:this._isTouchEvent=!1,e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown?(this._pressPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,null,null)):e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove?(this._pressPoint={x:e.x,y:e.y},this._eventHandler.doHandler("update",this._parentID,null,null)):e.name!=UIMsg.mouseLBUp&&e.name!=UIMsg.touchUp||(this._pressPoint=null,this._eventHandler.doHandler("update",this._parentID,null,null)),!0)},t}(FilterBase)),XeAIMarker=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,"AIMarker",t,i,n)||this;return a._datas=null,a}return __extends(t,e),t.prototype.procImage=function(e){var t=this;if(this.imageData.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID){null!=this._datas&&this._datas.forEach(function(i){"circle"==i.type&&i.imageIndex[0]<=t._imageHelper.imageData.index&&i.imageIndex[1]>=t._imageHelper.imageData.index&&(i.radius=parseInt(i.radius),i.ptCenter.x=parseInt(i.ptCenter.x),i.ptCenter.y=parseInt(i.ptCenter.y),t.drawCircle(e,"#57f900",i))})}},t.prototype.drawCircle=function(e,t,i){if(!(i.radius<.1)){var n=this._imageHelper.imageToClient_point(i.ptCenter),a=new Point2d(i.ptCenter.x+i.radius,i.ptCenter.y),s=this._imageHelper.imageToClient_point(a).x-n.x,r=e.getContext("2d",{alpha:!1});r.save(),r.strokeStyle=t,r.globalAlpha=1,r.lineWidth=1,r.beginPath(),r.arc(n.x,n.y,s,0,2*Math.PI,!0),r.stroke(),r.restore()}},t.prototype.drawTips=function(e,t){var i=e.getContext("2d",{alpha:!1});i.save(),i.font=this.c_fontHeight.toString()+"px sans-serif";var n=this.calcTips(t),a=this.calcTipLoc(i,n,t);if(n.length>0){var s=a.getClientRect(this._imageHelper);i.globalAlpha=.5,i.fillStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPBACKGROUND),i.fillRect(s.left,s.top,s.Width,s.Height),i.strokeStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPBORDER),i.strokeRect(s.left,s.top,s.Width,s.Height),i.fillStyle=UIUtilities.getAnnoColor(AnnoColor.COLOR_TIPTEXT),i.globalAlpha=1,UIUtilities.drawMultiLineText(i,s,a.orientationType,n,this.c_fontHeight,this.c_lineSpacing)}i.restore()},t.prototype.calcTipLoc=function(e,t,i){var n=new Rect(0,0,0,0);return n.left=i.ptCenter.x-i.radius,n.right=i.ptCenter.x+i.radius,n.top=i.ptCenter.y-i.radius,n.left=i.ptCenter.y-i.radius,TipLocation.calcTipLoc(e,this._imageHelper,t,n,this.c_fontHeight,this.c_lineSpacing,10)},t.prototype.calcTips=function(e){return"中心密度："+this.imageData.getPixelValue(e.ptCenter).toString()},t.prototype.setMarker=function(e){this._datas=e.datas},t}(FilterBase)),XeSignalNoiseRatio=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(e){function t(t,i,n){var a=e.call(this,t,i,n,"signalNoiseRatio")||this;return a._pressedBasePoint=null,a._lastPoint=null,a._defaultRadius_mm=5.64,a._backgroundMargin=10,a.isKeepCircle=!0,a._ellipses=t.imageState.signalNoiseRatio.ellipses,a._ellipses.forEach(function(e){e.clearTips()}),a}return __extends(t,e),t.prototype.getSNRBackValue=function(){return 0==this.ellipses.length?null:{back1_avrg:this.ellipses[0].getValue("average"),back2_avrg:this.ellipses[1].getValue("average"),back3_avrg:this.ellipses[2].getValue("average"),back4_avrg:this.ellipses[3].getValue("average"),back1_diff:this.ellipses[0].getValue("standarddiff"),back2_diff:this.ellipses[1].getValue("standarddiff"),back3_diff:this.ellipses[2].getValue("standarddiff"),back4_diff:this.ellipses[3].getValue("standarddiff")}},t.prototype.getSNRROIValue=function(){return 0==this.ellipses.length?null:{roi_avrg:this.ellipses[4].getValue("average"),roi_diff:this.ellipses[4].getValue("standarddiff")}},t.prototype.GetSavedEllipse=function(e,t){var i=localStorage.getItem("NoiseSignalRatio_Ellipses");if(null==i||0==i.length)return t;var n=JSON.parse(i),a=new Rect(n[e].left,n[e].top,n[e].right,n[e].bottom);return new Ellipse(a)},t.prototype.SavedEllipse=function(e,t,i,n,a){var s=[e.outerRect,t.outerRect,i.outerRect,n.outerRect,a.outerRect],r=JSON.stringify(s);localStorage.setItem("NoiseSignalRatio_Ellipses",r)},t.prototype.initEllipses=function(){var e=this._imageHelper.imageData.imageWidth,t=this._imageHelper.imageData.imageHeight;if(!(t<1||e<1)){var i=Math.round(this._defaultRadius_mm/this._imageHelper.imageData.pixelSpacingX),n=Math.round(e/2),a=Math.round(t/2),s=new Rect(this._backgroundMargin,this._backgroundMargin,this._backgroundMargin+2*i,this._backgroundMargin+2*i),r=new Ellipse(s);this._ellipses.push(this.GetSavedEllipse(0,r));var o=s.clone();o.offsetRect(e-2*this._backgroundMargin-2*i,0);var l=new Ellipse(o);this._ellipses.push(this.GetSavedEllipse(1,l));var h=s.clone();h.offsetRect(0,t-2*this._backgroundMargin-2*i);var u=new Ellipse(h);this._ellipses.push(this.GetSavedEllipse(2,u));var d=h.clone();d.offsetRect(e-2*this._backgroundMargin-2*i,0);var c=new Ellipse(d);this._ellipses.push(this.GetSavedEllipse(3,c));var p=new Rect(n-i,a-i,n+i,a+i),g=new Ellipse(p);this._ellipses.push(this.GetSavedEllipse(4,g)),(p.Width<1||p.Height<2)&&console.error("Error Level: invalid roi rect")}},t.prototype.procImage=function(t){this._imageHelper.imageState.dispInfo.isSNRShow?(0==this._ellipses.length&&this.initEllipses(),e.prototype.procImage.call(this,t),this.drawTips(t),this._ellipses.length>0&&this.SavedEllipse(this._ellipses[0],this._ellipses[1],this._ellipses[2],this._ellipses[3],this._ellipses[4])):this.showSliderControl()},t.prototype.onSliderChanged=function(e){if(!(this._selectedEllipseIndex<0||this._selectedEllipseIndex>=this._ellipses.length)){var t=new Rect(this._ellipses[this._selectedEllipseIndex].center.x-e,this._ellipses[this._selectedEllipseIndex].center.y-e,this._ellipses[this._selectedEllipseIndex].center.x+e,this._ellipses[this._selectedEllipseIndex].center.y+e);this._ellipses[this._selectedEllipseIndex].setEllipseRect(t),this._eventHandler.doHandler("update",this._parentID,null,null)}},t.prototype.showSliderControl=function(){var e=this;if(null==this._selectedEllipseIndex||this._selectedEllipseIndex<0||this._selectedEllipseIndex>=this._ellipses.length)null!=CImageDrawerManager.GetInstance().sliderHideControlHandle&&CImageDrawerManager.GetInstance().sliderHideControlHandle(this._imageHelper.getCanvasID());else{var t=this._ellipses[this._selectedEllipseIndex].hRadius;null!=CImageDrawerManager.GetInstance().sliderShowControlHandle&&CImageDrawerManager.GetInstance().sliderShowControlHandle(this._imageHelper.getCanvasID(),this._minRadius,Math.round(this.imageData.imageWidth/4),t,function(t){e.onSliderChanged(t)})}},t.prototype.procMessage=function(e){if(this._imageHelper.imageState.dispInfo.isSNRShow){if(e.name==UIMsg.mouseLBDown||e.name==UIMsg.touchDown){if(this._isLBDown=!0,this._originalEllipseRect=new Rect(0,0,0,0),this.hitOnHandle({x:e.x,y:e.y}))return this._pressedBasePoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),this.showSliderControl(),!0;if(this.hitOnBody({x:e.x,y:e.y}))return this.showSliderControl(),this._pressedBasePoint=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),!0;this.showSliderControl()}else if(e.name==UIMsg.mouseLBUp||e.name==UIMsg.touchUp){if(this._isLBDown=!1,this._lastPoint=null,this._originalEllipseRect=null,e.x&&e.y&&null!=this._selectedEllipseIndex)return this._imageHelper.needDrawSerial=!0,this._eventHandler.doHandler("update",this._parentID,this._lastPoint,new Point2d(e.pageX,e.pageY)),!0}else if(e.name==UIMsg.mouseMove||e.name==UIMsg.touchMove){if(!this._isLBDown)return!1;if(null==this._selectedEllipseIndex)return!1;var t=this._imageHelper.clientToImage_point({x:e.x,y:e.y}),i=t.x-this._pressedBasePoint.x,n=t.y-this._pressedBasePoint.y;if(null!=this._selectedHandleIndex){var a=this.getOffsetRect(this._originalEllipseRect,this._selectedHandleIndex,i,n);this._ellipses[this._selectedEllipseIndex].setEllipseRect(a)}else{(a=this._originalEllipseRect.clone()).offsetRect(i,n),this._ellipses[this._selectedEllipseIndex].setEllipseRect(a)}return this.showSliderControl(),this._eventHandler.doHandler("update",this._parentID,{x:e.x,y:e.y},new Point2d(e.pageX,e.pageY)),!0}return!1}},t.prototype.calcTipLoc=function(e,t){return 5!=this._ellipses.length?null:TipLocation.calcTipLoc(e,this._imageHelper,t,this._ellipses[4].outerRect,this.c_fontHeight,this.c_lineSpacing,10)},t.prototype.calcTips=function(){if(5!=this._ellipses.length)return"";var e=Number(this._ellipses[0].getValue("standarddiff")),t=Number(this._ellipses[1].getValue("standarddiff")),i=Number(this._ellipses[2].getValue("standarddiff")),n=Number(this._ellipses[3].getValue("standarddiff")),a=Number(this._ellipses[0].getValue("average")),s=Number(this._ellipses[1].getValue("average")),r=Number(this._ellipses[2].getValue("average")),o=Number(this._ellipses[3].getValue("average")),l=Number(this._ellipses[4].getValue("average")),h="BK_AVG："+((a+s+r+o)/4).toFixed(3)+"\r\n";return h+="BK_SDAVG："+((e+t+i+n)/4).toFixed(3)+"\r\n",h+="TL_SNR："+(.665*l/e).toFixed(3)+"\r\n",h+="TR_SNR："+(.665*l/t).toFixed(3)+"\r\n",h+="BL_SNR："+(.665*l/i).toFixed(3)+"\r\n",h+="BR_SNR："+(.665*l/n).toFixed(3)+"\r\n",h+="SNR："+((e+t+i+n)/4).toFixed(3)},t.prototype.drawTips=function(e){if(5==this._ellipses.length){var t=e.getContext("2d",{alpha:!1});t.save(),t.font=this.c_fontHeight.toString()+"px sans-serif";var i=this.calcTips(),n=this.calcTipLoc(t,i);TipLocation.drawTip(t,this._imageHelper,n)}},t.prototype.clear=function(){null!=CImageDrawerManager.GetInstance().sliderHideControlHandle&&CImageDrawerManager.GetInstance().sliderHideControlHandle(this._imageHelper.getCanvasID())},t}(CXeAnnoEllipse)),CRequestImgInfo=function(){return function(){this.tileIndexes=new Array}}(),MPR_PARAMS=function(){return function(){}}(),VR_PARAM=function(){return function(){}}(),CXeMessageProtocol=function(){function e(){this._msgCount=0,this._sessionID="",this._token=""}return Object.defineProperty(e.prototype,"sessionID",{get:function(){return this._sessionID},set:function(e){this._sessionID=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"token",{set:function(e){this._token=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"msgCount",{get:function(){return this._msgCount},enumerable:!0,configurable:!0}),e.prototype.createSession=function(e){var t={head:{cmdName:"CreateSession",msgID:++this._msgCount,uData:"",token:this._token,sessionID:this._sessionID},body:{userName:e}};return JSON.stringify(t)},e.prototype.closeSession=function(){var e={head:{cmdName:"CloseSession",msgID:++this._msgCount,uData:"",token:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456"}};return JSON.stringify(e)},e.prototype.getXeguid=function(e,t){var i={head:{cmdName:"getXeguid",msgID:++this._msgCount,uData:"",token:this._token},body:{name:e,value:t,sessionID:this._sessionID}};return JSON.stringify(i)},e.prototype.getStudyInfo=function(e,t){var i={head:{cmdName:"GetStudyInfo",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,sessionID:this._sessionID,hidePatientInfo:t}};return JSON.stringify(i)},e.prototype.getSeriesInfo=function(e){var t={head:{cmdName:"GetSeriesInfo",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,sessionID:this._sessionID}};return JSON.stringify(t)},e.prototype.getImageBinary=function(e,t,i,n,a,s,r,o){void 0===a&&(a=null),void 0===s&&(s=null),void 0===r&&(r=!0),void 0===o&&(o=[]);var l={head:{cmdName:"GetImageBinary",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,sessionID:this._sessionID,seriesIndex:t,currentImages:i,reservedImages:n}};return null!=a&&null!=s&&(l.body.windowCenter=a,l.body.windowWidth=s,l.body.forceWW=r?1:0),o.length>0&&(l.body.cancelledMsgIDs=o),JSON.stringify(l)},e.prototype.getImageInfo=function(e,t,i,n,a){var s={head:{cmdName:"GetImageInfo",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,seriesIndex:t,currentImageIndexs:i,reservedImageIndexs:n,sessionID:this._sessionID,hidePatientInfo:a}};return JSON.stringify(s)},e.prototype.getSerialThumb=function(e,t){void 0===t&&(t=[]);var i={head:{cmdName:"GetSerialThumb",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,sessionID:this._sessionID,seriesIndexes:t}};return JSON.stringify(i)},e.prototype.cancelMessages=function(e){var t={sessionID:this._sessionID,cancelledMsgIDs:e};return JSON.stringify(t)},e.prototype.getStudyThumb=function(e){var t={head:{cmdName:"getStudyThumb",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,sessionID:this._sessionID}};return JSON.stringify(t)},e.prototype.getVRInfo=function(e,t){var i={head:{cmdName:"getVRInfo",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,seriesIndex:t,sessionID:this._sessionID}};return JSON.stringify(i)},e.prototype.getVRJpg=function(e,t,i){var n={head:{cmdName:"getVRJpg",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,seriesIndex:t,sessionID:this._sessionID,eyeRayX:i.eyeRay.x,eyeRayY:i.eyeRay.y,eyeRayZ:i.eyeRay.z,yAxisX:i.yAxis.x,yAxisY:i.yAxis.y,yAxisZ:i.yAxis.z,opa_x1:i.opa_x1,opa_x2:i.opa_x2,opa_x3:i.opa_x3,opa_x4:i.opa_x4,opa_height:i.opa_height,fov:i.fov,width:i.width,height:i.height,pixelRate:i.pixelRate,middlePointX:i.middlePoint.x,middlePointY:i.middlePoint.y,middlePointZ:i.middlePoint.z}};return JSON.stringify(n)},e.prototype.getMPRInfo=function(e,t){var i={head:{cmdName:"getMPRInfo",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,seriesIndex:t,sessionID:this._sessionID}};return JSON.stringify(i)},e.prototype.getMPRJpg=function(e,t,i,n){var a={head:{cmdName:"getMPRJpg2",msgID:++this._msgCount,uData:"",token:this._token},body:{xeGUID:e,seriesIndex:t,sessionID:this._sessionID,planum:i,planum_t:n.planum_t,planum_c:n.planum_c,planum_s:n.planum_s,planum_o:n.planum_o,reset:n.reset}};return JSON.stringify(a)},e.prototype.getImageFile=function(e,t,i,n){var a={head:{cmdName:"GetImageFile",msgID:++this._msgCount,uData:"",token:this._token},body:{sessionID:this._sessionID,xeGUID:e,seriesIndex:t,imageIndex:i,highPriority:n}};return JSON.stringify(a)},e}(),CMessageProcesser=function(){function e(){this._msgProtocol=null,this._connectedTimes=0,this._sessionCreated=!1,this._getEventCache=new Array,this.OnGetXeguid=null,this.onGetStudyInfo=null,this.onGetSeriesInfo=null,this.onGetImageInfo=null,this.onGetImageBinary=null,this.onGetSerialThumb=null,this.onGetStudyThumb=null,this.onGetVRInfo=null,this.onGetVRJpg=null,this.onGetMPRInfo=null,this.onGetMPRJpg=null,this.onCreateSession=null,this.onGetImageFile=null,this._msgProtocol=new CXeMessageProtocol}return e.prototype.Connect=function(e,t,i){this._wsHost=e,this._userName=t,this._token=i,this._msgProtocol.token=i;var n=this;function a(){console.debug("onWSOpen"),n.createSession()}function s(e){console.debug("onWSClose: "+e.reason),n._sessionCreated=!1,l()}function r(e){console.debug("onWSError: "+e.message)}function o(e){try{if("string"==typeof e.data){var t=JSON.parse(e.data);switch(console.debug(t.head.cmdName),t.head.cmdName){case"CreateSessionRsp":0!=t.head.errCode?(console.error("CreateSessionRsp() return error:%s",t.head.errText),alert("服务器繁忙，请稍后刷新页面重试。")):(n._msgProtocol.sessionID=t.body.sessionID,n._sessionCreated=!0,n.onCreateSession(t),n._getEventCache.length>0&&(n._getEventCache.forEach(function(e){"getStudyInfo"==e.name?n.getStudyInfo(e.args.xeGUID,e.args.hidePatientInfo):"getXeguid"==e.name?n.getXeguid(e.args.name,e.args.value):"getSeriesInfo"==e.name?n.getSeriesInfo(e.args.xeGUID):"getImageInfo"==e.name?n.getImageInfo(e.args.xeGUID,e.args.seriesIndex,e.args.currentImageIndexs,e.args.reservedImageIndexs,e.args.hidePatientInfo):"getImageBinary"==e.name?n.getImageBinary(e.args.xeGUID,e.args.seriesIndex,e.args.currentImages,e.args.reservedImages,e.args.windowCenter,e.args.windowWidth,e.args.forceWW,e.args.cancelledMsgIDs):"getSerialThumb"==e.name?n.getSerialThumb(e.args.xeGUID,e.args.seriesIndexes):"getStudyThumb"==e.name?n.getStudyThumb(e.args.xeGUID):"getVRInfo"==e.name?n.getVRInfo(e.args.xeGUID,e.args.seriesIndex):"getVRJpg"==e.name?n.getVRJpg(e.args.xeGUID,e.args.seriesIndex,e.param):"getMPRInfo"==e.name?n.getMPRInfo(e.args.xeGUID,e.args.seriesIndex):"getMPRJpg"==e.name?n.getMPRJpg(e.args.xeGUID,e.args.seriesIndex,e.args.planum,e.args.param):"GetImageFile"==e.name&&n.getMPRJpg(e.args.xeGUID,e.args.seriesIndex,e.args.imageIndex,e.args.highPriority)}),n._getEventCache.splice(0)));break;case"getXeguidRsp":n.OnGetXeguid(t);break;case"GetStudyInfoRsp":n.onGetStudyInfo(t);break;case"GetSeriesInfoRsp":n.onGetSeriesInfo(t);break;case"GetImageInfoRsp":n.onGetImageInfo(t);break;case"getVRInfoRsp":n.onGetVRInfo(t);break;case"getMPRInfoRsp":n.onGetMPRInfo(t)}}else{var i=new FileReader;i.onload=function(e){if(e.target.readyState==FileReader.DONE){for(var t=new Uint8Array(e.target.result),i=Utility.convertToInt(t.subarray(0,4)),a="",s=4;s<4+i;++s)a+=String.fromCharCode(t[s]);a=Utility.Utf8ToUnicode(a);var r=JSON.parse(a);switch(r.head.cmdName){case"GetImageBinaryRsp":n.onGetImageBinary(r,t.subarray(4+i+4));break;case"GetSerialThumbRsp":var o=new Blob([t.subarray(4+i+4+4)],{type:"application/octet-binary"});n.onGetSerialThumb(r,o);break;case"getStudyThumbRsp":o=new Blob([t.subarray(4+i+4+4)],{type:"application/octet-binary"});n.onGetStudyThumb(r,o);break;case"getVRJpgRsp":n.onGetVRJpg(r,t.subarray(4+i+4));break;case"getMPRJpgRsp":case"getMPRJpg2Rsp":var l=new Blob([t.subarray(4+i+4+4)],{type:"application/octet-binary"});n.onGetMPRJpg(r,l);break;case"GetImageFileRsp":var h=new Blob([t.subarray(4+i+4)],{type:"application/octet-binary"});n.onGetImageFile(r,h)}}},i.readAsArrayBuffer(e.data)}}catch(e){console.error(e)}}function l(){console.debug("Connecting: "+n._wsHost),n._ws=new WebSocket(n._wsHost),n._ws.onopen=a,n._ws.onmessage=o,n._ws.onerror=r,n._ws.onclose=s}l()},e.prototype.Send=function(e){this._ws.readyState==WebSocket.OPEN&&this._ws.send(e)},e.prototype.createSession=function(){this.Send(this._msgProtocol.createSession(this._userName))},e.prototype.getStudyInfo=function(e,t){this._sessionCreated?this.Send(this._msgProtocol.getStudyInfo(e,t)):this._getEventCache.push({name:"getStudyInfo",args:{xeGUID:e,hidePatientInfo:t}})},e.prototype.getXeguid=function(e,t){this._sessionCreated?this.Send(this._msgProtocol.getXeguid(e,t)):this._getEventCache.push({name:"getXeguid",args:{name:e,value:t}})},e.prototype.getSeriesInfo=function(e){this._sessionCreated?this.Send(this._msgProtocol.getSeriesInfo(e)):this._getEventCache.push({name:"getSeriesInfo",args:{xeGUID:e}})},e.prototype.getImageInfo=function(e,t,i,n,a){this._sessionCreated?this.Send(this._msgProtocol.getImageInfo(e,t,i,n,a)):this._getEventCache.push({name:"getImageInfo",args:{xeGUID:e,seriesIndex:t,currentImageIndexs:i,reservedImageIndexs:n,hidePatientInfo:a}})},e.prototype.getImageBinary=function(e,t,i,n,a,s,r,o){return void 0===a&&(a=null),void 0===s&&(s=null),void 0===r&&(r=!0),void 0===o&&(o=[]),this._sessionCreated?this.Send(this._msgProtocol.getImageBinary(e,t,i,n,a,s,r,o)):this._getEventCache.push({name:"getImageBinary",args:{xeGUID:e,seriesIndex:t,currentImages:i,reservedImages:n,windowCenter:a,windowWidth:s,forceWW:r,cancelledMsgIDs:o}}),this._msgProtocol.msgCount},e.prototype.getSerialThumb=function(e,t){var i=new Array;i.push(t),this._sessionCreated?this.Send(this._msgProtocol.getSerialThumb(e,i)):this._getEventCache.push({name:"getSerialThumb",args:{xeGUID:e,seriesIndexes:i}})},e.prototype.getStudyThumb=function(e){this._sessionCreated?this.Send(this._msgProtocol.getStudyThumb(e)):this._getEventCache.push({name:"getStudyThumb",args:{xeGUID:e}})},e.prototype.getVRInfo=function(e,t){this._sessionCreated?this.Send(this._msgProtocol.getVRInfo(e,t)):this._getEventCache.push({name:"getVRInfo",args:{xeGUID:e,seriesIndex:t}})},e.prototype.getVRJpg=function(e,t,i){this._sessionCreated?this.Send(this._msgProtocol.getVRJpg(e,t,i)):this._getEventCache.push({name:"getVRJpg",args:{xeGUID:e,seriesIndex:t,param:i}})},e.prototype.getMPRInfo=function(e,t){this._sessionCreated?this.Send(this._msgProtocol.getMPRInfo(e,t)):this._getEventCache.push({name:"getMPRInfo",args:{xeGUID:e,seriesIndex:t}})},e.prototype.getMPRJpg=function(e,t,i,n){return this._sessionCreated?this.Send(this._msgProtocol.getMPRJpg(e,t,i,n)):this._getEventCache.push({name:"getMPRJpg",args:{xeGUID:e,seriesIndex:t,planum:i,param:n}}),this._msgProtocol.msgCount},e.prototype.getImageFile=function(e,t,i,n){this._sessionCreated?this.Send(this._msgProtocol.getImageFile(e,t,i,n)):this._getEventCache.push({name:"GetImageFile",args:{xeGUID:e,seriesIndex:t,imageIndex:i,highPriority:n}})},e}(),CImageResult=function(){function e(){this._imageWidth=0,this._imageHeight=0,this._lastGetTimeStamp=0}return Object.defineProperty(e.prototype,"imageWidth",{get:function(){return this._imageWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageHeight",{get:function(){return this._imageHeight},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=new e;return t._imageHeight=this._imageHeight,t._imageWidth=this._imageWidth,t._resultData=null==this._resultData?null:new Uint8ClampedArray(this._resultData),t},Object.defineProperty(e.prototype,"lastGetTimeStamp",{get:function(){return this._lastGetTimeStamp},enumerable:!0,configurable:!0}),e.prototype.getResultBuffer=function(e,t,i){var n=new Date;return this._lastGetTimeStamp=n.getTime(),i<=IMAGE_LEVEL.IMAGE_LEVEL_JPG?null:(e==this._imageWidth&&t==this._imageHeight&&null!=this._resultData||(this._imageWidth=e,this._imageHeight=t,this._resultData=new Uint8ClampedArray(t*e*4)),this._resultData)},e.prototype.getResultImageBuffer=function(){return this._resultData},e.prototype.clearCache=function(){this._resultData=null,this._imageWidth=0,this._imageHeight=0},e}();!function(e){e[e.IMAGE_LEVEL_INVALID=0]="IMAGE_LEVEL_INVALID",e[e.IMAGE_LEVEL_JPG=1]="IMAGE_LEVEL_JPG",e[e.IMAGE_LEVEL_ORIGINAL=2]="IMAGE_LEVEL_ORIGINAL"}(IMAGE_LEVEL||(IMAGE_LEVEL={}));var CImageData=function(){function e(t,i,n,a){void 0===a&&(a=0),this._xeGUID="",this._seriesIndex=-1,this.studyInstanceUID="",this.overlayInfo=null,this.tileWidth=256,this.tileHeight=256,this.frameIndex=0,this.heightFull=0,this.widthFull=0,this.defaultWW=null,this.defaultWL=null,this.classUID="123457890",this.magnificationFactor=1,this.numberOfFrames=1,this.photoMetricInterpretation="MONOCHROME2",this.samplesPerPixel=0,this.bitsAllocated=0,this.bitsStored=0,this.highBit=0,this.pixelRepresentation=0,this.imageDistanceToZero=0,this.zeroImagePosition=[],this.imageWidth=0,this.imageHeight=0,this.patientName="",this._isInLocalDB=!1,this._imageData16=null,this.imageJPG=null,this._isM2Ling=!1,this._isL2Ming=!1,this._L2M_cbs=new Array,this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID,this._blockCountPerLine=0,this._blockMatrix=null,this._loadImageOvertimeSeconds=2,this.realIndex=n,this.frameIndex=a,this.index=e.indexMerge(n,a),this._xeGUID=t,this._seriesIndex=i}return Object.defineProperty(e.prototype,"imageData16",{get:function(){return this._imageData16},set:function(e){this._imageData16=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imagePosition",{get:function(){return this._imagePosition},set:function(e){e&&(this._imagePosition=e)},enumerable:!0,configurable:!0}),e.prototype.MemoryToLocalDB=function(e){var t=this;void 0===e&&(e=null),!this._isInLocalDB&&!this._isM2Ling&&this._imageData16&&CLocalForageWrapperInstance.GetInstance().CanLocalDB()?(this._isM2Ling=!0,CLocalForageWrapperInstance.GetInstance().SaveItemToDBWithQueue(this.xeGuid,this.xeGuid+"_"+this.seriesIndex.toString()+"_"+this.index.toString(),this._imageData16,function(i){i?(t._isInLocalDB=!0,t._isM2Ling=!1,e&&e(!0)):(t._isM2Ling=!1,e&&e(!1))})):this._isInLocalDB&&e&&e(!0)},e.prototype.LocalDBToMemory=function(e,t){var i=this;if(void 0===t&&(t=null),null==this._imageData16&&this._isInLocalDB){Date.now();if(t&&this._L2M_cbs.push(t),!this._isL2Ming){this._isL2Ming=!0;var n=setTimeout(function(){null==i._imageData16&&null==i.getJPG()?i._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID:null==i._imageData16&&null!=i.getJPG()&&(i._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_JPG),i._isL2Ming=!1,i._L2M_cbs.forEach(function(e){e(!1)}),i._L2M_cbs.splice(0)},1e3);CLocalForageWrapperInstance.GetInstance().GetItemFromDB(this.xeGuid,this.xeGuid+"_"+this.seriesIndex.toString()+"_"+this.index.toString(),e,function(e,t){clearTimeout(n),e&&t?(i._imageData16=t,i._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL,i._L2M_cbs.forEach(function(e){e(!0)}),i._L2M_cbs.splice(0),i._isL2Ming=!1):(i._isInLocalDB=!1,null==i._imageData16&&null==i.getJPG()?i._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID:null==i._imageData16&&null!=i.getJPG()&&(i._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_JPG),i._isL2Ming=!1,i._L2M_cbs.forEach(function(e){e(!1)}),i._L2M_cbs.splice(0))})}}else t&&t(!1),console.warn("LocalDBToMemory failed: Not exist in LocalDB")},e.prototype.HasLocalDB=function(){return this._isInLocalDB},Object.defineProperty(e.prototype,"xeGuid",{get:function(){return this._xeGUID},enumerable:!0,configurable:!0}),e.indexMerge=function(e,t){return void 0===t?String(e)+"_0":String(e)+"_"+String(t)},e.realIndexSplit=function(e){var t=e.split("_");return parseInt(t[0])},e.indexIncrease=function(e){var t=e.split("_"),i=parseInt(t[0]);return(++i).toString()+t[1]},Object.defineProperty(e.prototype,"seriesIndex",{get:function(){return this._seriesIndex},enumerable:!0,configurable:!0}),e.prototype.getImageLevel=function(){return this._imageLevel},e.prototype.setOverlayInfo=function(e){null==this.overlayInfo&&(this.overlayInfo={}),this.overlayInfo.leftBottom=e.leftBottom,this.overlayInfo.leftTop=e.leftTop,this.overlayInfo.rightBottom=e.rightBottom,this.overlayInfo.rightTop=e.rightTop},e.prototype.hidePatientName=function(){""!=this.patientName&&(this.overlayInfo.leftBottom=this.overlayInfo.leftBottom.replace(this.patientName,"***"),this.overlayInfo.leftTop=this.overlayInfo.leftTop.replace(this.patientName,"***"),this.overlayInfo.rightBottom=this.overlayInfo.rightBottom.replace(this.patientName,"***"),this.overlayInfo.rightTop=this.overlayInfo.rightTop.replace(this.patientName,"***"))},e.prototype.cloneImageDataInfo=function(t){void 0===t&&(t=0);var i=new e(this.xeGuid,this.seriesIndex,this.realIndex,t);return i.acquisitionNumber=this.acquisitionNumber,i.acquisitionTime=this.acquisitionTime,i.contentTime=this.contentTime,i.imagerPixelSpacing=this.imagerPixelSpacing,i.magnificationFactor=this.magnificationFactor,i.imageOrientation=this.imageOrientation,i.imagePosition=this.imagePosition,i.imageType=this.imageType,i.imageDataTypeId=this.imageDataTypeId,i.numberOfFrames=this.numberOfFrames,i.patientPosition=this.patientPosition,i.photoMetricInterpretation=this.photoMetricInterpretation,i.samplesPerPixel=this.samplesPerPixel,i.bitsAllocated=this.bitsAllocated,i.bitsStored=this.bitsStored,i.highBit=this.highBit,i.pixelRepresentation=this.pixelRepresentation,i.pixelSpacingX=this.pixelSpacingX,i.pixelSpacingY=this.pixelSpacingY,i.defaultWW=this.defaultWW,i.defaultWL=this.defaultWL,i._xeGUID=this._xeGUID,i._seriesIndex=this._seriesIndex,i.overlayInfo=this.overlayInfo,i.imageWidth=this.imageWidth,i.imageHeight=this.imageHeight,i.patientName=this.patientName,i.widthFull=this.widthFull,i.heightFull=this.heightFull,i},e.prototype.setDicomInfo=function(e){e.studyInstanceUID&&(this.studyInstanceUID=e.studyInstanceUID),this.acquisitionNumber=parseInt(e.acquisitionNum),this.acquisitionTime=e.acquisitionTime,this.contentTime=e.contentTime,this.imagerPixelSpacing=e.imagerPixelSpacing,this.magnificationFactor=e.magnificationFactor,this.heightFull=parseInt(e.height),this.widthFull=parseInt(e.width),this.imageOrientation=e.imageOrientation,this.imagePosition=e.imagePosition,this.imageType=e.imageType,e.imageDataTypeId&&(this.imageDataTypeId=e.imageDataTypeId),this.numberOfFrames=parseInt(e.numOfFrames),this.patientPosition=e.patientPosition,this.photoMetricInterpretation=e.photoMetricInterpretation,this.setPixelInfo(e.pixelInfo),this.setPixelSpacing(e.pixelSpacing),e.patientName&&(this.patientName=e.patientName)},e.prototype.setImageLevel=function(e){e<0||e>IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL?this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID:e>this._imageLevel&&(this._imageLevel=e)},e.prototype.setDefaultWW=function(e,t){null==this.defaultWW&&(this.defaultWL=t,this.defaultWW=e)},e.prototype.setPixelRepresentation=function(e){this.pixelRepresentation=e},e.prototype.appendFullData=function(e){if(8==this.bitsAllocated);else if(16==this.bitsAllocated){var t=(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0];e=e.subarray(4,4+t);var i=new JSZip(e).file("1").asArrayBuffer();return this._imageData16=new Int16Array(i,0,Math.floor(i.byteLength/2)),this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL,this.imageHeight=this.heightFull,this.imageWidth=this.widthFull,!0}},e.prototype.mergeData=function(e,t,i){if(1==i)return this.mergeDataZip(e,t)},e.prototype.mergeDataZip=function(e,t){var i=(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0];e=e.subarray(4,4+i);var n=new JSZip(e).file("1").asUint8Array(),a=(n[3]<<24)+(n[2]<<16)+(n[1]<<8)+n[0],s=(n[7]<<24)+(n[6]<<16)+(n[5]<<8)+n[4],r=new Uint8Array(n.subarray(8,a*s+8));a=((n=n.subarray(a*s+8))[3]<<24)+(n[2]<<16)+(n[1]<<8)+n[0],s=(n[7]<<24)+(n[6]<<16)+(n[5]<<8)+n[4];var o=new Uint8Array(n.subarray(8,a*s+8));return this.loadOneBlockZip(r,o,t)},e.prototype.getData=function(){return 16==this.bitsAllocated?this.imageData16:null},e.prototype.getJPG=function(){return this.imageJPG},e.prototype.setJPG=function(e){null==e&&this._imageLevel==IMAGE_LEVEL.IMAGE_LEVEL_JPG&&(this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID),this.imageJPG=e},e.prototype.setPixelInfo=function(e){var t=e.split("\\");5==t.length&&(this.samplesPerPixel=Number(t[0]),this.bitsAllocated=Number(t[1]),this.bitsStored=Number(t[2]),this.highBit=Number(t[3]),this.pixelRepresentation=Number(t[4]))},e.prototype.setPixelSpacing=function(e){var t=e.split("\\");2==t.length&&(this.pixelSpacingX=parseFloat(t[0]),this.pixelSpacingY=parseFloat(t[1]))},e.prototype.isImageCutToBlock=function(){return void 0===this._useBlockMode&&(this.widthFull>1e3||this.heightFull>1e3?this._useBlockMode=!0:this._useBlockMode=!1),this._useBlockMode},e.prototype.setImageBlock=function(e,t){null!=this._blockMatrix&&(e>=this._blockMatrix.length||e<0||this._blockMatrix[e].isAlloc||(this._blockMatrix[e].isAlloc=!0,this._blockMatrix[e].blockData=t))},e.prototype.getPixelValue=function(e){if(this._imageLevel!=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL)return 0;var t=Math.round(e.x),i=Math.round(e.y);if(t<0||t>=this.imageWidth||i<0||i>=this.imageHeight)return 0;if(null==this.imageData16)return 0;var n=i*this.imageWidth+t;return this.imageData16[n]},e.prototype.getPixelValueXY=function(e,t){if(this._imageLevel!=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL)return-1024;if(null==this.imageData16)return-1024;var i=t*this.imageWidth+e;return this.imageData16[i]},e.prototype.getBlankBlocks=function(e){if(null==this._blockMatrix){this._blockCountPerLine=Math.ceil(this.widthFull/this.tileWidth);var t=this._blockCountPerLine*Math.ceil(this.heightFull/this.tileWidth);this._blockMatrix=new Array(t);for(var i=0;i<t;i++){var n={isAlloc:!1,isInBuffer:0,blockData:null};this._blockMatrix[i]=n}this._useBlockMode=!0}var a=new Array,s=new Array,r=Math.floor(e.left/this.tileWidth);r<=0&&(r=0);var o=Math.ceil(e.right/this.tileWidth);o<=0&&(o=this._blockCountPerLine-1);var l=Math.floor(e.top/this.tileWidth);l<=0&&(l=0);var h=Math.ceil(e.bottom/this.tileWidth);h<=0&&(h=Math.ceil(this.heightFull/this.tileWidth));for(i=0;i<this._blockMatrix.length;i++)if(!this._blockMatrix[i].isAlloc){var u=i%this._blockCountPerLine,d=Math.ceil(i/this._blockCountPerLine);u>=r&&u<=o&&d>=l&&d<=h?a.push(i):s.push(i)}for(i=0;i<s.length;i++)a.push(s[i]);return a},e.prototype.isAllBlockFilled=function(){if(null==this._blockMatrix)return!1;for(var e=0;e<this._blockMatrix.length;e++)if(!this._blockMatrix[e].isAlloc)return!1;return!0},e.prototype.isBlockFilling=function(){return null!=this._blockMatrix},e.prototype.combineBlocks=function(){this._imageData16=new Int16Array(this.widthFull*this.heightFull);for(var e=0;e<this._blockMatrix.length;e++)this.mergeData(this._blockMatrix[e].blockData,e,1);this._blockMatrix=null,this.imageHeight=this.heightFull,this.imageWidth=this.widthFull,this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL},e.prototype.loadOneBlockZip=function(e,t,i){var n=Math.floor(i/this._blockCountPerLine),a=i%this._blockCountPerLine,s=n*this.tileWidth,r=s+this.tileWidth;r>this.heightFull&&(r=this.heightFull);var o=a*this.tileWidth,l=o+this.tileWidth;l>this.widthFull&&(l=this.widthFull);for(var h=0,u=s;u<r;u++)for(var d=u*this.widthFull,c=o;c<l;c++)this._imageData16[d+c]|=e[h]<<8,this._imageData16[d+c]|=t[h],h++;return!0},e.prototype.clearCache=function(e){e||this._isInLocalDB?!e&&this._isInLocalDB?(this.setJPG(null),this.imageData16=null):16==this.bitsAllocated&&(this.setJPG(null),this._isInLocalDB?this.imageData16=null:this.MemoryToLocalDB()):(this._blockCountPerLine=0,this._blockMatrix=null,this._imageLevel=IMAGE_LEVEL.IMAGE_LEVEL_INVALID,this.imageData16=null,this.imageJPG=null)},e}(),CMPRDatas=(__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),function(){function e(){this._MPRDatas=new Map}return e.prototype.getMPRData=function(e,t){var i=e+"_"+t;return this._MPRDatas.has(i)?this._MPRDatas.get(i):null},e.prototype.setMPRData=function(e,t,i){var n=e+"_"+t;this._MPRDatas.set(n,i)},e}()),CMPRImageData=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.firstImageLoaded=!1,t.eyeRay=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.yAxis=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.thickness=0,t.mprMIPType="",t.ptCenter=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.ptOrigin=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t._dynaWidth=0,t.dynaHeight=0,t.dynaEyeRay=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.dynaYAxis=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.dynaPtOrigin=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t.dynaPtCenter=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),t}return __extends(t,e),Object.defineProperty(t.prototype,"dynaWidth",{get:function(){return this._dynaWidth},set:function(e){this._dynaWidth=e},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this.dynaEyeRay=this.eyeRay.clone(),this.dynaYAxis=this.yAxis.clone(),this.thickness=0,this.mprMIPType="",this.dynaFov=this.fov,this.dynaPixelRate=this.pixelRate,this.dynaPtOrigin=this.ptOrigin.clone(),this.dynaMaxFov=this.maxFov,this.dynaPtCenter=this.ptCenter.clone()},t.prototype.CalculateOriginPoint3d=function(e,t,i,n,a,s,r,o,l,h){var u=new Point3d(0,0,0),d=e.x*o.x+e.y*o.y+e.z*o.z-(l.x*e.x+l.y*e.y+l.z*e.z);u.x=e.x*d+l.x,u.y=e.y*d+l.y,u.z=e.z*d+l.z,h.x=u.x-t.x*((s-1)/2)*n-i.x*((r-1)/2)*n,h.y=u.y-t.y*((s-1)/2)*n-i.y*((r-1)/2)*n,h.z=u.z-t.z*((s-1)/2)*n-i.z*((r-1)/2)*n;var c=new Point2d(0,0),p=new Point3d(0,0,0);p.x=o.x-h.x,p.y=o.y-h.y,p.z=o.z-h.z,c.x=(t.x*p.x+t.y*p.y+t.z*p.z)/n,c.y=(i.x*p.x+i.y*p.y+i.z*p.z)/n;var g=e.x*p.x+e.y*p.y+e.z*p.z;return a>0&&(c.x<s*a||c.y<r*a||c.x>s*(1-a)||c.y>r*(1-a))?(l=o,h.x=l.x-t.x*((s-1)/2)*n-i.x*((r-1)/2)*n,h.y=l.y-t.y*((s-1)/2)*n-i.y*((r-1)/2)*n,h.z=l.z-t.z*((s-1)/2)*n-i.z*((r-1)/2)*n):(l.x+=e.x*g,l.y+=e.y*g,l.z+=e.z*g),!0},t}(CImageData),CMPRData=function(){function e(e,t){this.serialIndex=-1,this.xeGUID="",this.volWeight=0,this.volHeight=0,this.volTall=0,this._imageS=null,this._imageC=null,this._imageT=null,this._imageO=null,this._defaultKeyPoint=null,this.keyPoint=null,this.needReset=!1,this.xeGUID=e,this.serialIndex=t}return Object.defineProperty(e.prototype,"imageDataT",{get:function(){return this._imageT},set:function(e){this._imageT=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageDataS",{get:function(){return this._imageS},set:function(e){this._imageS=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageDataC",{get:function(){return this._imageC},set:function(e){this._imageC=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageDataO",{get:function(){return this._imageO},set:function(e){this._imageO=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MPRDefaultCenterPoint",{get:function(){return this._defaultKeyPoint},set:function(e){this._defaultKeyPoint=e},enumerable:!0,configurable:!0}),e.prototype.getImageData=function(e){var t=null;switch(e){case"t":t=this.imageDataT;break;case"s":t=this.imageDataS;break;case"c":t=this.imageDataC;break;case"o":t=this.imageDataO}return t},e.prototype.setImageData=function(e,t){switch(e){case"t":this.imageDataT=t;break;case"s":this.imageDataS=t;break;case"c":this.imageDataC=t;break;case"o":this.imageDataO=t}},e.prototype.reset=function(){this._imageC.reset(),this.updateOriginPT(this._imageC),this._imageT.reset(),this.updateOriginPT(this._imageT),this._imageO.reset(),this.updateOriginPT(this._imageO),this._imageS.reset(),this.updateEyeRayOfPlanumS(),this.updateOriginPT(this._imageS),this.keyPoint=this._defaultKeyPoint.clone(),this.needReset=!0},e.prototype.updateOriginPT=function(e){var t=new Point3d(0,0,0),i=new Point3d(0,0,0);Utility.ComputeVerticalVecter(e.dynaYAxis,e.dynaEyeRay,i),e.CalculateOriginPoint3d(e.dynaEyeRay,i,e.dynaYAxis,e.dynaPixelRate,0,e.dynaWidth,e.dynaHeight,this.keyPoint,e.dynaPtCenter,t),e.dynaPtOrigin=t},e.prototype.updateSomeDataWithUI=function(e,t,i,n){var a,s,r=this.getImageData(e);switch(e){case"t":a=r.pixelSpacingX*this.volWeight/t,s=r.pixelSpacingX*this.volHeight/i;break;case"s":a=r.pixelSpacingX*this.volHeight/t,s=r.pixelSpacingX*this.volTall/i;break;case"c":case"o":a=r.pixelSpacingX*this.volWeight/t,s=r.pixelSpacingX*this.volTall/i}var o=a>s?a:s;r.dynaFov=o*t/n,r.dynaWidth=t,r.dynaHeight=i},e.prototype.updateEyeRayOfPlanumS=function(){Utility.ComputeVerticalVecter(this.imageDataT.dynaEyeRay,this.imageDataC.dynaEyeRay,this.imageDataS.dynaEyeRay)},e}(),CSeriesData=function(){function e(e,t,i){this.index=-1,this.xeGUID="",this.seriesDesc="",this.seriesUID="",this.seriesNumber="",this.modality="",this.thumbnail=null,this.sliceThickness=0,this.isThinLayer=!1,this.zeroImagePosition=[],this.serialDirect=null,this._imageRealTotal=0,this._imageTotal=0,this._imagesMap=new Map,this._imagesArray=new Array,this.xeGUID=t,this.index=e,this._imageRealTotal=i,this._imageTotal=i;for(var n=0;n<this._imageTotal;n++)this._imagesArray.push({index:CImageData.indexMerge(n,0),imageData:null})}return Object.defineProperty(e.prototype,"imageRealTotal",{get:function(){return this._imageRealTotal},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageTotal",{get:function(){return this._imageTotal},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"xeGuid",{get:function(){return this.xeGUID},enumerable:!0,configurable:!0}),e.prototype.insertImage=function(e){var t=this;this._imagesMap.has(e.index)&&(e.setJPG(this._imagesMap.get(e.index).getJPG()),e.imageData16=this._imagesMap.get(e.index).imageData16),this._imagesMap.set(e.index,e);try{if(e&&0==e.realIndex){if(e.imageDistanceToZero=0,e.imagePosition){var i=e.imagePosition.split("\\");this.zeroImagePosition=[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])],e.zeroImagePosition=this.zeroImagePosition,this._imagesArray.forEach(function(e){if(e.imageData&&0!=e.imageData.realIndex&&e.imageData.imagePosition){var i=e.imageData.imagePosition.split("\\"),n=[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])];if(null===t.serialDirect){var a=e.imageData.imageOrientation.split("\\"),s=[parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4]),parseFloat(a[5])],r=Utility.CalcSliceDistance(n,t.zeroImagePosition,s);r<0?t.serialDirect=-1:r>0&&(t.serialDirect=1)}Utility.calcImageDistanceToZero(e.imageData,t.zeroImagePosition,t.serialDirect)}})}}else if(3==this.zeroImagePosition.length&&e.imagePosition){i=e.imagePosition.split("\\");var n=[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])];if(null===this.serialDirect){var a=e.imageOrientation.split("\\"),s=[parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4]),parseFloat(a[5])],r=Utility.CalcSliceDistance(n,this.zeroImagePosition,s);r<0?this.serialDirect=-1:r>0&&(this.serialDirect=1)}Utility.calcImageDistanceToZero(e,this.zeroImagePosition,this.serialDirect)}}catch(t){console.error("init imagedata(imagePosition).imageDistanceToZero catch(%s)",e.imagePosition,t)}for(var o=e.realIndex;o<this._imagesArray.length;o++){var l=this._imagesArray[o];if(l.index==e.index)if(null!=l.imageData)e.setJPG(l.imageData.getJPG()),e.imageData16=l.imageData.imageData16,l.imageData=e;else if(l.imageData=e,e.numberOfFrames>1){for(var h=1;h<e.numberOfFrames;h++){var u=e.cloneImageDataInfo(h);u.imageData16=null,u.setJPG(null),u.setImageLevel(IMAGE_LEVEL.IMAGE_LEVEL_INVALID),this._imagesArray.splice(o+h,0,{index:u.index,imageData:u}),this._imagesMap.set(u.index,u)}this._imageTotal=this.imageTotal+e.numberOfFrames-1}}},e.prototype.findImageByIndex=function(e){return this._imagesMap.has(e)?this._imagesMap.get(e):null},e.prototype.findImageByPos=function(e){return e>=this._imagesArray.length?null:this._imagesArray[e].imageData},Object.defineProperty(e.prototype,"imageSize",{get:function(){return this._imagesArray.length},enumerable:!0,configurable:!0}),e.prototype.forEachImage=function(e){this._imagesMap.forEach(e)},e.prototype.isAllLoaded=function(){return this.imageSize==this.imageTotal},e.prototype.getImageIndexByPos=function(e){return e>=this._imagesArray.length?null:-1==e?"":this._imagesArray[e].index},e.prototype.getPosByIndex=function(e){for(var t=CImageData.realIndexSplit(e);t<this._imagesArray.length;t++)if(this._imagesArray[t].index==e)return t;return-1},e}(),CStudyData=function(){function e(e){this.patientName="",this.patientGender="",this.patientAge="",this.patientAgeUnit="",this.studyStatus="0",this.studyTime="",this.imageCount=0,this.studydescribe="",this.studyInstanceUID="",this._series=null,this.thumbnail=null,this.isCompleted=!1,this.isHideThinSeries=!1,this.xeGUID=e}return Object.defineProperty(e.prototype,"seriesCount",{get:function(){return this._series?this._series.length:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"series",{get:function(){return this._series},set:function(e){if(null!=this._series&&this._series.length>0)for(var t=0;t<this._series.length&&t<e.length;t++)null!=this._series[t].thumbnail&&(e[t].thumbnail=this._series[t].thumbnail);this._series=e},enumerable:!0,configurable:!0}),e.prototype.findSerialByUID=function(e){if(null==this._series)return null;return this._series.forEach(function(t){t.seriesUID==e&&(t=t)}),null},e.prototype.findSerial=function(e){return null!=this._series&&this._series.length>e?this._series[e]:null},e.prototype.findSerialIndexByUID=function(e){var t=void 0,i=this.findSerialByUID(e);return null!=i&&(t=i.index),t},e}(),COMPARE_TOBECACHE="COMPARE_beCache",COMPARE_TOBEDELETE="COMPARE_beDelete",MAP_TOBECACHE="MAP_beCache",MAP_TOBEDELETE="MAP_beDelete",Args=function(){return function(e,t,i){this.xeGuid=e,this.serialIndex=t,this.imageIndex=i}}(),CImageCacheMgr=function(){function e(e,t){this._wsProcessor=null,this._userID="CImageCacheMgr",this._dicomDataMgr=null,this._finishedSeries=new Set,this._cachedImageList=new Set,this._toBeCache=new Map,this.cb_SeriesDownloadProgress=null,this.blockMode=!0,this.parallelCacheSerialCount=1,this.lastAccessStudy=null,this.lastAccessSerialIndex=0,this.studyCacheRecord=new Map,this.studyCacheArray=new Array,this.isReversing=!1,this._maxCacheCount=10,this._dicomDataMgr=e,this._wsProcessor=t}return e.prototype.getSerialCacheFinished=function(e){var t=!1;if(e.isAllLoaded()){var i=this.argsToString(e.xeGUID,e.index);this._finishedSeries.has(i)&&(t=!0)}return t},e.prototype.changeCacheMode=function(e,t,i){var n=this;console.log("changeCacheMode:"+e),t.forEach(function(t){null!=t.series&&e&&n.preSeriesCache(t)})},e.prototype.getImageBinaryReqest=function(e,t,i){if(null==t)return null;var n,a=t.getImageLevel(),s=t.isImageCutToBlock()&&this.blockMode;if(a==IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL)return null;if(a!=IMAGE_LEVEL.IMAGE_LEVEL_JPG)return(n=new CRequestImgInfo).index=t.realIndex,n.frameIndex=t.frameIndex,this._dicomDataMgr.isJPGMode?n.level="1":e||null!=t.bitsAllocated&&16!=t.bitsAllocated?n.level="1":(n.level=i?"2":"1+",s&&(n.tileIndexes=t.getBlankBlocks(new Rect(0,0,0,0)))),n;if(e)return null;if(16!=t.bitsAllocated)return null;if(this._dicomDataMgr.isJPGMode)return null;if((n=new CRequestImgInfo).index=t.realIndex,n.frameIndex=t.frameIndex,!s)return n.level="2",n;var r=t.getBlankBlocks(new Rect(0,0,0,0));if(r.length>0){for(var o=0;o<r.length;o++)n.tileIndexes.push(r[o]);return n.level="2",n}},e.prototype.argsToString=function(e,t,i){void 0===t&&(t=-1),void 0===i&&(i="");var n=new Args(e,t,i);return JSON.stringify(n)},e.prototype.stringToArgs=function(e){return JSON.parse(e)},e.prototype.promiseTimeout=function(e,t){var i=new Promise(function(e,i){setTimeout(function(){e("time out")},t)});return Promise.race([i,e])},e.prototype.preOneSerailAllCache=function(e,t,i,n,a){var s=this;if(this._dicomDataMgr.isFullMode&&!(t>=e.length)){var r=e[t],o=this.argsToString(r.xeGUID,r.index);if(this.getSerialCacheFinished(r))return this.preOneSerailAllCache(e,t+1,0,n,a);if(a&&r.isThinLayer)return this.preOneSerailAllCache(e,t+1,0,n,a);if(CLocalForageWrapperInstance.GetInstance().GetSaveItemQueueCount()>200)setTimeout(function(){return s.preOneSerailAllCache(e,t,i,n,a)},500);else{var l=i;if(l>=r.imageTotal)return this._finishedSeries.add(o),this.preOneSerailAllCache(e,t+1,0,n,a);for(var h=new Array,u=0;u<n;u++)if(l+u<r.imageTotal){var d=r.getImageIndexByPos(l+u),c=this.promiseTimeout(this._dicomDataMgr.getImageDataAsync(r.xeGUID,r.index,d,0,0,this._userID,!1,!0,!0),1e4);h.push(c)}Promise.all(h.map(function(e){return e.catch(function(e){return null})})).then(function(i){for(var o=0;o<i.length;o++){var h=i[o];if(null!=h&&"time out"!=h)null!=s.cb_SeriesDownloadProgress&&s.cb_SeriesDownloadProgress(h.xeGuid,h.seriesIndex,r.imageTotal,l+o+1);else if(null!=h&&"time out"==h)return s.preOneSerailAllCache(e,t,l+o,n,a)}return s.preOneSerailAllCache(e,t,l+n,n,a)}).catch(function(i){return console.error("getImageDataAsync(%s, %d, %d-%d) catch:%s",r.xeGuid,r.index,l,n,i),s.preOneSerailAllCache(e,t,l+n,n,a)})}}},e.prototype.getReserveImageDatas=function(e,t,i,n,a,s,r,o){var l=this;void 0===o&&(o=!1);var h=new CWWWWL(n,a),u=function(i,n,a){if(void 0===n&&(n=0),void 0===a&&(a=""),0==n&&null!=i){if(!l._dicomDataMgr.isFullMode&&l._toBeCache.get(COMPARE_TOBECACHE)&&!l._toBeCache.get(COMPARE_TOBECACHE).has(l.argsToString(i.xeGuid,i.seriesIndex,i.index)))return;var u=l.getImageBinaryReqest(s,i,o);null!=u&&l._wsProcessor.getImageBinary(e,t,null,[u],h.wl,h.ww,!0,[]),r&&l._cachedImageList.add(l.argsToString(i.xeGuid,i.seriesIndex,i.index))}};this._dicomDataMgr.getSeriesDataListAsync(e).then(function(n){if(null!=n&&n.length>t&&null!=n[t]){var a=[];i.forEach(function(i){var s=n[t].findImageByIndex(i);null!=s?u(s):(l._dicomDataMgr.addRequest("getImageInfo",l.argsToString(e,t,i),u),a.push(CImageData.realIndexSplit(i)))}),a.length>0&&l._wsProcessor.getImageInfo(e,t,null,a,l._dicomDataMgr.hidePatientInfo)}})},e.prototype.preSeriesCache=function(e){var t=this,i=!0;this._dicomDataMgr.isFullMode&&(i=!1),null!=e.series&&(this.studyCacheRecord.has(e.xeGUID)||e.series.forEach(function(n){t.getReserveImageDatas(e.xeGUID,n.index,["0_0"],0,0,i,!1,!1)}),this._dicomDataMgr.isFullMode&&this.preAllSeriesCache(e))},e.prototype.preAllSeriesCache=function(e){this._dicomDataMgr.isFullMode&&e&&this.preStudyCache(e)},e.prototype.setLastAccessSerialInfo=function(e,t){this.lastAccessStudy=e,this.lastAccessSerialIndex=t},e.prototype.preStudyCache=function(e){var t=this;if(this._dicomDataMgr.isFullMode&&e&&e.series){if(!this.studyCacheRecord.has(e.xeGUID)){for(var i=new Map,n=0;n<e.series.length;n++)i.set(e.series[n].index,-1);this.studyCacheRecord.set(e.xeGUID,i),this.studyCacheArray.push(e.xeGUID)}setTimeout(function(){t.isReversing||t.preSerialCacheReverse()},100)}},e.prototype.preSerialCacheReverse=function(){var e=this;this.isReversing=!0;var t=this.getReverseTask();if(t.length>0){for(var i=new Array,n=new Array,a=0;a<t.length;a++){var s=t[a];console.log("preSerialCacheReverse task:%o",s);var r=this.promiseTimeout(this.executeReverseTask(s.xeGuid,s.serialIndex,s.imageIndex,this._userID),1e4);i.push(r),n.push({xeguid:s.xeGuid,seriesIndex:s.serialIndex,imageIndex:s.imageIndex})}Promise.all(i.map(function(e){return e.catch(function(e){return null})})).then(function(t){for(var i=0;i<t.length;i++){var a=t[i];if(null!=a&&"time out"!=a){var s=(r=e._dicomDataMgr.getSeriesData(a.xeGuid,a.seriesIndex)).imageTotal;(o=r.getPosByIndex(a.index))>=s-1?e.studyCacheRecord.get(r.xeGuid).delete(r.index):e.studyCacheRecord.get(r.xeGuid).set(r.index,o),null!=e.cb_SeriesDownloadProgress&&e.cb_SeriesDownloadProgress(a.xeGuid,a.seriesIndex,s,o+1)}else if(null==a&&"time out"!=a){var r,o;s=(r=e._dicomDataMgr.getSeriesData(n[i].xeguid,n[i].seriesIndex)).imageTotal;(o=r.getPosByIndex(n[i].imageIndex))>=s-1?e.studyCacheRecord.get(r.xeGuid).delete(r.index):e.studyCacheRecord.get(r.xeGuid).set(r.index,o)}}return e.preSerialCacheReverse()}).catch(function(i){return console.error("preSerialCacheReverse execute tasks(%o) catch:%s",t,i),e.preSerialCacheReverse()})}else this.isReversing=!1},e.prototype.getReverseTask=function(){var e=this,t=function(e,t,i,n){if(!(n.length>=e.parallelCacheSerialCount)){var a=e.studyCacheRecord.get(t);if(a.has(i))for(var s=a.get(i),r=e._dicomDataMgr.getSeriesData(t,i),o=r.imageTotal,l=n.length,h=1;h<=e.parallelCacheSerialCount-l;h++){var u=s+h;if(!(u<o))break;n.push(new Args(t,i,r.getImageIndexByPos(u)))}}},i=new Array;null!=this.lastAccessStudy&&this.studyCacheRecord.has(this.lastAccessStudy)&&t(this,this.lastAccessStudy,this.lastAccessSerialIndex,i);for(var n=function(n){if(!(i.length<a.parallelCacheSerialCount))return"break";var s=a.studyCacheArray[n];a.studyCacheRecord.get(s).forEach(function(n,a){t(e,s,a,i)})},a=this,s=this.studyCacheArray.length-1;s>=0;s--){if("break"===n(s))break}return i},e.prototype.executeReverseTask=function(e,t,i,n){var a=this;return new Promise(function(n,s){if(""!=i){var r=function(a,r,o){void 0===r&&(r=0),void 0===o&&(o=""),null!=a?0==r?n(a):s(o):s("executeReverseTask("+e+"_"+t.toString()+"_"+i.toString()+"):: failed")},o=function(o,l,h){if(void 0===l&&(l=0),void 0===h&&(h=""),null!=o)if(0==l){var u=a.getImageBinaryReqest(!1,o,!0);null!=u?(a._dicomDataMgr.addRequest("getImageBinary",a.argsToString(e,t,i),r),a._wsProcessor.getImageBinary(e,t,null,[u],0,0,!0)):n(o)}else s(h);else s("executeReverseTask("+e+"_"+t.toString()+"_"+i.toString()+"):: failed")};a._dicomDataMgr.getSeriesDataListAsync(e).then(function(n){if(null!=n&&n.length>t&&null!=n[t]){var s=CDicomDataManager.studies.get(e).findSerial(t).findImageByIndex(i);null!=s?o(s):(a._dicomDataMgr.addRequest("getImageInfo",a.argsToString(e,t,i),o),a._wsProcessor.getImageInfo(e,t,[CImageData.realIndexSplit(i)],null,a._dicomDataMgr.hidePatientInfo))}else o(null)})}else s("executeReverseTask("+e+"_"+t.toString()+"_"+i.toString()+"):: failed")})},e.prototype.isNeedCache=function(e,t,i){var n=!1;if(this._toBeCache.has(MAP_TOBECACHE)){var a=this.argsToString(e,t);this._toBeCache.get(MAP_TOBECACHE).has(a)&&(n=-1!==this._toBeCache.get(MAP_TOBECACHE).get(a).indexOf(i))}return n},e.prototype.preCache=function(e,t,i,n,a,s){var r=this;this._dicomDataMgr.isFullMode&&s.forEach(function(e){e&&r.preAllSeriesCache(e)}),this.calcCacheImageIndexs(a,!1,s),this._toBeCache.has(MAP_TOBECACHE)&&this._toBeCache.get(MAP_TOBECACHE).forEach(function(a,o){var l=r.stringToArgs(o);if(l.xeGuid==i&&l.serialIndex==n)if(r._dicomDataMgr.isFullMode){var h=[];a.forEach(function(e){var t=s.get(l.xeGuid).findSerial(l.serialIndex).findImageByIndex(e);null==t?h.push(e):r._cachedImageList.add(r.argsToString(t.xeGuid,t.seriesIndex,t.index))}),r.getReserveImageDatas(l.xeGuid,l.serialIndex,h,e,t,!0,!0,!1)}else r.getReserveImageDatas(l.xeGuid,l.serialIndex,a,e,t,!0,!0,!1)}),this._toBeCache.has(COMPARE_TOBEDELETE)&&this._toBeCache.get(COMPARE_TOBEDELETE).forEach(function(e,t){var a=r.stringToArgs(t);if(a.xeGuid==i&&a.serialIndex==n){var o=s.get(a.xeGuid).findSerial(a.serialIndex).findImageByIndex(a.imageIndex);o.isBlockFilling()||(o.clearCache(r._dicomDataMgr.isFullMode),r._cachedImageList.delete(r.argsToString(o.xeGuid,o.seriesIndex,o.index)))}})},e.prototype.calcCacheImageIndexs=function(e,t,i){var n=this;void 0===t&&(t=!1);var a=new Map,s=new Map,r=new Map;this._toBeCache.set(COMPARE_TOBECACHE,a),this._toBeCache.set(COMPARE_TOBEDELETE,s),this._toBeCache.set(MAP_TOBECACHE,r),e.forEach(function(e,t){for(var s=n.stringToArgs(t),o=i.get(s.xeGuid).findSerial(s.serialIndex),l=o.imageTotal,h=n.argsToString(s.xeGuid,s.serialIndex),u=new Array,d=o.getPosByIndex(s.imageIndex),c=1;c<n._maxCacheCount+1;c++){var p=d+c;if(p!=d&&p>=0&&p<l&&p>=0&&p<l){var g=o.getImageIndexByPos(p);a.set(n.argsToString(s.xeGuid,s.serialIndex,g),null),u.push(g)}var _=d-c;if(_!=d&&_>=0&&_<l){g=o.getImageIndexByPos(_);a.set(n.argsToString(s.xeGuid,s.serialIndex,g),null),u.push(g)}}r.set(h,u)}),this._cachedImageList.forEach(function(t,i){a.has(i)||e.has(i)||s.set(i,null)})},e.prototype.changeSerailJGPCacheWWWL=function(e,t,i,n,a,s){this.cleanSerailJGPCache(e,t,s),this.preCache(i,n,e,t,a,s)},e.prototype.cleanSerailJGPCache=function(e,t,i){i.get(e).findSerial(t).forEachImage(function(e){16==e.bitsAllocated&&e.setJPG(null)})},e}(),Task=function(){return function(){}}(),TaskQueue=function(){function e(e){void 0===e&&(e=null),this._taskMergeFunc=null,this._tasks=new Array,this._waiting=!1,this._timerID=null,this._taskMergeFunc=e}return e.prototype.push=function(e,t,i){for(var n=[],a=3;a<arguments.length;a++)n[a-3]=arguments[a];var s={name:e,obj:t,handle:i,args:n.slice()};this._taskMergeFunc?this._tasks=this._taskMergeFunc(this._tasks,s):this._tasks.push(s),this._waiting||this.run()},e.prototype.pushAsTime=function(e,t,i,n){for(var a=[],s=4;s<arguments.length;s++)a[s-4]=arguments[s];var r={name:e,obj:t,handle:i,args:a.slice()};this._taskMergeFunc?this._tasks=this._taskMergeFunc(this._tasks,r):this._tasks.push(r),this._waiting||this.runAsTime(n)},e.prototype.run=function(){var e=this;this._waiting=!0,window.requestAnimationFrame(function(){if(0!==e._tasks.length){var t=e._tasks.shift();t.handle.apply(t.obj,t.args),e._tasks.length>0?e.run():e._waiting=!1}else e._waiting=!1})},e.prototype.runAsTime=function(e){var t=this;this._waiting=!0,this._timerID=setTimeout(function(){if(0!==t._tasks.length){var i=t._tasks.shift();if(i.handle.apply(i.obj,i.args),t._tasks.length>0)return t.runAsTime(e);t._waiting=!1,t._timerID=null}else t._waiting=!1},e)},e.prototype.clear=function(){this._tasks.splice(0),this._waiting=!1,this._timerID&&clearTimeout(this._timerID)},e.prototype.GetTaskCount=function(){return this._tasks.length},e}(),CLocalForageWrapperInstance=function(){function e(){var e=this;this._worker=null,this._dbInited=new Set,this._cbMaps=new Map,this._queue=new TaskQueue,this._host="",this._workerQueueCount=0,this._LocalDBManager=null,this._worker=new Worker("./static/js/IndexDBWorker.js"),this._worker.onmessage=function(t){switch(t.data.command){case"init":e._dbInited.add(t.data.args.host+"_"+t.data.args.xeguid);break;case"close":e._dbInited.delete(t.data.name);break;case"put":e._cbMaps.has(t.data.args.key)&&(e._cbMaps.get(t.data.args.key).forEach(function(e){e(t.data.res)}),e._cbMaps.delete(t.data.args.key));break;case"get":e._cbMaps.has(t.data.args.key)&&(e._cbMaps.get(t.data.args.key).forEach(function(e){e(t.data.res,t.data.value)}),e._cbMaps.delete(t.data.args.key));break;case"log":console.log(t.data.msg);break;case"count":e._workerQueueCount=t.data.count}},this._worker.onerror=function(e){console.error("worker init failed:%o",e)},this._LocalDBManager=new CLocalDBManager}return e.GetInstance=function(){return null==e._instance&&(e._instance=new e),e._instance},e.prototype.SetHost=function(e){""===this._host&&(this._host=e,this._host=this._host.split(":")[1],this._host.replace(".",""))},e.prototype.GetSaveItemQueueCount=function(){return this._workerQueueCount},e.prototype.SaveItemToDBWithQueue=function(e,t,i,n){this._LocalDBManager.supportLocalDB()?(this._cbMaps.has(t)?this._cbMaps.get(t).push(n):this._cbMaps.set(t,[n]),this._dbInited.has(this._host+"_"+e)||(this._worker.postMessage({command:"init",args:{host:this._host,xeguid:e}}),this._LocalDBManager.writeDBATS(this._host,e)),this._worker.postMessage({command:"put",args:{host:this._host,xeguid:e,key:t,value:i}}),this._LocalDBManager.updateDBAccessTimeStamp(this._host,e)):n(!1)},e.prototype.GetItemFromDB=function(e,t,i,n){this._LocalDBManager.supportLocalDB()?(this._cbMaps.has(t)?this._cbMaps.get(t).push(n):this._cbMaps.set(t,[n]),this._dbInited.has(this._host+"_"+e)||(this._worker.postMessage({command:"init",args:{host:this._host,xeguid:e}}),this._LocalDBManager.writeDBATS(this._host,e)),this._worker.postMessage({command:"get",args:{host:this._host,xeguid:e,key:t,isHigh:i}}),this._LocalDBManager.updateDBAccessTimeStamp(this._host,e)):n(!1,null)},e.prototype.CanLocalDB=function(){return this._LocalDBManager.supportLocalDB()},e.prototype.ClearDB=function(){var e=this;CDicomDataManager.studies.forEach(function(t,i){e._LocalDBManager.writeDBATS(e._host,t.xeGUID)})},e._instance=null,e}(),DB_TIMEOUT=1200,CLocalDBManager=function(){function e(){this._timeDBName="RADDBTimeStampDB",this._timeDBStoreName="Timestamp",this._indexDB=null,this._myTimeDBConn=null,this._support=!1,this._queue=new TaskQueue(function(e,t){for(var i=t,n=0,a=e;n<a.length;n++){var s=a[n];if(s.args[0]==i.args[0]&&s.args[1]==i.args[1])return e}return e.push(t),e}),this._isFirstCreateV1=!1,this.init(),this.supportLocalDB&&this.setClearTimeout(3e4)}return e.prototype.init=function(){var e=this;try{if(this._indexDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.moz_indexedDB||window.oIndexedDB||window.msIndexedDB,this._indexDB){this._support=!0;var t=this._indexDB.open(this._timeDBName,1);t.onupgradeneeded=function(i){e._myTimeDBConn=t.result,e._myTimeDBConn.createObjectStore(e._timeDBStoreName),e._isFirstCreateV1=!0},t.onsuccess=function(i){(e._myTimeDBConn=t.result,e._myTimeDBConn.onclose=function(t){return e._myTimeDBConn=null,e.init()},e._isFirstCreateV1&&e._indexDB.databases)&&(e._isFirstCreateV1=!1,e._indexDB.databases().then(function(t){for(var i=e._myTimeDBConn.transaction(e._timeDBStoreName,"readwrite").objectStore(e._timeDBStoreName),n=0,a=t;n<a.length;n++){var s=a[n];s.name!=e._timeDBName&&i.put((new Date).getTime(),s.name)}}))},t.onerror=function(e){console.error("RADDBTimeStampDB open failed (%o)",e)}}}catch(e){this._support=!1}},e.prototype.supportLocalDB=function(){return this._support},e.prototype.getDBStore=function(){if(this._myTimeDBConn){var e=this._myTimeDBConn.transaction(this._timeDBStoreName,"readwrite");if(e)return e.objectStore(this._timeDBStoreName)}return null},e.prototype.updateDBAccessTimeStamp=function(e,t){var i=this;this._queue.pushAsTime("updateTimeStamp",this,function(e,t){i.writeDBATS(e,t)},1e4,e,t)},e.prototype.writeDBATS=function(e,t){try{var i=this.getDBStore();i&&i.put((new Date).getTime(),e+"_"+t)}catch(e){console.error("CLocalDBManager::initDBStore,failed(%o)",e)}},e.prototype.setClearTimeout=function(e){var t=this;setTimeout(function(){t.clearTimeoutedDB()},e)},e.prototype.clearTimeoutedDB=function(){var e=this;try{var t=this.getDBStore();if(t){var i=(new Date).getTime(),n=new Array,a=function(t,i){if(t.length<=i)e.setClearTimeout(6e4);else{var n=e.getDBStore();if(n)try{var s=n.get(t[i]);s.onsuccess=function(){(new Date).getTime()-s.result>1e3*DB_TIMEOUT&&(e._indexDB.deleteDatabase(t[i]).onsuccess=function(n){var s=e.getDBStore();return s&&s.delete(t[i]),a(t,++i)})}}catch(t){console.error(t),e.setClearTimeout(6e4)}}};t.openCursor().onsuccess=function(t){var s=t.target.result;if(s&&null!=s){var r=s.value;i-r>1e3*DB_TIMEOUT&&n.push(s.key),s.continue()}else n.length>0?a(n,0):e.setClearTimeout(6e4)}}}catch(e){console.error("CLocalDBManager::initDBStore,failed(%o)",e)}},e}(),CWWWWL=function(){return function(e,t){this.ww=e,this.wl=t}}(),CDicomDataManager=function(){function e(e){var t=this;this._cacheMgr=null,this._wsProcessor=null,this._isHasConnected=!1,this._requests=new Map,this.currentImageMsgs=new Map,this._usingImages=new Map,this._mprDatas=new CMPRDatas,this.connKey="",this.hidePatientInfo=!1,this._thinLayerThick=0,this._isFullMode=!1,this._isJPGMode=!1,this.MPRJpgDealer=new Map,this.mprMsgLastIDs=new Map,"1"==Utility.queryString("hpi")&&(this.hidePatientInfo=!0),this.connKey=e,this._wsProcessor=new CMessageProcesser,this._cacheMgr=new CImageCacheMgr(this,this._wsProcessor),this._wsProcessor.onGetStudyInfo=function(e){t.onGetStudyInfo(e)},this._wsProcessor.onGetSeriesInfo=function(e){t.onGetSeriesInfo(e)},this._wsProcessor.onGetImageInfo=function(e){t.onGetImageInfo(e)},this._wsProcessor.onGetImageBinary=function(e,i){t.onGetImageBinary(e,i)},this._wsProcessor.onGetStudyThumb=function(e,i){t.onGetStudyThumb(e,i)},this._wsProcessor.onGetSerialThumb=function(e,i){t.onGetSerialThumb(e,i)},this._wsProcessor.OnGetXeguid=function(e){t.OnGetXeguid(e)},this._wsProcessor.onGetMPRInfo=function(e){t.onGetMPRInfo(e)},this._wsProcessor.onGetMPRJpg=function(e,i){t.onGetMPRJpg(e,i)},this._wsProcessor.onGetImageFile=function(e,i){t.onGetImageFile(e,i)},this._wsProcessor.onCreateSession=function(e){t.onCreateSession(e)}}return e.GetInstance=function(t){if(e._instances.has(t))return e._instances.get(t);var i=new e(t);return e._instances.set(t,i),i},e.prototype.onCreateSession=function(e){if(0==e.head.errCode&&e.body.webConfig){var t;if(e.body.webConfig.cacheThreadNum)(t=parseInt(e.body.webConfig.cacheThreadNum))>0&&(this._cacheMgr.parallelCacheSerialCount=t);if(e.body.webConfig.preLoadCount)(t=parseInt(e.body.webConfig.preLoadCount))>0&&(this._cacheMgr._maxCacheCount=t);else this.isFullMode?this._cacheMgr._maxCacheCount=20:this._cacheMgr._maxCacheCount=10;if(e.body.webConfig.thinLayerThick){var i=parseFloat(e.body.webConfig.thinLayerThick);i>=0&&(this._thinLayerThick=i)}if(e.body.webConfig.blockMode){var n=parseInt(e.body.webConfig.blockMode);this._cacheMgr.blockMode=1===n}}},Object.defineProperty(e,"studies",{get:function(){return this._studies},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFullMode",{get:function(){return this._isFullMode},set:function(t){this._isFullMode!=t&&(this._isFullMode=t,this._cacheMgr.changeCacheMode(t,e._studies,this._usingImages))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isJPGMode",{get:function(){return this._isJPGMode},set:function(e){this._isJPGMode=e},enumerable:!0,configurable:!0}),e.prototype.Connect=function(e,t,i){this._isHasConnected||(this._wsProcessor.Connect(e,t,i),this._isHasConnected=!0),CLocalForageWrapperInstance.GetInstance().SetHost(e)},e.prototype.getXeguidAsync=function(e,t){var i=this;return new Promise(function(n,a){i.addRequest("getXeguid",i._cacheMgr.argsToString(e+t),function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?n(e):a(i)}),i._wsProcessor.getXeguid(e,t)})},e.prototype.setVRInfoDealer=function(e){this._wsProcessor.onGetVRInfo=function(t){e(t)}},e.prototype.setVRJpgDealer=function(e){this._wsProcessor.onGetVRJpg=function(t,i){e(t,i)}},e.prototype.setMPRJpgDealer=function(e,t){this.MPRJpgDealer.has(e)&&this.MPRJpgDealer.get(e)(!1,null,"clear dealer",0),this.MPRJpgDealer.set(e,t)},e.prototype.getStudyDataAsync=function(t){var i=this;return new Promise(function(n,a){var s=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?n(e):a(i)};e._studies.has(t)&&e._studies.get(t).isCompleted?s(e._studies.get(t)):(i.addRequest("getStudyInfo",i._cacheMgr.argsToString(t),s),i._wsProcessor.getStudyInfo(t,i.hidePatientInfo))})},e.prototype.getStudyThumbAsync=function(e){var t=this;return new Promise(function(i,n){var a=function(e,t,a){void 0===t&&(t=0),void 0===a&&(a=""),0==t?i(e):n(a)};t.getStudyDataAsync(e).then(function(i){null!=i.thumbnail?a(i.thumbnail):(t.addRequest("getStudyThumb",t._cacheMgr.argsToString(e),a),t._wsProcessor.getStudyThumb(e))})})},e.prototype.getSeriesDataListAsync=function(t){var i=this;return new Promise(function(n,a){var s=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?n(e):a(i)},r=null;e._studies.has(t)&&(r=e._studies.get(t)),null!=r&&r.seriesCount>0?s(r.series):(i.addRequest("getSeriesInfo",i._cacheMgr.argsToString(t),s),i._wsProcessor.getSeriesInfo(t))})},e.prototype.getSeriesData=function(t,i){var n=null,a=null;return e._studies.has(t)&&(a=e._studies.get(t)),null!=a&&a.seriesCount>0&&(n=a.findSerial(i)),n},e.prototype.getSerialThumbAsync=function(e,t){var i=this;return new Promise(function(n,a){var s=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?n(e):a(i)};i.getSeriesDataListAsync(e).then(function(n){null!=n&&n.length>t&&null!=n[t]?null!=n[t].thumbnail?s(n[t].thumbnail):(i.addRequest("getSerialThumb",i._cacheMgr.argsToString(e,t),s),i._wsProcessor.getSerialThumb(e,t)):s(null)})})},e.prototype.getImageDataAsync=function(e,t,i,n,a,s,r,o,l){void 0===o&&(o=!1),void 0===l&&(l=!1);var h=new CWWWWL(n,a);return this.getImageDataAsync2(e,t,i,h,s,r,o,l)},e.prototype.getImageDataAsync2=function(t,i,n,a,s,r,o,l){var h=this;return void 0===o&&(o=!1),void 0===l&&(l=!1),new Promise(function(u,d){if(""!=n){var c=function(n,c,p){if(void 0===c&&(c=0),void 0===p&&(p=""),0==c){var g=function(){var e=new Array;!l&&h.currentImageMsgs.has(s)&&e.push(h.currentImageMsgs.get(s));var u=h._cacheMgr.getImageBinaryReqest(r,n,o);if(null!=u){var d=void 0;d=l?h._wsProcessor.getImageBinary(t,i,null,[u],a.wl,a.ww,!0,e):h._wsProcessor.getImageBinary(t,i,[u],null,a.wl,a.ww,!0,e),h.currentImageMsgs.set(s,d)}};null!=n&&null==n.getData()&&n.HasLocalDB()&&!l&&n.LocalDBToMemory(!l,function(e){e?h.onImageUpdate(n):g()}),u(n),null==n||null!=n.getData()||n.HasLocalDB()||g(),l||h._cacheMgr.preCache(a.ww,a.wl,t,i,h._usingImages,e._studies)}else d(p)};h.getSeriesDataListAsync(t).then(function(a){if(null!=a&&a.length>i&&null!=a[i]){var s=e._studies.get(t).findSerial(i).findImageByIndex(n);null!=s?c(s):(h.addRequest("getImageInfo",h._cacheMgr.argsToString(t,i,n),c),h._wsProcessor.getImageInfo(t,i,[CImageData.realIndexSplit(n)],null,h.hidePatientInfo))}else c(null)})}else d("getImageDataAsync2("+t+"_"+i.toString()+"_"+n.toString()+"):: failed")})},e.prototype.getMPRInfo=function(e,t){return this._mprDatas.getMPRData(e,t)},e.prototype.getMPRInfoAsync=function(e,t){var i=this;return new Promise(function(n,a){var s=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?n(e):a(i)},r=i._mprDatas.getMPRData(e,t);null!=r?s(r):(i.addRequest("getMPRInfo",i._cacheMgr.argsToString(e,t),s),i._wsProcessor.getMPRInfo(e,t))})},e.prototype.getMPRImageDataAsync=function(e,t,i,n,a,s,r,o){var l=this._mprDatas.getMPRData(e,t),h={planum_t:{x:l.keyPoint.x,y:l.keyPoint.y,z:l.keyPoint.z,ww:s.ww,wl:s.wl,thick:r,procmode:o,fov:l.imageDataT.dynaFov,width:l.imageDataT.dynaWidth,height:l.imageDataT.dynaHeight,eyeRay:l.imageDataT.dynaEyeRay,yAxis:l.imageDataT.dynaYAxis,ptCenter:l.imageDataT.dynaPtCenter,maxFov:l.imageDataT.dynaMaxFov,ptOrigin:l.imageDataT.dynaPtOrigin,pixelRate:l.imageDataT.dynaPixelRate},planum_c:{x:l.keyPoint.x,y:l.keyPoint.y,z:l.keyPoint.z,ww:s.ww,wl:s.wl,thick:r,procmode:o,fov:l.imageDataC.dynaFov,width:l.imageDataC.dynaWidth,height:l.imageDataC.dynaHeight,eyeRay:l.imageDataC.dynaEyeRay,yAxis:l.imageDataC.dynaYAxis,ptCenter:l.imageDataC.dynaPtCenter,maxFov:l.imageDataC.dynaMaxFov,ptOrigin:l.imageDataC.dynaPtOrigin,pixelRate:l.imageDataC.dynaPixelRate},planum_s:{x:l.keyPoint.x,y:l.keyPoint.y,z:l.keyPoint.z,ww:s.ww,wl:s.wl,thick:r,procmode:o,fov:l.imageDataS.dynaFov,width:l.imageDataS.dynaWidth,height:l.imageDataS.dynaHeight,eyeRay:l.imageDataS.dynaEyeRay,yAxis:l.imageDataS.dynaYAxis,ptCenter:l.imageDataS.dynaPtCenter,maxFov:l.imageDataS.dynaMaxFov,ptOrigin:l.imageDataS.dynaPtOrigin,pixelRate:l.imageDataS.dynaPixelRate},planum_o:{x:l.keyPoint.x,y:l.keyPoint.y,z:l.keyPoint.z,ww:s.ww,wl:s.wl,thick:r,procmode:o,fov:l.imageDataO.dynaFov,width:l.imageDataO.dynaWidth,height:l.imageDataO.dynaHeight,eyeRay:l.imageDataO.dynaEyeRay,yAxis:l.imageDataO.dynaYAxis,ptCenter:l.imageDataO.dynaPtCenter,maxFov:l.imageDataO.dynaMaxFov,ptOrigin:l.imageDataO.dynaPtOrigin,pixelRate:l.imageDataO.dynaPixelRate},reset:l.needReset};l.needReset=!1,console.log("getMPRJPG(%s)：t(w:%d,h:%d,fov:%d);c(w:%d,h:%d,fov:%d);s(w:%d,h:%d,fov:%d)",i,h.planum_t.width,h.planum_t.height,h.planum_t.fov,h.planum_c.width,h.planum_c.height,h.planum_c.fov,h.planum_s.width,h.planum_s.height,h.planum_s.fov),this.mprMsgLastIDs.set(i,this._wsProcessor.getMPRJpg(e,t,i,h))},e.prototype.changeSerailJGPCacheWWWL=function(t,i,n,a){return this._cacheMgr.changeSerailJGPCacheWWWL(t,i,n,a,this._usingImages,e._studies)},e.prototype.cleanSerailJGPCache=function(t,i){return this._cacheMgr.cleanSerailJGPCache(t,i,e._studies)},e.prototype.onImageUpdate=function(e){var t=this._cacheMgr.argsToString(e.xeGuid,e.seriesIndex,e.index);this._usingImages.has(t)&&this._usingImages.get(t).forEach(function(t){t(e)})},e.prototype.addRequest=function(e,t,i){if(!this._requests.has(e)){var n=new Map;this._requests.set(e,n)}var a=this._requests.get(e),s=null;a.has(t)?s=a.get(t):(s=new Array,a.set(t,s)),s.push(i)},e.prototype.executeRequest=function(e,t,i,n,a){if(this._requests.has(e)){var s=this._requests.get(e);if(s.has(t)){for(var r=0,o=s.get(t);r<o.length;r++){(0,o[r])(i,n,a)}s.delete(t)}}},e.prototype.regUsingImage=function(e,t,i,n,a){var s,r=this._cacheMgr.argsToString(e,t,i);this._usingImages.has(r)?(s=this._usingImages.get(r)).set(n,a):((s=new Map).set(n,a),this._usingImages.set(r,s));this._cacheMgr.setLastAccessSerialInfo(e,t)},e.prototype.unregUsingImage=function(e,t,i,n){var a=this._cacheMgr.argsToString(e,t,i);if(this._usingImages.has(a)){var s=this._usingImages.get(a);s.has(n)&&s.delete(n),0==s.size&&this._usingImages.delete(a)}},e.prototype.OnGetXeguid=function(e){0!=e.head.errCode?this.executeRequest("getXeguid",this._cacheMgr.argsToString(e.body.name+e.body.value),null,e.head.errCode,e.head.errText):this.executeRequest("getXeguid",this._cacheMgr.argsToString(e.body.name+e.body.value),e.body.xeGUID,0,"")},e.prototype.onGetStudyInfo=function(t){if(0!=t.head.errCode)console.warn("onGetStudyInfo(rspJson:%o)",t),this.executeRequest("getStudyInfo",this._cacheMgr.argsToString(t.body.xeGUID),null,t.head.errCode,t.head.errText);else{var i=null;e._studies.has(t.body.xeGUID)?i=e._studies.get(t.body.xeGUID):(i=new CStudyData(t.body.xeGUID),e._studies.set(i.xeGUID,i)),i.studyid=t.body.studyid,i.modality=t.body.modality,i.patientName=t.body.patientName,this.hidePatientInfo&&(i.patientName="***"),i.patientGender=t.body.patientGender,i.patientAge=t.body.patientAge,i.patientAgeUnit=t.body.patientAgeUnit,i.studyStatus=t.body.studyStatus,i.studyTime=t.body.studyTime,i.imageCount=t.body.imageCount,i.reportDiag=t.body.reportDiag,i.reportDesc=t.body.reportDesc,t.body.studydescribe&&(i.studydescribe=t.body.studydescribe),t.body.studyInstanceUID&&(i.studyInstanceUID=t.body.studyInstanceUID),i.isCompleted=!0,this.executeRequest("getStudyInfo",this._cacheMgr.argsToString(i.xeGUID),i,0,"")}},e.prototype.onGetSeriesInfo=function(t){if(0!=t.head.errCode)console.warn("onGetSeriesInfo(rspJson:%o)",t),this.executeRequest("getSeriesInfo",this._cacheMgr.argsToString(t.body.xeGUID),null,t.head.errCode,t.head.errText);else{var i=null;e._studies.has(t.body.xeGUID)?i=e._studies.get(t.body.xeGUID):(i=new CStudyData(t.body.xeGUID),e._studies.set(i.xeGUID,i));for(var n=new Array,a=0;a<t.body.series.length;a++){var s=t.body.series[a],r=new CSeriesData(s.index,t.body.xeGUID,s.imageTotal);r.seriesDesc=s.seriesDesc,r.seriesUID=s.seriesUID,r.seriesNumber=s.seriesNumber,r.modality=s.modality,n.push(r)}i.series=n,this.executeRequest("getSeriesInfo",this._cacheMgr.argsToString(t.body.xeGUID),i.series,0,""),this._cacheMgr.preSeriesCache(i)}},e.prototype.onGetImageInfo=function(t){if(0!=t.head.errCode)console.warn("onGetImageInfo(rspJson:%o)",t),this.executeRequest("getImageInfo",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndex,CImageData.indexMerge(t.body.index,0)),null,t.head.errCode,t.head.errText);else{var i=e._studies.get(t.body.xeGUID).findSerial(t.body.seriesIndex),n=i.findImageByIndex(CImageData.indexMerge(t.body.index,0)),a=!1;null==n&&(n=new CImageData(i.xeGUID,i.index,t.body.index,0),a=!0),n.setOverlayInfo(t.body.overlayInfo),n.setDicomInfo(t.body.dicomInfo),n.setDefaultWW(t.body.wwInfo.windowWidth,t.body.wwInfo.windowCenter),n.setPixelRepresentation(t.body.wwInfo.pixelRepresentation),this.hidePatientInfo&&n.hidePatientName(),a&&i.insertImage(n),this.executeRequest("getImageInfo",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndex,CImageData.indexMerge(t.body.index,0)),n,0,"")}},e.prototype.onGetImageBinary=function(t,i){if(0!=t.head.errCode)console.warn("onGetImageBinary(rspJson:%o)",t),this.executeRequest("getImageBinary",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndex,CImageData.indexMerge(t.body.index,t.body.frameIndex)),null,t.head.errCode,t.head.errText);else{var n=e._studies.get(t.body.xeGUID).findSerial(t.body.seriesIndex).findImageByIndex(CImageData.indexMerge(t.body.index,t.body.frameIndex));t.body.hasOwnProperty("tileIndex")&&t.body.tileIndex>=0?(n.setImageBlock(t.body.tileIndex,i),n.isAllBlockFilled()&&(n.combineBlocks(),this.onImageUpdate(n))):this.updateImage(n,t.body.level,i),this.executeRequest("getImageBinary",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndex,CImageData.indexMerge(t.body.index,t.body.frameIndex)),n,0,"")}},e.prototype.onGetSerialThumb=function(t,i){if(0!=t.head.errCode)console.warn("onGetSerialThumb(rspJson:%o)",t),this.executeRequest("getSerialThumb",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndexes[0]),null,t.head.errCode,t.head.errText);else{if(e._studies.has(t.body.xeGUID)){var n=e._studies.get(t.body.xeGUID).findSerial(t.body.seriesIndexes[0]);null!=n&&(null==n.thumbnail&&(n.thumbnail=i),t.body.sliceThickness>0&&(n.sliceThickness=t.body.sliceThickness,n.isThinLayer=n.sliceThickness<=this._thinLayerThick&&n.imageTotal>5))}this.executeRequest("getSerialThumb",this._cacheMgr.argsToString(t.body.xeGUID,t.body.seriesIndexes[0]),i,0,"")}},e.prototype.onGetStudyThumb=function(t,i){if(0!=t.head.errCode)console.warn("onGetStudyThumb(rspJson:%o)",t),this.executeRequest("getStudyThumb",this._cacheMgr.argsToString(t.body.xeGUID),null,t.head.errCode,t.head.errText);else{if(e._studies.has(t.body.xeGUID)){var n=e._studies.get(t.body.xeGUID);null!=n&&null==n.thumbnail&&(n.thumbnail=i)}this.executeRequest("getStudyThumb",this._cacheMgr.argsToString(t.body.xeGUID),i,0,"")}},e.prototype.fillMPRImageData=function(e,t,i){e&&(i&&(e.setPixelSpacing(t.pixelSpacing),e.widthFull=e.imageWidth=t.width,e.heightFull=e.imageHeight=t.height,e.yAxis=new Point3d(t.yAxisX,t.yAxisY,t.yAxisZ),void 0!==t.eyeRayX&&(e.eyeRay=new Point3d(t.eyeRayX,t.eyeRayY,t.eyeRayZ)),e.fov=t.fov,e.ptCenter=new Point3d(t.ptCenterX,t.ptCenterY,t.ptCenterZ),e.maxFov=t.maxFov,e.ptOrigin=new Point3d(t.ptOriginX,t.ptOriginY,t.ptOriginZ),e.pixelRate=t.pixelRate),e.dynaWidth=t.width,e.dynaHeight=t.height,e.dynaYAxis=new Point3d(t.yAxisX,t.yAxisY,t.yAxisZ),void 0!==t.eyeRayX&&(e.dynaEyeRay=new Point3d(t.eyeRayX,t.eyeRayY,t.eyeRayZ)),e.dynaFov=t.fov,e.dynaPtCenter=new Point3d(t.ptCenterX,t.ptCenterY,t.ptCenterZ),e.dynaMaxFov=t.maxFov,e.dynaPtOrigin=new Point3d(t.ptOriginX,t.ptOriginY,t.ptOriginZ),e.dynaPixelRate=t.pixelRate)},e.prototype.onGetMPRInfo=function(e){if(0!=e.head.errCode)console.warn("onGetMPRInfo(rspJson:%o)",e),this.executeRequest("getMPRInfo",this._cacheMgr.argsToString(e.body.xeGUID,e.body.seriesIndex),null,e.head.errCode,e.head.errText);else{var t=this._mprDatas.getMPRData(e.body.xeGUID,e.body.seriesIndex);if(null==t&&(t=new CMPRData(e.body.xeGUID,e.body.seriesIndex)),t.MPRDefaultCenterPoint=new Point3d(e.body.keyPointx,e.body.keyPointy,e.body.keyPointz),t.keyPoint=new Point3d(e.body.keyPointx,e.body.keyPointy,e.body.keyPointz),t.volHeight=e.body.volHeight,t.volWeight=e.body.volWeight,t.volTall=e.body.volTall,e.body.planum_t){var i=t.getImageData("t");null==i&&(i=new CMPRImageData(e.body.xeGUID,e.body.seriesIndex,"t"),t.imageDataT=i),i.setDefaultWW(e.body.imageBaseInfo.windowWidth,e.body.imageBaseInfo.windowCenter),i.setPixelRepresentation(e.body.imageBaseInfo.pixelRepresentation),i.photoMetricInterpretation=e.body.imageBaseInfo.photoMetricInterpretation,this.fillMPRImageData(i,e.body.planum_t,!0)}if(e.body.planum_s){var n=t.getImageData("s");null==n&&(n=new CMPRImageData(e.body.xeGUID,e.body.seriesIndex,"s"),t.imageDataS=n),n.setDefaultWW(e.body.imageBaseInfo.windowWidth,e.body.imageBaseInfo.windowCenter),n.setPixelRepresentation(e.body.imageBaseInfo.pixelRepresentation),n.photoMetricInterpretation=e.body.imageBaseInfo.photoMetricInterpretation,this.fillMPRImageData(n,e.body.planum_s,!0)}if(e.body.planum_c){var a=t.getImageData("c");null==a&&(a=new CMPRImageData(e.body.xeGUID,e.body.seriesIndex,"c"),t.imageDataC=a),a.setDefaultWW(e.body.imageBaseInfo.windowWidth,e.body.imageBaseInfo.windowCenter),a.setPixelRepresentation(e.body.imageBaseInfo.pixelRepresentation),a.photoMetricInterpretation=e.body.imageBaseInfo.photoMetricInterpretation,this.fillMPRImageData(a,e.body.planum_c,!0)}if(e.body.planum_o){var s=t.getImageData("o");null==s&&(s=new CMPRImageData(e.body.xeGUID,e.body.seriesIndex,"o"),t.imageDataO=s),s.setDefaultWW(e.body.imageBaseInfo.windowWidth,e.body.imageBaseInfo.windowCenter),s.setPixelRepresentation(e.body.imageBaseInfo.pixelRepresentation),s.photoMetricInterpretation=e.body.imageBaseInfo.photoMetricInterpretation,this.fillMPRImageData(s,e.body.planum_o,!0)}t.updateEyeRayOfPlanumS(),this._mprDatas.setMPRData(e.body.xeGUID,e.body.seriesIndex,t),this.executeRequest("getMPRInfo",this._cacheMgr.argsToString(e.body.xeGUID,e.body.seriesIndex),t,0,"")}},e.prototype.onGetMPRJpg=function(e,t){var i=this;if(0!=e.head.errCode)console.warn("onGetMPRJpg(rspJson:%o)",e),this.MPRJpgDealer.get(e.body.planum)(!1,null,e.head.errCode,e.head.msgID);else{var n=this._mprDatas.getMPRData(e.body.xeGUID,e.body.seriesIndex);e.head.msgID==this.mprMsgLastIDs.get(e.body.planum)&&(e.body.planum_t&&this.fillMPRImageData(n.imageDataT,e.body.planum_t,!n.imageDataT.firstImageLoaded),e.body.planum_s&&this.fillMPRImageData(n.imageDataS,e.body.planum_s,!n.imageDataS.firstImageLoaded),e.body.planum_c&&this.fillMPRImageData(n.imageDataC,e.body.planum_c,!n.imageDataC.firstImageLoaded),e.body.planum_o&&this.fillMPRImageData(n.imageDataO,e.body.planum_o,!n.imageDataO.firstImageLoaded),n.updateEyeRayOfPlanumS(),n.updateOriginPT(n.imageDataT),n.updateOriginPT(n.imageDataC),n.updateOriginPT(n.imageDataS),n.updateOriginPT(n.imageDataO)),n.getImageData(e.body.planum).firstImageLoaded=!0;var a=n.getImageData(e.body.planum);if(null!=a){var s=e.head.msgID,r=new Image;r.src=window.URL.createObjectURL(t),r.onload=function(){a.setJPG(r),a.setImageLevel(IMAGE_LEVEL.IMAGE_LEVEL_JPG),i.MPRJpgDealer.get(e.body.planum)(!0,a,e.head.errCode,s)}}}},e.prototype.getImageFileAsync=function(e,t,i,n){var a=this;return new Promise(function(s,r){a.addRequest("GetImageFile",a._cacheMgr.argsToString(e,t,i),function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=""),0==t?s(e):r(i)}),a._wsProcessor.getImageFile(e,t,CImageData.realIndexSplit(i),n)})},e.prototype.onGetImageFile=function(e,t){if(0!=e.head.errCode)console.warn("onGetImageFile(rspJson:%o)",e),this.executeRequest("GetImageFile",this._cacheMgr.argsToString(e.body.xeGUID,e.body.seriesIndex,CImageData.indexMerge(e.body.index,e.body.frameIndex)),null,e.head.errCode,e.head.errText);else{var i=new ImageFile;i.blob=t,i.filename=e.body.filename,i.imageTypeID=e.body.imageTypeID,i.xeGUID=e.body.xeGUID,i.seriesIndex=e.body.seriesIndex,i.imageIndex=e.body.index,this.executeRequest("GetImageFile",this._cacheMgr.argsToString(e.body.xeGUID,e.body.seriesIndex,CImageData.indexMerge(e.body.index,e.body.frameIndex)),i,0,"")}},e.prototype.updateImage=function(e,t,i){var n=this,a=e.getImageLevel();if(t==IMAGE_LEVEL.IMAGE_LEVEL_JPG){if(a>IMAGE_LEVEL.IMAGE_LEVEL_JPG)return void console.debug("updating image(",e.realIndex,"-",e.frameIndex,") to jpg is late, current level is ",a,", set value is ",t);var s=i.subarray(4),r=new Blob([s],{type:"application/octet-binary"}),o=new Image;o.src=window.URL.createObjectURL(r),o.onload=function(){e.setJPG(o),e.setImageLevel(IMAGE_LEVEL.IMAGE_LEVEL_JPG),n.onImageUpdate(e)}}else{if(t!=IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL)return;e.appendFullData(i),this.onImageUpdate(e),e.setJPG(null),e.MemoryToLocalDB(function(t){var i=n._cacheMgr.argsToString(e.xeGuid,e.seriesIndex,e.index);!t||n._usingImages.has(i)||n._cacheMgr.isNeedCache(e.xeGuid,e.seriesIndex,e.index)||(e.imageData16=null)})}},e.prototype.getVRInfo=function(e,t){this._wsProcessor.getVRInfo(e,t)},e.prototype.getVRJpg=function(e,t,i){this._wsProcessor.getVRJpg(e,t,i)},e.prototype.getSerialCacheFinished=function(t,i){if(!this._isFullMode)return!1;var n=!1;return e._studies.has(t)&&(n=this._cacheMgr.getSerialCacheFinished(e._studies.get(t).findSerial(i))),n},e.prototype.setDownloadProgressCallback=function(e){this._cacheMgr.cb_SeriesDownloadProgress=e},e.prototype.setThinSeriesMode=function(t,i){var n=this;if(void 0===i&&(i=""),""!=i){if(e._studies.has(i)){var a=e._studies.get(i);a.isHideThinSeries=t,t||this._cacheMgr.preSeriesCache(a)}}else e._studies.forEach(function(e){e.isHideThinSeries=t,t||n._cacheMgr.preSeriesCache(e)})},e._instances=new Map,e._studies=new Map,e}(),CXeImageHelper=function(){function e(e,t,i,n){void 0===n&&(n=DISPLAY_MODE.DISP_2D),this._imageData=null,this._imageState=null,this._canvas=null,this._rotateMatrix=[1,0,0,1,0,0],this._roi=new Rect(0,0,0,0),this._needDrawSerial=!1,this._needDrawSameImage=!1,this._localizerData=null,this.offCanvas=document.createElement("canvas"),this.offFilterCanvas=document.createElement("canvas"),this.offScale=1,this.offCoarseRotateMatrix=null,this.displayMode=DISPLAY_MODE.DISP_2D,this.mprPlanum="",this._connKey=e,this._canvas=t,this._imageState=i,this._localizerData=new Array,this.displayMode=n}return e.prototype.getCanvasID=function(){return this._canvas.getAttribute("id")},Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connKey",{get:function(){return this._connKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageData",{get:function(){return this._imageData},set:function(e){this._imageData=e,null==this._imageState.windowWidth&&(this._imageState.windowCenter=this._imageData.defaultWL,this._imageState.windowWidth=this._imageData.defaultWW,this._imageState.dispInfo.wwwlChanged=!1)},enumerable:!0,configurable:!0}),e.prototype.isMPRMode=function(){return this.displayMode==DISPLAY_MODE.DISP_MPR_T||this.displayMode==DISPLAY_MODE.DISP_MPR_S||this.displayMode==DISPLAY_MODE.DISP_MPR_C||this.displayMode==DISPLAY_MODE.DISP_MPR_O},e.prototype.isVRMode=function(){return this.displayMode==DISPLAY_MODE.DISP_VR},e.prototype.isJPGMode=function(){return CDicomDataManager.GetInstance(this._connKey).isJPGMode},e.prototype.isLocalizerImage=function(){if(null!=this.imageData){var e=this.imageData.imageType;return null!=e&&-1!=e.indexOf("LOCALIZER")}return!1},Object.defineProperty(e.prototype,"imageState",{get:function(){return this._imageState},set:function(e){this._imageState=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowCenter",{get:function(){return this._imageState.windowCenter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowWidth",{get:function(){return this._imageState.windowWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roi",{get:function(){return this._roi},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cellWidth",{get:function(){return null==this._canvas?0:this._canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cellHeight",{get:function(){return null==this._canvas?0:this._canvas.height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotateMatrix",{get:function(){return this._rotateMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needCalcWW",{get:function(){return this._imageState.needCalcWW},set:function(e){this._imageState.needCalcWW=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needDrawSerial",{get:function(){return this._needDrawSerial},set:function(e){this._needDrawSerial=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needDrawSameImage",{get:function(){return this._needDrawSameImage},set:function(e){this._needDrawSameImage=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateX",{get:function(){return this._imageState.offRateX},set:function(e){this._imageState.offRateX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateY",{get:function(){return this._imageState.offRateY},set:function(e){this._imageState.offRateY=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoom",{get:function(){return this._imageState.zoom},set:function(e){this._imageState.zoom=e,this._imageState.zoom<.1?this._imageState.zoom=.1:this._imageState.zoom>10&&(this._imageState.zoom=10)},enumerable:!0,configurable:!0}),e.prototype.getLocalizer=function(){return this._localizerData},e.prototype.setLocalizer=function(e){this._localizerData.push(e)},e.prototype.setWW=function(e,t,i){var n=!1;return this.imageState.windowCenter==t&&this.imageState.windowWidth==e||(this.imageState.windowCenter=Math.round(t),this.imageState.windowWidth=Math.round(e),i&&(this._imageState.dispInfo.wwwlChanged=!1),this.needCalcWW=!0,n=!0,null!=this._imageData&&CDicomDataManager.GetInstance(this._connKey).changeSerailJGPCacheWWWL(this._imageData.xeGuid,this._imageData.seriesIndex,e,t),CImageDrawerManager.GetInstance().WWWLChange(this.getCanvasID(),this.imageState.windowWidth,this.imageState.windowCenter)),n},e.prototype.getWW=function(){return this.imageState.windowWidth},e.prototype.getWL=function(){return this.imageState.windowCenter},e.prototype.calDispMatrix=function(e,t){if(!this.isVRMode()){if(this._rotateMatrix=this.calMatrix(e,t,this._canvas.width,this._canvas.height),this._roi.left=0,this._roi.top=0,this._roi.right=this._canvas.width,this._roi.bottom=this._canvas.height,this.clientToImage_rect(this._roi),this._roi.left>this._roi.right){var i=this._roi.left;this._roi.left=this._roi.right,this._roi.right=i}if(this._roi.top>this._roi.bottom){i=this._roi.top;this._roi.top=this._roi.bottom,this._roi.bottom=i}this._roi.left=this._roi.left<0?0:this._roi.left,this._roi.left=this._roi.left>e?e:this._roi.left,this._roi.top=this._roi.top<0?0:this._roi.top,this._roi.top=this._roi.top>t?t:this._roi.top,this._roi.right=this._roi.right<0?0:this._roi.right,this._roi.right=this._roi.right>e?e:this._roi.right,this._roi.bottom=this._roi.bottom<0?0:this._roi.bottom,this._roi.bottom=this._roi.bottom>t?t:this._roi.bottom}},e.prototype.calMatrix=function(e,t,i,n){var a=[1,0,0,1,0,0],s=this._imageState.rotateAngle;if(0!=e){var r,o,l=this._imageState.offRateX,h=this._imageState.offRateY,u=.5*i,d=.5*n,c=this._imageState.zoom;return this.isMPRMode()&&(c=1),!this._imageState.isHorzMirror||90!=s&&270!=s||(s=(s+180+360)%360),!this._imageState.isVertMirror||90!=s&&270!=s||(s=(s+180+360)%360),90==s||270==s?(r=i/t,o=n/e):(r=i/e,o=n/t),c*=r>o?o:r,a[4]=u+l*i,a[5]=d+h*n,0==s?(a[4]-=.5*e*c,a[5]-=.5*t*c):90==s?(a[0]=0,a[1]=1,a[2]=-1,a[3]=0,a[4]+=.5*t*c,a[5]-=.5*e*c):180==s?(a[0]=-1,a[1]=0,a[2]=0,a[3]=-1,a[4]+=.5*e*c,a[5]+=.5*t*c):270==s&&(a[0]=0,a[1]=-1,a[2]=1,a[3]=0,a[4]-=.5*t*c,a[5]+=.5*e*c),this._imageState.isHorzMirror&&(a[0]=-a[0],a[2]=-a[2],90==s?a[4]-=c*t:0==s?a[4]+=c*e:180==s?a[4]-=c*e:270==s&&(a[4]+=c*t)),this._imageState.isVertMirror&&(a[1]=-a[1],a[3]=-a[3],90==s?a[5]+=c*e:270==s?a[5]-=c*e:0==s?a[5]+=c*t:180==s&&(a[5]-=c*t)),a[0]=c*a[0],a[1]=c*a[1],a[2]=c*a[2],a[3]=c*a[3],a[4]=a[4],a[5]=a[5],a}},e.prototype.clientToImage_point=function(e){var t=new Point2d(0,0);if(this.RotatedPointToOrgPoint(e,t,this._rotateMatrix,this._imageState),this._imageData.imageWidth>0){var i=this._imageData.heightFull/this._imageData.imageHeight,n=this._imageData.widthFull/this._imageData.imageWidth;n>1.2&&(t.x*=n,t.y*=i)}return new Point2d(Math.round(t.x),Math.round(t.y))},e.prototype.clientToCoarse_point=function(e){var t=new Point2d(0,0);if(this.RotatedPointToOrgPoint(e,t,this.offCoarseRotateMatrix,this._imageState),this._imageData.imageWidth>0){var i=this._imageData.heightFull/this._imageData.imageHeight,n=this._imageData.widthFull/this._imageData.imageWidth;n>1.2&&(t.x*=n,t.y*=i)}return new Point2d(Math.round(t.x),Math.round(t.y))},e.prototype.clientToImage_rect=function(e){var t=new Point2d(e.left,e.top),i=this.clientToImage_point(t);e.left=i.x,e.top=i.y;var n=new Point2d(e.right,e.bottom),a=this.clientToImage_point(n);e.right=a.x,e.bottom=a.y},e.prototype.imageToClient_rect=function(e){var t=new Point2d(e.left,e.top),i=this.imageToClient_point(t);e.left=i.x,e.top=i.y;var n=new Point2d(e.right,e.bottom),a=this.imageToClient_point(n);e.right=a.x,e.bottom=a.y},e.prototype.imageToClient_point=function(e){var t=new Point2d(0,0),i=e.x,n=e.y;if(this._imageData.imageWidth>0){var a=this._imageData.heightFull/this._imageData.imageHeight,s=this._imageData.widthFull/this._imageData.imageWidth;s>1.2&&(i/=s,n/=a)}return this.OrgPointToRotatedPoint(new Point2d(i,n),t,this._rotateMatrix,this._imageState),t},e.prototype.imageToCoarse_point=function(e){if(null==this.offCoarseRotateMatrix)return null;var t=new Point2d(0,0),i=e.x,n=e.y;if(this._imageData.imageWidth>0){var a=this._imageData.heightFull/this._imageData.imageHeight,s=this._imageData.widthFull/this._imageData.imageWidth;s>1.2&&(i/=s,n/=a)}return this.OrgPointToRotatedPoint(new Point2d(i,n),t,this.offCoarseRotateMatrix,this._imageState),t},e.prototype.RotatedPointToOrgPoint=function(e,t,i,n){var a=1/(i[0]*i[3]-i[1]*i[2]),s=a*i[3],r=-a*i[1],o=-a*i[2],l=a*i[0],h=s*e.x+r*e.y,u=o*e.x+l*e.y;n.isHorzMirror&&n.isVertMirror?0==n.rotateAngle||180==n.rotateAngle?(h+=(i[1]*i[5]-i[4]*i[3])*a,u+=(-i[0]*i[5]+i[4]*i[2])*a):90!=n.rotateAngle&&270!=n.rotateAngle||(h=-h-(i[1]*i[5]-i[4]*i[3])*a,u=-u-(-i[0]*i[5]+i[4]*i[2])*a):n.isHorzMirror||n.isVertMirror?(h+=(i[1]*i[5]-i[4]*i[3])*a,u+=(-i[0]*i[5]+i[4]*i[2])*a):0==n.rotateAngle||180==n.rotateAngle?(h+=(i[1]*i[5]-i[4]*i[3])*a,u+=(-i[0]*i[5]+i[4]*i[2])*a):90!=n.rotateAngle&&270!=n.rotateAngle||(h=-h-(i[1]*i[5]-i[4]*i[3])*a,u=-u-(-i[0]*i[5]+i[4]*i[2])*a),t.x=h,t.y=u},e.prototype.OrgPointToRotatedPoint=function(e,t,i,n){t.x=e.x*i[0]+e.y*i[1],t.y=e.x*i[2]+e.y*i[3],n.isHorzMirror&&n.isVertMirror?0==n.rotateAngle||180==n.rotateAngle?(t.x+=i[4],t.y+=i[5]):90!=n.rotateAngle&&270!=n.rotateAngle||(t.x=-t.x+i[4],t.y=-t.y+i[5]):n.isHorzMirror||n.isVertMirror?(t.x+=i[4],t.y+=i[5]):0==n.rotateAngle||180==n.rotateAngle?(t.x+=i[4],t.y+=i[5]):90!=n.rotateAngle&&270!=n.rotateAngle||(t.x=-t.x+i[4],t.y=-t.y+i[5]),t.x=Math.round(t.x),t.y=Math.round(t.y)},e.prototype.updateVRStateParam=function(){if(this._imageState){this._imageState.vrState.width=this.cellWidth,this._imageState.vrState.height=this.cellHeight;var e=this._imageState.vrState,t=e.pixelSpacingX*e.default_middlePoint.x*2/this.cellWidth,i=e.pixelSpacingX*e.default_middlePoint.z*2/this.cellHeight;this._imageState.vrState.fov=(t>i?t:i)*this.cellWidth/this.zoom;var n=this._imageState.vrState.pixelRate,a=this._imageState.vrState.default_middlePoint.x,s=this._imageState.vrState.default_middlePoint.y,r=this._imageState.vrState.default_middlePoint.z,o=this._imageState.vrState.yAxis.x,l=this._imageState.vrState.yAxis.y,h=this._imageState.vrState.yAxis.z,u=l*this._imageState.vrState.eyeRay.z-h*this._imageState.vrState.eyeRay.y,d=h*this._imageState.vrState.eyeRay.x-o*this._imageState.vrState.eyeRay.z,c=o*this._imageState.vrState.eyeRay.y-l*this._imageState.vrState.eyeRay.x,p=this.offRateX*this.cellWidth,g=this.offRateY*this.cellHeight;this._imageState.vrState.middlePoint.x=a-u*p*n-o*g*n,this._imageState.vrState.middlePoint.y=s-d*p*n-l*g*n,this._imageState.vrState.middlePoint.z=r-c*p*n-h*g*n}},e.prototype.calcRelation=function(e){var t=this._imageData;if(null==e||null==t)return-1;if(void 0==e.imagePosition||""==e.imagePosition||void 0==e.imageOrientation||""==e.imageOrientation||void 0==t.imagePosition||""==t.imagePosition||void 0==t.imageOrientation||""==t.imageOrientation)return-1;var i=e.imagePosition.split("\\"),n=[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])],a=e.imageOrientation.split("\\"),s=[parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4]),parseFloat(a[5])],r=t.imagePosition.split("\\"),o=[parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])],l=t.imageOrientation.split("\\"),h=[parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]),parseFloat(l[4]),parseFloat(l[5])];if(Math.abs(s[0]-h[0])<.1&&Math.abs(s[1]-h[1])<.1&&Math.abs(s[2]-h[2])<.1&&Math.abs(s[3]-h[3])<.1&&Math.abs(s[4]-h[4])<.1&&Math.abs(s[5]-h[5])<.1&&Math.abs(n[0]-o[0])<.1&&Math.abs(n[1]-o[1])<.1&&Math.abs(n[2]-o[2])<.1)return 5;var u=s[1]*s[5]-s[2]*s[4],d=s[2]*s[3]-s[0]*s[5],c=s[0]*s[4]-s[1]*s[3],p=h[1]*h[5]-h[2]*h[4],g=h[2]*h[3]-h[0]*h[5],_=h[0]*h[4]-h[1]*h[3];return Math.abs(u-p)<.1&&Math.abs(d-g)<.1&&Math.abs(c-_)<.1||Math.abs(u+p)<.1&&Math.abs(d+g)<.1&&Math.abs(c+_)<.1?0:Utility.VecterVertical(new Point3d(u,d,c),new Point3d(p,g,_))?2:1},e}(),INVALID_COORDINATE_VALUE=65535,CXeImageStateManager=function(){function e(){this.studies=new Map,this.isListenedSync=!1}return e.GetInstance=function(t){if(e._instances.has(t))return e._instances.get(t);var i=new e;return e._instances.set(t,i),i},e.GetAllInstance=function(){return e._instances},e.prototype.getStudyState=function(e,t){void 0===t&&(t=!0);var i=null;return this.studies.has(e)?i=this.studies.get(e):t&&(i=this.createStudyState(e)),i},e.prototype.createStudyState=function(e){var t=null;return this.studies.has(e)?t=this.studies.get(e):(t=new CXeStudyState(e),this.studies.set(e,t)),t},e.prototype.genCurrentStudyState=function(){var e={studies:[]};return this.studies.forEach(function(t){var i={XEGUID:t.XEGUID,series:[]};e.studies.push(i),t.series.forEach(function(e){var t={index:e.index,dispInfo:{isShowAnno:e.isShowAnno,isShowOverlay:e.isShowOverlay,zoom:e.zoom,isHorzMirror:e.isHorzMirror,isVertMirror:e.isVertMirror,rotateAngle:e.rotateAngle,_windowCenter:e.windowCenter,_windowWidth:e.windowWidth,offRateX:e.offRateX,offRateY:e.offRateY},_defaultWW:e.defaultWW,_defaultWL:e.defaultWL,images:[]};i.series.push(t),e.images.forEach(function(e){var i={index:e.index};t.images.push(i)})})}),e},e._instances=new Map,e}(),CXeStudyState=function(){function e(e){this.series=new Map,this.XEGUID=e}return e.prototype.getSerialState=function(e,t){void 0===t&&(t=!0);var i=null;return this.series.has(e)?i=this.series.get(e):t&&(i=this.createSerialState(e)),i},e.prototype.getSerialMPRState=function(e,t){void 0===t&&(t=!0);var i=null,n="MPR_"+e;return this.series.has(n)?i=this.series.get(n):t&&(i=this.createSerialState(n)),i},e.prototype.getSerialVRState=function(e,t){void 0===t&&(t=!0);var i=null,n="VR_"+e;return this.series.has(n)?i=this.series.get(n):t&&(i=this.createSerialState(n)),i},e.prototype.createSerialState=function(e){var t=null;return this.series.has(e)?t=this.series.get(e):(t=new CXeSerialState(e),this.series.set(e,t)),t},e}(),CXeSerialState=function(){function e(e){this.images=new Map,this.dispInfo=new CXeImageDisplayState,this._defaultWW=null,this._defaultWL=null,this._defaultMPRCenterPoint=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.index=e}return Object.defineProperty(e.prototype,"defaultWW",{get:function(){return this._defaultWW},set:function(e){this._defaultWW=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultWL",{get:function(){return this._defaultWL},set:function(e){this._defaultWL=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isShowAnno",{get:function(){return this.dispInfo.isShowAnno},set:function(e){this.dispInfo.isShowAnno=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isShowOverlay",{get:function(){return this.dispInfo.isShowOverlay},set:function(e){this.dispInfo.isShowOverlay=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoom",{get:function(){return this.dispInfo.zoom},set:function(e){this.dispInfo.zoom=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isHorzMirror",{get:function(){return this.dispInfo.isHorzMirror},set:function(e){this.dispInfo.isHorzMirror=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isVertMirror",{get:function(){return this.dispInfo.isVertMirror},set:function(e){this.dispInfo.isVertMirror=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotateAngle",{get:function(){return this.dispInfo.rotateAngle},set:function(e){this.dispInfo.rotateAngle=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowCenter",{get:function(){return this.dispInfo.windowCenter},set:function(e){this.dispInfo.windowCenter=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowWidth",{get:function(){return this.dispInfo.windowWidth},set:function(e){this.dispInfo.windowWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateX",{get:function(){return this.dispInfo.offRateX},set:function(e){this.dispInfo.offRateX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateY",{get:function(){return this.dispInfo.offRateY},set:function(e){this.dispInfo.offRateY=e},enumerable:!0,configurable:!0}),e.prototype.resetDisplay=function(){this.dispInfo.reset(this.defaultWW,this._defaultWL,this._defaultMPRCenterPoint)},e.prototype.resetAll=function(){this.dispInfo.reset(this.defaultWW,this._defaultWL,this._defaultMPRCenterPoint),this.resetAllImageAnno()},e.prototype.resetAllImageAnno=function(e){void 0===e&&(e="all"),this.images.forEach(function(t){t.resetAnno(e)})},e.prototype.getImageDisplayState=function(){return this.dispInfo},e.prototype.setImageDisplayState=function(e){null!=e&&this.dispInfo.copy(e)},e.prototype.getImageState=function(e,t){void 0===t&&(t=!0);var i=null;return this.images.has(e)?i=this.images.get(e):t&&(i=this.createImageState(e)),i},e.prototype.setImageState=function(e,t){this.images.has(e)?this.images.get(e).copy(t):this.images.set(e,t.clone(null))},e.prototype.createImageState=function(e){var t=null;return this.images.has(e)?t=this.images.get(e):(t=new CXeImageState(e,this.dispInfo),this.images.set(e,t)),t},e.prototype.getMPRCenterPoint=function(){return new Point3d(this.dispInfo.mprCenterX,this.dispInfo.mprCenterY,this.dispInfo.mprCenterZ)},e.prototype.setMPRCenterPoint=function(e,t,i){this.dispInfo.mprCenterX!=e&&(this.dispInfo.mprCenterX=e),this.dispInfo.mprCenterY!=t&&(this.dispInfo.mprCenterY=t),this.dispInfo.mprCenterZ!=i&&(this.dispInfo.mprCenterZ=i)},Object.defineProperty(e.prototype,"defaultMPRCenterPoint",{get:function(){return this._defaultMPRCenterPoint},set:function(e){this._defaultMPRCenterPoint=new Point3d(e.x,e.y,e.z),this.dispInfo.mprCenterX==INVALID_COORDINATE_VALUE&&(this.dispInfo.mprCenterX=e.x),this.dispInfo.mprCenterY==INVALID_COORDINATE_VALUE&&(this.dispInfo.mprCenterY=e.y),this.dispInfo.mprCenterZ==INVALID_COORDINATE_VALUE&&(this.dispInfo.mprCenterZ=e.z)},enumerable:!0,configurable:!0}),e}(),CXeImageDisplayState=function(){function e(){this.isShowAnno=!0,this.isShowOverlay=!0,this._zoom=1,this.isHorzMirror=!1,this.isVertMirror=!1,this.rotateAngle=0,this.isAutoFitWnd=!0,this.rotateMatrix=[1,0,0,1,0,0],this.offRateX=0,this.offRateY=0,this.isSNRShow=!1,this._enbalePseudoColor=!1,this._enbaleSharpen=!1,this._enbaleInverse=!1,this._pseudoColorMap=null,this._mprCenterX=INVALID_COORDINATE_VALUE,this._mprCenterY=INVALID_COORDINATE_VALUE,this._mprCenterZ=INVALID_COORDINATE_VALUE,this.mprThick=0,this.mprMIPType="",this._windowCenter=null,this._windowWidth=null,this.wwwlChanged=!1,this.cb_wwwlChangeds=new Map,this.cb_mprChangeds=new Map}return Object.defineProperty(e.prototype,"zoom",{get:function(){return this._zoom},set:function(e){this._zoom=e,this._zoom<.1?this._zoom=.1:this._zoom>10&&(this._zoom=10)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowCenter",{get:function(){return this._windowCenter},set:function(e){null!=e&&this._windowCenter!=e&&(this._windowCenter=e,this.wwwlChanged=!0,this.onWWWWLChanged("wwwl"))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowWidth",{get:function(){return this._windowWidth},set:function(e){null!=e&&this._windowWidth!=e&&(this._windowWidth=e,this.wwwlChanged=!0,this.onWWWWLChanged("wwwl"))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprCenterX",{get:function(){return this._mprCenterX},set:function(e){e!=INVALID_COORDINATE_VALUE&&this._mprCenterX!=e&&(this._mprCenterX=e,this.onMPRPointChanged())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprCenterY",{get:function(){return this._mprCenterY},set:function(e){e!=INVALID_COORDINATE_VALUE&&this._mprCenterY!=e&&(this._mprCenterY=e,this.onMPRPointChanged())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprCenterZ",{get:function(){return this._mprCenterZ},set:function(e){e!=INVALID_COORDINATE_VALUE&&this._mprCenterZ!=e&&(this._mprCenterZ=e,this.onMPRPointChanged())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enbalePseudoColor",{get:function(){return this._enbalePseudoColor},set:function(e){this._enbalePseudoColor=e,this.onWWWWLChanged("pseudoColor")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enbaleSharpen",{get:function(){return this._enbaleSharpen},set:function(e){this._enbaleSharpen=e,this.onWWWWLChanged("sharpen")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enbaleInverse",{get:function(){return this._enbaleInverse},set:function(e){this._enbaleInverse=e,this.onWWWWLChanged("inverse")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pseudoColorMap",{get:function(){return this._pseudoColorMap},set:function(e){this._pseudoColorMap=e,this.onWWWWLChanged("pseudoColor")},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=new e;return t.zoom=this.zoom,t.isShowAnno=this.isShowAnno,t.isShowOverlay=this.isShowOverlay,t.isHorzMirror=this.isHorzMirror,t.isVertMirror=this.isVertMirror,t.rotateAngle=this.rotateAngle,t.isAutoFitWnd=this.isAutoFitWnd,t.windowCenter=this.windowCenter,t.windowWidth=this.windowWidth,t.wwwlChanged=this.wwwlChanged,this.rotateMatrix.forEach(function(e,i){t.rotateMatrix[i]=e}),t.offRateX=this.offRateX,t.offRateY=this.offRateY,t.isSNRShow=this.isSNRShow,t.mprCenterX=this.mprCenterX,t.mprCenterY=this.mprCenterY,t.mprCenterZ=this.mprCenterZ,t.enbalePseudoColor=this.enbalePseudoColor,t.enbaleSharpen=this.enbaleSharpen,t.enbaleInverse=this.enbaleInverse,t.pseudoColorMap=new Map(this.pseudoColorMap),t.mprThick=this.mprThick,t.mprMIPType=this.mprMIPType,t},e.prototype.reset=function(e,t,i){this.isShowOverlay=!0,this.zoom=1,this.isHorzMirror=!1,this.isVertMirror=!1,this.rotateAngle=0,this.isAutoFitWnd=!0,this.windowCenter=t,this.windowWidth=e,this.wwwlChanged=!1,this.rotateMatrix=[1,0,0,1,0,0],this.offRateX=0,this.offRateY=0,this.isSNRShow=!1,this.mprCenterX=i.x,this.mprCenterY=i.y,this.mprCenterZ=i.z,this.enbalePseudoColor=!1,this.pseudoColorMap=null,this.mprThick=0,this.mprMIPType="",this.enbaleSharpen=!1,this.enbaleInverse=!1},e.prototype.copy=function(e){this.isShowAnno=e.isShowAnno,this.isShowOverlay=e.isShowOverlay,this.zoom=e.zoom,this.isHorzMirror=e.isHorzMirror,this.isVertMirror=e.isVertMirror,this.rotateAngle=e.rotateAngle,this.isAutoFitWnd=e.isAutoFitWnd,this.windowCenter=e.windowCenter,this.windowWidth=e.windowWidth,this.wwwlChanged=e.wwwlChanged,this.rotateMatrix=e.rotateMatrix,this.offRateX=e.offRateX,this.offRateY=e.offRateY,this.isSNRShow=e.isSNRShow,this.mprCenterX=e.mprCenterX,this.mprCenterY=e.mprCenterY,this.mprCenterZ=e.mprCenterZ,this.enbalePseudoColor=e.enbalePseudoColor,this.pseudoColorMap=new Map(e.pseudoColorMap),this.enbaleSharpen=e.enbaleSharpen,this.enbaleInverse=e.enbaleInverse,this.mprThick=e.mprThick,this.mprMIPType=e.mprMIPType},e.prototype.update=function(e){Utility.updateProp(e.zoom,this.zoom,null),Utility.updateProp(e.isShowAnno,this.isShowAnno,null),Utility.updateProp(e.isShowOverlay,this.isShowOverlay,null),Utility.updateProp(e.isHorzMirror,this.isHorzMirror,null),Utility.updateProp(e.isVertMirror,this.isVertMirror,null),Utility.updateProp(e.rotateAngle,this.rotateAngle,null),Utility.updateProp(e.isAutoFitWnd,this.isAutoFitWnd,null),Utility.updateProp(e.windowCenter,this.windowCenter,null),Utility.updateProp(e.windowWidth,this.windowWidth,null),Utility.updateProp(e.wwwlChanged,this.wwwlChanged,null),Utility.updateProp(e.rotateMatrix,this.rotateMatrix,null),Utility.updateProp(e.offRateX,this.offRateX,null),Utility.updateProp(e.offRateY,this.offRateY,null),Utility.updateProp(e.isSNRShow,this.isSNRShow,null),Utility.updateProp(e.mprCenterX,this.mprCenterX,null),Utility.updateProp(e.mprCenterY,this.mprCenterY,null),Utility.updateProp(e.mprCenterZ,this.mprCenterZ,null),Utility.updateProp(e.enbalePseudoColor,this.enbalePseudoColor,null),Utility.updateProp(e.enbaleSharpen,this.enbaleSharpen,null),Utility.updateProp(e.enbaleInverse,this.enbaleInverse,null),Utility.updateProp(e.mprThick,this.mprThick,null),Utility.updateProp(e.mprMIPType,this.mprMIPType,null)},e.prototype.setWWWWLChanged=function(e,t){this.cb_wwwlChangeds.set(e,t)},e.prototype.removeWWWWLChanged=function(e){this.cb_wwwlChangeds.delete(e)},e.prototype.onWWWWLChanged=function(e){this.cb_wwwlChangeds.forEach(function(t){t(e)})},e.prototype.setMPRPointChanged=function(e,t){this.cb_mprChangeds.set(e,t)},e.prototype.removeMPRPointChanged=function(e){this.cb_mprChangeds.delete(e)},e.prototype.onMPRPointChanged=function(){this.cb_mprChangeds.forEach(function(e){e()})},e}(),CXeVRState=function(){function e(){this.defaultEyeRay=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.defaultYAxis=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.default_opa_height=1,this.default_middlePoint=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.eyeRay=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.yAxis=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE),this.opa_height=1,this.middlePoint=new Point3d(INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE,INVALID_COORDINATE_VALUE)}return e.prototype.clone=function(){var t=new e;return t.defaultEyeRay=new Point3d(this.defaultEyeRay.x,this.defaultEyeRay.y,this.defaultEyeRay.z),t.defaultYAxis=new Point3d(this.defaultYAxis.x,this.defaultYAxis.y,this.defaultYAxis.z),t.eyeRay=new Point3d(this.eyeRay.x,this.eyeRay.y,this.eyeRay.z),t.yAxis=new Point3d(this.yAxis.x,this.yAxis.y,this.yAxis.z),t.default_opa_x1=this.default_opa_x1,t.default_opa_x2=this.default_opa_x2,t.default_opa_x3=this.default_opa_x3,t.default_opa_x4=this.default_opa_x4,t.default_opa_height=this.default_opa_height,t.default_fov=this.default_fov,t.default_width=this.default_width,t.default_height=this.default_height,t.default_pixelRate=this.default_pixelRate,t.default_middlePoint=new Point3d(this.default_middlePoint.x,this.default_middlePoint.y,this.default_middlePoint.z),t.opa_x1=this.opa_x1,t.opa_x2=this.opa_x2,t.opa_x3=this.opa_x3,t.opa_x4=this.opa_x4,t.opa_height=this.opa_height,t.fov=this.fov,t.width=this.width,t.height=this.height,t.pixelRate=this.pixelRate,t.middlePoint=new Point3d(this.middlePoint.x,this.middlePoint.y,this.middlePoint.z),t.pixelSpacingX=this.pixelSpacingX,t},e.prototype.copy=function(e){this.defaultEyeRay=new Point3d(e.defaultEyeRay.x,e.defaultEyeRay.y,e.defaultEyeRay.z),this.defaultYAxis=new Point3d(e.defaultYAxis.x,e.defaultYAxis.y,e.defaultYAxis.z),this.default_opa_x1=e.default_opa_x1,this.default_opa_x2=e.default_opa_x2,this.default_opa_x3=e.default_opa_x3,this.default_opa_x4=e.default_opa_x4,this.default_opa_height=e.default_opa_height,this.default_fov=e.default_fov,this.default_width=e.default_width,this.default_height=e.default_height,this.default_pixelRate=e.default_pixelRate,this.default_middlePoint=new Point3d(e.default_middlePoint.x,e.default_middlePoint.y,e.default_middlePoint.z),this.eyeRay=new Point3d(e.eyeRay.x,e.eyeRay.y,e.eyeRay.z),this.yAxis=new Point3d(e.yAxis.x,e.yAxis.y,e.yAxis.z),this.opa_x1=e.opa_x1,this.opa_x2=e.opa_x2,this.opa_x3=e.opa_x3,this.opa_x4=e.opa_x4,this.opa_height=e.opa_height,this.fov=e.fov,this.width=e.width,this.height=e.height,this.pixelRate=e.pixelRate,this.middlePoint=new Point3d(e.middlePoint.x,e.middlePoint.y,e.middlePoint.z),this.pixelSpacingX=e.pixelSpacingX},e.prototype.clear=function(){},e.prototype.getVRParam=function(){return{eyeRay:new Point3d(this.eyeRay.x,this.eyeRay.y,this.eyeRay.z),yAxis:new Point3d(this.yAxis.x,this.yAxis.y,this.yAxis.z),opa_x1:this.opa_x1,opa_x2:this.opa_x2,opa_x3:this.opa_x3,opa_x4:this.opa_x4,opa_height:this.opa_height,fov:this.fov,width:this.width,height:this.height,pixelRate:this.pixelRate,middlePoint:new Point3d(this.middlePoint.x,this.middlePoint.y,this.middlePoint.z),pixelSpacingX:this.pixelSpacingX}},e.prototype.setVRParam=function(e,t){t&&(this.defaultEyeRay=new Point3d(e.eyeRay.x,e.eyeRay.y,e.eyeRay.z),this.defaultYAxis=new Point3d(e.yAxis.x,e.yAxis.y,e.yAxis.z),this.default_opa_x1=e.opa_x1,this.default_opa_x2=e.opa_x2,this.default_opa_x3=e.opa_x3,this.default_opa_x4=e.opa_x4,this.default_opa_height=e.opa_height,this.default_fov=e.fov,this.default_width=e.width,this.default_height=e.height,this.default_pixelRate=e.pixelRate,this.default_middlePoint.x=e.middlePoint.x,this.default_middlePoint.y=e.middlePoint.y,this.default_middlePoint.z=e.middlePoint.z),this.eyeRay=new Point3d(e.eyeRay.x,e.eyeRay.y,e.eyeRay.z),this.yAxis=new Point3d(e.yAxis.x,e.yAxis.y,e.yAxis.z),this.opa_x1=e.opa_x1,this.opa_x2=e.opa_x2,this.opa_x3=e.opa_x3,this.opa_x4=e.opa_x4,this.opa_height=e.opa_height,this.fov=e.fov,this.width=e.width,this.height=e.height,this.pixelRate=e.pixelRate,this.middlePoint.x=e.middlePoint.x,this.middlePoint.y=e.middlePoint.y,this.middlePoint.z=e.middlePoint.z,this.pixelSpacingX=e.pixelSpacingX},e.prototype.reset=function(){this.eyeRay=new Point3d(this.defaultEyeRay.x,this.defaultEyeRay.y,this.defaultEyeRay.z),this.yAxis=new Point3d(this.defaultYAxis.x,this.defaultYAxis.y,this.defaultYAxis.z),this.opa_x1=this.default_opa_x1,this.opa_x2=this.default_opa_x2,this.opa_x3=this.default_opa_x3,this.opa_x4=this.default_opa_x4,this.opa_height=this.default_opa_height,this.fov=this.default_fov,this.width=this.default_width,this.height=this.default_height,this.pixelRate=this.default_pixelRate,this.middlePoint=new Point3d(this.default_middlePoint.x,this.default_middlePoint.y,this.default_middlePoint.z)},e}(),CXeImageState=(INVALID_COORDINATE_VALUE=65535,function(){function e(e,t){var i=this;this.needCalcWW=!1,this.needGetMPRJpg=!1,this.id=Utility.generateID(),this.pointStates=new CXeAnnoPointState,this.lineStates=new CXeAnnoLineState,this.rectStates=new CXeAnnoRectState,this.ellipseStates=new CXeAnnoEllipseState,this.angleState=new CXeAnnoAngleState,this.lineAngleState=new CXeAnnoLineAngleState,this.arrowState=new CXeAnnoArrowState,this.textState=new CXeAnnoTextState,this.signalNoiseRatio=new CSignalNoiseRatioState,this.vrState=new CXeVRState,this.dispInfo=new CXeImageDisplayState,this.isWaitingResponse=!1,this.lastRequest=(new Date).getTime(),this.expiredMiliSeconds=2e3,this.index=e,this.dispInfo=t||new CXeImageDisplayState,this.dispInfo.setWWWWLChanged(this.id,function(e){i.needCalcWW=!0}),this.dispInfo.setMPRPointChanged(this.id,function(){i.needGetMPRJpg=!0})}return e.prototype.setImageState=function(e){try{var t=CircularJSON.parse(e);this.copy(t),console.log("setImageState return: %o",t)}catch(e){console.error(e)}},e.prototype.getImageState=function(){try{var e=CircularJSON.stringify(this,function(e,t){if("_mapTable"!=e)return t});return console.log("getImageState: %s",e),e}catch(e){return console.error(e),null}},e.prototype.destroy=function(){this.dispInfo&&(this.dispInfo.removeWWWWLChanged(this.id),this.dispInfo.removeMPRPointChanged(this.id)),this.pointStates=null,this.lineStates=null,this.rectStates=null,this.ellipseStates=null,this.angleState=null,this.lineAngleState=null,this.arrowState=null,this.textState=null,this.dispInfo=null},e.prototype.copy=function(e){this.pointStates=e.pointStates,this.lineStates=e.lineStates,this.rectStates=e.rectStates,this.ellipseStates=e.ellipseStates,this.angleState=e.angleState,this.lineAngleState=e.lineAngleState,this.arrowState=e.arrowState,this.textState=e.textState,this.vrState=e.vrState},e.prototype.update=function(e){Utility.updateProp(e.dispInfo,this.dispInfo,this.dispInfo.update)},e.prototype.clone=function(t){var i=new e(this.index,null!=t?t:this.dispInfo);return i.pointStates=this.pointStates.clone(),i.lineStates=this.lineStates.clone(),i.rectStates=this.rectStates.clone(),i.ellipseStates=this.ellipseStates.clone(),i.angleState=this.angleState.clone(),i.lineAngleState=this.lineAngleState.clone(),i.arrowState=this.arrowState.clone(),i.textState=this.textState.clone(),i.vrState=this.vrState.clone(),i},e.prototype.recover=function(e,t,i){this.reset(e,t,i),this.resetAnno()},e.prototype.reset=function(e,t,i){this.dispInfo.windowWidth==e&&this.dispInfo.windowCenter==t||(this.needCalcWW=!0),this.dispInfo.reset(e,t,i)},e.prototype.resetAnno=function(e){void 0===e&&(e="all"),"annoPoint"!=e&&"all"!=e||this.pointStates.clear(),"annoLine"!=e&&"all"!=e||this.lineStates.clear(),"annoRect"!=e&&"all"!=e||this.rectStates.clear(),"annoEllipse"!=e&&"all"!=e||this.ellipseStates.clear(),"annoAngle"!=e&&"all"!=e||this.angleState.clear(),"lineAnnoAngle"!=e&&"all"!=e||this.lineAngleState.clear(),"annoArrow"!=e&&"all"!=e||this.arrowState.clear(),"annoText"!=e&&"all"!=e||this.textState.clear()},Object.defineProperty(e.prototype,"isShowAnno",{get:function(){return this.dispInfo.isShowAnno},set:function(e){this.dispInfo.isShowAnno=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isShowOverlay",{get:function(){return this.dispInfo.isShowOverlay},set:function(e){this.dispInfo.isShowOverlay=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoom",{get:function(){return this.dispInfo.zoom},set:function(e){this.dispInfo.zoom=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isHorzMirror",{get:function(){return this.dispInfo.isHorzMirror},set:function(e){this.dispInfo.isHorzMirror=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isVertMirror",{get:function(){return this.dispInfo.isVertMirror},set:function(e){this.dispInfo.isVertMirror=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotateAngle",{get:function(){return this.dispInfo.rotateAngle},set:function(e){this.dispInfo.rotateAngle=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowCenter",{get:function(){return this.dispInfo.windowCenter},set:function(e){this.dispInfo.windowCenter=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windowWidth",{get:function(){return this.dispInfo.windowWidth},set:function(e){this.dispInfo.windowWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateX",{get:function(){return this.dispInfo.offRateX},set:function(e){this.dispInfo.offRateX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offRateY",{get:function(){return this.dispInfo.offRateY},set:function(e){this.dispInfo.offRateY=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprX",{get:function(){return this.dispInfo.mprCenterX},set:function(e){this.dispInfo.mprCenterX=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprY",{get:function(){return this.dispInfo.mprCenterY},set:function(e){this.dispInfo.mprCenterY=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mprZ",{get:function(){return this.dispInfo.mprCenterZ},set:function(e){this.dispInfo.mprCenterZ=e},enumerable:!0,configurable:!0}),e.prototype.requestCan=function(){return!this.isWaitingResponse||(new Date).getTime()-this.lastRequest>=this.expiredMiliSeconds&&(console.debug("mpr requestCan timeout %d",this.lastRequest),this.isWaitingResponse=!1,!0)},e.prototype.responseReceive=function(){console.debug("mpr responseReceive %d",this.lastRequest),this.isWaitingResponse=!1},e.prototype.requestSended=function(){console.debug("mpr requestSended %d",this.lastRequest),this.isWaitingResponse=!0,this.lastRequest=(new Date).getTime()},e}()),CXeAnnoLineState=function(){function e(){this.lines=new Array}return e.prototype.clone=function(){var t=new e;return this.lines.forEach(function(e){t.lines.push(e.clone())}),t},e.prototype.clear=function(){this.lines.splice(0)},e}(),CXeAnnoPointState=function(){function e(){this.imagePoint=null,this.pagePoint=null}return e.prototype.clone=function(){var t=new e;return t.imagePoint=null==this.imagePoint?null:{x:this.imagePoint.x,y:this.imagePoint.y},t.pagePoint=null==this.pagePoint?null:{x:this.pagePoint.x,y:this.pagePoint.y},t},e.prototype.clear=function(){this.imagePoint=null,this.pagePoint=null},e}(),CXeAnnoRectState=function(){function e(){this.rects=new Array}return e.prototype.clone=function(){var t=new e;return this.rects.forEach(function(e){t.rects.push(e.clone())}),t},e.prototype.clear=function(){this.rects.splice(0)},e}(),CXeAnnoTextState=function(){function e(){this.texts=new Array}return e.prototype.clone=function(){var t=new e;return this.texts.forEach(function(e){t.texts.push(e.clone())}),t},e.prototype.clear=function(){this.texts.splice(0)},e}(),CXeAnnoEllipseState=function(){function e(){this.ellipses=new Array}return e.prototype.clone=function(){var t=new e;return this.ellipses.forEach(function(e){t.ellipses.push(e.clone())}),t},e.prototype.clear=function(){this.ellipses.splice(0)},e}(),CSignalNoiseRatioState=function(){function e(){this.ellipses=new Array}return e.prototype.clone=function(){var t=new e;return this.ellipses.forEach(function(e){t.ellipses.push(e.clone())}),t},e.prototype.clear=function(){this.ellipses.splice(0)},e}(),CXeAnnoAngleState=function(){function e(){this.angles=new Array}return e.prototype.clone=function(){var t=new e;return this.angles.forEach(function(e){t.angles.push(e.clone())}),t},e.prototype.clear=function(){this.angles.splice(0)},e}(),CXeAnnoLineAngleState=function(){function e(){this.lineAngles=new Array}return e.prototype.clone=function(){var t=new e;return this.lineAngles.forEach(function(e){t.lineAngles.push(e.clone())}),t},e.prototype.clear=function(){this.lineAngles.splice(0)},e}(),CXeAnnoArrowState=function(){function e(){this.arrows=new Array}return e.prototype.clone=function(){var t=new e;return this.arrows.forEach(function(e){t.arrows.push(e.clone())}),t},e.prototype.clear=function(){this.arrows.splice(0)},e}();__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();function DrawerFactoryMethod(e,t,i,n,a,s,r,o){var l=null;switch(e){case DISPLAY_MODE.DISP_2D:l=new C2DImageDrawer(t,i,n,a,s,r,o);break;case DISPLAY_MODE.DISP_MPR_T:case DISPLAY_MODE.DISP_MPR_S:case DISPLAY_MODE.DISP_MPR_C:case DISPLAY_MODE.DISP_MPR_O:l=new CMPRDrawer(t,i,n,a,s,r,e,o);break;case DISPLAY_MODE.DISP_VR:l=new CVRDrawer(t,i,n,a,s,r)}return l}var CImageDrawer=function(){function e(e,t,i,n,a,s,r){this._xeGuid="",this._serialIndex=-1,this._imagePos=-1,this._imageIndex="",this._paneID="",this._canvasID="",this._canvas=null,this._imageHelper=null,this._eventHandler=new CXeEventHandler,this._imageFilters=null,this._id="image"+Utility.generateID(),this._isLBPressed=!1,this._isRBPressed=!1,this._cb_SyncAllDrawInSerial=null,this.isListenedSync=!1,this.needCalcWW=!1,this.dispMode=DISPLAY_MODE.DISP_2D,this.linkageBaseDistance=0,this._drawQueue=new TaskQueue(function(e,t){var i=t;return e.forEach(function(e){e.args[2]<i.args[2]?e.args[0]():(i[0](),i=e)}),[i]}),this._mouseMoveQueue=new TaskQueue(function(e,t){return[t]}),this._canvasIndex=0,this._cb_sliderInit=null,this._cb_sliderPosChange=null,this._dispState=null,this._imageMaxIndex=-1,this.promiseRejectInRefreshAsync=null,this._tmpForceJPG=!1,this._imageMoving=!1,this._imageZooming=!1,this._runningMsgAnnoName="",this._connKey=e,this._xeGuid=t,this._serialIndex=i,this._paneID=n,this._canvasID=a,this._canvasIndex=s,this._canvas=document.getElementById(a),this.clearCanvas(),this._eventHandler.addHandler("update",this,this._id,this.onUpdate),this._eventHandler.addHandler("showZoomInImage",this,this._id,this.showZoomInImage),this._cb_SyncAllDrawInSerial=r,this._eventHandler.addHandler("pageTurn",this,this._id,this.pageTurnEvent)}return e.prototype.setDrawerState=function(e){null!=this._imageHelper&&null!=this._imageHelper.imageState&&this._imageHelper.imageState.setImageState(e)},e.prototype.getDrawerState=function(){return null!=this._imageHelper&&null!=this._imageHelper.imageState?this._imageHelper.imageState.getImageState():null},Object.defineProperty(e.prototype,"imagePos",{get:function(){return this._imagePos},set:function(e){if(this._imagePos=e,-1==e)this._imageIndex="";else{var t=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex);null!=t&&(this._imageIndex=t.getImageIndexByPos(e))}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connKey",{get:function(){return this._connKey},enumerable:!0,configurable:!0}),e.prototype.setCanvasSliderBar=function(e,t){this._cb_sliderInit=e,this._cb_sliderPosChange=t},e.prototype.setDisplayState=function(e){this._dispState=e},e.prototype.onUpdate=function(e,t){this.draw(),this.showZoomInImage(e,t)},Object.defineProperty(e.prototype,"imageMaxIndex",{get:function(){if(this._imageMaxIndex<0){var e=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex).imageTotal-1;this._imageMaxIndex=e,this._cb_sliderInit&&this._cb_sliderInit(1,e+1,this.imagePos+1)}return this._imageMaxIndex},enumerable:!0,configurable:!0}),e.prototype.pageTurnEvent=function(e){if(null!=this._cb_SyncAllDrawInSerial){var t=this.imagePos+e;if(t<0+this._canvasIndex?t=0+this._canvasIndex:t>this.imageMaxIndex&&(t=this.imageMaxIndex),t!=this.imagePos){var i=t-this.imagePos;null!=i&&this._cb_SyncAllDrawInSerial("pageTurn",i)}}},e.prototype.pageTurn=function(e,t){var i=this;return void 0===t&&(t=null),new Promise(function(t,n){if(e>=0&&e!=i.imagePos)if(0==i._canvasIndex&&e>i.imageMaxIndex&&(e=i.imageMaxIndex),e<=i.imageMaxIndex){var a=CDicomDataManager.GetInstance(i._connKey).getSeriesData(i._xeGuid,i._serialIndex).findImageByPos(e),s=null!=a&&a.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID;!s&&CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!0),i.refreshAsync(i._xeGuid,i._serialIndex,e,i._tmpForceJPG,null).then(function(){i._cb_sliderPosChange&&i._cb_sliderPosChange(e+1),!s&&CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!1),t()},function(t){i._cb_sliderPosChange&&i._cb_sliderPosChange(e+1),!s&&CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!1),n(t)}).catch(function(t){i._cb_sliderPosChange&&i._cb_sliderPosChange(e+1),!s&&CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!1),n(t)})}else i.clear(),t();else t()})},e.prototype.PageLinkageTurn=function(e){e._imageHelper},e.prototype.showZoomInImage=function(e,t){var i=new Point2d(0,0);if(null!=e){i.x=e.x-75,i.y=e.y-75;var n=this._canvas.getContext("2d",{alpha:!1}).getImageData(i.x,i.y,150,150);null!=CImageDrawerManager.GetInstance().cb_showZoomInHandle&&CImageDrawerManager.GetInstance().cb_showZoomInHandle(t,n,150,this._canvasID)}else null!=CImageDrawerManager.GetInstance().cb_closeZoomInHandle&&CImageDrawerManager.GetInstance().cb_closeZoomInHandle(this._canvasID)},e.prototype.showPositionLine=function(e){var t=new Array,i=!1;e.forEach(function(e){null!=e._imageHelper&&null!=e._imageHelper.imageData&&(t.push(e._imageHelper.imageData),i=!0)}),i?this._eventHandler.doHandler("showPositionLine","LOCALIZER",t):this.clearPositionLine()},e.prototype.clearPositionLine=function(){this._eventHandler.doHandler("clearPositionLine","LOCALIZER")},e.prototype.calcRelation=function(e){return null==e._imageHelper?-1:null==this._imageHelper?-1:this._imageHelper.calcRelation(e._imageHelper.imageData)},e.prototype.LayerLinkageSameStudy=function(e,t){try{var i=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex);if(i){var n=Date.now(),a=e._imageHelper.imageData.imageDistanceToZero,s=e._imageHelper.imageData.zeroImagePosition,r=i.zeroImagePosition,o=this._imageHelper.imageData.imageOrientation.split("\\"),l=[parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]),parseFloat(o[4]),parseFloat(o[5])],h=Utility.CalcSliceDistance(r,s,l),u=CDicomDataManager.GetInstance(this._connKey).getSeriesData(e._xeGuid,e._serialIndex);if(!u)return;var d=u.findImageByPos(u.imageTotal-1),c=d.imagePosition.split("\\"),p=[parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])],g=i.findImageByPos(i.imageTotal-1),_=g.imagePosition.split("\\"),m=[parseFloat(_[0]),parseFloat(_[1]),parseFloat(_[2])],f=void 0,y=void 0;g.imageDistanceToZero>0?(f=r,y=m):(y=r,f=m);var I=void 0,x=void 0;if(d.imageDistanceToZero>0?(I=s,x=p):(x=s,I=p),Utility.CalcSliceDistance(f,x,l)>0)return;if(Utility.CalcSliceDistance(y,I,l)<0)return;for(var w=!1,D=null,P=0,v=0;v<i.imageTotal;v++){var S=i.findImageByPos(v);if(null!=S){var C=Math.abs(S.imageDistanceToZero+h-a);if(null==D&&(D=C),D>=C&&(P=v,D=C),w)break;C<(u.sliceThickness<i.sliceThickness?u.sliceThickness:i.sliceThickness)&&(w=!0)}}P<0&&(P=0),P>this.imageMaxIndex-t+this._canvasIndex+1&&(P=this.imageMaxIndex-t+this._canvasIndex+1),this._cb_SyncAllDrawInSerial("pageTurnForLinkage",P);var M=Date.now();console.log("LayerLinkageSameStudy use time: %d",M-n)}}catch(t){console.warn("LayerLinkageSameStudy(base:%o, this:%o),catch:%o",e,this,t)}},e.prototype.LayerLinkageDiffStudy=function(e,t){var i=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex);if(i){var n=Math.abs(e._imageHelper.imageData.imageDistanceToZero),a=0,s=0;0===CImageDrawerManager.GetInstance().seriesLinkageModeDiffStudy&&(s=Math.abs(e.linkageBaseDistance)-Math.abs(this.linkageBaseDistance));for(var r=0;r<i.imageTotal;r++){var o=i.findImageByPos(r);if(null!=o){var l=Math.abs(o.imageDistanceToZero)+s-n;if(l>=0){Math.abs(a)>=Math.abs(l)?r=r:r-=1;break}a=l}}r<0&&(r=0),r>this.imageMaxIndex-t+this._canvasIndex+1&&(r=this.imageMaxIndex-t+this._canvasIndex+1),this._cb_SyncAllDrawInSerial("pageTurnForLinkage",r)}},e.prototype.recordLinkageBaseDistance=function(){null!=this._imageHelper&&null!=this._imageHelper.imageData&&(this.linkageBaseDistance=this._imageHelper.imageData.imageDistanceToZero)},e.prototype.clear=function(e){void 0===e&&(e=!0),""!=this._xeGuid&&-1!=this._serialIndex&&-1!=this.imagePos&&null!=this._imageHelper&&null!=this._imageHelper.imageData&&(CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex).setImageState(this._imageIndex,this._imageHelper.imageState),this._imageHelper.imageState.destroy()),e&&this.clearCanvas(),null!=CImageDrawerManager.GetInstance().cb_closeZoomInHandle&&CImageDrawerManager.GetInstance().cb_closeZoomInHandle(this._canvasID),CDicomDataManager.GetInstance(this._connKey).unregUsingImage(this._xeGuid,this._serialIndex,this._imageIndex,this._id),this._imageHelper=null,null!=this._imageFilters&&(this._imageFilters.clear(),this._imageFilters=null),this.imagePos=-1},e.prototype.refreshAsync=function(e,t,i,n,a){var s=this;return new Promise(function(r,o){null!=s.promiseRejectInRefreshAsync&&s.promiseRejectInRefreshAsync("refresh stop"),s.promiseRejectInRefreshAsync=o,-1!=s.imagePos&&s.clear(!1),s._xeGuid=e,s._serialIndex=t,s.imagePos=i;var l=CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).getImageState(s._imageIndex).clone(s._dispState);s._imageHelper=new CXeImageHelper(s._connKey,s._canvas,l,DISPLAY_MODE.DISP_2D);var h=CDicomDataManager.GetInstance(s._connKey).getSeriesData(e,t);if(h){var u=h.imageTotal-1;if(u!=s._imageMaxIndex&&(s._imageMaxIndex=u,s._cb_sliderInit&&s._cb_sliderInit(1,u+1,s.imagePos+1)),s.imagePos>s.imageMaxIndex)return s.imagePos=-1,void r()}CDicomDataManager.GetInstance(s._connKey).regUsingImage(s._xeGuid,s._serialIndex,s._imageIndex,s._id,function(i){null==CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWW&&(CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWW=i.defaultWW,CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWL=i.defaultWL),null!=s._imageHelper&&null!=s._imageFilters?i.xeGuid==s._xeGuid&&i.seriesIndex==s._serialIndex&&i.index==s._imageIndex?(null!=s._imageHelper.imageState.windowWidth&&!1!==s._dispState.wwwlChanged||s._imageHelper.setWW(i.defaultWW,i.defaultWL,!0),s._imageHelper.needCalcWW=!0,s.draw(a),r()):o("获取到图像时，drawer已经在处理下一个图像"):o("图像级别更新时，drawer中的imageHelper或imageFilters已经为空")});var d=new CWWWWL(l.windowWidth,l.windowCenter);CDicomDataManager.GetInstance(s._connKey).getImageDataAsync2(e,t,s._imageIndex,d,s._id,n).then(function(i){if(i.xeGuid==s._xeGuid&&i.seriesIndex==s._serialIndex&&i.index==s._imageIndex&&null!=s._imageHelper){var n=CDicomDataManager.GetInstance(s._connKey).getSeriesData(e,t).imageTotal-1;n!=s._imageMaxIndex&&(s._imageMaxIndex=n,s._cb_sliderInit&&s._cb_sliderInit(1,n+1,s.imagePos+1));var h=i;s._imageHelper.imageData=h,null==CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWW&&(CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWW=h.defaultWW,CXeImageStateManager.GetInstance(s._connKey).getStudyState(e).getSerialState(t).defaultWL=h.defaultWL),null!=s._imageHelper.imageState.windowWidth&&!1!==s._dispState.wwwlChanged||s._imageHelper.setWW(h.defaultWW,h.defaultWL,!0),null==d.ww&&(d.ww=l.windowWidth,d.wl=l.windowCenter),s._imageHelper.needCalcWW=!0,s._imageFilters&&s._imageFilters.clear(),s._imageFilters=new FilterManager,s._imageFilters.AddFilter("ww-wl",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("overlay",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoPoint",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoLine",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("AIMarker",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoRect",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoEllipse",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoAngle",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("lineAnnoAngle",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("annoArrow",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("imageMove",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("imageZoom",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("positionLine",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("orientationFilter",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("rulerFilter",s._imageHelper,s._eventHandler,s._id),s._imageFilters.AddFilter("magnifyMirror",s._imageHelper,s._eventHandler,s._id);var u=h.getImageLevel();(u==IMAGE_LEVEL.IMAGE_LEVEL_ORIGINAL&&null!=h.getData()||u==IMAGE_LEVEL.IMAGE_LEVEL_JPG&&null!=h.getJPG())&&(s.draw(a),r())}else o("获取到图像时，drawer中的imageHelper或imageFilters已经为空，或者drawer已经在处理下一个图像")},function(e){s.clearCanvas(),o(e)})})},e.prototype.setAttachmentData=function(e){if(null!=e){var t=null;if(null!=(t="string"==typeof e?JSON.parse(e):e)&&"undefined"!=t)if("aimark"==t.type)this._imageFilters.getFilter("AIMarker").setMarker(t)}},e.prototype.drawImageAsync=function(e,t,i,n,a){var s=this;this._tmpForceJPG=n;var r=Date.now();return new Promise(function(o,l){s._drawQueue.push("drawImage",s,function(r,o,l){var h=CDicomDataManager.GetInstance(s._connKey).getSeriesData(e,t).findImageByPos(i),u=null!=h&&h.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID;s._xeGuid!=e||s._serialIndex!=t||s.imagePos!=i||null==s._imageHelper||null==s._imageFilters?(!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!0),s.refreshAsync(e,t,i,n,a).then(function(){!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),r()},function(e){!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),o(e)}).catch(function(e){!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),o(e)})):(!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!0),CDicomDataManager.GetInstance(s._connKey).getImageDataAsync(e,t,s._imageIndex,s._imageHelper.imageState.windowWidth,s._imageHelper.imageState.windowCenter,s._id,n).then(function(e){s.draw(a),!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),r()},function(e){!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),o(e)}).catch(function(e){!u&&CImageDrawerManager.GetInstance().CanvasDrawState(s._canvasID,!1),o(e)}))},o,l,r)})},e.prototype.sameDraw=function(e){e&&(e.imagePos,this.imagePos),this.draw()},e.prototype.draw=function(e){void 0===e&&(e=null),null!=this._imageHelper&&null!=this._imageHelper.imageData&&null!=this._imageFilters&&(this.setAttachmentData(e),this.clearCanvas(),this._imageFilters.procImage(this._canvas))},e.prototype.destroy=function(){this.clear(),this._eventHandler.removeHandler("update",this),this._eventHandler.removeHandler("showZoomInImage",this)},e.prototype.isLocalizerImage=function(){return null!=this._imageHelper&&this._imageHelper.isLocalizerImage()},e.prototype.hitTest=function(e){if(null==this._canvas)return!1;var t=e.pageX,i=e.pageY,n=$("#"+this._canvasID).offset();return t>n.left&&t<n.left+this._canvas.width&&i>n.top&&i<n.top+this._canvas.height},e.prototype.recover=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex),t=!1;null!=this._imageHelper.imageData?(this._imageHelper.imageState.reset(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,e.defaultMPRCenterPoint),t=this._imageHelper.setWW(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,!0)):(this._imageHelper.imageState.reset(e.defaultWW,e.defaultWL,e.defaultMPRCenterPoint),t=this._imageHelper.setWW(e.defaultWW,e.defaultWL,!0)),this._imageHelper.imageData.getImageLevel()<=IMAGE_LEVEL.IMAGE_LEVEL_JPG&&t?CDicomDataManager.GetInstance(this._connKey).getImageDataAsync(this._xeGuid,this._serialIndex,this._imageHelper.imageData.index,Math.round(e.defaultWW),Math.round(e.defaultWL),this._id,!1):this.draw()},e.prototype.reset=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex),t=!1;null!=this._imageHelper.imageData?(this._imageHelper.imageState.reset(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,e.defaultMPRCenterPoint),t=this._imageHelper.setWW(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,!0)):(this._imageHelper.imageState.reset(e.defaultWW,e.defaultWL,e.defaultMPRCenterPoint),t=this._imageHelper.setWW(e.defaultWW,e.defaultWL,!0)),this._imageHelper.imageData.getImageLevel()<=IMAGE_LEVEL.IMAGE_LEVEL_JPG&&t?CDicomDataManager.GetInstance(this._connKey).getImageDataAsync(this._xeGuid,this._serialIndex,this._imageHelper.imageData.index,Math.round(e.defaultWW),Math.round(e.defaultWL),this._id,!1):this.draw()},e.prototype.rotate=function(e){this._imageHelper.imageState.rotateAngle=(this._imageHelper.imageState.rotateAngle+e+360)%360,this.draw()},e.prototype.mirrorH=function(){this._imageHelper.imageState.isHorzMirror=!this._imageHelper.imageState.isHorzMirror,this.draw()},e.prototype.mirrorV=function(){this._imageHelper.imageState.isVertMirror=!this._imageHelper.imageState.isVertMirror,this.draw()},e.prototype.setWWWL=function(e,t){var i=this._imageHelper.imageData.getImageLevel(),n=this._imageHelper.setWW(e,t,!1);i<=IMAGE_LEVEL.IMAGE_LEVEL_JPG&&n&&this._imageHelper.displayMode==DISPLAY_MODE.DISP_2D?CDicomDataManager.GetInstance(this._connKey).getImageDataAsync(this._xeGuid,this._serialIndex,this._imageHelper.imageData.index,Math.round(e),Math.round(t),this._id,!1):this.draw()},Object.defineProperty(e.prototype,"isSelected",{get:function(){return this===CImageDrawerManager.GetInstance().SelectedDraw},set:function(e){e&&!this.isSelected?CImageDrawerManager.GetInstance().SelectedDraw=this:!e&&this.isSelected&&(CImageDrawerManager.GetInstance().SelectedDraw=null)},enumerable:!0,configurable:!0}),e.prototype.myID=function(){return this._serialIndex+"_"+this.imagePos+"_"+this._paneID+"_"+this._canvasID},e.prototype.onUIMessage=function(e){if(null!=this._imageFilters&&!(e.srcEvent.isSyncSelf||e.srcEvent.originalEvent&&e.srcEvent.originalEvent.isSyncSelf||e.srcEvent.srcEvent&&e.srcEvent.srcEvent.isSyncSelf)){switch(e.name){case UIMsg.mouseClick:this.isSelected=!0,this.onClick(e);break;case UIMsg.mouseDoubleClick:this.isSelected=!0,this.onDbClick(e);break;case UIMsg.touchDown:case UIMsg.mouseLBDown:this.isSelected=!0,this.onMouseLBDown(e);break;case UIMsg.mouseRBDown:this.isSelected=!0,this.onMouseRBDown(e);break;case UIMsg.touchUp:case UIMsg.mouseLBUp:this.onMouseLBUp(e);break;case UIMsg.mouseRBUp:this.onMouseRBUp(e);break;case UIMsg.touchMove:case UIMsg.mouseMove:this.onMouseMove(e);break;case UIMsg.mouseWheel:this.onMouseWheel(e);break;case UIMsg.keyPress:this.onKeyDown(e);break;case UIMsg.touchZoom:this.onPinch(e);break;case UIMsg.touchZoomStart:this.isSelected=!0,this.onPinch(e);break;case UIMsg.touchZoomEnd:this.onPinch(e)}this._imageHelper&&this._imageHelper.needDrawSerial&&(null!=this._cb_SyncAllDrawInSerial&&this._cb_SyncAllDrawInSerial("SerialSync",null),this._imageHelper.needDrawSerial=!1)}},e.prototype.onClick=function(e){this.convertMsg(e),this._imageFilters.procMessage(e)},e.prototype.onDbClick=function(e){this.convertMsg(e),this._imageFilters.procMessage(e)},e.prototype.onMouseLBDown=function(e){this._isRBPressed||(this.convertMsg(e),this._isLBPressed=!0,this._imageFilters.procMessage(e))},e.prototype.onMouseLBUp=function(e){this._isRBPressed||(this.convertMsg(e),this._isLBPressed=!1,this._imageFilters.procMessage(e))},e.prototype.onMouseRBDown=function(e){this._isLBPressed||(this.convertMsg(e),this._isRBPressed=!0,this._isRBPressed&&(e.annoName="ww-wl"),this._imageFilters.procMessage(e))},e.prototype.onMouseRBUp=function(e){this._isLBPressed||(this.convertMsg(e),this._isRBPressed&&(e.annoName="ww-wl"),this._isRBPressed=!1,this._imageFilters.procMessage(e))},e.prototype.onMouseMove=function(e){var t=this;this._mouseMoveQueue.push("drawerMouseMove",this,function(e){(t._isLBPressed||t._isRBPressed)&&(t.convertMsg(e),t._isRBPressed&&(e.annoName="ww-wl"),t._imageFilters.procMessage(e))},e)},e.prototype.onKeyDown=function(e){this.convertMsg(e),this._imageFilters.procMessage(e)},e.prototype.onMouseWheel=function(e){this.convertMsg(e),"pageTurn"==e.annoName&&e.wheelDelta?e.wheelDelta>0?this.pageTurnEvent(-1):this.pageTurnEvent(1):this._imageFilters.procMessage(e)},e.prototype.onPinch=function(e){this.convertMsg(e),this._imageFilters.procMessage(e)},e.prototype.deleteSelected=function(e){this._eventHandler.doHandler("deleteSelected",e,null)},e.prototype.deleteAll=function(e){return!!this._dispState.isShowAnno&&(this._eventHandler.doHandler("deleteAll",e,null),!0)},e.prototype.changeOperateMode=function(e){this._eventHandler.doHandler("changeOperateMode","all",e)},e.prototype.convertMsg=function(e){if(!0!==e.isConverted){e.annoName=CImageDrawerManager.GetInstance().getCurrentToolName();var t=$("#"+this._canvasID).offset();"pan"==e.srcEvent.type||"panstart"==e.srcEvent.type||"panend"==e.srcEvent.type||"panmove"==e.srcEvent.type||"touchstart"==e.srcEvent.type||"touchend"==e.srcEvent.type||"touchcancel"==e.srcEvent.type?(e.x=e.pageX-t.left-this._canvas.clientLeft,e.y=e.pageY-t.top-this._canvas.clientTop):"pinchstart"==e.srcEvent.type||"pinchend"==e.srcEvent.type||"pinchmove"==e.srcEvent.type||(e.x=e.pageX-t.left-this._canvas.clientLeft,e.y=e.pageY-t.top-this._canvas.clientTop),e.name==UIMsg.mouseWheel&&e.ctrlKey&&1==e.ctrlKey?e.annoName=CImageDrawerManager.GetInstance().WheelCtrlAnnoName:e.name!=UIMsg.mouseWheel||e.ctrlKey||(e.annoName=CImageDrawerManager.GetInstance().WheelAnnoName),e.name!=UIMsg.touchZoomStart&&e.name!=UIMsg.touchZoom&&e.name!=UIMsg.touchZoomEnd||(e.annoName="imageZoom"),e.name==UIMsg.mouseLBDown&&e.ctrlKey&&1==e.ctrlKey?(e.annoName=CImageDrawerManager.GetInstance().leftCtrlAnnoName,this._runningMsgAnnoName=e.annoName):e.name==UIMsg.mouseMove?"imageZoom"===this._runningMsgAnnoName?e.annoName="imageZoom":"imageMove"===this._runningMsgAnnoName?e.annoName="imageMove":"ww-wl"===this._runningMsgAnnoName&&(e.annoName="ww-wl"):e.name==UIMsg.mouseLBUp&&("imageZoom"===this._runningMsgAnnoName?e.annoName="imageZoom":"imageMove"===this._runningMsgAnnoName?e.annoName="imageMove":"ww-wl"===this._runningMsgAnnoName&&(e.annoName="ww-wl"),this._runningMsgAnnoName=""),e.isConverted=!0}},e.prototype.clearCanvas=function(){var e=this._canvas.getContext("2d",{alpha:!1});e.save(),e.clearRect(0,0,this._canvas.width,this._canvas.height),e.fillStyle="black",e.fillRect(0,0,this._canvas.width,this._canvas.height),e.restore()},e.prototype.hasOverlay=function(){var e=!1;return null!=this._imageHelper&&null!=this._imageHelper.imageData&&(e=16==this._imageHelper.imageData.bitsAllocated),e},e.prototype.getSNRBackValue=function(){return null==this._imageFilters.getFilter("signalNoiseRatio")?null:this._imageFilters.getFilter("signalNoiseRatio").getSNRBackValue()},e.prototype.getSNRROIValue=function(){return null==this._imageFilters.getFilter("signalNoiseRatio")?null:this._imageFilters.getFilter("signalNoiseRatio").getSNRROIValue()},e.prototype.updateImageData=function(e){this._imageHelper.imageData=e,this._imageHelper.needCalcWW=!0},e}(),C2DImageDrawer=function(e){function t(t,i,n,a,s,r,o){var l=e.call(this,t,i,n,a,s,r,o)||this;return l._pageTurnTool=null,l._pageTurnTool=new CPageTurn(l._imageHelper,l._eventHandler,l._id),l.dispMode=DISPLAY_MODE.DISP_2D,l}return __extends(t,e),t.prototype.onUIMessage=function(t){t.name!=UIMsg.mouseWheel||t.ctrlKey||"pageTurn"!==CImageDrawerManager.GetInstance().WheelAnnoName?(this.convertMsg(t),this._pageTurnTool.procMessage(t)||e.prototype.onUIMessage.call(this,t)):t.wheelDelta>0?this.pageTurnEvent(-1):this.pageTurnEvent(1)},t}(CImageDrawer),MPRDrawersContent=new Set,CMPRDrawer=function(e){function t(t,i,n,a,s,r,o,l){var h=e.call(this,t,i,n,a,s,r,l)||this;return h._MPRPlanum="",h._mprData=null,h._drawMPRQueue=new TaskQueue(function(e,t){for(var i=t,n=0,a=e;n<a.length;n++){var s=a[n];s.args[1]>i.args[1]&&(i=s)}return[i]}),h.dispMode=o,h}return __extends(t,e),Object.defineProperty(t.prototype,"MPRPlanum",{get:function(){return this._MPRPlanum},set:function(e){MPRDrawersContent.delete(this._MPRPlanum),MPRDrawersContent.add(e),this._MPRPlanum=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"imagePos",{get:function(){return this._imagePos},set:function(e){this._imagePos=e},enumerable:!0,configurable:!0}),t.prototype.onUpdate=function(e,t){this.updateMPR(),this.showZoomInImage(e,t)},t.prototype.pageTurnEvent=function(e){var t=e,i=new Point3d(0,0,0);i=this._imageHelper.imageData.dynaEyeRay;var n=new Point3d(this._mprData.keyPoint.x+t*i.x,this._mprData.keyPoint.y+t*i.y,this._mprData.keyPoint.z+t*i.z);this._mprData.keyPoint=n,this.updateMPR(),this._cb_SyncAllDrawInSerial("MPRChange",null)},t.prototype.clear=function(){""!=this._xeGuid&&-1!=this._serialIndex&&""!=this.MPRPlanum&&null!=this._imageHelper&&null!=this._imageHelper.imageData&&(CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex).setImageState(this.MPRPlanum,this._imageHelper.imageState),this._imageHelper.imageState.destroy(),MPRDrawersContent.delete(this.MPRPlanum)),this.clearCanvas(),null!=CImageDrawerManager.GetInstance().cb_closeZoomInHandle&&CImageDrawerManager.GetInstance().cb_closeZoomInHandle(this._canvasID),this.imagePos=-1,this._imageHelper=null,null!=this._imageFilters&&(this._imageFilters.clear(),this._imageFilters=null),this.MPRPlanum=""},t.prototype.recover=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex);this._imageHelper.setWW(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,!0),this._imageHelper.imageState.reset(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,e.defaultMPRCenterPoint),this._mprData.reset(),this.updateMPR()},t.prototype.reset=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex);this._imageHelper.setWW(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,!0),this._imageHelper.imageState.reset(this._imageHelper.imageData.defaultWW,this._imageHelper.imageData.defaultWL,e.defaultMPRCenterPoint),this._mprData.reset(),this.updateMPR()},t.prototype.getMPRData=function(e,t,i){CDicomDataManager.GetInstance(this._connKey).setMPRJpgDealer(this.MPRPlanum,function(e,n,a,s){e?t(n,s):i(a)}),CDicomDataManager.GetInstance(this._connKey).getMPRInfo(this._xeGuid,this._serialIndex).updateSomeDataWithUI(this.MPRPlanum,this._imageHelper.cellWidth,this._imageHelper.cellHeight,this._imageHelper.imageState.zoom),CDicomDataManager.GetInstance(this._connKey).getMPRImageDataAsync(this._xeGuid,this._serialIndex,this.MPRPlanum,this._canvas.width,this._canvas.height,e,this._imageHelper.imageState.dispInfo.mprThick,this._imageHelper.imageState.dispInfo.mprMIPType)},t.prototype.refreshMPRAsync=function(e,t,i){var n=this;return new Promise(function(a,s){""!=n.MPRPlanum&&n.clear(),n._xeGuid=e,n._serialIndex=t,n.MPRPlanum=i,CDicomDataManager.GetInstance(n._connKey).getMPRInfoAsync(e,t).then(function(r){if(r.xeGUID==n._xeGuid&&r.serialIndex==n._serialIndex){n._mprData=r,CXeImageStateManager.GetInstance(n._connKey).getStudyState(e).getSerialMPRState(t).defaultMPRCenterPoint=r.MPRDefaultCenterPoint;var o=CXeImageStateManager.GetInstance(n._connKey).getStudyState(e).getSerialMPRState(t).getImageState(i).clone(n._dispState);n._imageHelper=new CXeImageHelper(n._connKey,n._canvas,o,n.dispMode),n._imageHelper.imageData=r.getImageData(n.MPRPlanum),n._imageHelper.mprPlanum=n.MPRPlanum,null==o.windowWidth&&n._imageHelper.setWW(n._imageHelper.imageData.defaultWW,n._imageHelper.imageData.defaultWL,!1),r.updateSomeDataWithUI(n.MPRPlanum,n._imageHelper.cellWidth,n._imageHelper.cellHeight,n._imageHelper.imageState.zoom);var l=new CWWWWL(o.windowWidth,o.windowCenter);n.getMPRData(l,function(e,t){if(e.xeGuid==n._xeGuid&&e.seriesIndex==n._serialIndex&&e.index.substr(0,1)==n.MPRPlanum&&null!=n._imageHelper){var i=e;n._imageHelper.imageData=i,n._imageFilters&&n._imageFilters.clear(),n._imageFilters=new FilterManager,n._imageFilters.AddFilter("ww-wl",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("overlay",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("mpr",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoPoint",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoLine",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoRect",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoEllipse",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoAngle",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("lineAnnoAngle",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("annoArrow",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("imageMove",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("imageZoom",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("orientationFilter",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("rulerFilter",n._imageHelper,n._eventHandler,n._id),n._imageFilters.AddFilter("magnifyMirror",n._imageHelper,n._eventHandler,n._id),i.getImageLevel()!=IMAGE_LEVEL.IMAGE_LEVEL_INVALID&&(n.draw(null),a())}},function(e){"clear dealer"==e?a():s(e)})}else s("返回的MPRInfo已经过期，不是当前选中的检查序列")},function(e){s(e)})})},t.prototype.drawMPRAsync=function(e,t,i){var n=this;return new Promise(function(a,s){if(n._xeGuid!=e||n._serialIndex!=t||n.MPRPlanum!=i||null==n._imageHelper||null==n._imageFilters)CImageDrawerManager.GetInstance().CanvasDrawState(n._canvasID,!0),n.refreshMPRAsync(e,t,i).then(function(){CImageDrawerManager.GetInstance().CanvasDrawState(n._canvasID,!1),a()},function(e){CImageDrawerManager.GetInstance().CanvasDrawState(n._canvasID,!1),s(e)}).catch(function(e){CImageDrawerManager.GetInstance().CanvasDrawState(n._canvasID,!1),s(e)});else{var r=new CWWWWL(n._imageHelper.imageState.windowWidth,n._imageHelper.imageState.windowCenter);n.getMPRData(r,function(e,t){n._imageHelper.imageData=e,n.draw(),a()},function(e){"clear dealer"==e?a():s(e)})}})},t.prototype.setMPRParam=function(e){var t=this._dispState;null!=this._imageHelper&&(t=this._imageHelper.imageState.dispInfo),void 0!==e.thick&&(t.mprThick=e.thick),void 0!==e.mprMIPType&&(t.mprMIPType=e.mprMIPType),null!=this._imageHelper?(this._imageHelper.needCalcWW=!0,this.draw()):this.needCalcWW=!0},t.prototype.updateMPR=function(){var e=this;if(null!=this._imageHelper&&null!=this._imageHelper.imageData){var t=new CWWWWL(this._imageHelper.imageState.windowWidth,this._imageHelper.imageState.windowCenter);this._imageHelper.needCalcWW=!1,this.getMPRData(t,function(t,i){e._drawMPRQueue.push("drawImage",e,function(t,i){e._imageHelper.imageData=t,e.draw()},t,i)},function(e){"clear dealer"==e||console.error("updateMPR:"+e)})}},t.prototype.setWWWL=function(e,t){this._imageHelper.setWW(e,t,!1)&&(this.updateMPR(),null!=this._cb_SyncAllDrawInSerial&&this._cb_SyncAllDrawInSerial("MPRChange",null))},t}(CImageDrawer),CVRDrawer=function(e){function t(t,i,n,a,s,r){var o=e.call(this,t,i,n,a,s,r,null)||this;o._imageData=null,o._imageState=null,o._firstLoadFinished=!1,o._firstLoadResolve=null,o._LoadReject=null,o.isDrawing=!1,o.dispMode=DISPLAY_MODE.DISP_VR,o._imageData=new CImageData(o._xeGuid,o._serialIndex,null);var l=CXeImageStateManager.GetInstance(o._connKey).getStudyState(o._xeGuid).getSerialVRState(o._serialIndex).getImageState("vr",!1);return l&&(o._imageState=l.clone(null)),CDicomDataManager.GetInstance(o._connKey).setVRInfoDealer(function(e){o.onGetVRInfo(e)}),CDicomDataManager.GetInstance(o._connKey).setVRJpgDealer(function(e,t){o.onGetVRJpg(e,t)}),o}return __extends(t,e),t.prototype.destroy=function(){""!=this._xeGuid&&-1!=this._serialIndex&&null!=this._imageState&&CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex).setImageState("vr",this._imageState),e.prototype.destroy.call(this),this._firstLoadFinished=!1,this._imageState&&(this._imageState.destroy(),this._imageState=null),this._imageData&&(this._imageData.clearCache(CDicomDataManager.GetInstance(this._connKey).isFullMode),this._imageData=null)},t.prototype.clear=function(){e.prototype.clear.call(this),""!=this._xeGuid&&-1!=this._serialIndex&&null!=this._imageState&&(CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex).setImageState("vr",this._imageState),this._imageState.destroy(),this._imageState=null),this._firstLoadFinished=!1},t.prototype.drawVRAsync=function(e,t){var i=this;return new Promise(function(n,a){i.isDrawing&&(CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!1),i.isDrawing=!1),CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!0),i.isDrawing=!0,i._xeGuid==e&&i._serialIndex==t||(i.clear(),i._xeGuid=e,i._serialIndex=t),i._firstLoadResolve=n,i._LoadReject=a,i._firstLoadFinished?i.updateVRJpg():CDicomDataManager.GetInstance(i._connKey).getVRInfo(i._xeGuid,i._serialIndex)})},t.prototype.onGetVRInfo=function(e){var t=this;if(0!=e.head.errCode)return CImageDrawerManager.GetInstance().CanvasDrawState(this._canvasID,!1),this.isDrawing=!1,void this._LoadReject(e.head.errText);var i=e.body.pixelSpacing.split("\\"),n={eyeRay:new Point3d(e.body.eyeRayX,e.body.eyeRayY,e.body.eyeRayZ),yAxis:new Point3d(e.body.yAxisX,e.body.yAxisY,e.body.yAxisZ),opa_x1:e.body.opa_x1,opa_x2:e.body.opa_x2,opa_x3:e.body.opa_x3,opa_x4:e.body.opa_x4,opa_height:e.body.opa_height,fov:e.body.fov,width:e.body.width,height:e.body.height,pixelRate:e.body.pixelRate,middlePoint:new Point3d(e.body.middlePointX,e.body.middlePointY,e.body.middlePointZ),pixelSpacingX:parseFloat(i[0])},a=!1;if(null==this._imageState){var s=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex).getImageState("vr",!1);s?(this._firstLoadFinished=!0,this._imageState=s.clone(null)):(this._firstLoadFinished=!1,a=!0,this._imageState=new CXeImageState("vr",new CXeImageDisplayState))}this._imageState.vrState.setVRParam(n,a),this.createByImageDataForVR(this._imageData,this._imageState,function(){t.updateVRJpg()}),this.updateVRJpg()},t.prototype.onGetVRJpg=function(e,t){var i=this;if(0!=e.head.errCode)console.error("onGetVRJpg(rspJson:%o)",e);else{var n=t.subarray(4),a=new Blob([n],{type:"application/octet-binary"}),s=new Image,r=this;s.src=window.URL.createObjectURL(a),s.onload=function(){r._firstLoadFinished=!0,r._firstLoadResolve&&(CImageDrawerManager.GetInstance().CanvasDrawState(i._canvasID,!1),i.isDrawing=!1,r._firstLoadResolve(),r._firstLoadResolve=null),r._imageData.setJPG(s),r._imageData.setImageLevel(IMAGE_LEVEL.IMAGE_LEVEL_JPG),r.draw()}}},t.prototype.onUpdate=function(e,t){this.updateVRJpg()},t.prototype.updateVRJpg=function(){this._firstLoadFinished||this._imageState.vrState.reset(),this._imageHelper.updateVRStateParam(),CDicomDataManager.GetInstance(this._connKey).getVRJpg(this._xeGuid,this._serialIndex,this._imageState.vrState.getVRParam())},t.prototype.recover=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex);this._imageState.recover(e.defaultWW,e.defaultWL,e.defaultMPRCenterPoint),this._imageState.vrState.reset(),this.updateVRJpg()},t.prototype.reset=function(){var e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex);this._imageState.reset(e.defaultWW,e.defaultWL,e.defaultMPRCenterPoint),this._imageState.vrState.reset(),this.updateVRJpg()},t.prototype.createByImageDataForVR=function(e,t,i){this._imageHelper=new CXeImageHelper(this._connKey,this._canvas,t,DISPLAY_MODE.DISP_VR),this._imageHelper.imageData=e,this._imageHelper.needCalcWW=!0,this._eventHandler.addHandler("updateVRJpg",this,this._id,function(e){i()}),this._imageFilters&&this._imageFilters.clear(),this._imageFilters=new FilterManager,this._imageFilters.AddFilter("ww-wl",this._imageHelper,this._eventHandler,this._id),this._imageFilters.AddFilter("overlay",this._imageHelper,this._eventHandler,this._id),this._imageFilters.AddFilter("vr",this._imageHelper,this._eventHandler,this._id),this._imageFilters.AddFilter("imageMove",this._imageHelper,this._eventHandler,this._id),this._imageFilters.AddFilter("imageZoom",this._imageHelper,this._eventHandler,this._id)},t}(CImageDrawer),CImageDrawerGroup=function(){function e(e,t,i,n,a){var s;switch(void 0===a&&(a=DISPLAY_MODE.DISP_2D),this._drawers=null,this._isFocused=!1,this.connKey="",this.paneID="",this.serialIndex=-1,this.xeGuid="",this.startIndex=0,this.endIndex=0,this.dispState=null,this.LinkageEvent=null,this.connKey=e,this.paneID=t,this.xeGuid=i,this.serialIndex=n,this.groupMode=a,this._drawers=new Array,this.groupMode){case DISPLAY_MODE.DISP_2D:s=CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialState(this.serialIndex).getImageDisplayState(),this.dispState=s.clone();break;case DISPLAY_MODE.DISP_MPR:s=CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialMPRState(this.serialIndex).getImageDisplayState(),this.dispState=s;break;case DISPLAY_MODE.DISP_VR:s=CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialVRState(this.serialIndex).getImageDisplayState(),this.dispState=s;break;default:s=CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialState(this.serialIndex).getImageDisplayState(),this.dispState=s.clone()}}return Object.defineProperty(e.prototype,"isFocused",{get:function(){return this._isFocused},set:function(e){this._isFocused!=e&&(this._isFocused=e,null!=this.LinkageEvent&&this.LinkageEvent(this,ShowPositionLine,null))},enumerable:!0,configurable:!0}),e.prototype.createDrawer=function(e,t,i,n,a,s,r,o){var l=DrawerFactoryMethod(e,t,i,n,a,s,r,o);return null==this._drawers&&(this._drawers=new Array),l.setDisplayState(this.dispState),this._drawers.push(l),l},e.prototype.delelteDrawer=function(e){var t=this._drawers.indexOf(e,0);t>=0&&this._drawers.splice(t,1)},e.prototype.refresh=function(e,t){var i=this,n=this.xeGuid,a=this.serialIndex;switch(this.xeGuid=e,this.serialIndex=t,this.groupMode){case DISPLAY_MODE.DISP_2D:CXeImageStateManager.GetInstance(this.connKey).getStudyState(n).getSerialState(a).setImageDisplayState(this.dispState),this.dispState=CXeImageStateManager.GetInstance(this.connKey).getStudyState(e).getSerialState(t).getImageDisplayState().clone();break;case DISPLAY_MODE.DISP_MPR:CXeImageStateManager.GetInstance(this.connKey).getStudyState(n).getSerialMPRState(a).setImageDisplayState(this.dispState),this.dispState=CXeImageStateManager.GetInstance(this.connKey).getStudyState(e).getSerialMPRState(t).getImageDisplayState();break;case DISPLAY_MODE.DISP_VR:CXeImageStateManager.GetInstance(this.connKey).getStudyState(n).getSerialVRState(a).setImageDisplayState(this.dispState),this.dispState=CXeImageStateManager.GetInstance(this.connKey).getStudyState(e).getSerialVRState(t).getImageDisplayState();break;default:CXeImageStateManager.GetInstance(this.connKey).getStudyState(n).getSerialState(a).setImageDisplayState(this.dispState),this.dispState=CXeImageStateManager.GetInstance(this.connKey).getStudyState(e).getSerialState(t).getImageDisplayState().clone()}this._drawers.forEach(function(e){e.setDisplayState(i.dispState)})},e.prototype.onLinkageEvent=function(e,t){null!=this.LinkageEvent&&this.LinkageEvent(this,e,t)},e.prototype.isLocalizerGroup=function(){return null!=this._drawers&&this._drawers.length>0&&this._drawers[0].isLocalizerImage()},Object.defineProperty(e.prototype,"drawers",{get:function(){return this._drawers},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){switch(this._drawers=null,this.LinkageEvent=null,this.groupMode){case DISPLAY_MODE.DISP_2D:CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialState(this.serialIndex).setImageDisplayState(this.dispState);break;case DISPLAY_MODE.DISP_MPR:CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialMPRState(this.serialIndex).setImageDisplayState(this.dispState);break;case DISPLAY_MODE.DISP_VR:CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialVRState(this.serialIndex).setImageDisplayState(this.dispState);break;default:CXeImageStateManager.GetInstance(this.connKey).getStudyState(this.xeGuid).getSerialState(this.serialIndex).setImageDisplayState(this.dispState)}},e}(),PageTurnSync="PageTurnSync",ShowPositionLine="ShowPositionLine",SameSerialSync="SameSerialSync",CGroupLinkageManager=function(){function e(e){this._drawerGroups=new Array,this._drawerGroups=e}return e.prototype.createDrawerGroup=function(e){var t=this;e.LinkageEvent=function(e,i,n){t.onLinkageGroup(e,i,n)}},e.prototype.hideAllPosLine=function(){for(var e=0;e<this._drawerGroups.length;e++){this._drawerGroups[e].drawers.forEach(function(e){e.clearPositionLine()})}},e.prototype.showAllPosLine=function(){for(var e=0;e<this._drawerGroups.length;e++){var t=this._drawerGroups[e];t.groupMode==DISPLAY_MODE.DISP_MPR?t.drawers.forEach(function(e){e.draw()}):t.isFocused&&this.onLinkageGroup(t,ShowPositionLine,null)}},e.prototype.onLinkageGroup=function(e,t,i){for(var n=new Array,a=new Array,s=new Array,r=0;r<this._drawerGroups.length;r++){var o=this._drawerGroups[r];o!==e&&(o.groupMode==e.groupMode&&(o.xeGuid==e.xeGuid?o.serialIndex==e.serialIndex?a.push(o):n.push(o):s.push(o)))}var l=new Array,h=new Array,u=new Array,d=new Array;switch(t){case PageTurnSync:this.DiffGroupSplit(e,n,l,h),this.DiffGroupSplit(e,s,u,d),this.GroupPageLinkage(e,a,h,d),this.GroupPositionLine(e,a,l);break;case ShowPositionLine:this.DiffGroupSplit(e,n,l,h),this.GroupPositionLine(e,a,l);break;case SameSerialSync:this.GroupSameSync(a,i)}},e.prototype.GroupPositionLine=function(e,t,i){e.isFocused&&CImageDrawerManager.GetInstance().showPositionLine&&(t.forEach(function(e){e.drawers.forEach(function(e){e.clearPositionLine()})}),i.forEach(function(t){t.drawers.forEach(function(t){t.showPositionLine(e.drawers)})}),e.drawers.forEach(function(e){e.clearPositionLine()}))},e.prototype.GroupPageLinkage=function(e,t,i,n){if(CImageDrawerManager.GetInstance().isSeriesLinkageSameStudy){var a=e.drawers.length>0?e.drawers[0]:null;if(null==a)return;t.forEach(function(e){e.drawers.length>0&&e.drawers[0].LayerLinkageSameStudy(a,e.drawers.length)}),i.forEach(function(e){e.drawers.length>0&&e.drawers[0].LayerLinkageSameStudy(a,e.drawers.length)})}if(CImageDrawerManager.GetInstance().isSeriesLinkageDiffStudy){var s=e.drawers.length>0?e.drawers[0]:null;if(null==s)return;n.forEach(function(e){e.drawers.length>0&&e.drawers[0].LayerLinkageDiffStudy(s,e.drawers.length)})}},e.prototype.DiffGroupSplit=function(e,t,i,n){e.drawers.length<=0||t.forEach(function(t){var a=e.drawers[0].calcRelation(t.drawers[0]);0==a||5==a?n.push(t):1!=a&&2!=a||i.push(t)})},e.prototype.GroupSameSync=function(e,t){e.forEach(function(e){e.drawers.forEach(function(e){e.sameDraw(t)})})},e}(),CImageDrawerManager=function(){function e(){this._currAnnoName="pageTurn",this._leftCtrlAnnoName="imageMove",this._WheelAnnoName="pageTurn",this._WheelCtrlAnnoName="imageZoom",this._drawerGroups=new Array,this._drawers=new Array,this._groupLinkageManager=new CGroupLinkageManager(this._drawerGroups),this.cb_showZoomInHandle=null,this.cb_closeZoomInHandle=null,this.sliderShowControlHandle=null,this.sliderHideControlHandle=null,this.cb_WWWLChange=null,this.cb_CanvasDrawState=null,this._showPositionLine=!0,this._isSeriesLinkageSameStudy=!1,this._isSeriesLinkageDiffStudy=!1,this._seriesLinkageModeDiffStudy=-1,this._SelectedDraw=null}return e.GetInstance=function(){return null==e._instance&&(e._instance=new e),e._instance},Object.defineProperty(e.prototype,"showPositionLine",{get:function(){return this._showPositionLine},set:function(e){this._showPositionLine=e,e?this._groupLinkageManager.showAllPosLine():this._groupLinkageManager.hideAllPosLine()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSeriesLinkageSameStudy",{get:function(){return this._isSeriesLinkageSameStudy},set:function(e){this._isSeriesLinkageSameStudy=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSeriesLinkageDiffStudy",{get:function(){return this._isSeriesLinkageDiffStudy},set:function(e){this._isSeriesLinkageDiffStudy=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"seriesLinkageModeDiffStudy",{get:function(){return this._seriesLinkageModeDiffStudy},set:function(e){this._seriesLinkageModeDiffStudy=e,0==this._seriesLinkageModeDiffStudy&&this._drawers.forEach(function(e){e.dispMode===DISPLAY_MODE.DISP_2D&&e.recordLinkageBaseDistance()})},enumerable:!0,configurable:!0}),e.prototype.WWWLChange=function(e,t,i){this.cb_WWWLChange&&this.cb_WWWLChange(e,t,i)},e.prototype.CanvasDrawState=function(e,t){this.cb_CanvasDrawState&&this.cb_CanvasDrawState(e,t)},e.prototype.createDrawerGroup=function(e,t,i,n,a){void 0===a&&(a=DISPLAY_MODE.DISP_2D);var s=new CImageDrawerGroup(e,t,i,n,a);return this._drawerGroups.push(s),this._groupLinkageManager.createDrawerGroup(s),s},e.prototype.destroyDrawerGroup=function(e){var t=this._drawerGroups.indexOf(e);t>=0&&this._drawerGroups.splice(t,1),e.destroy(),e=null},e.prototype.createDrawer=function(e,t,i,n,a,s,r,o){var l=this,h=null;return this._drawerGroups.forEach(function(u){u.paneID==a&&(h=u.createDrawer(e,t,i,n,a,s,r,o),l._drawers.push(h),e==DISPLAY_MODE.DISP_2D&&l._groupLinkageManager.showAllPosLine())}),h},e.prototype.destroyDrawer=function(e){this._drawerGroups.forEach(function(t){t.delelteDrawer(e)});var t=this._drawers.indexOf(e,0);this._drawers.splice(t,1),e.destroy(),e=null},e.prototype.setZoomInCallback=function(e,t){this.cb_showZoomInHandle=e,this.cb_closeZoomInHandle=t},e.prototype.setSliderControlCallback=function(e,t){this.sliderShowControlHandle=e,this.sliderHideControlHandle=t},e.prototype.getCurrentToolName=function(){return this._currAnnoName},e.prototype.setCurrentToolName=function(e){this._currAnnoName=e;for(var t=0;t<this._drawers.length;t++)this._drawers[t].changeOperateMode(e)},Object.defineProperty(e.prototype,"leftCtrlAnnoName",{get:function(){return this._leftCtrlAnnoName},set:function(e){this._leftCtrlAnnoName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"WheelAnnoName",{get:function(){return this._WheelAnnoName},set:function(e){this._WheelAnnoName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"WheelCtrlAnnoName",{get:function(){return this._WheelCtrlAnnoName},set:function(e){this._WheelCtrlAnnoName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"SelectedDraw",{get:function(){return this._SelectedDraw},set:function(e){this._SelectedDraw=e},enumerable:!0,configurable:!0}),e.prototype.getImageDraw=function(e){return this._drawers.length<=e?null:this._drawers[e]},e.prototype.deleteSelected=function(e){for(var t=0;t<this._drawerGroups.length;t++){var i=this._drawerGroups[t];i.isFocused&&i.drawers.forEach(function(t){t.deleteSelected(e)})}},e.prototype.OnUIMessageToFocus=function(e,t,i){for(var n=0;n<this._drawerGroups.length;n++){var a=this._drawerGroups[n];a.isFocused&&a.groupMode==t&&(i?a.drawers.forEach(function(t){t.onUIMessage(e)}):a.drawers[0].onUIMessage(e))}},e._instance=null,e}(),CImageEventCapture=function(){function e(e,t,i){this.elememtID="",this.hammer=null,this.drawer=null,this.UIMessageHandle=null,this.touchStartTimeID=0,this.touchStartMsg=null,this._singleTouching=!1,this.elememtID=e,this.drawer=t,this._dispMode=i;var n={inputClass:Hammer.TouchInput};this.hammer=new Hammer(document.getElementById(this.elememtID),n),this.hammer.add(new Hammer.Pinch),this.hammer.get("pan").set({direction:Hammer.DIRECTION_ALL})}return e.prototype.Start=function(){this.refresh(!0)},e.prototype.Stop=function(){this.refresh(!1)},e.prototype.refresh=function(e){var t=this;var i={down:null,move:null,up:null};e?(this.UIMessageHandle=function(e){t.onUIMessage(e)},i.down=t.UIMessageHandle,i.move=t.UIMessageHandle,i.up=t.UIMessageHandle,$("#"+t.elememtID).mousecapture(i),$("#"+t.elememtID).mousewheel(t.UIMessageHandle),$("#"+t.elememtID).bind("click dblclick keydown",t.UIMessageHandle),t.hammer.on("panmove pinchstart pinchmove pinchend",t.UIMessageHandle),document.getElementById(t.elememtID).addEventListener("touchstart",t.UIMessageHandle,!1),document.getElementById(t.elememtID).addEventListener("touchend",t.UIMessageHandle,!1),document.getElementById(t.elememtID).addEventListener("touchcancel",t.UIMessageHandle,!1)):(null!=document.getElementById(t.elememtID)&&(i.down=null,i.move=null,i.up=null,$("#"+t.elememtID).mousecapture(i),$("#"+t.elememtID).unmousewheel(t.UIMessageHandle),$("#"+t.elememtID).unbind("click dblclick keydown",t.UIMessageHandle),t.hammer.off("panmove pinchstart pinchmove pinchend",t.UIMessageHandle),document.getElementById(t.elememtID).removeEventListener("touchstart",t.UIMessageHandle,!1),document.getElementById(t.elememtID).removeEventListener("touchend",t.UIMessageHandle,!1),document.getElementById(t.elememtID).removeEventListener("touchcancel",t.UIMessageHandle,!1)),this.UIMessageHandle=null)},e.prototype.getOffset=function(e){var t,i,n=e.target;return i=this.getPageCoord(n),{X:(t={X:window.pageXOffset+e.clientX,Y:window.pageYOffset+e.clientY}).X-i.X,Y:t.Y-i.Y}},e.prototype.getPageCoord=function(e){for(var t={X:0,Y:0};e;)t.X+=e.offsetLeft,t.Y+=e.offsetTop,e=e.offsetParent;return t},e.prototype.onUIMessage=function(e){var t=this;e.preventDefault(),"mousedown"!=e.type&&"click"!=e.type&&"dblclick"!=e.type||document.getElementById(this.elememtID).focus();var i=this.getMsgType(e);if(""!=i){var n={name:i};if(n.pageX=e.pageX,n.pageY=e.pageY,n.clientX=e.clientX,n.clientY=e.clientY,n.ctrlKey=e.ctrlKey,n.altKey=e.altKey,n.shiftKey=e.shiftKey,n.scale=e.scale,i==UIMsg.mouseWheel&&(e.deltaY?n.wheelDelta=e.deltaY:e.deltaY&&(n.wheelDelta=e.deltaY)),i==UIMsg.keyPress&&(n.keyCode=e.keyCode),"pinchstart"==e.type||"pinchend"==e.type||"pinchmove"==e.type){if(2==e.pointers.length){var a=e.pointers[1].clientX-e.pointers[0].clientX,s=e.pointers[1].clientY-e.pointers[0].clientY;n.twoFingerDistance=Math.sqrt(a*a+s*s),n.x=e.center.x,n.y=e.center.y,n.clientX=e.center.x,n.clientY=e.center.y,n.pageX=e.center.x,n.pageY=e.center.y}}else"pan"==e.type||"panstart"==e.type||"panend"==e.type||"panmove"==e.type?null!=e.srcEvent&&void 0!=e.srcEvent&&("mouse"==e.pointerType?(n.x=e.srcEvent.x,n.y=e.srcEvent.y,n.pageX=e.srcEvent.pageX,n.pageY=e.srcEvent.pageY,n.clientX=e.srcEvent.clientX,n.clientY=e.srcEvent.clientY):(void 0!=e.srcEvent.changedTouches?(n.x=e.srcEvent.changedTouches[0].screenX,n.y=e.srcEvent.changedTouches[0].screenY,n.pageX=e.srcEvent.changedTouches[0].pageX,n.pageY=e.srcEvent.changedTouches[0].pageY,n.clientX=e.srcEvent.changedTouches[0].clientX,n.clientY=e.srcEvent.changedTouches[0].clientY):(n.x=e.srcEvent.x,n.y=e.srcEvent.y,n.pageX=e.srcEvent.pageX,n.pageY=e.srcEvent.pageY,n.clientX=e.srcEvent.clientX,n.clientY=e.srcEvent.clientY),n.ctrlKey=e.srcEvent.ctrlKey,n.altKey=e.srcEvent.altKey,n.shiftKey=e.srcEvent.shiftKey)):"touchstart"!=e.type&&"touchend"!=e.type&&"touchcancel"!=e.type||(n.x=e.changedTouches[0].screenX,n.y=e.changedTouches[0].screenX,n.pageX=e.changedTouches[0].pageX,n.pageY=e.changedTouches[0].pageY,n.clientX=e.changedTouches[0].clientX,n.clientY=e.changedTouches[0].clientY);n.srcEvent=e,"touchstart"==e.type?(this.touchStartMsg=n,this.touchStartTimeID=setTimeout(function(){t.sendEventMsg(t.touchStartMsg)},200)):(0!=this.touchStartTimeID&&(clearTimeout(this.touchStartTimeID),this.touchStartTimeID=0,"pinchstart"==e.type||"pinchend"==e.type||"pinchmove"==e.type?this.touchStartMsg=null:(this.sendEventMsg(this.touchStartMsg),this.touchStartMsg=null)),this.sendEventMsg(n))}},e.prototype.getMsgType=function(e){var t="";switch(e.type){case"mousewheel":t=UIMsg.mouseWheel;break;case"mousedown":1==e.which?t=UIMsg.mouseLBDown:3==e.which&&(t=UIMsg.mouseRBDown);break;case"mousemove":t=UIMsg.mouseMove;break;case"mouseup":1==e.which?t=UIMsg.mouseLBUp:3==e.which&&(t=UIMsg.mouseRBUp);break;case"click":t=UIMsg.mouseClick;break;case"dblclick":t=UIMsg.mouseDoubleClick;break;case"keydown":t=UIMsg.keyPress;break;case"touchstart":1==e.targetTouches.length&&(t=UIMsg.touchDown,this._singleTouching=!0);break;case"touchend":case"touchcancel":0==e.targetTouches.length&&1==e.changedTouches.length?(t=UIMsg.touchUp,this._singleTouching=!1):0==e.targetTouches.length&&2==e.changedTouches.length&&this._singleTouching&&(t=UIMsg.touchUp,this._singleTouching=!1);break;case"panstart":t=UIMsg.touchDown;break;case"panend":t=UIMsg.touchUp;break;case"panmove":t=UIMsg.touchMove;break;case"pinchstart":t=UIMsg.touchZoomStart;break;case"pinchend":t=UIMsg.touchZoomEnd;break;case"pinchmove":t=UIMsg.touchZoom}return t},e.prototype.sendEventMsg=function(e){null!=this.drawer&&(e.name==UIMsg.mouseWheel&&this._dispMode==DISPLAY_MODE.DISP_2D?CImageDrawerManager.GetInstance().OnUIMessageToFocus(e,this._dispMode,!1):this.drawer.onUIMessage(e))},e}();__extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();function ImageCellFactoryMethod(e,t,i,n,a,s,r,o){var l=null;switch(e){case DISPLAY_MODE.DISP_2D:l=new CImageCell(i,t,n,a,s,r,o);break;case DISPLAY_MODE.DISP_MPR_T:l=new CMPRCell(i,t,n,a,s,r,e,"t",o);break;case DISPLAY_MODE.DISP_MPR_C:l=new CMPRCell(i,t,n,a,s,r,e,"c",o);break;case DISPLAY_MODE.DISP_MPR_S:l=new CMPRCell(i,t,n,a,s,r,e,"s",o);break;case DISPLAY_MODE.DISP_MPR_O:l=new CMPRCell(i,t,n,a,s,r,e,"o",o);break;case DISPLAY_MODE.DISP_VR:l=new CVRCell(i,t,n,a,s,r,o)}return l}var CImageCellBase=function(){function e(e,t,i,n,a,s,r,o){var l=this;this._canvasID="",this._canvasIndex=0,this._paneID="",this._xeGuid="",this._serialIndex=-1,this._imageIndex=-1,this._cb_UpdateAllCellInPane=null,this._connKey=t,this._paneID=i,this._canvasID=n,this._canvasIndex=a,this._xeGuid=s,this._serialIndex=r,this._dispMode=e,this._cb_UpdateAllCellInPane=o,this._drawer=CImageDrawerManager.GetInstance().createDrawer(e,this._connKey,this._xeGuid,this._serialIndex,this._paneID,this._canvasID,this._canvasIndex,function(e,t){l.onSyncAllDrawInSerial(e,t)}),this._eventCapture=new CImageEventCapture(n,this._drawer,this._dispMode),this._eventCapture.Start()}return e.prototype.setCanvasSliderBar=function(e,t){this._drawer.setCanvasSliderBar(e,t)},e.prototype.onSyncAllDrawInSerial=function(e,t){this._cb_UpdateAllCellInPane(e,t)},e.prototype.refresh=function(e,t){this._xeGuid==e&&this._serialIndex==t||(this._xeGuid=e,this._serialIndex=t,this.clearImage())},e.prototype.clearImage=function(e){void 0===e&&(e=!0),this._imageIndex=-1,this._drawer.clear(e)},e.prototype.drawAsync=function(e,t,i){return null},e.prototype.draw=function(){this._drawer.draw()},e.prototype.pageTurn=function(e){return this._drawer.pageTurn(e)},e.prototype.destroy=function(){this._eventCapture.Stop(),this._eventCapture=null,CImageDrawerManager.GetInstance().destroyDrawer(this._drawer),this._drawer=null},e.prototype.recover=function(){this._drawer.recover()},e.prototype.reset=function(){this._drawer.reset()},e.prototype.rotate=function(e){this._drawer.rotate(e)},e.prototype.mirrorH=function(){this._drawer.mirrorH()},e.prototype.mirrorV=function(){this._drawer.mirrorV()},e.prototype.setWWWL=function(e,t){this._drawer.setWWWL(e,t)},e.prototype.deleteCanvasSelectedAnno=function(e){this._drawer.deleteSelected(e)},e.prototype.deleteAllAnno=function(e){return this._drawer.deleteAll(e)},e.prototype.hasOverlay=function(){return this._drawer.hasOverlay()},e.prototype.isSelected=function(){return this._drawer.isSelected},e.prototype.setMPRParam=function(e){},e.prototype.setCellState=function(e){e.cellID==this._canvasID&&this._drawer&&this._drawer.setDrawerState(e.drawerState)},e.prototype.getCellState=function(){var e=new CellStateForSync;return e.cellID=this._canvasID,e.drawerState=this._drawer.getDrawerState(),e},e}(),CImageCell=function(e){function t(t,i,n,a,s,r,o){return e.call(this,DISPLAY_MODE.DISP_2D,i,t,n,a,s,r,o)||this}return __extends(t,e),t.prototype.drawAsync=function(e,t,i){var n=this._drawer;return n?(this._imageIndex=e,n.drawImageAsync(this._xeGuid,this._serialIndex,this._imageIndex,t,i)):null},t}(CImageCellBase),CMPRCell=function(e){function t(t,i,n,a,s,r,o,l,h){var u=e.call(this,o,i,t,n,a,s,r,h)||this;return u.planum=l,u}return __extends(t,e),t.prototype.drawAsync=function(e,t,i){var n=this._drawer;return n?n.drawMPRAsync(this._xeGuid,this._serialIndex,this.planum):null},t.prototype.draw=function(){var e=this._drawer;e&&e.updateMPR()},t.prototype.setMPRParam=function(e){var t=this._drawer;t&&t.setMPRParam(e)},t}(CImageCellBase),CVRCell=function(e){function t(t,i,n,a,s,r,o){return e.call(this,DISPLAY_MODE.DISP_VR,i,t,n,a,s,r,o)||this}return __extends(t,e),t.prototype.drawAsync=function(e,t,i){var n=this._drawer;return n?n.drawVRAsync(this._xeGuid,this._serialIndex):null},t.prototype.refresh=function(e,t){this._xeGuid==e&&this._serialIndex==t||(this._xeGuid=e,this._serialIndex=t,this.clearImage())},t.prototype.draw=function(){var e=this._drawer;e&&e.updateVRJpg()},t}(CImageCellBase),CImagePane=function(){function e(e,t,i,n,a){void 0===a&&(a=DISPLAY_MODE.DISP_2D),this._cells=new Map,this._paneID=e,this._xeGuid=t,this._serialIndex=i,this._connKey=n,this._paneMode=a,this._drawerGroup=CImageDrawerManager.GetInstance().createDrawerGroup(this._connKey,e,t,i,a)}return e.prototype.onUpdateAllCellInPane=function(e,t){var i=this;if("MPRChange"==e)this._cells.forEach(function(e){e.draw()});else if("SerialSync"==e)this._cells.forEach(function(e){e.draw()});else if("pageTurn"==e){var n=this._imageIndex+t,a=!1;if((r=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex))&&n+this.cellCount()-1>r.imageTotal-1&&(a=!0),n!=this._imageIndex&&!a){this._imageIndex=n,this._cells.forEach(function(e){e.clearImage(!1)});var s=new Array;this._cells.forEach(function(e){var t=e.pageTurn(n++);s.push(t)}),Promise.all(s).then(function(){i._drawerGroup.onLinkageEvent(PageTurnSync,t)},function(e){})}}else if("pageTurnForLinkage"==e){var r,o=t;a=!1;(r=CDicomDataManager.GetInstance(this._connKey).getSeriesData(this._xeGuid,this._serialIndex))&&o+this.cellCount()-1>r.imageTotal-1&&(a=!0),o==this._imageIndex||a||(this._imageIndex=o,this._cells.forEach(function(e){e.clearImage(!1)}),this._cells.forEach(function(e){e.pageTurn(o++)}))}},e.prototype.attach=function(e,t){for(var i=this,n=0,a=e;n<a.length;n++){var s=a[n];if(!this._cells.has(s)){var r=ImageCellFactoryMethod(t,this._connKey,this._paneID,s,this._cells.size,this._xeGuid,this._serialIndex,function(e,t){i.onUpdateAllCellInPane(e,t)});this._cells.set(s,r)}}},e.prototype.detach=function(e){for(var t=0,i=e;t<i.length;t++){var n=i[t];this._cells.has(n)&&(this._cells.get(n).destroy(),this._cells.delete(n))}},e.prototype.setCanvasSliderBar=function(e,t,i){null!=e&&""!=e&&this._cells.has(e)&&this._cells.get(e).setCanvasSliderBar(t,i)},e.prototype.destroy=function(){CImageDrawerManager.GetInstance().destroyDrawerGroup(this._drawerGroup),this._cells.forEach(function(e){e.destroy()}),this._cells.clear()},Object.defineProperty(e.prototype,"isFocused",{get:function(){return this._drawerGroup.isFocused},set:function(e){this._drawerGroup.isFocused=e},enumerable:!0,configurable:!0}),e.prototype.cellCount=function(){return this._cells.size},e.prototype.refresh=function(e,t){this._xeGuid==e&&this._serialIndex==t||(this._xeGuid=e,this._serialIndex=t,this._drawerGroup.refresh(e,t),this._cells.forEach(function(i){i.refresh(e,t)}))},e.prototype.drawAsync=function(e,t,i){var n=this;return new Promise(function(a,s){n._imageIndex!=e&&n._cells.forEach(function(e){e.clearImage(!1)}),n._imageIndex=e;var r=new Array;n._cells.forEach(function(n){var a=n.drawAsync(e++,t,i);r.push(a)}),Promise.all(r).then(function(){n._paneMode==DISPLAY_MODE.DISP_2D&&(n._drawerGroup.onLinkageEvent(PageTurnSync,null),n._drawerGroup.onLinkageEvent(ShowPositionLine,null)),a()},function(e){s(e)})})},e.prototype.getWWWL=function(){return{ww:this._drawerGroup.dispState.windowWidth,wl:this._drawerGroup.dispState.windowCenter}},e.prototype.getPaneDispState=function(){return{ww:this._drawerGroup.dispState.windowWidth,wl:this._drawerGroup.dispState.windowCenter,enbalePseudoColor:this._drawerGroup.dispState.enbalePseudoColor,enbaleSharpen:this._drawerGroup.dispState.enbaleSharpen,enbaleInverse:this._drawerGroup.dispState.enbaleInverse,isShowAnno:this._drawerGroup.dispState.isShowAnno,isShowOverlay:this._drawerGroup.dispState.isShowOverlay,zoom:this._drawerGroup.dispState.zoom,isHorzMirror:this._drawerGroup.dispState.isHorzMirror,isVertMirror:this._drawerGroup.dispState.isVertMirror,rotateAngle:this._drawerGroup.dispState.rotateAngle,mprThick:this._drawerGroup.dispState.mprThick,mprMIPType:this._drawerGroup.dispState.mprMIPType}},e.prototype.recover=function(){var e;switch(this._cells.forEach(function(e){e.recover()}),this._paneMode){case DISPLAY_MODE.DISP_2D:(e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex)).resetAll();break;case DISPLAY_MODE.DISP_MPR:(e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex)).resetAll();break;case DISPLAY_MODE.DISP_VR:(e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex)).resetAll();break;default:(e=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex)).resetAll()}this.deleteAllAnno("all"),this._drawerGroup.dispState.reset(e.defaultWW,e.defaultWL,e.defaultMPRCenterPoint)},e.prototype.resetDisplayState=function(){switch(this._cells.forEach(function(e){e.reset()}),this._paneMode){case DISPLAY_MODE.DISP_2D:CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex).resetDisplay();break;case DISPLAY_MODE.DISP_MPR:CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex).resetDisplay();break;case DISPLAY_MODE.DISP_VR:CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex).resetDisplay();break;default:CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex).resetDisplay()}},e.prototype.setShowAnno=function(e){this._drawerGroup.dispState.isShowAnno=e,this._cells.forEach(function(e){e.draw()})},e.prototype.rotate=function(e){this._drawerGroup.dispState.rotateAngle=(this._drawerGroup.dispState.rotateAngle+e+360)%360,this._cells.forEach(function(e){e.draw()})},e.prototype.mirrorH=function(){this._drawerGroup.dispState.isHorzMirror=!this._drawerGroup.dispState.isHorzMirror,this._cells.forEach(function(e){e.draw()})},e.prototype.mirrorV=function(){this._drawerGroup.dispState.isVertMirror=!this._drawerGroup.dispState.isVertMirror,this._cells.forEach(function(e){e.draw()})},e.prototype.setWWWL=function(e,t){this._cells.forEach(function(i){i.setWWWL(e,t)}),this._drawerGroup.dispState.windowWidth=Math.round(e),this._drawerGroup.dispState.windowCenter=Math.round(t)},e.prototype.deleteCanvasSelectedAnno=function(e,t){this._cells.has(e)&&this._cells.get(e).deleteCanvasSelectedAnno(t)},e.prototype.deleteAllAnno=function(e){var t=!1;if(this._cells.forEach(function(i){t=i.deleteAllAnno(e)||t}),t){var i=void 0;switch(this._paneMode){case DISPLAY_MODE.DISP_2D:i=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex);break;case DISPLAY_MODE.DISP_MPR:i=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialMPRState(this._serialIndex);break;case DISPLAY_MODE.DISP_VR:i=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialVRState(this._serialIndex);break;default:i=CXeImageStateManager.GetInstance(this._connKey).getStudyState(this._xeGuid).getSerialState(this._serialIndex)}i.resetAllImageAnno(e)}},e.prototype.setShowOverlay=function(e){this._drawerGroup.dispState.isShowOverlay!=e&&(this._drawerGroup.dispState.isShowOverlay=e,this._cells.forEach(function(e){e.draw()}))},e.prototype.getShowOverlay=function(){return this._drawerGroup.dispState.isShowOverlay},e.prototype.calcSignalNoiseRatio=function(){this._drawerGroup.dispState.isSNRShow=!this._drawerGroup.dispState.isSNRShow,this._cells.forEach(function(e){e.draw()})},e.prototype.setPseudocolor=function(e,t){this._drawerGroup.dispState.enbalePseudoColor==t&&this._drawerGroup.dispState.pseudoColorMap==e||(this._drawerGroup.dispState.pseudoColorMap=e,this._drawerGroup.dispState.enbalePseudoColor=t,this._cells.forEach(function(e){e.draw()}))},e.prototype.setSharpen=function(e){this._drawerGroup.dispState.enbaleSharpen!=e&&(this._drawerGroup.dispState.enbaleSharpen=e,this._cells.forEach(function(e){e.draw()}))},e.prototype.setInverse=function(e){this._drawerGroup.dispState.enbaleInverse!=e&&(this._drawerGroup.dispState.enbaleInverse=e,this._cells.forEach(function(e){e.draw()}))},e.prototype.setMPRParam=function(e,t){this._cells.has(e)&&this._cells.get(e).setMPRParam(t)},e.prototype.changeImageZoom=function(e){this._drawerGroup.dispState.zoom+=e,this._cells.forEach(function(e){e.draw()})},e.prototype.forEachCell=function(e){this._cells.forEach(e)},e.prototype.setPaneState=function(e){if(e.paneID==this._paneID)for(var t=0;t<e.cellStates.length;t++){var i=e.cellStates[t];this._cells.has(i.cellID)&&this._cells.get(i.cellID).setCellState(i)}},e.prototype.getPaneState=function(){var e=new PaneStateForSync;return e.paneID=this._paneID,this._cells.forEach(function(t,i){var n=t.getCellState();e.cellStates.push(n)}),e},e}(),CellStateForSync=function(){return function(){}}(),PaneStateForSync=function(){return function(){this.cellStates=new Array}}(),DicomStateForSync=function(){return function(){this.paneStates=new Array}}(),CUIBinder=function(){function e(e){this._panes=new Map,this._connKey=e}return e.prototype.attachPane=function(e,t,i,n){if(void 0===n&&(n=DISPLAY_MODE.DISP_2D),this._panes.has(i))this._panes.get(i).refresh(e,t);else{var a=new CImagePane(i,e,t,this._connKey,n);this._panes.set(i,a)}},e.prototype.detachPane=function(e){this._panes.has(e)&&(this._panes.get(e).destroy(),this._panes.delete(e))},e.prototype.getPane=function(e){return this._panes.has(e)?this._panes.get(e):null},e.prototype.setFocusPane=function(e,t){this._panes.forEach(function(i,n){n==e?i.isFocused=!0:!t&&i.isFocused&&(i.isFocused=!1)})},e.prototype.forEachPane=function(e){this._panes.forEach(e)},e.prototype.setBinderSate=function(e){for(var t=0;t<e.paneStates.length;t++){var i=e.paneStates[t];this._panes.has(i.paneID)&&this._panes.get(i.paneID).setPaneState(i)}},e.prototype.getBinderState=function(){var e=new DicomStateForSync;return e.viewName=this._connKey,this._panes.forEach(function(t,i){var n=t.getPaneState();e.paneStates.push(n)}),e},e}();